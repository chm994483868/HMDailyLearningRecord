# JavaScript å­¦ä¹ è®°å½•ï¼ˆäº”ï¼‰ï¼šasynchronous JavaScript

&emsp;å¼‚æ­¥æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„å¯¹è±¡æˆ–äº‹ä»¶ä¸åŒæ—¶å­˜åœ¨æˆ–å‘ç”Ÿï¼ˆæˆ–å¤šä¸ªç›¸å…³äº‹ç‰©çš„å‘ç”Ÿæ— éœ€ç­‰å¾…å…¶å‰ä¸€äº‹ç‰©çš„å®Œæˆï¼‰ã€‚åœ¨è®¡ç®—æœºæŠ€æœ¯ä¸­ï¼Œ"å¼‚æ­¥" ä¸€ è¯è¢«ç”¨äºä¸¤å¤§è¯­å¢ƒã€‚

&emsp;å¼‚æ­¥é€šä¿¡æ˜¯ä¸€ç§åœ¨åŒæ–¹æˆ–å¤šæ–¹ä¹‹é—´äº¤æ¢æ¶ˆæ¯çš„æ–¹å¼ã€‚å…¶ä¸­æ¯ä¸ªå‚ä¸æ–¹å„è‡ªåœ¨ä»–ä»¬æ–¹ä¾¿æˆ–å¯æ“ä½œçš„æƒ…å†µä¸‹æ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯åœ¨æ”¶åˆ°æ¶ˆæ¯åç«‹å³è¿›è¡Œå¤„ç†ã€‚ å¦å¤–ï¼Œæ¶ˆæ¯çš„å‘é€æ— éœ€ç­‰å¾…ç¡®è®¤ä¿¡æ¯ï¼Œå‰ææ˜¯å¦‚æœå‡ºç°é—®é¢˜ï¼Œæ¥æ”¶æ–¹å°†è¯·æ±‚æ›´æ­£æˆ–ä»¥å…¶ä»–æ–¹å¼å¤„ç†è¯¥æƒ…å†µã€‚

&emsp;å¯¹äººç±»æ¥è¯´ï¼Œç”µå­é‚®ä»¶å°±æ˜¯ä¸€ç§å¼‚æ­¥é€šä¿¡æ–¹å¼ï¼›å‘é€è€…å‘é€äº†ä¸€å°é‚®ä»¶ï¼Œæ¥ç€æ¥æ”¶è€…ä¼šåœ¨æ–¹ä¾¿æ—¶è¯»å–å’Œå›å¤è¯¥é‚®ä»¶ï¼Œè€Œä¸æ˜¯é©¬ä¸Šè¿™æ ·åšã€‚åŒæ–¹å¯ä»¥ç»§ç»­éšæ—¶å‘é€å’Œæ¥æ”¶ä¿¡æ¯ï¼Œè€Œæ— éœ€åŒæ–¹å®‰æ’ä½•æ—¶è¿›è¡Œæ“ä½œã€‚

&emsp;åœ¨è½¯ä»¶è¿›è¡Œå¼‚æ­¥é€šä¿¡æ—¶ï¼Œä¸€ä¸ªç¨‹åºå¯èƒ½ä¼šå‘å¦ä¸€è½¯ä»¶ï¼ˆå¦‚æœåŠ¡å™¨ï¼‰è¯·æ±‚ä¿¡æ¯ï¼Œå¹¶åœ¨ç­‰å¾…å›å¤çš„åŒæ—¶ç»§ç»­æ‰§è¡Œå…¶ä»–æ“ä½œã€‚ä¾‹å¦‚ï¼ŒAJAXï¼ˆAsynchronous JavaScript and XMLï¼‰ç¼–ç¨‹æŠ€æœ¯ï¼ˆç°åœ¨é€šå¸¸ç®€å†™ä¸º "Ajax"ï¼Œä¸è¿‡ç°åœ¨çš„åº”ç”¨ä¸å¸¸ç”¨ XMLï¼Œè€Œæ˜¯ç”¨ JSONï¼‰å°±æ˜¯è¿™æ ·ä¸€ç§æœºåˆ¶ï¼Œå®ƒé€šè¿‡ HTTP ä»æœåŠ¡å™¨è¯·æ±‚è¾ƒå°‘çš„æ•°æ®ï¼Œå½“ç»“æœå¯è¢«è¿”å›æ—¶æ‰è¿”å›ç»“æœï¼Œè€Œä¸æ˜¯ç«‹å³è¿”å›ã€‚

&emsp;å¼‚æ­¥è½¯ä»¶è®¾è®¡é€šè¿‡æ„å»ºä»£ç æ‰©å±•äº†å¼‚æ­¥çš„æ¦‚å¿µï¼ŒæŒ‰ç…§è¿™ç§è®¾è®¡ç¼–å†™çš„ä»£ç ä½¿å¾—ç¨‹åºèƒ½å¤Ÿè¦æ±‚ä¸€ä¸ªä»»åŠ¡ä¸å…ˆå‰çš„ä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰ä»»åŠ¡ä¸€èµ·æ‰§è¡Œï¼Œè€Œæ— éœ€ä¸ºäº†ç­‰å¾…å®ƒä»¬å®Œæˆè€Œåœæ­¢æ‰§è¡Œã€‚å½“åæ¥çš„ä»»åŠ¡å®Œæˆæ—¶ï¼Œç¨‹åºå°†ä½¿ç”¨çº¦å®šå¥½çš„æœºåˆ¶é€šçŸ¥å…ˆå‰çš„ä»»åŠ¡ï¼Œä»¥ä¾¿è®©å®ƒçŸ¥é“ä»»åŠ¡å·²ç»å®Œæˆï¼Œä»¥åŠå¦‚æœæœ‰ç»“æœå­˜åœ¨çš„è¯ï¼Œè¿™ä¸ªç»“æœæ˜¯å¯ç”¨çš„ã€‚

&emsp;åœ¨ JavaScript ä»£ç ä¸­ï¼Œä½ ç»å¸¸ä¼šé‡åˆ°ä¸¤ç§å¼‚æ­¥ç¼–ç¨‹é£æ ¼ï¼šè€æ´¾ callbacksï¼Œæ–°æ´¾ promiseã€‚

## å¼‚æ­¥ callbacks

&emsp;å¼‚æ­¥ callbacks å…¶å®å°±æ˜¯å‡½æ•°ï¼Œåªä¸è¿‡æ˜¯ä½œä¸ºå‚æ•°ä¼ é€’ç»™é‚£äº›åœ¨åå°æ‰§è¡Œçš„å…¶ä»–å‡½æ•°ã€‚å½“é‚£äº›åå°è¿è¡Œçš„ä»£ç ç»“æŸï¼Œå°±è°ƒç”¨ callbacks å‡½æ•°ï¼Œé€šçŸ¥ä½ å·¥ä½œå·²ç»å®Œæˆï¼Œæˆ–è€…å…¶ä»–æœ‰è¶£çš„äº‹æƒ…å‘ç”Ÿäº†ã€‚ä½¿ç”¨ callbacks æœ‰ä¸€ç‚¹è€å¥—ï¼Œåœ¨ä¸€äº›è€æ´¾ä½†ç»å¸¸ä½¿ç”¨çš„ API é‡Œé¢ï¼Œç»å¸¸ä¼šçœ‹åˆ°è¿™ç§é£æ ¼ã€‚

&emsp;ä¸æ˜¯æ‰€æœ‰çš„å›è°ƒå‡½æ•°éƒ½æ˜¯å¼‚æ­¥çš„ â€” æœ‰ä¸€äº›æ˜¯åŒæ­¥çš„ã€‚ä¸€ä¸ªä¾‹å­å°±æ˜¯ä½¿ç”¨ Array.prototype.forEach() æ¥éå†æ•°ç»„ã€‚

```javascript
const gods = ['Apollo', 'Artemis', 'Ares', 'Zeus'];

gods.forEach(function (eachName, index){
  console.log(index + '. ' + eachName);
});
```

&emsp;forEach() éœ€è¦çš„å‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°æœ¬èº«å¸¦æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œæ•°ç»„å…ƒç´ å’Œç´¢å¼•å€¼ã€‚å®ƒæ— éœ€ç­‰å¾…ä»»ä½•äº‹æƒ…ï¼Œç«‹å³è¿è¡Œã€‚

&emsp;Promises æ˜¯æ–°æ´¾çš„å¼‚æ­¥ä»£ç ï¼Œç°ä»£çš„ web APIs ç»å¸¸ç”¨åˆ°ã€‚fetch() API å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œå®ƒåŸºæœ¬ä¸Šå°±æ˜¯ä¸€ä¸ªç°ä»£ç‰ˆçš„æ›´é«˜æ•ˆçš„ XMLHttpRequestã€‚

```javascript
fetch('products.json').then(function(response) {
  return response.json();
}).then(function(json) {
  products = json;
  initialize();
}).catch(function(err) {
  console.log('Fetch problem: ' + err.message);
});
```

&emsp;è¿™é‡Œ fetch() åªéœ€è¦ä¸€ä¸ªå‚æ•° â€” èµ„æºçš„ç½‘ç»œ URL â€” è¿”å›ä¸€ä¸ª promiseã€‚promise æ˜¯è¡¨ç¤ºå¼‚æ­¥æ“ä½œå®Œæˆæˆ–å¤±è´¥çš„å¯¹è±¡ã€‚å¯ä»¥è¯´ï¼Œå®ƒä»£è¡¨äº†ä¸€ç§ä¸­é—´çŠ¶æ€ã€‚æœ¬è´¨ä¸Šï¼Œè¿™æ˜¯æµè§ˆå™¨è¯´ "æˆ‘ä¿è¯å°½å¿«ç»™ä½ ç­”å¤" çš„æ–¹å¼ï¼Œå› æ­¤å¾—å "promise"ã€‚è¿™ä¸¤ç§å¯èƒ½çš„ç»“æœéƒ½è¿˜æ²¡æœ‰å‘ç”Ÿï¼Œå› æ­¤ fetch æ“ä½œç›®å‰æ­£åœ¨ç­‰å¾…æµè§ˆå™¨è¯•å›¾åœ¨å°†æ¥æŸä¸ªæ—¶å€™å®Œæˆè¯¥æ“ä½œçš„ç»“æœã€‚ç„¶åæˆ‘ä»¬æœ‰ä¸‰ä¸ªä»£ç å—é“¾æ¥åˆ° fetch() çš„æœ«å°¾ï¼š

+ ä¸¤ä¸ª then() å—ã€‚ä¸¤è€…éƒ½åŒ…å«ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå¦‚æœå‰ä¸€ä¸ªæ“ä½œæˆåŠŸï¼Œè¯¥å‡½æ•°å°†è¿è¡Œï¼Œå¹¶ä¸”æ¯ä¸ªå›è°ƒéƒ½æ¥æ”¶å‰ä¸€ä¸ªæˆåŠŸæ“ä½œçš„ç»“æœä½œä¸ºè¾“å…¥ï¼Œå› æ­¤ä½ å¯ä»¥ç»§ç»­å¯¹å®ƒæ‰§è¡Œå…¶ä»–æ“ä½œã€‚æ¯ä¸ª .then() å—è¿”å›å¦ä¸€ä¸ª promiseï¼Œè¿™æ„å‘³ç€å¯ä»¥å°†å¤šä¸ª .then() å—é“¾æ¥åˆ°å¦ä¸€ä¸ªå—ä¸Šï¼Œè¿™æ ·å°±å¯ä»¥ä¾æ¬¡æ‰§è¡Œå¤šä¸ªå¼‚æ­¥æ“ä½œã€‚
+ å¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ª then() å—å¤±è´¥ï¼Œåˆ™åœ¨æœ«å°¾è¿è¡Œ catch() å— â€”â€” ä¸åŒæ­¥ try...catch ç±»ä¼¼ï¼Œcatch() æä¾›äº†ä¸€ä¸ªé”™è¯¯å¯¹è±¡ï¼Œå¯ç”¨æ¥æŠ¥å‘Šå‘ç”Ÿçš„é”™è¯¯ç±»å‹ã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼ŒåŒæ­¥ try...catch ä¸èƒ½ä¸ promise ä¸€èµ·å·¥ä½œï¼Œå°½ç®¡å®ƒå¯ä»¥ä¸ async/await ä¸€èµ·å·¥ä½œã€‚

&emsp;åƒ promise è¿™æ ·çš„å¼‚æ­¥æ“ä½œè¢«æ”¾å…¥äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼Œäº‹ä»¶é˜Ÿåˆ—åœ¨ä¸»çº¿ç¨‹å®Œæˆå¤„ç†åè¿è¡Œï¼Œè¿™æ ·å®ƒä»¬å°±ä¸ä¼šé˜»æ­¢åç»­ JavaScript ä»£ç çš„è¿è¡Œã€‚æ’é˜Ÿæ“ä½œå°†å°½å¿«å®Œæˆï¼Œç„¶åå°†ç»“æœè¿”å›åˆ° JavaScript ç¯å¢ƒã€‚

### Promises å¯¹æ¯” callbacks

&emsp;Promises ä¸æ—§å¼ callbacks æœ‰ä¸€äº›ç›¸ä¼¼ä¹‹å¤„ã€‚å®ƒä»¬æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè¿”å›çš„å¯¹è±¡ï¼Œä½ å¯ä»¥å°†å›è°ƒå‡½æ•°é™„åŠ åˆ°è¯¥å¯¹è±¡ä¸Šï¼Œè€Œä¸å¿…å°†å›è°ƒä½œä¸ºå‚æ•°ä¼ é€’ç»™å¦ä¸€ä¸ªå‡½æ•°ã€‚ç„¶è€Œï¼ŒPromiseæ˜¯ä¸“é—¨ä¸ºå¼‚æ­¥æ“ä½œè€Œè®¾è®¡çš„ï¼Œä¸æ—§å¼å›è°ƒç›¸æ¯”å…·æœ‰è®¸å¤šä¼˜ç‚¹ï¼š

+ ä½ å¯ä»¥ä½¿ç”¨å¤šä¸ª then() æ“ä½œå°†å¤šä¸ªå¼‚æ­¥æ“ä½œé“¾æ¥åœ¨ä¸€èµ·ï¼Œå¹¶å°†å…¶ä¸­ä¸€ä¸ªæ“ä½œçš„ç»“æœä½œä¸ºè¾“å…¥ä¼ é€’ç»™ä¸‹ä¸€ä¸ªæ“ä½œã€‚è¿™ç§é“¾æ¥æ–¹å¼å¯¹å›è°ƒæ¥è¯´è¦éš¾å¾—å¤šï¼Œä¼šä½¿å›è°ƒä»¥æ··ä¹±çš„ "æœ«æ—¥é‡‘å­—å¡”" å‘Šç»ˆï¼ˆä¹Ÿç§°ä¸ºå›è°ƒåœ°ç‹±ï¼‰ã€‚
+ Promise æ€»æ˜¯ä¸¥æ ¼æŒ‰ç…§å®ƒä»¬æ”¾ç½®åœ¨äº‹ä»¶é˜Ÿåˆ—ä¸­çš„é¡ºåºè°ƒç”¨ã€‚
+ é”™è¯¯å¤„ç†è¦å¥½å¾—å¤š â€”â€” æ‰€æœ‰çš„é”™è¯¯éƒ½ç”±å—æœ«å°¾çš„ä¸€ä¸ª .catch() å—å¤„ç†ï¼Œè€Œä¸æ˜¯åœ¨ "é‡‘å­—å¡”" çš„æ¯ä¸€å±‚å•ç‹¬å¤„ç†ã€‚

&emsp;åœ¨æœ€åŸºæœ¬çš„å½¢å¼ä¸­ï¼ŒJavaScript æ˜¯ä¸€ç§åŒæ­¥çš„ã€é˜»å¡çš„ã€å•çº¿ç¨‹çš„è¯­è¨€ï¼Œåœ¨è¿™ç§è¯­è¨€ä¸­ï¼Œä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªæ“ä½œã€‚ä½† web æµè§ˆå™¨å®šä¹‰äº†å‡½æ•°å’Œ APIï¼Œå…è®¸æˆ‘ä»¬å½“æŸäº›äº‹ä»¶å‘ç”Ÿæ—¶ä¸æ˜¯æŒ‰ç…§åŒæ­¥æ–¹å¼ï¼Œè€Œæ˜¯å¼‚æ­¥åœ°è°ƒç”¨å‡½æ•°(æ¯”å¦‚ï¼Œæ—¶é—´çš„æ¨ç§»ï¼Œç”¨æˆ·é€šè¿‡é¼ æ ‡çš„äº¤äº’ï¼Œæˆ–è€…è·å–ç½‘ç»œæ•°æ®)ã€‚è¿™æ„å‘³ç€ä½ çš„ä»£ç å¯ä»¥åŒæ—¶åšå‡ ä»¶äº‹æƒ…ï¼Œè€Œä¸éœ€è¦åœæ­¢æˆ–é˜»å¡ä¸»çº¿ç¨‹ã€‚

## ä½¿ç”¨ Promise

&emsp;Promise å¯¹è±¡ç”¨äºè¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„æœ€ç»ˆå®Œæˆï¼ˆæˆ–å¤±è´¥ï¼‰åŠå…¶ç»“æœå€¼ã€‚

&emsp;Promise æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒä»£è¡¨äº†ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„æœ€ç»ˆå®Œæˆæˆ–è€…å¤±è´¥ã€‚å› ä¸ºå¤§å¤šæ•°äººä»…ä»…æ˜¯ä½¿ç”¨å·²åˆ›å»ºçš„ Promise å®ä¾‹å¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œé¦–å…ˆè¯´æ˜æ€æ ·ä½¿ç”¨ Promiseï¼Œå†è¯´æ˜å¦‚ä½•åˆ›å»º Promiseã€‚

&emsp;æœ¬è´¨ä¸Š Promise æ˜¯ä¸€ä¸ªå‡½æ•°è¿”å›çš„å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å®ƒä¸Šé¢ç»‘å®šå›è°ƒå‡½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸éœ€è¦åœ¨ä¸€å¼€å§‹æŠŠå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ä¼ å…¥è¿™ä¸ªå‡½æ•°äº†ã€‚

&emsp;å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªåä¸º createAudioFileAsync() çš„å‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸€äº›é…ç½®å’Œä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Œç„¶åå¼‚æ­¥åœ°ç”ŸæˆéŸ³é¢‘æ–‡ä»¶ã€‚ä¸€ä¸ªå›è°ƒå‡½æ•°åœ¨æ–‡ä»¶æˆåŠŸåˆ›å»ºæ—¶è¢«è°ƒç”¨ï¼Œå¦ä¸€ä¸ªåˆ™åœ¨å‡ºç°å¼‚å¸¸æ—¶è¢«è°ƒç”¨ã€‚

&emsp;ä»¥ä¸‹ä¸ºä½¿ç”¨ createAudioFileAsync() çš„ç¤ºä¾‹ï¼š

```javascript
// æˆåŠŸçš„å›è°ƒå‡½æ•°
function successCallback(result) {
  console.log("éŸ³é¢‘æ–‡ä»¶åˆ›å»ºæˆåŠŸ: " + result);
}

// å¤±è´¥çš„å›è°ƒå‡½æ•°
function failureCallback(error) {
  console.log("éŸ³é¢‘æ–‡ä»¶åˆ›å»ºå¤±è´¥: " + error);
}

createAudioFileAsync(audioSettings, successCallback, failureCallback)
```

&emsp;æ›´ç°ä»£çš„å‡½æ•°ä¼šè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œä½¿å¾—ä½ å¯ä»¥å°†ä½ çš„å›è°ƒå‡½æ•°ç»‘å®šåœ¨è¯¥ Promise ä¸Šã€‚

&emsp;å¦‚æœå‡½æ•° createAudioFileAsync() è¢«é‡å†™ä¸ºè¿”å› Promise çš„å½¢å¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·ç®€å•åœ°è°ƒç”¨å®ƒï¼š

```javascript
const promise = createAudioFileAsync(audioSettings);
promise.then(successCallback, failureCallback);
```

&emsp;æˆ–è€…ç®€å†™ä¸ºï¼š

```javascript
createAudioFileAsync(audioSettings).then(successCallback, failureCallback);
```

&emsp;æˆ‘ä»¬æŠŠè¿™ä¸ªç§°ä¸ºå¼‚æ­¥å‡½æ•°è°ƒç”¨ï¼Œè¿™ç§å½¢å¼æœ‰è‹¥å¹²ä¼˜ç‚¹ã€‚

&emsp;ä¸åŒäº "è€å¼" çš„ä¼ å…¥å›è°ƒï¼Œåœ¨ä½¿ç”¨ Promise æ—¶ï¼Œä¼šæœ‰ä»¥ä¸‹çº¦å®šï¼š

+ åœ¨æœ¬è½® äº‹ä»¶å¾ªç¯ è¿è¡Œå®Œæˆä¹‹å‰ï¼Œå›è°ƒå‡½æ•°æ˜¯ä¸ä¼šè¢«è°ƒç”¨çš„ã€‚
+ å³ä½¿å¼‚æ­¥æ“ä½œå·²ç»å®Œæˆï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰ï¼Œåœ¨è¿™ä¹‹åé€šè¿‡ then() æ·»åŠ çš„å›è°ƒå‡½æ•°ä¹Ÿä¼šè¢«è°ƒç”¨ã€‚
+ é€šè¿‡å¤šæ¬¡è°ƒç”¨ then() å¯ä»¥æ·»åŠ å¤šä¸ªå›è°ƒå‡½æ•°ï¼Œå®ƒä»¬ä¼šæŒ‰ç…§æ’å…¥é¡ºåºè¿›è¡Œæ‰§è¡Œã€‚

&emsp;Promise å¾ˆæ£’çš„ä¸€ç‚¹å°±æ˜¯é“¾å¼è°ƒç”¨ï¼ˆchainingï¼‰ã€‚

### é“¾å¼è°ƒç”¨ï¼ˆchainingï¼‰

&emsp;è¿ç»­æ‰§è¡Œä¸¤ä¸ªæˆ–è€…å¤šä¸ªå¼‚æ­¥æ“ä½œæ˜¯ä¸€ä¸ªå¸¸è§çš„éœ€æ±‚ï¼Œåœ¨ä¸Šä¸€ä¸ªæ“ä½œæ‰§è¡ŒæˆåŠŸä¹‹åï¼Œå¼€å§‹ä¸‹ä¸€ä¸ªçš„æ“ä½œï¼Œå¹¶å¸¦ç€ä¸Šä¸€æ­¥æ“ä½œæ‰€è¿”å›çš„ç»“æœã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›é€ ä¸€ä¸ª Promise é“¾æ¥å®ç°è¿™ç§éœ€æ±‚ã€‚

&emsp;then() å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå’ŒåŸæ¥ä¸åŒçš„æ–°çš„ Promiseï¼š

```javascript
const promise = doSomething();
const promise2 = promise.then(successCallback, failureCallback);
```

&emsp;æˆ–è€…ï¼š

```javascript
const promise2 = doSomething().then(successCallback, failureCallback);
```

&emsp;promise2 ä¸ä»…è¡¨ç¤º doSomething() å‡½æ•°çš„å®Œæˆï¼Œä¹Ÿä»£è¡¨äº†ä½ ä¼ å…¥çš„ successCallback æˆ–è€… failureCallback çš„å®Œæˆï¼Œè¿™ä¸¤ä¸ªå‡½æ•°ä¹Ÿå¯ä»¥è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œä»è€Œå½¢æˆå¦ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œè¿™æ ·çš„è¯ï¼Œåœ¨ promise2 ä¸Šæ–°å¢çš„å›è°ƒå‡½æ•°ä¼šæ’åœ¨è¿™ä¸ª Promise å¯¹è±¡çš„åé¢ã€‚

&emsp;åŸºæœ¬ä¸Šï¼Œæ¯ä¸€ä¸ª Promise éƒ½ä»£è¡¨äº†é“¾ä¸­å¦ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹çš„å®Œæˆã€‚

&emsp;åœ¨è¿‡å»ï¼Œè¦æƒ³åšå¤šé‡çš„å¼‚æ­¥æ“ä½œï¼Œä¼šå¯¼è‡´ç»å…¸çš„å›è°ƒåœ°ç‹±ï¼š

```javascript
doSomething(function(result) {
  doSomethingElse(result, function(newResult) {
    doThirdThing(newResult, function(finalResult) {
      console.log('Got the final result: ' + finalResult);
    }, failureCallback);
  }, failureCallback);
}, failureCallback);
```

&emsp;ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå›è°ƒç»‘å®šåˆ°è¿”å›çš„ Promise ä¸Šï¼Œå½¢æˆä¸€ä¸ª Promise é“¾ï¼š

```javascript
doSomething().then(function(result) {
  return doSomethingElse(result);
})
.then(function(newResult) {
  return doThirdThing(newResult);
})
.then(function(finalResult) {
  console.log('Got the final result: ' + finalResult);
})
.catch(failureCallback);
```

&emsp;then é‡Œçš„å‚æ•°æ˜¯å¯é€‰çš„ï¼Œcatch(failureCallback) æ˜¯ then(null, failureCallback) çš„ç¼©ç•¥å½¢å¼ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ç®­å¤´å‡½æ•°æ¥è¡¨ç¤ºï¼š

```javascript
doSomething()
.then(result => doSomethingElse(result))
.then(newResult => doThirdThing(newResult))
.then(finalResult => {
  console.log(`Got the final result: ${finalResult}`);
})
.catch(failureCallback);
```

> &emsp;noteï¼šä¸€å®šè¦æœ‰è¿”å›å€¼ï¼Œå¦åˆ™ï¼Œcallback å°†æ— æ³•è·å–ä¸Šä¸€ä¸ª Promise çš„ç»“æœã€‚(å¦‚æœä½¿ç”¨ç®­å¤´å‡½æ•°ï¼Œ() => x æ¯” () => { return x; } æ›´ç®€æ´ä¸€äº›ï¼Œä½†åä¸€ç§ä¿ç•™ return çš„å†™æ³•æ‰æ”¯æŒä½¿ç”¨å¤šä¸ªè¯­å¥ã€‚ï¼‰ã€‚

### Catch çš„åç»­é“¾å¼æ“ä½œ

&emsp;æœ‰å¯èƒ½ä¼šåœ¨ä¸€ä¸ªå›è°ƒå¤±è´¥ä¹‹åç»§ç»­ä½¿ç”¨é“¾å¼æ“ä½œå³ä½¿ç”¨ä¸€ä¸ª catchï¼Œè¿™å¯¹äºåœ¨é“¾å¼æ“ä½œä¸­æŠ›å‡ºä¸€ä¸ªå¤±è´¥ä¹‹åï¼Œå†æ¬¡è¿›è¡Œæ–°çš„æ“ä½œä¼šå¾ˆæœ‰ç”¨ã€‚è¯·é˜…è¯»ä¸‹é¢çš„ä¾‹å­ï¼š

```javascript
new Promise((resolve, reject) => {
    console.log('åˆå§‹åŒ–');

    resolve();
})
.then(() => {
    throw new Error('æœ‰å“ªé‡Œä¸å¯¹äº†');

    console.log('æ‰§è¡Œã€Œè¿™ä¸ªã€');
})
.catch(() => {
    console.log('æ‰§è¡Œã€Œé‚£ä¸ªã€');
})
.then(() => {
    console.log('æ‰§è¡Œã€Œè¿™ä¸ªã€ï¼Œæ— è®ºå‰é¢å‘ç”Ÿäº†ä»€ä¹ˆ');
});
```

&emsp;è¾“å‡ºï¼š

```javascript
åˆå§‹åŒ–
æ‰§è¡Œã€Œé‚£ä¸ªã€
æ‰§è¡Œã€Œè¿™ä¸ªã€ï¼Œæ— è®ºå‰é¢å‘ç”Ÿäº†ä»€ä¹ˆ
```

> &emsp;noteï¼šå› ä¸ºæŠ›å‡ºäº†é”™è¯¯ æœ‰ 'å“ªé‡Œä¸å¯¹äº†'ï¼Œæ‰€ä»¥å‰ä¸€ä¸ª 'æ‰§è¡Œã€Œè¿™ä¸ªã€' æ²¡æœ‰è¢«è¾“å‡ºã€‚

### é”™è¯¯ä¼ é€’

&emsp;åœ¨ä¹‹å‰çš„å›è°ƒåœ°ç‹±ç¤ºä¾‹ä¸­ï¼Œä½ å¯èƒ½è®°å¾—æœ‰ 3 æ¬¡ failureCallback çš„è°ƒç”¨ï¼Œè€Œåœ¨ Promise é“¾ä¸­åªæœ‰å°¾éƒ¨çš„ä¸€æ¬¡è°ƒç”¨ã€‚

```javascript
doSomething()
.then(result => doSomethingElse(result))
.then(newResult => doThirdThing(newResult))
.then(finalResult => console.log(`Got the final result: ${finalResult}`))
.catch(failureCallback);
```

&emsp;é€šå¸¸ï¼Œä¸€é‡åˆ°å¼‚å¸¸æŠ›å‡ºï¼Œæµè§ˆå™¨å°±ä¼šé¡ºç€ Promise é“¾å¯»æ‰¾ä¸‹ä¸€ä¸ª onRejected å¤±è´¥å›è°ƒå‡½æ•°æˆ–è€…ç”± .catch() æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚è¿™å’Œä»¥ä¸‹åŒæ­¥ä»£ç çš„å·¥ä½œåŸç†ï¼ˆæ‰§è¡Œè¿‡ç¨‹ï¼‰éå¸¸ç›¸ä¼¼ã€‚

```javascript
try {
  let result = syncDoSomething();
  let newResult = syncDoSomethingElse(result);
  let finalResult = syncDoThirdThing(newResult);
  console.log(`Got the final result: ${finalResult}`);
} catch(error) {
  failureCallback(error);
}
```

&emsp;åœ¨ ECMAScript 2017 æ ‡å‡†çš„ async/await è¯­æ³•ç³–ä¸­ï¼Œè¿™ç§å¼‚æ­¥ä»£ç çš„å¯¹ç§°æ€§å¾—åˆ°äº†æè‡´çš„ä½“ç°ï¼š

```javascript
async function foo() {
  try {
    const result = await doSomething();
    const newResult = await doSomethingElse(result);
    const finalResult = await doThirdThing(newResult);
    console.log(`Got the final result: ${finalResult}`);
  } catch(error) {
    failureCallback(error);
  }
}
```

&emsp;è¿™ä¸ªä¾‹å­æ˜¯åœ¨ Promise çš„åŸºç¡€ä¸Šæ„å»ºçš„ï¼Œä¾‹å¦‚ï¼šdoSomething() ä¸ä¹‹å‰çš„å‡½æ•°æ˜¯ç›¸åŒçš„ã€‚

&emsp;é€šè¿‡æ•è·æ‰€æœ‰çš„é”™è¯¯ï¼Œç”šè‡³æŠ›å‡ºå¼‚å¸¸å’Œç¨‹åºé”™è¯¯ï¼ŒPromise è§£å†³äº†å›è°ƒåœ°ç‹±çš„åŸºæœ¬ç¼ºé™·ã€‚è¿™å¯¹äºæ„å»ºå¼‚æ­¥æ“ä½œçš„åŸºç¡€åŠŸèƒ½è€Œè¨€æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚

### Promise æ‹’ç»äº‹ä»¶

&emsp;å½“ Promise è¢«æ‹’ç»æ—¶ï¼Œä¼šæœ‰ä¸‹æ–‡æ‰€è¿°çš„ä¸¤ä¸ªäº‹ä»¶ä¹‹ä¸€è¢«æ´¾å‘åˆ°å…¨å±€ä½œç”¨åŸŸï¼ˆé€šå¸¸è€Œè¨€ï¼Œå°±æ˜¯ windowï¼›å¦‚æœæ˜¯åœ¨ web worker ä¸­ä½¿ç”¨çš„è¯ï¼Œå°±æ˜¯ Worker æˆ–è€…å…¶ä»– worker-based æ¥å£ï¼‰ã€‚è¿™ä¸¤ä¸ªäº‹ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š

+ `rejectionhandled`
  å½“ Promise è¢«æ‹’ç»ã€å¹¶ä¸”åœ¨ reject å‡½æ•°å¤„ç†è¯¥ rejection ä¹‹åä¼šæ´¾å‘æ­¤äº‹ä»¶ã€‚

&emsp;å½“ Promise è¢« rejected ä¸”æœ‰ rejection å¤„ç†å™¨æ—¶ä¼šåœ¨å…¨å±€è§¦å‘ rejectionhandled äº‹ä»¶ (é€šå¸¸æ˜¯å‘ç”Ÿåœ¨ window ä¸‹ï¼Œä½†æ˜¯ä¹Ÿå¯èƒ½å‘ç”Ÿåœ¨ Worker ä¸­)ã€‚åº”ç”¨äºè°ƒè¯•ä¸€èˆ¬åº”ç”¨å›é€€ã€‚å½“ Promise è¢« rejected ä¸”æ²¡æœ‰ rejection å¤„ç†å™¨å¤„ç†æ—¶ä¼šè§¦å‘ unhandledrejection äº‹ä»¶ã€‚è¿™ä¸¤ä¸ªäº‹ä»¶ååŒå·¥ä½œã€‚

&emsp;å¦‚ä¸‹ç¤ºä¾‹ä»£ç å¯ä»¥ä½¿ç”¨ rejectionhandled äº‹ä»¶åœ¨æ§åˆ¶å°æ‰“å°å‡ºè¢« rejected çš„ Promiseï¼Œä»¥åŠè¢« rejected çš„åŸå› ï¼š

```javascript
window.addEventListener("rejectionhandled", event => {
  console.log("Promise rejected; reason: " + event.reason);
}, false);
```

+ `unhandledrejection`
  å½“ Promise è¢«æ‹’ç»ï¼Œä½†æ²¡æœ‰æä¾› reject å‡½æ•°æ¥å¤„ç†è¯¥ rejection æ—¶ï¼Œä¼šæ´¾å‘æ­¤äº‹ä»¶ã€‚
  
&emsp;å½“ Promise è¢« reject ä¸”æ²¡æœ‰ reject å¤„ç†å™¨çš„æ—¶å€™ï¼Œä¼šè§¦å‘ unhandledrejection äº‹ä»¶ï¼ˆé€šå¸¸æ˜¯å‘ç”Ÿåœ¨ window ä¸‹ï¼Œä½†æ˜¯ä¹Ÿå¯èƒ½å‘ç”Ÿåœ¨ Worker ä¸­ï¼‰ã€‚è¿™å¯¹äºè°ƒè¯•å›é€€é”™è¯¯å¤„ç†éå¸¸æœ‰ç”¨ã€‚

&emsp;unhandledrejection ç»§æ‰¿è‡ª PromiseRejectionEventï¼Œè€Œ PromiseRejectionEvent åˆç»§æ‰¿è‡ª Eventã€‚å› æ­¤ unhandledrejection å«æœ‰ PromiseRejectionEvent å’Œ Event çš„å±æ€§å’Œæ–¹æ³•ã€‚

&emsp;ä¸‹é¢é€šè¿‡å‡ ä¸ªä¾‹å­æ¥å±•ç¤º unhandledrejection äº‹ä»¶çš„ä½¿ç”¨æ–¹å¼ã€‚è¯¥äº‹ä»¶ä¸»è¦åŒ…å«ä¸¤éƒ¨åˆ†æœ‰ç”¨çš„ä¿¡æ¯ï¼š

+ `promise`
  ç‰¹å®šçš„ Promise è¢« reject è€Œæ²¡æœ‰è¢«ç›¸åº”çš„å¼‚å¸¸å¤„ç†æ–¹æ³•æ‰€å¤„ç†æ—¶
  
+ `reason`
  å°†ä¼šä¼ å…¥å¼‚å¸¸å¤„ç†æ–¹æ³•ä¸­çš„é”™è¯¯åŸå› ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼ŒæŸ¥çœ‹ [catch()](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch) ç›¸å…³ä»¥è·å–æ›´å¤šç»†èŠ‚ã€‚

#### åŸºæœ¬çš„å¼‚å¸¸ä¸ŠæŠ¥

&emsp;æ­¤ç¤ºä¾‹åªæ˜¯å°†æœ‰å…³æœªå¤„ç†çš„ Promise rejection ä¿¡æ¯æ‰“å°åˆ°æ§åˆ¶å°ã€‚

```javascript
window.addEventListener("unhandledrejection", event => {
  console.warn(`UNHANDLED PROMISE REJECTION: ${event.reason}`);
});
```

&emsp;è¿˜å¯ä»¥ä½¿ç”¨ onunhandledrejection äº‹ä»¶å¤„ç†ç¨‹åºå±æ€§æ¥è®¾ç½®äº‹ä»¶ä¾¦å¬å™¨ï¼š

```javascript
window.onunhandledrejection = event => {
  console.warn(`UNHANDLED PROMISE REJECTION: ${event.reason}`);
};
```

#### é˜²æ­¢é»˜è®¤å¤„ç†

&emsp;è®¸å¤šç¯å¢ƒ (ä¾‹å¦‚ Node.js ) é»˜è®¤æƒ…å†µä¸‹ä¼šå‘æ§åˆ¶å°æ‰“å°æœªå¤„ç†çš„ Promise rejectionsã€‚ä½ å¯ä»¥é€šè¿‡æ·»åŠ ä¸€ä¸ªå¤„ç†ç¨‹åºæ¥é˜²æ­¢ unhandledrejection è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œè¯¥å¤„ç†ç¨‹åºé™¤äº†ä½ å¸Œæœ›æ‰§è¡Œçš„ä»»ä½•å…¶ä»–ä»»åŠ¡ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è°ƒç”¨ preventDefault() æ¥å–æ¶ˆè¯¥äº‹ä»¶ï¼Œä»è€Œé˜²æ­¢è¯¥äº‹ä»¶å†’æ³¡å¹¶ç”±è¿è¡Œæ—¶çš„æ—¥å¿—ä»£ç å¤„ç†ã€‚è¿™ç§æ–¹æ³•ä¹‹æ‰€ä»¥æœ‰æ•ˆï¼Œæ˜¯å› ä¸º unhandledrejection æ˜¯å¯ä»¥å–æ¶ˆçš„ã€‚

```javascript
window.addEventListener('unhandledrejection', function (event) {
  // ...ä½ çš„ä»£ç å¯ä»¥å¤„ç†æœªå¤„ç†çš„æ‹’ç»...

  // é˜²æ­¢é»˜è®¤å¤„ç†ï¼ˆä¾‹å¦‚å°†é”™è¯¯è¾“å‡ºåˆ°æ§åˆ¶å°ï¼‰

  event.preventDefault();
});
```

### preventDefault

&emsp;Event æ¥å£çš„ preventDefault() æ–¹æ³•ï¼Œå‘Šè¯‰ user agentï¼šå¦‚æœæ­¤äº‹ä»¶æ²¡æœ‰è¢«æ˜¾å¼å¤„ç†ï¼Œå®ƒé»˜è®¤çš„åŠ¨ä½œä¹Ÿä¸åº”è¯¥ç…§å¸¸æ‰§è¡Œã€‚æ­¤äº‹ä»¶è¿˜æ˜¯ç»§ç»­ä¼ æ’­ï¼Œé™¤éç¢°åˆ°äº‹ä»¶ä¾¦å¬å™¨è°ƒç”¨ stopPropagation() æˆ– stopImmediatePropagation()ï¼Œæ‰åœæ­¢ä¼ æ’­ã€‚

#### é˜»æ­¢é»˜è®¤çš„ç‚¹å‡»äº‹ä»¶æ‰§è¡Œ

&emsp;é€‰ä¸­å¤é€‰æ¡†æ˜¯ç‚¹å‡»å¤é€‰æ¡†çš„é»˜è®¤è¡Œä¸ºã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­è¯´æ˜äº†æ€æ ·é˜»æ­¢é»˜è®¤è¡Œä¸ºçš„å‘ç”Ÿï¼š

```javascript
document.querySelector("#id-checkbox").addEventListener("click", function(event) {
         document.getElementById("output-box").innerHTML += "Sorry! <code>preventDefault()</code> won't let you check this!<br>";
         event.preventDefault();
}, false);
```

#### åœ¨ç¼–è¾‘åŸŸä¸­é˜»æ­¢æŒ‰é”®

&emsp;ä¸‹é¢çš„è¿™ä¸ªä¾‹å­è¯´æ˜äº†å¦‚ä½•ä½¿ç”¨ preventDefault() åœ¨æ–‡æœ¬ç¼–è¾‘åŸŸä¸­é˜»æ­¢æœ‰æ•ˆçš„æ–‡æœ¬è¾“å…¥ã€‚

&emsp;HTML:

```javascript
<div class="container">
  <p>Please enter your name using lowercase letters only.</p>

  <form>
    <input type="text" id="my-textbox">
  </form>
</div>
```

&emsp;CSS:

&emsp;å½“ç”¨æˆ·æŒ‰ä¸‹ä¸€ä¸ªæœ‰æ•ˆæŒ‰é”®çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±ç»™è¿™ä¸ª warning box åŠ ä¸Šä¸€äº›æ ·å¼ï¼š

```javascript
.warning {
  border: 2px solid #f39389;
  border-radius: 2px;
  padding: 10px;
  position: absolute;
  background-color: #fbd8d4;
  color: #3b3c40;
}
```

&emsp;JavaScript:

&emsp;è¿™é‡Œæ˜¯ç›¸å…³çš„ JavaScript ä»£ç ã€‚é¦–å…ˆï¼Œç›‘å¬ keypress äº‹ä»¶ï¼š

```javascript
var myTextbox = document.getElementById('my-textbox');
myTextbox.addEventListener('keypress', checkName, false);
```

&emsp;checkName() æ–¹æ³•å¯ä»¥ç›‘å¬æŒ‰é”®å¹¶ä¸”å†³å®šæ˜¯å¦å…è®¸æŒ‰é”®çš„é»˜è®¤è¡Œä¸ºå‘ç”Ÿã€‚

```javascript
function checkName(evt) {
  var charCode = evt.charCode;
  if (charCode != 0) {
    if (charCode < 97 || charCode > 122) {
      evt.preventDefault();
      displayWarning(
        "Please use lowercase letters only."
        + "\n" + "charCode: " + charCode + "\n"
      );
    }
  }
}
```

&emsp;displayWarning() æ–¹æ³•æ˜¾ç¤ºäº†ä¸€ä¸ªé—®é¢˜çš„é€šçŸ¥ã€‚è¿™ä¸æ˜¯ä¸€ç§ä¼˜é›…çš„æ–¹æ³•ï¼Œä½†æ˜¯ç¡®å®å¯ä»¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ã€‚

```javascript
var warningTimeout;
var warningBox = document.createElement("div");
warningBox.className = "warning";

function displayWarning(msg) {
  warningBox.innerHTML = msg;

  if (document.body.contains(warningBox)) {
    window.clearTimeout(warningTimeout);
  } else {
    // insert warningBox after myTextbox
    myTextbox.parentNode.insertBefore(warningBox, myTextbox.nextSibling);
  }

  warningTimeout = window.setTimeout(function() {
      warningBox.parentNode.removeChild(warningBox);
      warningTimeout = -1;
    }, 2000);
}
```

&emsp;åœ¨äº‹ä»¶æµçš„ä»»ä½•é˜¶æ®µè°ƒç”¨ preventDefault() éƒ½ä¼šå–æ¶ˆäº‹ä»¶ï¼Œè¿™æ„å‘³ç€ä»»ä½•é€šå¸¸è¢«è¯¥å®ç°è§¦å‘å¹¶ä½œä¸ºç»“æœçš„é»˜è®¤è¡Œä¸ºéƒ½ä¸ä¼šå‘ç”Ÿã€‚

&emsp;ä½ å¯ä»¥ä½¿ç”¨ Event.cancelable æ¥æ£€æŸ¥è¯¥äº‹ä»¶æ˜¯å¦æ”¯æŒå–æ¶ˆã€‚ä¸ºä¸€ä¸ªä¸æ”¯æŒ cancelable çš„äº‹ä»¶è°ƒç”¨ preventDefault() å°†æ²¡æœ‰æ•ˆæœã€‚

### catch

&emsp;catch() æ–¹æ³•è¿”å›ä¸€ä¸ª Promiseï¼Œå¹¶ä¸”å¤„ç†æ‹’ç»çš„æƒ…å†µã€‚å®ƒçš„è¡Œä¸ºä¸è°ƒç”¨ Promise.prototype.then(undefined, onRejected) ç›¸åŒã€‚(äº‹å®ä¸Šï¼Œcalling obj.catch(onRejected) å†…éƒ¨ calls obj.then(undefined, onRejected))

```javascript
p.catch(onRejected);

p.catch(function(reason) {
   // æ‹’ç»
});
```

&emsp;å‚æ•° onRejectedï¼šå½“ Promise è¢« rejected æ—¶ï¼Œè¢«è°ƒç”¨çš„ä¸€ä¸ª Functionã€‚è¯¥å‡½æ•°æ‹¥æœ‰ä¸€ä¸ªå‚æ•° reasonï¼šrejection çš„åŸå› ã€‚å¦‚æœ onRejected æŠ›å‡ºä¸€ä¸ªé”™è¯¯æˆ–è¿”å›ä¸€ä¸ªæœ¬èº«å¤±è´¥çš„ Promiseï¼Œé€šè¿‡ catch() è¿”å›çš„ Promise è¢« rejectedï¼›å¦åˆ™ï¼Œå®ƒå°†æ˜¾ç¤ºä¸ºæˆåŠŸï¼ˆresolvedï¼‰ã€‚

&emsp;catch æ–¹æ³•å¯ä»¥ç”¨äºä½ çš„ promise ç»„åˆä¸­çš„é”™è¯¯å¤„ç†ã€‚

&emsp;ä¸‹é¢æˆ‘ä»¬ç»§ç»­å›åˆ°ï¼šrejectionhandled å’Œ unhandledrejection ä¸¤ç§æƒ…å†µï¼ŒPromiseRejectionEvent äº‹ä»¶éƒ½æœ‰ä¸¤ä¸ªå±æ€§ï¼Œä¸€ä¸ªæ˜¯ promise å±æ€§ï¼Œè¯¥å±æ€§æŒ‡å‘è¢«é©³å›çš„ Promiseï¼Œå¦ä¸€ä¸ªæ˜¯ reason å±æ€§ï¼Œè¯¥å±æ€§ç”¨æ¥è¯´æ˜ Promise è¢«é©³å›çš„åŸå› ã€‚

&emsp;å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸Šäº‹ä»¶ä¸º Promise å¤±è´¥æ—¶æä¾›è¡¥å¿å¤„ç†ï¼Œä¹Ÿæœ‰åˆ©äºè°ƒè¯• Promise ç›¸å…³çš„é—®é¢˜ã€‚åœ¨æ¯ä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œè¯¥å¤„ç†éƒ½æ˜¯å…¨å±€çš„ï¼Œå› æ­¤ä¸ç®¡æºç å¦‚ä½•ï¼Œæ‰€æœ‰çš„é”™è¯¯éƒ½ä¼šåœ¨åŒä¸€ä¸ªå¤„ç†å‡½æ•°ä¸­è¢«æ•æ‰å¹¶å¤„ç†ã€‚

&emsp;ä¸€ä¸ªç‰¹åˆ«æœ‰ç”¨çš„ä¾‹å­ï¼šå½“ä½ ä½¿ç”¨ Node.js æ—¶ï¼Œæœ‰äº›ä¾èµ–æ¨¡å—å¯èƒ½ä¼šæœ‰æœªè¢«å¤„ç†çš„ rejected promisesï¼Œè¿™äº›éƒ½ä¼šåœ¨è¿è¡Œæ—¶æ‰“å°åˆ°æ§åˆ¶å°ã€‚ä½ å¯ä»¥åœ¨è‡ªå·±çš„ä»£ç ä¸­æ•æ‰è¿™äº›ä¿¡æ¯ï¼Œç„¶åæ·»åŠ ä¸ unhandledrejection ç›¸åº”çš„å¤„ç†å‡½æ•°æ¥åšåˆ†æå’Œå¤„ç†ï¼Œæˆ–åªæ˜¯ä¸ºäº†è®©ä½ çš„è¾“å‡ºæ›´æ•´æ´ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š

```javascript
window.addEventListener("unhandledrejection", event => {
  /* ä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€äº›ä»£ç ï¼Œä»¥ä¾¿æ£€æŸ¥ event.promise ä¸­çš„ promise å’Œ event.reason ä¸­çš„ rejection åŸå›  */

  event.preventDefault();
}, false);
```

&emsp;è°ƒç”¨ event çš„ preventDefault() æ–¹æ³•æ˜¯ä¸ºäº†å‘Šè¯‰ JavaScript å¼•æ“å½“ Promise è¢«æ‹’ç»æ—¶ä¸è¦æ‰§è¡Œé»˜è®¤æ“ä½œï¼Œé»˜è®¤æ“ä½œä¸€èˆ¬ä¼šåŒ…å«æŠŠé”™è¯¯æ‰“å°åˆ°æ§åˆ¶å°ï¼ŒNode å°±æ˜¯å¦‚æ­¤çš„ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œåœ¨å¿½ç•¥è¿™äº›äº‹ä»¶ä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥æ£€æŸ¥æ‰€æœ‰è¢«æ‹’ç»çš„ Promiseï¼Œæ¥ç¡®è®¤è¿™ä¸æ˜¯ä»£ç ä¸­çš„ bugã€‚

### åœ¨æ—§å¼å›è°ƒ API ä¸­åˆ›å»º Promise

&emsp;å¯ä»¥é€šè¿‡ Promise çš„æ„é€ å™¨ä»é›¶å¼€å§‹åˆ›å»º Promiseã€‚è¿™ç§æ–¹å¼ï¼ˆé€šè¿‡æ„é€ å™¨çš„æ–¹å¼ï¼‰åº”å½“åªåœ¨å°è£…æ—§ API çš„æ—¶å€™ç”¨åˆ°ã€‚

&emsp;ç†æƒ³çŠ¶æ€ä¸‹ï¼Œæ‰€æœ‰çš„å¼‚æ­¥å‡½æ•°éƒ½å·²ç»è¿”å› Promise äº†ã€‚ä½†æœ‰ä¸€äº› API ä»ç„¶ä½¿ç”¨æ—§æ–¹å¼æ¥ä¼ å…¥çš„æˆåŠŸï¼ˆæˆ–è€…å¤±è´¥ï¼‰çš„å›è°ƒã€‚å…¸å‹çš„ä¾‹å­å°±æ˜¯ setTimeout() å‡½æ•°ï¼š

```javascript
setTimeout(() => saySomething("10 seconds passed"), 10000);
```

&emsp;æ··ç”¨æ—§å¼å›è°ƒå’Œ Promise å¯èƒ½ä¼šé€ æˆè¿è¡Œæ—¶åºé—®é¢˜ã€‚å¦‚æœ saySomething å‡½æ•°å¤±è´¥äº†ï¼Œæˆ–è€…åŒ…å«äº†ç¼–ç¨‹é”™è¯¯ï¼Œé‚£å°±æ²¡æœ‰åŠæ³•æ•è·å®ƒäº†ã€‚è¿™å¾—æ€ª setTimeoutã€‚

&emsp;å¹¸è¿åœ°æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ Promise æ¥å°è£…å®ƒã€‚æœ€å¥½çš„åšæ³•æ˜¯ï¼Œå°†è¿™äº›æœ‰é—®é¢˜çš„å‡½æ•°å°è£…èµ·æ¥ï¼Œç•™åœ¨åº•å±‚ï¼Œå¹¶ä¸”æ°¸è¿œä¸è¦å†ç›´æ¥è°ƒç”¨å®ƒä»¬ï¼š

```javascript
const wait = ms => new Promise(resolve => setTimeout(resolve, ms));

wait(10000).then(() => saySomething("10 seconds")).catch(failureCallback);
```

&emsp;é€šå¸¸ï¼ŒPromise çš„æ„é€ å™¨æ¥æ”¶ä¸€ä¸ªæ‰§è¡Œå‡½æ•° (executor)ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªæ‰§è¡Œå‡½æ•°é‡Œæ‰‹åŠ¨åœ° resolve å’Œ reject ä¸€ä¸ª Promiseã€‚æ—¢ç„¶ setTimeout å¹¶ä¸ä¼šçœŸçš„æ‰§è¡Œå¤±è´¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨è¿™ç§æƒ…å†µä¸‹å¿½ç•¥ rejectã€‚

### ç»„åˆ

&emsp;Promise.resolve() å’Œ Promise.reject() æ˜¯æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªå·²ç» resolve æˆ–è€… reject çš„ Promise å¿«æ·æ–¹æ³•ã€‚å®ƒä»¬æœ‰æ—¶å¾ˆæœ‰ç”¨ã€‚

&emsp;Promise.all() å’Œ Promise.race() æ˜¯å¹¶è¡Œè¿è¡Œå¼‚æ­¥æ“ä½œçš„ä¸¤ä¸ªç»„åˆå¼å·¥å…·ã€‚

&emsp;æˆ‘ä»¬å¯ä»¥å‘èµ·å¹¶è¡Œæ“ä½œï¼Œç„¶åç­‰å¤šä¸ªæ“ä½œå…¨éƒ¨ç»“æŸåè¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼Œå¦‚ä¸‹ï¼š

```javascript
Promise.all([func1(), func2(), func3()]).then(([result1, result2, result3]) => { /* use result1, result2 and result3 */ });
```

&emsp;å¯ä»¥ä½¿ç”¨ä¸€äº›èªæ˜çš„ JavaScript å†™æ³•å®ç°æ—¶åºç»„åˆï¼š

```javascript
[func1, func2, func3].reduce((p, f) => p.then(f), Promise.resolve()).then(result3 => { /* use result3 */ });
```

&emsp;é€šå¸¸ï¼Œæˆ‘ä»¬é€’å½’è°ƒç”¨ä¸€ä¸ªç”±å¼‚æ­¥å‡½æ•°ç»„æˆçš„æ•°ç»„æ—¶ï¼Œç›¸å½“äºä¸€ä¸ª Promise é“¾ï¼š

```javascript
Promise.resolve().then(func1).then(func2).then(func3);
```

&emsp;æˆ‘ä»¬ä¹Ÿå¯ä»¥å†™æˆå¯å¤ç”¨çš„å‡½æ•°å½¢å¼ï¼Œè¿™åœ¨å‡½æ•°å¼ç¼–ç¨‹ä¸­æä¸ºæ™®éï¼š

```javascript
const applyAsync = (acc,val) => acc.then(val);
const composeAsync = (...funcs) => x => funcs.reduce(applyAsync, Promise.resolve(x));
```

&emsp;composeAsync() å‡½æ•°å°†ä¼šæ¥å—ä»»æ„æ•°é‡çš„å‡½æ•°ä½œä¸ºå…¶å‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥å—ä¸€ä¸ªé€šè¿‡ composition pipeline ä¼ å…¥çš„åˆå§‹å€¼ã€‚è¿™å¯¹æˆ‘ä»¬æ¥è¯´éå¸¸æœ‰ç›Šï¼Œå› ä¸ºä»»ä¸€å‡½æ•°å¯ä»¥æ˜¯å¼‚æ­¥æˆ–åŒæ­¥çš„ï¼Œå®ƒä»¬èƒ½è¢«ä¿è¯æŒ‰é¡ºåºæ‰§è¡Œï¼š

```javascript
const transformData = composeAsync(func1, func2, func3);
const result3 = transformData(data);
```

&emsp;åœ¨ ECMAScript 2017 æ ‡å‡†ä¸­ï¼Œæ—¶åºç»„åˆå¯ä»¥é€šè¿‡ä½¿ç”¨ async/await è€Œå˜å¾—æ›´ç®€å•ï¼š

```javascript
let result;
for (const f of [func1, func2, func3]) {
  result = await f(result);
}

/* use last result (i.e. result3) */
```

### æ—¶åº

&emsp;ä¸ºäº†é¿å…æ„å¤–ï¼Œå³ä½¿æ˜¯ä¸€ä¸ªå·²ç»å˜æˆ resolve çŠ¶æ€çš„ Promiseï¼Œä¼ é€’ç»™ then() çš„å‡½æ•°ä¹Ÿæ€»æ˜¯ä¼šè¢«å¼‚æ­¥è°ƒç”¨ï¼š

```javascript
Promise.resolve().then(() => console.log(2));
console.log(1); // 1, 2
```

&emsp;ä¼ é€’åˆ° then() ä¸­çš„å‡½æ•°è¢«ç½®å…¥åˆ°ä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè€Œä¸æ˜¯ç«‹å³æ‰§è¡Œï¼Œè¿™æ„å‘³ç€å®ƒæ˜¯åœ¨ JavaScript äº‹ä»¶é˜Ÿåˆ—çš„æ‰€æœ‰è¿è¡Œæ—¶ç»“æŸäº†ï¼Œä¸”äº‹ä»¶é˜Ÿåˆ—è¢«æ¸…ç©ºä¹‹åï¼Œæ‰å¼€å§‹æ‰§è¡Œï¼š

```javascript
const wait = ms => new Promise(resolve => setTimeout(resolve, ms));

wait().then(() => console.log(4));
Promise.resolve().then(() => console.log(2)).then(() => console.log(3));
console.log(1); // 1, 2, 3, 4
```

### åµŒå¥—

&emsp;ç®€ä¾¿çš„ Promise é“¾å¼ç¼–ç¨‹æœ€å¥½ä¿æŒæ‰å¹³åŒ–ï¼Œä¸è¦åµŒå¥— Promiseï¼Œå› ä¸ºåµŒå¥—ç»å¸¸ä¼šæ˜¯ç²—å¿ƒå¯¼è‡´çš„ã€‚

&emsp;åµŒå¥— Promise æ˜¯ä¸€ç§å¯ä»¥é™åˆ¶ catch è¯­å¥çš„ä½œç”¨åŸŸçš„æ§åˆ¶ç»“æ„å†™æ³•ã€‚æ˜ç¡®æ¥è¯´ï¼ŒåµŒå¥—çš„ catch ä»…æ•æ‰åœ¨å…¶ä¹‹å‰åŒæ—¶è¿˜å¿…é¡»æ˜¯å…¶ä½œç”¨åŸŸçš„ failureresï¼Œè€Œæ•æ‰ä¸åˆ°åœ¨å…¶é“¾å¼ä»¥å¤–æˆ–è€…å…¶åµŒå¥—åŸŸä»¥å¤–çš„ errorã€‚å¦‚æœä½¿ç”¨æ­£ç¡®ï¼Œé‚£ä¹ˆå¯ä»¥å®ç°é«˜ç²¾åº¦çš„é”™è¯¯ä¿®å¤ã€‚

```javascript
doSomethingCritical()
.then(result => doSomethingOptional()
  .then(optionalResult => doSomethingExtraNice(optionalResult))
  .catch(e => {console.log(e.message)})) // å³ä½¿æœ‰å¼‚å¸¸ä¹Ÿä¼šå¿½ç•¥ï¼Œç»§ç»­è¿è¡Œ;(æœ€åä¼šè¾“å‡º)
.then(() => moreCriticalStuff())
.catch(e => console.log("Critical failure: " + e.message));// æ²¡æœ‰è¾“å‡º
```

&emsp;æ³¨æ„ï¼Œæœ‰äº›ä»£ç æ­¥éª¤æ˜¯åµŒå¥—çš„ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç®€å•çš„çº¯é“¾å¼ï¼Œè¿™äº›è¯­å¥å‰ä¸åéƒ½è¢«æ‹¬å· () åŒ…è£¹ç€ã€‚

&emsp;è¿™ä¸ªå†…éƒ¨çš„ catch è¯­å¥ä»…èƒ½æ•è·åˆ° doSomethingOptional() å’Œ doSomethingExtraNice() çš„å¤±è´¥ï¼Œä¹‹åå°±æ¢å¤åˆ° moreCriticalStuff() çš„è¿è¡Œã€‚é‡è¦æé†’ï¼šå¦‚æœ doSomethingCritical() å¤±è´¥ï¼Œè¿™ä¸ªé”™è¯¯ä»…ä¼šè¢«æœ€åçš„ï¼ˆå¤–éƒ¨ï¼‰catch è¯­å¥æ•è·åˆ°ã€‚

### å¸¸è§é”™è¯¯

&emsp;åœ¨ç¼–å†™ Promise é“¾æ—¶ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹ç¤ºä¾‹ä¸­å±•ç¤ºçš„å‡ ä¸ªé”™è¯¯ï¼š

```javascript
// é”™è¯¯ç¤ºä¾‹ï¼ŒåŒ…å« 3 ä¸ªé—®é¢˜ï¼

doSomething().then(function(result) {
  doSomethingElse(result) // æ²¡æœ‰è¿”å› Promise ä»¥åŠæ²¡æœ‰å¿…è¦çš„åµŒå¥— Promise
  .then(newResult => doThirdThing(newResult));
}).then(() => doFourthThing());
// æœ€åï¼Œæ˜¯æ²¡æœ‰ä½¿ç”¨ catch ç»ˆæ­¢ Promise è°ƒç”¨é“¾ï¼Œå¯èƒ½å¯¼è‡´æ²¡æœ‰æ•è·çš„å¼‚å¸¸
```

&emsp;ç¬¬ä¸€ä¸ªé”™è¯¯æ˜¯æ²¡æœ‰æ­£ç¡®åœ°å°†äº‹ç‰©ç›¸è¿æ¥ã€‚å½“æˆ‘ä»¬åˆ›å»ºæ–° Promise ä½†å¿˜è®°è¿”å›å®ƒæ—¶ï¼Œä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚å› æ­¤ï¼Œé“¾æ¡è¢«æ‰“ç ´ï¼Œæˆ–è€…æ›´ç¡®åˆ‡åœ°è¯´ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªç‹¬ç«‹çš„é“¾æ¡ç«äº‰ï¼ˆåŒæ—¶åœ¨æ‰§è¡Œä¸¤ä¸ªå¼‚æ­¥è€Œéä¸€ä¸ªä¸€ä¸ªçš„æ‰§è¡Œï¼‰ã€‚è¿™æ„å‘³ç€ doFourthThing() ä¸ä¼šç­‰å¾… doSomethingElse() æˆ– doThirdThing() å®Œæˆï¼Œå¹¶ä¸”å°†ä¸å®ƒä»¬å¹¶è¡Œè¿è¡Œï¼Œå¯èƒ½æ˜¯æ— æ„çš„ã€‚å•ç‹¬çš„é“¾ä¹Ÿæœ‰å•ç‹¬çš„é”™è¯¯å¤„ç†ï¼Œå¯¼è‡´æœªæ•è·çš„é”™è¯¯ã€‚

&emsp;ç¬¬äºŒä¸ªé”™è¯¯æ˜¯ä¸å¿…è¦åœ°åµŒå¥—ï¼Œå®ç°ç¬¬ä¸€ä¸ªé”™è¯¯ã€‚åµŒå¥—è¿˜é™åˆ¶äº†å†…éƒ¨é”™è¯¯å¤„ç†ç¨‹åºçš„èŒƒå›´ï¼Œå¦‚æœæ˜¯éé¢„æœŸçš„ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœªæ•è·çš„é”™è¯¯ã€‚å…¶ä¸­ä¸€ä¸ªå˜ä½“æ˜¯ Promise æ„é€ å‡½æ•°åæ¨¡å¼ï¼Œå®ƒç»“åˆäº† Promise æ„é€ å‡½æ•°çš„å¤šä½™ä½¿ç”¨å’ŒåµŒå¥—ã€‚

&emsp;ç¬¬ä¸‰ä¸ªé”™è¯¯æ˜¯å¿˜è®°ç”¨ catch ç»ˆæ­¢é“¾ã€‚è¿™å¯¼è‡´åœ¨å¤§å¤šæ•°æµè§ˆå™¨ä¸­ä¸èƒ½ç»ˆæ­¢çš„ Promise é“¾é‡Œçš„ rejectionã€‚

&emsp;ä¸€ä¸ªå¥½çš„ç»éªŒæ³•åˆ™æ˜¯æ€»æ˜¯è¿”å›æˆ–ç»ˆæ­¢ Promise é“¾ï¼Œå¹¶ä¸”ä¸€æ—¦ä½ å¾—åˆ°ä¸€ä¸ªæ–°çš„ Promiseï¼Œè¿”å›å®ƒã€‚ä¸‹é¢æ˜¯ä¿®æ”¹åçš„å¹³é¢åŒ–çš„ä»£ç ï¼š

```javascript
doSomething()
.then(function(result) {
  return doSomethingElse(result);
})
.then(newResult => doThirdThing(newResult))
.then(() => doFourthThing())
.catch(error => console.log(error));
```

> &emsp;note: () => x æ˜¯ () => { return x; } çš„ç®€å†™ã€‚

&emsp;ä¸Šè¿°ä»£ç çš„å†™æ³•å°±æ˜¯å…·æœ‰é€‚å½“é”™è¯¯å¤„ç†çš„ç®€å•æ˜ç¡®çš„é“¾å¼å†™æ³•ã€‚ä½¿ç”¨ async/await å¯ä»¥è§£å†³ä»¥ä¸Šå¤§å¤šæ•°é”™è¯¯ï¼Œä½¿ç”¨ async/await æ—¶ï¼Œæœ€å¸¸è§çš„è¯­æ³•é”™è¯¯å°±æ˜¯å¿˜è®°äº† await å…³é”®å­—ã€‚

## Promise è§£æ

&emsp;ä¸€ä¸ª Promise å¯¹è±¡ä»£è¡¨ä¸€ä¸ªåœ¨è¿™ä¸ª promise è¢«åˆ›å»ºå‡ºæ¥æ—¶ä¸ä¸€å®šå·²çŸ¥å€¼çš„ä»£ç†ã€‚å®ƒè®©ä½ èƒ½å¤ŸæŠŠå¼‚æ­¥æ“ä½œæœ€ç»ˆçš„æˆåŠŸè¿”å›å€¼æˆ–è€…å¤±è´¥åŸå› å’Œç›¸åº”çš„å¤„ç†ç¨‹åºå…³è”èµ·æ¥ã€‚è¿™æ ·ä½¿å¾—å¼‚æ­¥æ–¹æ³•å¯ä»¥åƒåŒæ­¥æ–¹æ³•é‚£æ ·è¿”å›å€¼ï¼šå¼‚æ­¥æ–¹æ³•å¹¶ä¸ä¼šç«‹å³è¿”å›æœ€ç»ˆçš„å€¼ï¼Œè€Œæ˜¯ä¼šè¿”å›ä¸€ä¸ª promiseï¼Œä»¥ä¾¿åœ¨æœªæ¥æŸä¸ªæ—¶å€™æŠŠå€¼äº¤ç»™ä½¿ç”¨è€…ã€‚

&emsp;ä¸€ä¸ª Promise å¿…ç„¶å¤„äºä»¥ä¸‹å‡ ç§çŠ¶æ€ä¹‹ä¸€ï¼š

+ å¾…å®šï¼ˆpendingï¼‰ï¼šåˆå§‹çŠ¶æ€ï¼Œæ—¢æ²¡æœ‰è¢«å…‘ç°ï¼Œä¹Ÿæ²¡æœ‰è¢«æ‹’ç»ã€‚
+ å·²å…‘ç°ï¼ˆfulfilledï¼‰ï¼šæ„å‘³ç€æ“ä½œæˆåŠŸå®Œæˆã€‚
+ å·²æ‹’ç»ï¼ˆrejectedï¼‰ï¼šæ„å‘³ç€æ“ä½œå¤±è´¥ã€‚

&emsp;å¾…å®šçŠ¶æ€çš„ Promise å¯¹è±¡è¦ä¹ˆä¼šé€šè¿‡ä¸€ä¸ªå€¼è¢«å…‘ç°ï¼Œè¦ä¹ˆä¼šé€šè¿‡ä¸€ä¸ªåŸå› ï¼ˆé”™è¯¯ï¼‰è¢«æ‹’ç»ã€‚å½“è¿™äº›æƒ…å†µä¹‹ä¸€å‘ç”Ÿæ—¶ï¼Œæˆ‘ä»¬ç”¨ promise çš„ then æ–¹æ³•æ’åˆ—èµ·æ¥çš„ç›¸å…³å¤„ç†ç¨‹åºå°±ä¼šè¢«è°ƒç”¨ã€‚å¦‚æœ promise åœ¨ä¸€ä¸ªç›¸åº”çš„å¤„ç†ç¨‹åºè¢«ç»‘å®šæ—¶å°±å·²ç»è¢«å…‘ç°æˆ–è¢«æ‹’ç»äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªå¤„ç†ç¨‹åºä¹ŸåŒæ ·ä¼šè¢«è°ƒç”¨ï¼Œå› æ­¤åœ¨å®Œæˆå¼‚æ­¥æ“ä½œå’Œç»‘å®šå¤„ç†æ–¹æ³•ä¹‹é—´ä¸å­˜åœ¨ç«æ€æ¡ä»¶ã€‚

&emsp;å› ä¸º Promise.prototype.then å’Œ Promise.prototype.catch æ–¹æ³•è¿”å›çš„æ˜¯ promiseï¼Œæ‰€ä»¥å®ƒä»¬å¯ä»¥è¢«é“¾å¼è°ƒç”¨ã€‚

> &emsp;note: æœ‰ä¸€äº›è¯­è¨€ä¸­æœ‰æƒ°æ€§æ±‚å€¼å’Œå»¶è¿Ÿè®¡ç®—çš„ç‰¹æ€§ï¼Œå®ƒä»¬ä¹Ÿè¢«ç§°ä¸º "promise"ï¼Œä¾‹å¦‚ Schemeã€‚JavaScript ä¸­çš„ promise ä»£è¡¨çš„æ˜¯å·²ç»åœ¨å‘ç”Ÿçš„è¿›ç¨‹ï¼Œè€Œä¸”å¯ä»¥é€šè¿‡å›è°ƒå‡½æ•°å®ç°é“¾å¼è°ƒç”¨ã€‚å¦‚æœä½ æƒ³å¯¹ä¸€ä¸ªè¡¨è¾¾å¼è¿›è¡Œæƒ°æ€§æ±‚å€¼ï¼Œå°±è€ƒè™‘ä¸€ä¸‹ä½¿ç”¨æ— å‚æ•°çš„ç®­å¤´å‡½æ•°ï¼Œå¦‚ f = () => expression æ¥åˆ›å»ºæƒ°æ€§æ±‚å€¼çš„è¡¨è¾¾å¼ï¼Œç„¶åä½¿ç”¨ f() è¿›è¡Œæ±‚å€¼ã€‚

> &emsp;note: å¦‚æœä¸€ä¸ª promise å·²ç»è¢«å…‘ç°æˆ–è¢«æ‹’ç»ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥è¯´å®ƒå¤„äº å·²æ•²å®šï¼ˆsettledï¼‰ çŠ¶æ€ã€‚ä½ è¿˜ä¼šå¬åˆ°ä¸€ä¸ªç»å¸¸è·Ÿ promise ä¸€èµ·ä½¿ç”¨çš„æœ¯è¯­ï¼šå·²å†³è®®ï¼ˆresolvedï¼‰ï¼Œå®ƒè¡¨ç¤º promise å·²ç»å¤„äºå·²æ•²å®šçŠ¶æ€ï¼Œæˆ–è€…ä¸ºäº†åŒ¹é…å¦ä¸€ä¸ª promise çš„çŠ¶æ€è¢« "é”å®š" äº†ã€‚

&emsp;æˆ‘ä»¬å¯ä»¥ç”¨ Promise.prototype.then()ã€Promise.prototype.catch() å’Œ Promise.prototype.finally() è¿™äº›æ–¹æ³•å°†è¿›ä¸€æ­¥çš„æ“ä½œä¸ä¸€ä¸ªå˜ä¸ºå·²æ•²å®šçŠ¶æ€çš„ promise å…³è”èµ·æ¥ã€‚

&emsp;ä¾‹å¦‚ .then() æ–¹æ³•éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºå¤„ç†å·²å…‘ç°çŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼Œè€Œç¬¬äºŒä¸ªå‚æ•°åˆ™ä½œä¸ºå¤„ç†å·²æ‹’ç»çŠ¶æ€çš„å›è°ƒå‡½æ•°ã€‚æ¯ä¸€ä¸ª .then() æ–¹æ³•è¿˜ä¼šè¿”å›ä¸€ä¸ªæ–°ç”Ÿæˆçš„ promise å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å¯è¢«ç”¨ä½œé“¾å¼è°ƒç”¨ã€‚

&emsp;å½“ .then() ä¸­ç¼ºå°‘èƒ½å¤Ÿè¿”å› promise å¯¹è±¡çš„å‡½æ•°æ—¶ï¼Œé“¾å¼è°ƒç”¨å°±ç›´æ¥ç»§ç»­è¿›è¡Œä¸‹ä¸€ç¯æ“ä½œã€‚å› æ­¤ï¼Œé“¾å¼è°ƒç”¨å¯ä»¥åœ¨æœ€åä¸€ä¸ª .catch() ä¹‹å‰æŠŠæ‰€æœ‰çš„å¤„ç†å·²æ‹’ç»çŠ¶æ€çš„å›è°ƒå‡½æ•°éƒ½çœç•¥æ‰ã€‚

&emsp;è¿‡æ—©åœ°å¤„ç†å˜ä¸ºå·²æ‹’ç»çŠ¶æ€çš„ promise ä¼šå¯¹ä¹‹å promise çš„é“¾å¼è°ƒç”¨é€ æˆå½±å“ã€‚ä¸è¿‡æœ‰æ—¶å€™æˆ‘ä»¬å› ä¸ºéœ€è¦é©¬ä¸Šå¤„ç†ä¸€ä¸ªé”™è¯¯ä¹Ÿåªèƒ½è¿™æ ·åšã€‚ä¾‹å¦‚ï¼Œå¤–é¢å¿…é¡»æŠ›å‡ºæŸç§ç±»å‹çš„é”™è¯¯ä»¥åœ¨é“¾å¼è°ƒç”¨ä¸­ä¼ é€’é”™è¯¯çŠ¶æ€ã€‚å¦ä¸€æ–¹é¢ï¼Œåœ¨æ²¡æœ‰è¿«åˆ‡éœ€è¦çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥åœ¨æœ€åä¸€ä¸ª .catch() è¯­å¥æ—¶å†è¿›è¡Œé”™è¯¯å¤„ç†ï¼Œè¿™ç§åšæ³•æ›´åŠ ç®€å•ã€‚.catch() å…¶å®åªæ˜¯æ²¡æœ‰ç»™å¤„ç†å·²å…‘ç°çŠ¶æ€çš„å›è°ƒå‡½æ•°é¢„ç•™å‚æ•°ä½ç½®çš„ .then() è€Œå·²ã€‚

&emsp;æœ¬è´¨ä¸Šï¼ŒPromise æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»£è¡¨æ“ä½œçš„ä¸­é—´çŠ¶æ€ â€”â€” æ­£å¦‚å®ƒçš„å•è¯å«ä¹‰ 'æ‰¿è¯º'ï¼Œå®ƒä¿è¯åœ¨æœªæ¥å¯èƒ½è¿”å›æŸç§ç»“æœã€‚è™½ç„¶ Promise å¹¶ä¸ä¿è¯æ“ä½œåœ¨ä½•æ—¶å®Œæˆå¹¶è¿”å›ç»“æœï¼Œä½†æ˜¯å®ƒä¿è¯å½“ç»“æœå¯ç”¨æ—¶ï¼Œä½ çš„ä»£ç èƒ½æ­£ç¡®å¤„ç†ç»“æœï¼Œå½“ç»“æœä¸å¯ç”¨æ—¶ï¼Œä½ çš„ä»£ç åŒæ ·ä¼šè¢«æ‰§è¡Œï¼Œæ¥ä¼˜é›…çš„å¤„ç†é”™è¯¯ã€‚

## å‚è€ƒé“¾æ¥
**å‚è€ƒé“¾æ¥:ğŸ”—**
+ [JavaScript å‚è€ƒ](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference)
+ [JavaScript æŒ‡å—](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide)
+ [JavaScript Related Topics](https://developer.mozilla.org/zh-CN/docs/Learn/JavaScript)
+ [JavaScript ä¸»é¢˜å­¦ä¹ åŒº](https://developer.mozilla.org/zh-CN/docs/learn/JavaScript)
+ [é‡æ–°ä»‹ç» JavaScriptï¼ˆJS æ•™ç¨‹ï¼‰](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/A_re-introduction_to_JavaScript)







