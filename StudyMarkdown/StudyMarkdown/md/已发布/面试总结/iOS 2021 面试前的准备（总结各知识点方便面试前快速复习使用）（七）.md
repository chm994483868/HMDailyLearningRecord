# iOS 2021 é¢è¯•å‰çš„å‡†å¤‡ï¼ˆæ€»ç»“å„çŸ¥è¯†ç‚¹æ–¹ä¾¿é¢è¯•å‰å¿«é€Ÿå¤ä¹ ä½¿ç”¨ï¼‰ï¼ˆä¸ƒï¼‰

## 55. ç±»å£°æ˜ä¸­çš„æˆå‘˜å˜é‡çš„é¡ºåºå’Œå®é™…çš„æˆå‘˜å˜é‡çš„é¡ºåºã€‚
&emsp;åœ¨é¢å‘å¯¹è±¡ï¼ˆ`oop`ï¼‰çš„ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œæ¯ä¸€ä¸ªå¯¹è±¡éƒ½æ˜¯æŸä¸ªç±»çš„å®ä¾‹ã€‚åœ¨ `Objective-C` ä¸­ï¼Œæ‰€æœ‰å¯¹è±¡çš„æœ¬è´¨éƒ½æ˜¯ä¸€ä¸ª `objc_object` ç»“æ„ä½“ï¼Œä¸”æ¯ä¸ªå®ä¾‹å¯¹è±¡çš„ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡éƒ½æ˜¯ `isa`ï¼Œå¯ä»ä¸­å–å¾—è¯¥å¯¹è±¡æ‰€å±çš„ç±»ï¼Œæ¯ä¸€ä¸ªç±»æè¿°äº†ä¸€ç³»åˆ—å®ƒçš„å®ä¾‹å¯¹è±¡çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¯¹è±¡å ç”¨å†…å­˜å¤§å°ã€æˆå‘˜å˜é‡åˆ—è¡¨ã€è¯¥å¯¹è±¡èƒ½æ‰§è¡Œçš„å‡½æ•°åˆ—è¡¨...ç­‰ç­‰ã€‚

&emsp;åœ¨ä¸€ä¸ªç±»çš„å®ä¾‹å¯¹è±¡çš„å†…å­˜å¸ƒå±€ä¸­ï¼Œç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡æ˜¯ `isa`ï¼Œç„¶åæ ¹æ®è¯¥å¯¹è±¡æ‰€å±ç±»çš„ç»§æ‰¿ä½“ç³»ä¾æ¬¡å¯¹æˆå‘˜å˜é‡æ’åºï¼Œæ’åˆ—é¡ºåºæ˜¯: æ ¹ç±»çš„æˆå‘˜å˜é‡ã€çˆ¶ç±»çš„æˆå‘˜å˜é‡ã€æœ€åæ‰æ˜¯è‡ªå·±çš„æˆå‘˜å˜é‡ï¼Œä¸”æ¯ä¸ªç±»å®šä¹‰ä¸­çš„æˆå‘˜å˜é‡ï¼ˆä»…åŒ…å«ä½¿ç”¨ `@property` å£°æ˜å±æ€§åç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„åŒåçš„ _æˆå‘˜å˜é‡ï¼‰ç›¸äº’ä¹‹é—´çš„é¡ºåºå¯èƒ½ä¼šä¸å®šä¹‰æ—¶çš„é¡ºåºä¸åŒï¼Œç¼–è¯‘å™¨ä¼šåœ¨å†…å­˜å¯¹é½çš„åŸåˆ™ä¸‹å¯¹ç±»å®šä¹‰æ—¶çš„æˆå‘˜å˜é‡çš„é¡ºåºåšå‡ºä¼˜åŒ–ï¼Œä¿è¯å†…å­˜å ç”¨æœ€å°‘ã€‚ï¼ˆè¿˜ä¼šæ¶‰åŠåˆ° `.h` ä¸­çš„æˆå‘˜å˜é‡å’Œå±æ€§ï¼Œ`.m` ä¸­ `extension` ä¸­æ·»åŠ çš„æˆå‘˜å˜é‡å’Œå±æ€§ï¼Œå®ƒä»¬ä¹‹é—´çš„æ’åºé¡ºåºï¼‰

&emsp;éªŒè¯ä»£ç :
```objective-c
// SubObject ç±»å®šä¹‰
@interface SubObject : BaseObject {
    NSArray *cus_array;
}

@property (nonatomic, assign) int cus_int;
@property (nonatomic, assign) double cus_dou;
@property (nonatomic, assign) int cus_int2;
@property (nonatomic, copy) NSString *cus_string;

@end

// æ·»åŠ æ–­ç‚¹ï¼Œæ§åˆ¶å°æ‰“å°
(lldb) p *sub
(SubObject) $2 = {
  BaseObject = {
    NSObject = {
      isa = SubObject
    }
    baseString = nil
    _baseArray = nil
  }
  cus_array = nil
  _cus_int = 0
  _cus_int2 = 0
  _cus_dou = 0
  _cus_string = nil
}
```
&emsp;å¯çœ‹åˆ° `NSObject` çš„ `isa` åœ¨æœ€å‰é¢ï¼Œç„¶åæ˜¯ `BaseObject` çš„æˆå‘˜å˜é‡ï¼Œæœ€åæ‰æ˜¯ `SubObject` çš„æˆå‘˜å˜é‡ï¼Œç„¶åæ³¨æ„ `_cus_int2` è·‘åˆ°äº† `_cus_dou` å‰é¢ï¼Œè€Œåœ¨ç±»å®šä¹‰æ—¶ `cus_dou` å±æ€§æ˜¯åœ¨ `cus_int2` å±æ€§å‰é¢çš„ã€‚ï¼ˆç”±äºå†…å­˜å¯¹é½æ—¶ä¸ç”¨å†ä¸º `double` è¡¥ä½ï¼Œè¿™æ ·è‡³å°‘å‡å°‘äº† 4 ä¸ªå­—èŠ‚çš„å†…å­˜æµªè´¹ï¼‰

***

## 56. ä¸ºä»€ä¹ˆä¸èƒ½åŠ¨æ€çš„ç»™ç±»æ·»åŠ æˆå‘˜å˜é‡å´å¯ä»¥æ·»åŠ æ–¹æ³•ï¼Ÿ
&emsp;ç±»çš„æˆå‘˜å˜é‡å¸ƒå±€ä»¥åŠå…¶å®ä¾‹å¯¹è±¡å¤§å°åœ¨ç¼–è¯‘æ—¶å°±å·²ç¡®å®šï¼Œè®¾æƒ³ä¸€ä¸‹ï¼Œå¦‚æœ `Objective-C` ä¸­å…è®¸ç»™ä¸€ä¸ªç±»åŠ¨æ€æ·»åŠ æˆå‘˜å˜é‡ï¼Œä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼šä¸ºåŸºç±»åŠ¨æ€å¢åŠ æˆå‘˜å˜é‡ä¼šå¯¼è‡´æ‰€æœ‰å·²åˆ›å»ºå‡ºçš„å­ç±»å®ä¾‹éƒ½æ— æ³•ä½¿ç”¨ã€‚æˆ‘ä»¬æ‰€è¯´çš„ â€œç±»çš„å®ä¾‹â€ï¼ˆå¯¹è±¡ï¼‰ï¼ŒæŒ‡çš„æ˜¯ä¸€å—å†…å­˜åŒºåŸŸï¼Œé‡Œé¢å­˜å‚¨äº† `isa` æŒ‡é’ˆå’Œæ‰€æœ‰çš„æˆå‘˜å˜é‡ã€‚æ‰€ä»¥å‡å¦‚å…è®¸åŠ¨æ€ä¿®æ”¹ç±»å·²å›ºå®šçš„æˆå‘˜å˜é‡çš„å¸ƒå±€ï¼Œé‚£ä¹ˆé‚£äº›å·²ç»åˆ›å»ºå‡ºçš„å¯¹è±¡å°±ä¸ç¬¦åˆç±»çš„å®šä¹‰äº†ï¼Œé‚£å°±å˜æˆæ— æ•ˆå¯¹è±¡äº†ã€‚è€Œæ–¹æ³•çš„å®šä¹‰éƒ½æ˜¯åœ¨ç±»å¯¹è±¡æˆ–å…ƒç±»å¯¹è±¡ä¸­çš„ï¼Œä¸ç®¡å¦‚ä½•å¢åˆ æ–¹æ³•ï¼Œéƒ½ä¸ä¼šå½±å“å¯¹è±¡çš„å†…å­˜å¸ƒå±€ï¼Œå·²ç»åˆ›å»ºå‡ºçš„å¯¹è±¡ä»ç„¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚

***

## 57. ISA_BITFIELD ä¸­çš„ 64 ä½åˆ†åˆ«éƒ½ä»£è¡¨ä»€ä¹ˆã€‚
```c++
#   define ISA_BITFIELD                                                      \
      // è¡¨ç¤º isa ä¸­åªæ˜¯å­˜æ”¾çš„ Class cls æŒ‡é’ˆè¿˜æ˜¯åŒ…å«æ›´å¤šä¿¡æ¯çš„ bits
      uintptr_t nonpointer        : 1;                                       \
      // æ ‡è®°è¯¥å¯¹è±¡æ˜¯å¦æœ‰å…³è”å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å¯¹è±¡èƒ½æ›´å¿«çš„é”€æ¯ï¼Œ
      // å¦‚æœæœ‰çš„è¯é”€æ¯å‰ä¼šè°ƒç”¨ _object_remove_assocations å‡½æ•°æ ¹æ®å…³è”ç­–ç•¥å¾ªç¯é‡Šæ”¾æ¯ä¸ªå…³è”å¯¹è±¡
      uintptr_t has_assoc         : 1;                                       \
      // æ ‡è®°è¯¥å¯¹è±¡æ‰€å±ç±»æ˜¯å¦æœ‰è‡ªå®šä¹‰çš„ C++ ææ„å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å¯¹è±¡èƒ½æ›´å¿«é”€æ¯ï¼Œ
      // å¦‚æœæœ‰çš„è¯å¯¹è±¡é”€æ¯å‰ä¼šè°ƒç”¨ object_cxxDestruct å‡½æ•°å»æ‰§è¡Œè¯¥ç±»çš„ææ„å‡½æ•°
      uintptr_t has_cxx_dtor      : 1;                                       \
      // isa & ISA_MASK å¾—å‡ºè¯¥å®ä¾‹å¯¹è±¡æ‰€å±çš„çš„ç±»çš„åœ°å€
      uintptr_t shiftcls          : 33; /*MACH_VM_MAX_ADDRESS 0x1000000000*/ \
      // ç”¨äºè°ƒè¯•å™¨åˆ¤æ–­å½“å‰å¯¹è±¡æ˜¯çœŸçš„å¯¹è±¡è¿˜æ˜¯æ²¡æœ‰åˆå§‹åŒ–çš„ç©ºé—´
      uintptr_t magic             : 6;                                       \
      // æ ‡è®°è¯¥å¯¹è±¡æ˜¯å¦æœ‰å¼±å¼•ç”¨ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å¯¹è±¡èƒ½æ›´å¿«é”€æ¯ï¼Œ
      // å¦‚æœæœ‰çš„è¯å¯¹è±¡é”€æ¯å‰ä¼šè°ƒç”¨ weak_clear_no_lock å‡½æ•°æŠŠè¯¥å¯¹è±¡çš„å¼±å¼•ç”¨ç½®ä¸º nilï¼Œ
      // å¹¶è°ƒç”¨ weak_entry_remove æŠŠå¯¹è±¡çš„ entry ä» weak_table ä¸­ç§»é™¤
      uintptr_t weakly_referenced : 1;                                       \
      // æ ‡è®°è¯¥å¯¹è±¡æ˜¯å¦æ­£åœ¨æ‰§è¡Œé”€æ¯
      uintptr_t deallocating      : 1;                                       \
      // æ ‡è®° refcnts ä¸­æ˜¯å¦ä¹Ÿæœ‰ä¿å­˜å®ä¾‹å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œå½“ extra_rc æº¢å‡ºæ—¶ä¼šæŠŠä¸€éƒ¨åˆ†å¼•ç”¨è®¡æ•°ä¿å­˜åˆ° refcnts ä¸­å»ï¼Œ
      uintptr_t has_sidetable_rc  : 1;                                       \
      // ä¿å­˜è¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•° -1 çš„å€¼ï¼ˆæœªæº¢å‡ºä¹‹å‰ï¼Œæº¢å‡ºåå­˜æ”¾ RC_HALFï¼‰
      uintptr_t extra_rc          : 19 // æœ€å¤§ä¿å­˜ 2^19 - 1ï¼Œè§‰å¾—è¿™ä¸ªå€¼å¾ˆå¤§å‘€, mac ä¸‹æ˜¯ 2^8 - 1 = 255
#   define RC_ONE   (1ULL<<45)
#   define RC_HALF  (1ULL<<18)
```

***

## 58. ISA() å‡½æ•°è¿”å›çš„æ˜¯ objc_object æ‰€å±çš„ç±»åœ°å€ã€‚
&emsp;ä¸‰ç§æƒ…å†µï¼Œä¸€ç§æ˜¯ isa çš„ä½åŸŸï¼ˆindexclsï¼‰ä¸­ä¿å­˜çš„æ˜¯ç±»å¯¹è±¡åœ¨å…¨å±€ç±»è¡¨ä¸­çš„ç´¢å¼•ã€‚ä¸€ç§æ˜¯ isa å°±æ˜¯ä¸€ä¸ªç±»æŒ‡é’ˆã€‚ä¸€ç§æ˜¯ isa çš„ä½åŸŸï¼ˆshiftclsï¼‰ä¸­ä¿å­˜çš„æ˜¯ç±»å¯¹è±¡çš„åœ°å€ã€‚ 
```c++
// ISA() assumes this is NOT a tagged pointer object
// å‡å®šä¸æ˜¯ tagged pointer å¯¹è±¡æ—¶è°ƒç”¨è¯¥å‡½æ•°
inline Class 
objc_object::ISA() 
{
    // å¦‚æœæ˜¯ tagged pointer åˆ™ç›´æ¥æ‰§è¡Œæ–­è¨€
    ASSERT(!isTaggedPointer()); 
#if SUPPORT_INDEXED_ISA
    // æ”¯æŒåœ¨ isa ä¸­ä¿å­˜ç±»çš„ç´¢å¼•çš„æƒ…å†µä¸‹
    
    if (isa.nonpointer) {
        uintptr_t slot = isa.indexcls;
        
        // æ ¹æ®ç´¢å¼•è¿”å› class table ä¸­çš„ Class
        return classForIndex((unsigned)slot);
    }
    
    // å¦‚æœæ˜¯éä¼˜åŒ–æŒ‡é’ˆç›´æ¥è¿”å› isa ä¸­çš„ bitsï¼Œç”±äº isa æ˜¯ union æ‰€ä»¥ (Class)isa.bits å’Œ (Class)isa.cls çš„å€¼æ˜¯ä¸€æ ·çš„ã€‚
    return (Class)isa.bits;
#else
    // ä» shiftcls ä½åŸŸå–å¾— Class æŒ‡é’ˆï¼Œè¿™ä¸ªæ˜¯æˆ‘ä»¬å¹³æ—¶ç”¨åˆ°çš„æœ€å¤šçš„ï¼Œæˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨çš„å®ä¾‹å¯¹è±¡è·å–æ‰€å±çš„ç±»éƒ½æ˜¯é€šè¿‡è¿™ç§æ–¹å¼ã€‚
    return (Class)(isa.bits & ISA_MASK);
#endif
}
```

***

## 59. isWeaklyReferenced / sidetable_isWeaklyReferenced
&emsp;åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜åœ¨å¼±å¼•ç”¨ã€‚
```c++
inline bool
objc_object::isWeaklyReferenced()
{
    // å¦‚æœæ˜¯ Tagged Pointer æ‰§è¡Œæ–­è¨€
    ASSERT(!isTaggedPointer());
    
    // å¦‚æœæ˜¯éæŒ‡é’ˆåˆ™è¿”å› weakly_referenced æ ‡è®°ä½
    if (isa.nonpointer) return isa.weakly_referenced;
    
    // å…¶ä»–æƒ…å†µè°ƒç”¨ sidetable_isWeaklyReferenced
    //ï¼ˆå½“ isa æ˜¯ objc_class æŒ‡é’ˆæ—¶ï¼Œå¯¹è±¡çš„å¼±å¼•ç”¨æ ‡è¯†ä½åœ¨ SideTable çš„ refcnts ä¸­ï¼‰
    else return sidetable_isWeaklyReferenced();
}
```

&emsp;`isa` æ˜¯åŸå§‹ç±»æŒ‡é’ˆçš„å¯¹è±¡çš„æ˜¯å¦æœ‰å¼±å¼•ç”¨çš„æ ‡è¯†åœ¨ `refcnts` ä¸­ã€‚
```c++
bool 
objc_object::sidetable_isWeaklyReferenced()
{
    bool result = false;
    
    // å–å¾—å¯¹è±¡æ‰€å¤„çš„ SideTable
    SideTable& table = SideTables()[this];
    // åŠ é”
    table.lock();
    
    RefcountMap::iterator it = table.refcnts.find(this);
    // åˆ¤æ–­å½“å‰å¯¹è±¡æ˜¯å¦å­˜åœ¨ SideTable çš„ refcnts ä¸­
    if (it != table.refcnts.end()) {
        // å¦‚æœå­˜åœ¨ 
        // it->second æ˜¯å¼•ç”¨è®¡æ•° ä¸ SIDE_TABLE_WEAKLY_REFERENCED è¿›è¡Œä¸æ“ä½œ
        // å¼•ç”¨è®¡æ•°å€¼çš„ç¬¬ 1 ä½æ˜¯å¼±å¼•ç”¨çš„æ ‡è¯†ä½å“¦
        result = it->second & SIDE_TABLE_WEAKLY_REFERENCED;
    }
    
    // è§£é”
    table.unlock();

    return result;
}
```

***

## 60. Tagged Pointer è§£è¯»ã€‚
&emsp;2013 å¹´ 9 æœˆï¼Œè‹¹æœé¦–æ¬¡åœ¨ iOS å¹³å°æ¨å‡ºäº†æ­è½½ 64 ä½æ¶æ„å¤„ç†å™¨çš„ iPhoneï¼ˆiPhone 5sï¼‰ï¼Œä¸ºäº†èŠ‚çœå†…å­˜å’Œæé«˜è¿è¡Œæ•ˆç‡ï¼Œæå‡ºäº† Tagged Pointer æ¦‚å¿µã€‚

&emsp;Tagged Pointer æ˜¯è‹¹æœä¸ºäº†åœ¨ 64 ä½æ¶æ„çš„å¤„ç†å™¨ä¸‹èŠ‚çœå†…å­˜å ç”¨å’Œæé«˜è¿è¡Œæ•ˆç‡è€Œæå‡ºçš„æ¦‚å¿µã€‚å®ƒçš„æœ¬è´¨æ˜¯æŠŠä¸€äº›å ç”¨å†…å­˜è¾ƒå°çš„å¯¹è±¡çš„æ•°æ®ç›´æ¥æ”¾åœ¨æŒ‡é’ˆçš„å†…å­˜ç©ºé—´å†…ï¼Œç„¶åæŠŠè¿™ä¸ªæŒ‡é’ˆç›´æ¥ä½œä¸ºå¯¹è±¡ä½¿ç”¨ï¼Œç›´æ¥çœå»äº†ä¸ºå¯¹è±¡åœ¨å †åŒºå¼€è¾Ÿç©ºé—´çš„è¿‡ç¨‹ã€‚

&emsp;è¿™é‡Œå¼•å‡ºäº†ä¸€ä¸ªç–‘é—®ï¼Œâ€œå¯¹è±¡çš„å†…å­˜éƒ½æ˜¯ä½äºå †åŒºå—ï¼Ÿâ€ æ˜¯çš„ã€‚ä¸‹é¢æ˜¯æˆ‘è‡ªå·±çš„æ¨æµ‹ï¼šé»˜è®¤è¿™é‡Œè¯´çš„å¯¹è±¡éƒ½æ˜¯ NSObject çš„å­ç±»ï¼Œå½“æ·±å…¥çœ‹ + (id)alloc å‡½æ•°æ—¶ï¼Œå¯çœ‹åˆ°æœ€åé¢å¼€è¾Ÿç©ºé—´éƒ½æ˜¯ä½¿ç”¨çš„ mallocï¼ˆcalloc å‡½æ•°å†…éƒ¨æ˜¯è°ƒç”¨ malloc åå†è°ƒç”¨ bzero ç½® 0ï¼‰å‡½æ•°ï¼Œè€Œ malloc æ˜¯ C çš„è¿è¡Œåº“å‡½æ•°ï¼Œå‘å®ƒç”³è¯·çš„å†…å­˜éƒ½æ˜¯ C è¿è¡Œåº“ç®¡ç†ï¼Œé‡‡ç”¨å †çš„å†…å­˜ç®¡ç†æ–¹å¼ã€‚è¯¥å‡½æ•°å®é™…ä¸Šä¼šå‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œç„¶ååˆ†é…ç»™è¯·æ±‚è€…ï¼ŒåŒæ—¶å…¶å†…éƒ¨ç»´æŠ¤æœ‰å®ƒç”³è¯·çš„å†…å­˜çš„åˆ†é…æƒ…å†µï¼Œä»¥ä¾¿ç®¡ç†å…¶æ‹¥æœ‰çš„å†…å­˜ã€‚

&emsp;æŒ‡é’ˆå˜é‡çš„é•¿åº¦ä¸åœ°å€æ€»çº¿æœ‰å…³ã€‚ä» 32 ä½ç³»ç»Ÿæ¶æ„åˆ‡æ¢åˆ° 64 ä½ç³»ç»Ÿæ¶æ„åï¼ŒæŒ‡é’ˆå˜é‡çš„é•¿åº¦ä¹Ÿä¼šç”± 32 ä½å¢åŠ åˆ° 64 ä½ã€‚å¦‚æœä¸è€ƒè™‘å…¶å®ƒå› ç´ ï¼Œ64 ä½æŒ‡é’ˆå¯è¡¨ç¤ºçš„åœ°å€é•¿åº¦å¯è¾¾åˆ° 2^64 å­—èŠ‚å³ 2^34 TBï¼Œä»¥ç›®å‰çš„è®¾å¤‡çš„å†…å­˜æ¥çœ‹ï¼Œä½¿ç”¨ 8 ä¸ªå­—èŠ‚å­˜å‚¨ä¸€ä¸ªåœ°å€æ•°æ®ï¼Œå…¶å®æœ‰å¾ˆå¤šä½éƒ½æ˜¯ç©ºä½™çš„ï¼Œè€Œ Tagged Pointer æ­£æ˜¯ä¸ºäº†æŠŠè¿™äº›ç©ºä½™çš„ç©ºé—´åˆ©ç”¨èµ·æ¥ã€‚ï¼ˆä¾‹å¦‚ï¼Œåœ¨ iPhone çœŸæœºä¸‹ï¼Œåœ¨å †åŒºåˆ›å»ºä¸€ä¸ª NSObject å¯¹è±¡ï¼Œæ‰“å°çš„å®ƒçš„åœ°å€ï¼Œçœ‹åˆ°åªå ç”¨äº† 36 ä½ï¼Œå‰©ä¸‹ 28 ä½éƒ½æ˜¯é›¶ã€‚ï¼‰ 

&emsp;æ˜ç¡®ä¸€ç‚¹ï¼ŒNSInteger/NSUInteger æ˜¯ä½¿ç”¨ typedef å£°æ˜çš„åŸºæœ¬ç±»å‹ long/int/unsigned long/unsigned intã€‚NSNumberã€NSStringã€NSDate ç­‰éƒ½æ˜¯ç»§æ‰¿è‡ª NSObject çš„å­ç±»ã€‚

&emsp;åœ¨ objc-runtime-new.hï¼ŒCF è¦æ±‚æ‰€æœ‰å¯¹è±¡è‡³å°‘ä¸º 16 ä¸ªå­—èŠ‚ã€‚ï¼ˆå¯¹è±¡å†…éƒ¨æˆå‘˜å˜é‡å¤šä¸º 8 å­—èŠ‚å¯¹é½ï¼Œå¦‚æœæœ€åå¯¹é½åå¯¹è±¡å†…å­˜å°äº 16 å­—èŠ‚ï¼Œåˆ™æ‰©å±•ä¸º 16 å­—èŠ‚ã€‚ï¼‰

&emsp;\_OBJC_TAG_MASK è¡¨ç¤ºåœ¨å­—ç¬¦ä¸²é«˜ä½ä¼˜å…ˆæ’åºçš„å¹³å°ä¸‹æŒ‡é’ˆå˜é‡çš„ç¬¬ 64 ä½æ ‡è®°è¯¥æŒ‡é’ˆä¸º Tagged Pointerï¼Œåœ¨å­—ç¬¦ä¸²ä½ä½ä¼˜å…ˆæ’åºçš„å¹³å°ä¸‹æŒ‡é’ˆå˜é‡çš„ç¬¬ 1 ä½æ ‡è®°è¯¥æŒ‡é’ˆä¸º Tagged Pointerã€‚

&emsp;åœ¨ iOS çœŸæœºä¸Šåˆ¤æ–­æ˜¯å¦æ˜¯ Tagged Pointer çœ‹æŒ‡é’ˆçš„ç¬¬ 64 æ¯”ç‰¹ä½æ˜¯å¦æ˜¯ 1ï¼Œåœ¨ x86_64 æ¶æ„çš„ Mac ä¸‹çœ‹æŒ‡é’ˆçš„ç¬¬ 1 ä¸ªæ¯”ç‰¹ä½æ˜¯å¦æ˜¯ 1ã€‚ï¼ˆå³åœ¨ iOS ä¸­åˆ¤æ–­æœ€é«˜ä½ï¼Œåœ¨ mac ä¸­åˆ¤æ–­æœ€ä½ä½ï¼‰

&emsp;åˆ†ææ‰“å°ç»“æœï¼Œå¯çœ‹åˆ°æ‰€æœ‰ Tagged Pointer çš„ 64 ä½å†…å­˜ä½¿ç”¨å‡ ä¹éƒ½æ˜¯æ»¡çš„ï¼Œæœ€é«˜ä½éƒ½æ˜¯ 1ï¼Œmalloc_size è¿”å›çš„éƒ½æ˜¯ 0ï¼Œå¯¹æ¯”æœ€åé Tagged Pointer ç³»ç»Ÿæ²¡æœ‰ä¸ºå¯¹è±¡å¼€è¾Ÿç©ºé—´ã€‚æ­£å¸¸çš„ Objective-C å®ä¾‹å¯¹è±¡çš„ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡éƒ½æ˜¯æŒ‡å‘ç±»å¯¹è±¡å†…å­˜åœ°å€çš„ isa æŒ‡é’ˆï¼Œé€šè¿‡æ‰“æ–­ç‚¹ï¼Œå¯çœ‹åˆ°æ‰€æœ‰ Tagged Pointer çš„ isa éƒ½æ˜¯ 0x0ï¼Œä¸”å½“ Tagged Pointer æ˜¯ NSNumber ç±»å‹æ—¶ï¼Œclass å‡½æ•°çš„æ‰“å°ä¾ç„¶æ˜¯ \_\_NSCFNumberï¼Œè‹¹æœå¹¶æ²¡æœ‰è®¾è®¡ä¸€ä¸ªå•ç‹¬çš„ Class æ¥è¡¨ç¤º Tagged Pointerï¼ŒNSString åˆ™æ‰“å°çš„æ˜¯ NSTaggedPointerStringï¼Œé‚£è¿™é‡Œå¼•å‡ºäº†å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼ŒTagged Pointer åˆæ˜¯æ€ä¹ˆè·å–æ‰€å±çš„ç±»å‘¢ï¼Ÿ

&emsp;ä¸ºä½•å¯é€šè¿‡è®¾å®šæœ€é«˜ä½æˆ–æœ€ä½ä½æ¥æ ‡è¯† Tagged Pointer? è¿™æ˜¯å› ä¸ºåœ¨åˆ†é…å†…å­˜çš„æ—¶å€™ï¼Œéƒ½æ˜¯æŒ‰ 2 çš„æ•´æ•°å€æ¥åˆ†é…çš„ï¼Œè¿™æ ·åˆ†é…å‡ºæ¥çš„æ­£å¸¸å†…å­˜åœ°å€æœ«ä½ä¸å¯èƒ½ä¸º 1ï¼Œé€šè¿‡å°†æœ€ä½æ ‡è¯†ä¸º 1ï¼Œå°±å¯ä»¥å’Œå…¶ä»–æ­£å¸¸æŒ‡é’ˆåšå‡ºåŒºåˆ†ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆæœ€é«˜ä½ä¸º 1ï¼Œä¹Ÿå¯ä»¥æ ‡è¯†å‘¢ ï¼Ÿï¼ˆç›®å‰ iOS è®¾å¤‡çš„å†…å­˜éƒ½æ˜¯å›ºå®šçš„ï¼Œå¦‚ iPhoneã€iPadã€iWatch éƒ½æ˜¯å›ºå®šçš„ï¼Œä¸åƒæ˜¯ mac äº§å“æˆ‘ä»¬å¯ä»¥è‡ªå·±åŠ è£…å†…å­˜æ¡ï¼‰è¿™æ˜¯å› ä¸º 64 ä½æ“ä½œç³»ç»Ÿï¼Œè®¾å¤‡ä¸€èˆ¬æ²¡æœ‰é‚£ä¹ˆå¤§çš„å†…å­˜ï¼Œæ‰€ä»¥å†…å­˜åœ°å€ä¸€èˆ¬åªæœ‰ 48 ä¸ªå·¦å³æœ‰æ•ˆä½ï¼ˆ64 ä½ iOS å †åŒºåœ°å€åªä½¿ç”¨äº† 36 ä½æœ‰æ•ˆä½ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´é«˜ä½çš„ 16 ä½å·¦å³éƒ½ä¸º 0ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡æœ€é«˜ä½æ ‡è¯†ä¸º 1 æ¥è¡¨ç¤º Tagged Pointerã€‚é‚£ä¹ˆæ—¢ç„¶ 1 ä½å°±å¯ä»¥æ ‡è¯† Tagged Pointer äº†ï¼Œå…¶ä»–çš„ä¿¡æ¯æ˜¯å¹²å˜›çš„å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥æƒ³è±¡çš„ï¼Œé¦–å…ˆè¦æœ‰ä¸€äº› bit ä½æ¥è¡¨ç¤ºè¿™ä¸ªæŒ‡é’ˆå¯¹åº”çš„ç±»å‹ï¼Œä¾‹å¦‚ NSNumber åœ¨ LSB ä¸­ç¬¬ä¸€é«˜ä½é™¤å¤–çš„æ¥ä¸‹æ¥çš„ä¸‰ä½è¡¨ç¤ºæ‰€å±ç±»å‹åœ¨ Tagged Pointer ç±»è¡¨ä¸­çš„ç´¢å¼•ï¼Œç„¶åæ¥ä¸‹çš„ 60 ä½åˆ™æ˜¯ç”¨æ¥å­˜å‚¨å€¼ï¼Œè´Ÿè½½æ•°æ®å®¹é‡ï¼Œç”¨æ¥å­˜å‚¨å¯¹è±¡æ•°æ®ã€‚

```c++
* Tagged pointer æŒ‡é’ˆå¯¹è±¡å°† class å’Œå¯¹è±¡æ•°æ®å­˜å‚¨åœ¨å¯¹è±¡æŒ‡é’ˆä¸­ï¼ŒæŒ‡é’ˆå®é™…ä¸Šä¸æŒ‡å‘ä»»ä½•ä¸œè¥¿ã€‚
* Tagged pointer å½“å‰ä½¿ç”¨æ­¤è¡¨ç¤ºå½¢å¼:
*
* (LSB)(å­—ç¬¦ä¸²ä½ä½ä¼˜å…ˆæ’åºï¼Œ64 ä½çš„ mac ä¸‹)
*  1 bit   set if tagged, clear if ordinary object pointer // å€¼ä¸º 1 æ ‡è®°æ˜¯ tagged pointerï¼Œå¦‚æœæ˜¯æ™®é€šå¯¹è±¡æŒ‡é’ˆåˆ™æ˜¯ 0
*  3 bits  tag index // æ ‡è®°ç±»å‹
* 60 bits  payload // è´Ÿè½½æ•°æ®å®¹é‡ï¼Œï¼ˆå­˜å‚¨å¯¹è±¡æ•°æ®ï¼‰
*
* (MSB)(64 ä½ iPhone ä¸‹)
* tag index è¡¨ç¤ºå¯¹è±¡æ‰€å±çš„ classã€‚è´Ÿè½½æ ¼å¼ç”±å¯¹è±¡çš„ class å®šä¹‰ã€‚
*
* å¦‚æœ tag index æ˜¯ 0b111(7), tagged pointer å¯¹è±¡ä½¿ç”¨ â€œæ‰©å±•â€ è¡¨ç¤ºå½¢å¼ï¼Œå…è®¸æ›´å¤šç±»ï¼Œä½†æœ‰æ•ˆè½½è·æ›´å°: 
* (LSB)(å­—ç¬¦ä¸²ä½ä½ä¼˜å…ˆæ’åºï¼Œ64 ä½çš„ mac ä¸‹)
*  1 bit   set if tagged, clear if ordinary object pointer // å€¼ä¸º 1 æ ‡è®°æ˜¯ tagged pointerï¼Œå¦‚æœæ˜¯æ™®é€šå¯¹è±¡æŒ‡é’ˆåˆ™æ˜¯ 0
*  3 bits  0b111 
*  8 bits  extended tag index // æ‰©å±•çš„ tag index
* 52 bits  payload // è´Ÿè½½æ•°æ®å®¹é‡ï¼Œæ­¤æ—¶åªæœ‰ 52 ä½
* (MSB)
```

&emsp;å¦å¤–çš„ä¸€ä¸ªå»¶å±•ï¼ŒTagged Pointer å¯å­˜å‚¨çš„æœ€å¤§å€¼ã€‚å½“ Tagged Pointer æ˜¯ NSNumber ç±»å‹æ—¶ï¼Œåœ¨ x86_64 Mac å¹³å°ä¸‹:
```c++
NSNumber *number = [[NSNumber alloc] initWithInteger: pow(2, 55) - 2];;
NSLog(@"number %p %@ %zu", number, [number class], malloc_size(CFBridgingRetain(number)));
// æ‰“å°:
number 0x10063e330 __NSCFNumber 32

NSNumber *number = [[NSNumber alloc] initWithInteger: pow(2, 55) - 3];;
NSLog(@"number %p %@ %zu", number, [number class], malloc_size(CFBridgingRetain(number)));
// æ‰“å°:
number 0x21a60cf72f053d4b __NSCFNumber 0
```
&emsp;åœ¨ x86_64 Mac å¹³å°ä¸‹å­˜å‚¨ NSString ç±»å‹çš„ Tagged Pointerï¼Œä¸€ä¸ªæŒ‡é’ˆ 8 ä¸ªå­—èŠ‚ï¼Œ64 ä¸ªæ¯”ç‰¹ä½ï¼Œç¬¬ 1 ä¸ªæ¯”ç‰¹ä½ç”¨äºæ ‡è®°æ˜¯å¦æ˜¯ Tagged Pointerï¼Œç¬¬ 2~4 æ¯”ç‰¹ä½ç”¨äºæ ‡è®° Tagged Pointer çš„æŒ‡é’ˆç±»å‹ï¼Œè§£ç åçš„æœ€å 4 ä¸ªæ¯”ç‰¹ä½ç”¨äºæ ‡è®° value çš„é•¿åº¦ï¼Œé‚£ä¹ˆç”¨äºå­˜å‚¨ value çš„æ¯”ç‰¹ä½åªæœ‰ 56 ä¸ªäº†ï¼Œæ­¤æ—¶å¦‚æœæ¯ä¸ªå­—ç¬¦ç”¨ ASCII ç¼–ç çš„è¯ 8 ä¸ªå­—ç¬¦åº”è¯¥å°±ä¸æ˜¯ Tagged Pointer äº†ï¼Œä½†å…¶å® NSTaggedPointerString é‡‡ç”¨ä¸åŒçš„ç¼–ç æ–¹å¼ï¼š

1. å¦‚æœé•¿åº¦ä»‹äº 0 åˆ° 7ï¼Œç›´æ¥ç”¨å…«ä½ç¼–ç å­˜å‚¨å­—ç¬¦ä¸²ã€‚
2. å¦‚æœé•¿åº¦æ˜¯ 8 æˆ– 9ï¼Œç”¨å…­ä½ç¼–ç å­˜å‚¨å­—ç¬¦ä¸²ï¼Œä½¿ç”¨ç¼–ç è¡¨ eilotrm.apdnsIc ufkMShjTRxgC4013bDNvwyUL2O856P-B79AFKEWV_zGJ/HYXã€‚
3. å¦‚æœé•¿åº¦æ˜¯ 10 æˆ– 11ï¼Œç”¨äº”ä½ç¼–ç å­˜å‚¨å­—ç¬¦ä¸²,ä½¿ç”¨ç¼–ç è¡¨ eilotrm.apdnsIc ufkMShjTRxgC4013ã€‚

&emsp;@"aaaaaaaa"ï¼ˆ8 ä¸ª aï¼‰ è§£ç åçš„ TaggedPointer å€¼ä¸º 0x2082082082088ï¼Œæ‰£é™¤æœ€å 4 ä¸ªæ¯”ç‰¹ä½ä»£è¡¨çš„é•¿åº¦ï¼Œåˆ™ä¸º 0x208208208208ï¼Œåªæœ‰ 6 ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯å› ä¸ºé•¿åº¦ä¸º 8ï¼Œéœ€è¦è¿›è¡Œåˆ†ç»„è§£ç ï¼Œ6 ä¸ªæ¯”ç‰¹ä½ä¸ºä¸€ç»„ï¼Œåˆ†ç»„åä¸º 0x0808080808080808ï¼Œåˆšå¥½ 8 ä¸ªå­—èŠ‚ï¼Œé•¿åº¦ç¬¦åˆäº†ã€‚é‡‡ç”¨ç¼–ç è¡¨ eilotrm.apdnsIc ufkMShjTRxgC4013bDNvwyUL2O856P-B79AFKEWV_zGJ/HYXï¼Œä¸‹æ ‡ä¸º 8 çš„åˆšå¥½æ˜¯ aã€‚

&emsp;@"aaaaaaaaaa"ï¼ˆ10 ä¸ª aï¼‰ è§£ç åçš„ TaggedPointer å€¼ä¸º 0x1084210842108aï¼Œæ‰£é™¤æœ€å 4 ä¸ªæ¯”ç‰¹ä½ä»£è¡¨çš„é•¿åº¦ï¼Œåˆ™ä¸º 0x1084210842108ï¼Œåªæœ‰ 6.5 å­—èŠ‚ï¼Œä½†æ˜¯å› ä¸ºé•¿åº¦ä¸º 10ï¼Œéœ€è¦è¿›è¡Œåˆ†ç»„è§£ç ï¼Œ5 ä¸ªæ¯”ç‰¹ä½ä¸ºä¸€ç»„ï¼Œåˆ†ç»„åä¸º 0x08080808080808080808ï¼Œåˆšå¥½ 10 ä¸ªå­—èŠ‚ï¼Œé•¿åº¦ç¬¦åˆäº†ã€‚é‡‡ç”¨ç¼–ç è¡¨ eilotrm.apdnsIc ufkMShjTRxgC4013ï¼Œä¸‹æ ‡ä¸º 8 çš„åˆšå¥½æ˜¯ aã€‚

&emsp;åœ¨ç¼–ç è¡¨ä¸­å¹¶æ²¡æœ‰çœ‹åˆ° + å­—ç¬¦ï¼Œä½¿ç”¨ + å­—ç¬¦åšä¸ªæµ‹è¯•ï¼Œ7 ä¸ª + åº”ä¸º NSTaggedPointerStringï¼Œè€Œ 8 ä¸ª + åˆ™ä¸ºæ™®é€šçš„ \_\_NSCFString å¯¹è±¡ã€‚

&emsp;å…³äºå­—ç¬¦ä¸²çš„å­˜å‚¨å¯ä»¥å‚è€ƒ: [ã€Šè¯‘ã€‘é‡‡ç”¨Tagged Pointerçš„å­—ç¬¦ä¸²ã€‹](http://www.cocoachina.com/articles/13449)ã€‚

***

## 61. åœ¨ category ä¸­ä¸ºç°æœ‰ç±»æ·»åŠ å±æ€§æ—¶ã€‚
&emsp;ä½¿ç”¨ Category ä¸ºå·²ç»å­˜åœ¨çš„ç±»æ·»åŠ æ–¹æ³•æ˜¯æˆ‘ä»¬å¾ˆç†Ÿæ‚‰çš„å¸¸è§„æ“ä½œï¼Œä½†æ˜¯å¦‚æœåœ¨ Category ä¸­ä¸ºç±»æ·»åŠ å±æ€§ @propertyï¼Œåˆ™ç¼–è¯‘å™¨ä¼šç«‹å³ç»™æˆ‘ä»¬å¦‚ä¸‹è­¦å‘Š:
```c++
Property 'categoryProperty' requires method 'categoryProperty' to be defined - use @dynamic or provide a method implementation in this category.
Property 'categoryProperty' requires method 'setCategoryProperty:' to be defined - use @dynamic or provide a method implementation in this category
```
&emsp;æç¤ºæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ä¸ºå±æ€§æ·»åŠ  setterã€gettr æ–¹æ³•æˆ–è€…ä½¿ç”¨ @dynamic æ ‡è®°å‘Šè¯‰ç¼–è¯‘å™¨æ˜¯åœ¨è¿è¡Œæ—¶å®ç°è¿™äº›æ–¹æ³•ï¼Œå³è¿™ä¹Ÿæ˜ç¡®çš„å‘Šè¯‰äº†æˆ‘ä»¬åœ¨åˆ†ç±»ä¸­ @property å¹¶ä¸ä¼šè‡ªåŠ¨ç”Ÿæˆä¸‹åˆ’çº¿å®ä¾‹å˜é‡ä»¥åŠ setter å’Œ getter å­˜å–æ–¹æ³•ã€‚

&emsp;ä¸æ˜¯è¯´å¥½çš„ä½¿ç”¨ @propertyï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆä¸‹åˆ’çº¿å®ä¾‹å˜é‡å’Œå¯¹åº”çš„ setter å’Œ getter æ–¹æ³•å—ï¼Ÿæ­¤æœºåˆ¶åªèƒ½åœ¨ç±»å®šä¹‰ä¸­å®ç°ï¼Œå› ä¸ºåœ¨åˆ†ç±»ä¸­ï¼Œç±»çš„å®ä¾‹å˜é‡çš„å†…å­˜å¸ƒå±€å·²ç»å›ºå®šï¼Œä½¿ç”¨ @property å·²ç»æ— æ³•å‘å›ºå®šçš„å†…å­˜å¸ƒå±€ä¸­æ·»åŠ æ–°çš„å®ä¾‹å˜é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨å…³è”å¯¹è±¡ä»¥åŠä¸¤ä¸ªæ–¹æ³• objc_getAssociatedObjectã€objc_setAssociatedObject æ¥æ¨¡æ‹Ÿæ„æˆå±æ€§çš„ä¸‰ä¸ªè¦ç´ ã€‚

&emsp;ç¤ºä¾‹ä»£ç :
```c++
#import "HMObject.h"

NS_ASSUME_NONNULL_BEGIN

@interface HMObject (category)

// åœ¨åˆ†ç±»ä¸­æ·»åŠ ä¸€ä¸ªå±æ€§
@property (nonatomic, copy) NSString *categoryProperty;

@end

NS_ASSUME_NONNULL_END
```

```c++
#import "HMObject+category.h"
#import <objc/runtime.h> 

@implementation HMObject (category)

- (NSString *)categoryProperty {
    // _cmd ä»£æŒ‡å½“å‰æ–¹æ³•çš„é€‰æ‹©å­ï¼Œå³ @selector(categoryProperty)
    return objc_getAssociatedObject(self, _cmd);
}

- (void)setCategoryProperty:(NSString *)categoryProperty {
    objc_setAssociatedObject(self,
                             @selector(categoryProperty),
                             categoryProperty,
                             OBJC_ASSOCIATION_COPY_NONATOMIC);
}

@end
```
&emsp;æ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…³è”å¯¹è±¡ Associated Object æ¥æ‰‹åŠ¨ä¸º categoryProperty å±æ€§æ·»åŠ å­˜å–æ–¹æ³•ã€‚

***

## 62. åœ¨ç±»å®šä¹‰ä¸­æ·»åŠ å±æ€§æ—¶ã€‚
&emsp;åœ¨ç±»å®šä¹‰ä¸­æˆ‘ä»¬ä½¿ç”¨ @property ä¸ºç±»æ·»åŠ å±æ€§æ—¶ï¼Œå¦‚æœä¸ä½¿ç”¨ @dynamic æ ‡è¯†è¯¥å±æ€§çš„è¯ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªåå­—ä¸ºä¸‹åˆ’çº¿åŠ å±æ€§åçš„å®ä¾‹å˜é‡å’Œè¯¥å±æ€§çš„ setter å’Œ getter æ–¹æ³•ã€‚æˆ‘ä»¬ç¼–å†™å¦‚ä¸‹ä»£ç :
```c++
// .h ä¸­å¦‚ä¸‹ä¹¦å†™
#import <Foundation/Foundation.h>

NS_ASSUME_NONNULL_BEGIN

@interface HMObject : NSObject
@property (nonatomic, copy) NSString *cusProperty;
@end

NS_ASSUME_NONNULL_END

// .m ä¸­ä»€ä¹ˆéƒ½ä¸åš
#import "HMObject.h"
@implementation HMObject
// @dynamic cusProperty;

@end
```
&emsp;ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åšå¦‚ä¸‹ä¸‰ä»¶äº‹:
1. æ·»åŠ å®ä¾‹å˜é‡ \_cusProperty
2. æ·»åŠ  setter æ–¹æ³• setCusProperty
3. æ·»åŠ  getter æ–¹æ³• cusProperty
&emsp;å³å¦‚ä¸‹ HMObject.m çš„ä»£ç å®ç°ï¼š
```c++
#import "HMObject.h"

@implementation HMObject
// @dynamic cusProperty;
{
    NSString *_cusProperty;
}

- (void)setCusProperty:(NSString *)cusProperty {
    _cusProperty = cusProperty;
}

- (NSString *)cusProperty {
    return _cusProperty;
}

@end
```

&emsp;ä¸‹é¢æˆ‘ä»¬é€šè¿‡ LLDB è¿›è¡ŒéªŒè¯ï¼Œé¦–å…ˆæˆ‘ä»¬æŠŠ HMObject.m çš„ä»£ç éƒ½æ³¨é‡Šæ‰ï¼Œåªç•™ä¸‹ HMObject.h ä¸­çš„ cusProperty å±æ€§ã€‚ç„¶ååœ¨ main å‡½æ•°ä¸­ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š
```c++
Class cls = NSClassFromString(@"HMObject");
NSLog(@"%@", cls); // â¬…ï¸ è¿™é‡Œæ‰“ä¸€ä¸ªæ–­ç‚¹
```
&emsp;å¼€å§‹éªŒè¯ï¼š

> &emsp;è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ runtime çš„ class_copyPropertyListã€class_copyMethodListã€class_copyIvarList ä¸‰ä¸ªå‡½æ•°æ¥åˆ†åˆ«è·å– HMObject çš„å±æ€§åˆ—è¡¨ã€æ–¹æ³•åˆ—è¡¨å’Œæˆå‘˜å˜é‡åˆ—è¡¨æ¥éªŒè¯ç¼–è¯‘å™¨ä¸ºæˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆäº†ä»€ä¹ˆå†…å®¹ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨ä¸€ç§æ›´ä¸ºç®€å•çš„æ–¹æ³•ï¼Œä»…é€šè¿‡æ§åˆ¶å°æ‰“å°å³å¯éªŒè¯ã€‚

1. æ‰¾åˆ° cls çš„ bitsï¼š
```c++
(lldb) x/5gx cls
0x1000022e8: 0x00000001000022c0 (isa) 0x00000001003ee140 (superclass)
0x1000022f8: 0x00000001003e84a0 0x0000001c00000000 (cache_t)
0x100002308: 0x0000000101850640 (bits)
```
2. å¼ºåˆ¶è½¬æ¢ class_data_bits_t æŒ‡é’ˆ
```c++
(lldb) p (class_data_bits_t *)0x100002308
(class_data_bits_t *) $1 = 0x0000000100002308
```
3. å–å¾— class_rw_t *
```c++
(lldb) p $1->data()
(class_rw_t *) $2 = 0x0000000101850640
```
4. å–å¾— class_ro_t *
```c++
(lldb) p $2->ro
(const class_ro_t *) $3 = 0x0000000100002128
```
5. æ‰“å° ro å†…å®¹
```c++
(lldb) p *$3
(const class_ro_t) $4 = {
  flags = 388
  instanceStart = 8
  instanceSize = 16
  reserved = 0
  ivarLayout = 0x0000000100000ee6 "\x01"
  name = 0x0000000100000edd "HMObject" // ç±»å
  baseMethodList = 0x0000000100002170 // æ–¹æ³•åˆ—è¡¨
  baseProtocols = 0x0000000000000000 // éµå¾ªåè®®ä¸ºç©º
  ivars = 0x00000001000021c0 // æˆå‘˜å˜é‡
  weakIvarLayout = 0x0000000000000000
  baseProperties = 0x00000001000021e8 // å±æ€§
  _swiftMetadataInitializer_NEVER_USE = {}
}
```
6. æ‰“å° ivars
```c++
(lldb) p $4.ivars
(const ivar_list_t *const) $5 = 0x00000001000021c0
(lldb) p *$5
(const ivar_list_t) $6 = {
  entsize_list_tt<ivar_t, ivar_list_t, 0> = {
    entsizeAndFlags = 32
    count = 1 // æœ‰ 1 ä¸ªæˆå‘˜å˜é‡
    first = {
      offset = 0x00000001000022b8
      // çœ‹åˆ°åå­—ä¸º _cusProperty çš„æˆå‘˜å˜é‡
      name = 0x0000000100000ef6 "_cusProperty"
      type = 0x0000000100000f65 "@\"NSString\""
      alignment_raw = 3
      size = 8
    }
  }
}
```
7. æ‰“å° baseProperties
```c++
(lldb) p $4.baseProperties
(property_list_t *const) $7 = 0x00000001000021e8
(lldb) p *$7
(property_list_t) $8 = {
  entsize_list_tt<property_t, property_list_t, 0> = {
    entsizeAndFlags = 16
    count = 1
    first = (name = "cusProperty", attributes = "T@\"NSString\",C,N,V_cusProperty")
  }
}
```
&emsp;çœ‹åˆ°åªæœ‰ä¸€ä¸ªåå­—æ˜¯ cusProperty çš„å±æ€§ï¼Œå±æ€§çš„ attributes æ˜¯ï¼š"T@\"NSString\",C,N,V_cusProperty"

| code | meaning |
| ... | ... |
| T | ç±»å‹ |
| C | copy |
| N | nonatomic |
| V | å®ä¾‹å˜é‡ |

&emsp;å…³äºå®ƒçš„è¯¦ç»†ä¿¡æ¯å¯å‚è€ƒ [ã€ŠObjective-C Runtime Programming Guideã€‹](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html)ã€‚

8. æ‰“å° baseMethodList
```c++
(lldb) p $4.baseMethodList
(method_list_t *const) $9 = 0x0000000100002170
(lldb) p *$9
(method_list_t) $10 = {
  entsize_list_tt<method_t, method_list_t, 3> = {
    entsizeAndFlags = 26
    count = 3 // æœ‰ 3 ä¸ª method
    first = {
      // ç¬¬ä¸€ä¸ªæ­£æ˜¯ cusProperty çš„ getter å‡½æ•°
      name = "cusProperty"
      types = 0x0000000100000f79 "@16@0:8"
      imp = 0x0000000100000c30 (KCObjcTest`-[HMObject cusProperty])
    }
  }
}
```

&emsp;çœ‹åˆ°æ–¹æ³•çš„ TypeEncoding å¦‚ä¸‹:

&emsp;types = 0x0000000100000f79 "@16@0:8" ä»å·¦å‘å³åˆ†åˆ«è¡¨ç¤ºçš„å«ä¹‰æ˜¯: @ è¡¨ç¤ºè¿”å›ç±»å‹æ˜¯ OC å¯¹è±¡ï¼Œ16 è¡¨ç¤ºæ‰€æœ‰å‚æ•°æ€»é•¿åº¦ï¼Œå†å¾€å @ è¡¨ç¤ºç¬¬ä¸€ä¸ªå‚æ•°çš„ç±»å‹ï¼Œå¯¹åº”å‡½æ•°è°ƒç”¨çš„ self ç±»å‹ï¼Œ0 è¡¨ç¤ºä»ç¬¬ 0 ä½å¼€å§‹ï¼Œåˆ†éš”å· : è¡¨ç¤ºç¬¬äºŒä¸ªå‚æ•°ç±»å‹ï¼Œå¯¹åº” SELï¼Œ8 è¡¨ç¤ºä»ç¬¬ 8 ä½å¼€å§‹ï¼Œå› ä¸ºå‰é¢çš„ä¸€ä¸ªå‚æ•° self å  8 ä¸ªå­—èŠ‚ã€‚ä¸‹é¢å¼€å§‹æ˜¯è‡ªå®šä¹‰å‚æ•°ï¼Œå› ä¸º getter å‡½æ•°æ²¡æœ‰è‡ªå®šä¹‰å‡½æ•°ï¼Œæ‰€ä»¥åªæœ‰ self å’Œ SEL å‚æ•°å°±ç»“æŸäº†ã€‚å¯¹åº”çš„å‡½æ•°åŸå‹æ­£æ˜¯ objc_msgSend å‡½æ•°:

```c++
void
objc_msgSend(void /* id self, SEL op, ... */ )
```

9. æ‰“å°å‰©ä¸‹çš„ä¸¤ä¸ª method
```c++
(lldb) p $10.get(1)
(method_t) $11 = {
  name = "setCusProperty:"
  types = 0x0000000100000f81 "v24@0:8@16"
  imp = 0x0000000100000c60 (KCObjcTest`-[HMObject setCusProperty:])
}
(lldb) p $10.get(2)
(method_t) $12 = {
  name = ".cxx_destruct"
  types = 0x0000000100000f71 "v16@0:8"
  imp = 0x0000000100000c00 (KCObjcTest`-[HMObject .cxx_destruct])
}
```

&emsp;çœ‹åˆ°ä¸€ä¸ªæ˜¯ cusProperty çš„ setter å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯ C++ çš„ææ„å‡½æ•°ã€‚

&emsp;ä¸ºäº†åšå‡ºå¯¹æ¯”ï¼Œæˆ‘ä»¬æ³¨é‡Šæ‰  HMObject.h ä¸­çš„ cusProperty å±æ€§ï¼Œç„¶åé‡èµ°ä¸Šé¢çš„æµç¨‹ï¼Œå¯æ‰“å°å‡ºå¦‚ä¸‹ä¿¡æ¯:

```c++
(lldb) x/5gx cls
0x100002240: 0x0000000100002218 0x00000001003ee140
0x100002250: 0x00000001003e84a0 0x0000001000000000
0x100002260: 0x00000001006696c0
(lldb) p (class_data_bits_t *)0x100002260
(class_data_bits_t *) $1 = 0x0000000100002260
(lldb) p $1->data()
(class_rw_t *) $2 = 0x00000001006696c0
(lldb) p $2->ro
(const class_ro_t *) $3 = 0x0000000100002118
(lldb) p *$3
(const class_ro_t) $4 = {
  flags = 128
  instanceStart = 8
  instanceSize = 8
  reserved = 0
  ivarLayout = 0x0000000000000000
  name = 0x0000000100000f22 "HMObject"
  baseMethodList = 0x0000000000000000
  baseProtocols = 0x0000000000000000
  ivars = 0x0000000000000000
  weakIvarLayout = 0x0000000000000000
  baseProperties = 0x0000000000000000
  _swiftMetadataInitializer_NEVER_USE = {}
}
(lldb) 
```

&emsp;å¯çœ‹åˆ° ivarsã€baseProperties å’Œ baseMethodList éƒ½æ˜¯ 0x0000000000000000ï¼Œå³ç¼–è¯‘å™¨æ²¡æœ‰ä¸º HMObject ç”Ÿæˆå±æ€§ã€æˆå‘˜å˜é‡å’Œå‡½æ•°ã€‚è‡³æ­¤ @property çš„ä½œç”¨å¯å¾—åˆ°å®Œæ•´è¯æ˜ã€‚

&emsp;@property èƒ½å¤Ÿä¸ºæˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆå®ä¾‹å˜é‡ä»¥åŠå­˜å–æ–¹æ³•ï¼Œè€Œè¿™ä¸‰è€…æ„æˆäº†å±æ€§è¿™ä¸ªç±»ä¼¼äºè¯­æ³•ç³–çš„æ¦‚å¿µï¼Œä¸ºæˆ‘ä»¬æä¾›äº†æ›´ä¾¿åˆ©çš„ç‚¹è¯­æ³•æ¥è®¿é—®å±æ€§ï¼š

> &emsp;self.property ç­‰ä»·äº [self property];
> &emsp;self.property = value; ç­‰ä»·äº [self setProperty:value];

&emsp;ä¹ æƒ¯äº C/C++ ç»“æ„ä½“å’Œç»“æ„ä½“æŒ‡é’ˆå–ç»“æ„ä½“æˆå‘˜å˜é‡æ—¶ä½¿ç”¨ `.` å’Œ `->`ã€‚åˆè§ OC çš„ç‚¹è¯­æ³•æ—¶æœ‰ä¸€ä¸ç–‘é—®ï¼Œself æ˜æ˜æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œè®¿é—®å®ƒçš„æˆå‘˜å˜é‡æ—¶ä¸ºä»€ä¹ˆå¯ä»¥ç”¨ `.` å‘¢ï¼Ÿå¦‚æœæŒ‰ C/C++ çš„è§„åˆ™ï¼Œä¸æ˜¯åº”è¯¥ä½¿ç”¨ self->_property å—ï¼Ÿ

&emsp;è¿™é‡Œæˆ‘ä»¬åº”ä¸ C/C++ çš„ç‚¹è¯­æ³•åšå‡ºåŒºåˆ«ç†è§£ï¼ŒOC ä¸­ç‚¹è¯­æ³•æ˜¯ç”¨æ¥å¸®åŠ©æˆ‘ä»¬ä¾¿æ·è®¿é—®å±æ€§çš„ï¼Œåœ¨ç±»å†…éƒ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ \_proertyã€self->_propery å’Œ self.property ä¸‰ç§æ–¹å¼è®¿é—®åŒä¸€ä¸ªæˆå‘˜å˜é‡ï¼ŒåŒºåˆ«åœ¨äºä½¿ç”¨ self.property æ˜¯é€šè¿‡è°ƒç”¨ property çš„ setter å’Œ getter æ¥è¯»å–æˆå‘˜å˜é‡ï¼Œè€Œå‰ä¸¤ç§åˆ™æ˜¯ç›´æ¥è¯»å–ï¼Œå› æ­¤å½“æˆ‘ä»¬é‡å†™å±æ€§çš„ setter å’Œ getter å¹¶åœ¨å†…éƒ¨åšä¸€äº›è‡ªå®šä¹‰æ“ä½œæ—¶ï¼Œæˆ‘ä»¬ä¸€å®šè¦è®°å¾—ä½¿ç”¨ self.property æ¥è®¿é—®å±æ€§è€Œä¸æ˜¯ç›´æ¥è®¿é—®æˆå‘˜å˜é‡ã€‚

***

## 63. Associated Object åŸç†ã€‚
&emsp;æˆ‘ä»¬ä½¿ç”¨ objc_setAssociatedObject å’Œ objc_getAssociatedObject æ¥åˆ†åˆ«æ¨¡æ‹Ÿå±æ€§çš„å­˜å–æ–¹æ³•ï¼Œè€Œä½¿ç”¨å…³è”å¯¹è±¡æ¨¡æ‹Ÿå®ä¾‹å˜é‡ã€‚runtime.h ä¸­å®šä¹‰äº†å¦‚ä¸‹ä¸‰ä¸ªä¸å…³è”å¯¹è±¡ç›¸å…³çš„å‡½æ•°æ¥å£:

&emsp;objc_setAssociatedObject ä½¿ç”¨ç»™å®šçš„é”®å’Œå…³è”ç­–ç•¥ä¸ºç»™å®šçš„æºå¯¹è±¡è®¾ç½®å…³è”çš„å€¼ã€‚
```c++
/** 
 * @param object è¦è¿›è¡Œå…³è”è¡Œä¸ºçš„æºå¯¹è±¡
 * @param key å…³è”çš„ key
 * @param value ä¸æºå¯¹è±¡çš„é”®ç›¸å…³è”çš„å€¼ã€‚ä¼ é€’ nil ä»¥æ¸…é™¤ç°æœ‰çš„å…³è”ã€‚
 * @param policy å…³è”ç­–ç•¥
 * 
 * @see objc_setAssociatedObject
 * @see objc_removeAssociatedObjects
 */
OBJC_EXPORT void
objc_setAssociatedObject(id _Nonnull object, const void * _Nonnull key,
                         id _Nullable value, objc_AssociationPolicy policy);
```
&emsp;objc_getAssociatedObject è¿”å›ä¸æºå¯¹è±¡çš„ç»™å®šé”®å…³è”çš„å€¼ã€‚
```c++
/** 
 * @param object å…³è”çš„æºå¯¹è±¡
 * @param key The å…³è”çš„ key
 * @return The value associated with the key \e key for \e object.
 * 
 * @see objc_setAssociatedObject
 */
OBJC_EXPORT id _Nullable
objc_getAssociatedObject(id _Nonnull object, const void * _Nonnull key);
```
&emsp;objc_removeAssociatedObjects åˆ é™¤ç»™å®šå¯¹è±¡çš„æ‰€æœ‰å…³è”ã€‚
```c++
/** 
 * æ„æŒ‡æ­¤å‡½æ•°ä¼šä¸€ä¸‹åˆ é™¤å¯¹è±¡å…¨éƒ¨çš„å…³è”å¯¹è±¡ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦åˆ é™¤æŒ‡å®šçš„å…³è”å¯¹è±¡ï¼Œ
 * åº”è¯¥ä½¿ç”¨ objc_setAssociatedObject å‡½æ•°æŠŠ value å‚æ•°ä¼ é€’ nil å³å¯ã€‚
 *
 * æ­¤åŠŸèƒ½çš„ä¸»è¦ç›®çš„æ˜¯ä½¿å¯¹è±¡è½»æ¾è¿”å› â€œåŸå§‹çŠ¶æ€â€ï¼Œå› æ­¤ä¸åº”ä»è¯¥å¯¹è±¡ä¸­æ™®éåˆ é™¤å…³è”ï¼Œ
 * å› ä¸ºå®ƒè¿˜ä¼šåˆ é™¤å…¶ä»– clients å¯èƒ½å·²æ·»åŠ åˆ°è¯¥å¯¹è±¡çš„å…³è”ã€‚
 * é€šå¸¸ï¼Œä½ åº”è¯¥å°† objc_setAssociatedObject ä¸ nil ä¸€èµ·ä½¿ç”¨ä»¥æ¸…é™¤æŒ‡å®šå…³è”ã€‚
 * 
 * @see objc_setAssociatedObject
 * @see objc_getAssociatedObject
 */
OBJC_EXPORT void
objc_removeAssociatedObjects(id _Nonnull object);
```

&emsp;å­˜å–å‡½æ•°ä¸­çš„å‚æ•° key æˆ‘ä»¬éƒ½ä½¿ç”¨äº† @selector(categoryProperty)ï¼Œå…¶å®ä¹Ÿå¯ä»¥ä½¿ç”¨é™æ€æŒ‡é’ˆ static void * ç±»å‹çš„å‚æ•°æ¥ä»£æ›¿ï¼Œä¸è¿‡è¿™é‡Œå¼ºçƒˆå»ºè®®ä½¿ç”¨ @selector(categoryProperty) ä½œä¸º key ä¼ å…¥ï¼Œå› ä¸ºè¿™ç§æ–¹æ³•çœç•¥äº†å£°æ˜å‚æ•°çš„ä»£ç ï¼Œå¹¶ä¸”èƒ½å¾ˆå¥½åœ°ä¿è¯ key çš„å”¯ä¸€æ€§ã€‚

&emsp;policy ä»£è¡¨å…³è”ç­–ç•¥:
```c++
/**
 * ä¸å…³è”å¼•ç”¨ç›¸å…³çš„ç­–ç•¥ã€‚
 */
typedef OBJC_ENUM(uintptr_t, objc_AssociationPolicy) {
    /**< Specifies a weak reference to the associated object. */
    OBJC_ASSOCIATION_ASSIGN = 0,    
    
    /**< Specifies a strong reference to the associated object. 
    *   The association is not made atomically. */
    OBJC_ASSOCIATION_RETAIN_NONATOMIC = 1, 
    
    /**< Specifies that the associated object is copied. 
    *   The association is not made atomically. */
    OBJC_ASSOCIATION_COPY_NONATOMIC = 3,
    
    /**< Specifies a strong reference to the associated object.
    *   The association is made atomically. */
    OBJC_ASSOCIATION_RETAIN = 01401,
    
    /**< Specifies that the associated object is copied.
    *   The association is made atomically. */
    OBJC_ASSOCIATION_COPY = 01403          
};
```
&emsp;æ³¨é‡Šå·²ç»è§£é‡Šçš„å¾ˆæ¸…æ¥šäº†ï¼Œå³ä¸åŒçš„ç­–ç•¥å¯¹åº”ä¸åŒçš„ä¿®é¥°ç¬¦:

| objc_AssociationPolicy | ä¿®é¥°ç¬¦ |
| ... | ... |
| OBJC_ASSOCIATION_ASSIGN | assign |
| OBJC_ASSOCIATION_RETAIN_NONATOMIC | nonatomicã€strong |
| OBJC_ASSOCIATION_COPY_NONATOMIC | nonatomicã€copy |
| OBJC_ASSOCIATION_RETAIN | atomic, strong |
| OBJC_ASSOCIATION_COPY | atomic, copy |

&emsp;ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ Associated Object æœºåˆ¶ä¸­å‡ ä¸ªå…³é”®çš„æ•°æ®ç»“æ„ã€‚

&emsp;**class ObjcAssociation** ç”¨äºä¿å­˜å…³è”ç­–ç•¥ å’Œå…³è”å€¼ã€‚
```c++
class ObjcAssociation {
    // typedef unsigned long uintptr_t;
    uintptr_t _policy; // å…³è”ç­–ç•¥
    id _value; // å…³è”å€¼
public:

    ...
    
    // åœ¨ SETTER æ—¶è°ƒç”¨ï¼Œæ ¹æ®å…³è”ç­–ç•¥ _policy åˆ¤æ–­æ˜¯å¦éœ€è¦æŒæœ‰ _value
    inline void acquireValue() {
        if (_value) {
            switch (_policy & 0xFF) {
            case OBJC_ASSOCIATION_SETTER_RETAIN:
                _value = objc_retain(_value); // retainï¼Œè°ƒç”¨ objc_retain å‡½æ•°
                break;
            case OBJC_ASSOCIATION_SETTER_COPY:
                _value = ((id(*)(id, SEL))objc_msgSend)(_value, @selector(copy)); // copyï¼Œè°ƒç”¨ copy å‡½æ•°
                break;
            }
        }
    }
    
    // åœ¨ SETTER æ—¶è°ƒç”¨ï¼šä¸ä¸Šé¢çš„ acquireValue å‡½æ•°å¯¹åº”å½“éœ€è¦è¿›è¡Œé‡Šæ”¾æ—§å€¼ _value æ—¶è°ƒç”¨ 
    inline void releaseHeldValue() {
        if (_value && (_policy & OBJC_ASSOCIATION_SETTER_RETAIN)) {
            objc_release(_value); // release å‡å°‘å¼•ç”¨è®¡æ•°
        }
    }

    // åœ¨ GETTER æ—¶è°ƒç”¨ï¼šæ ¹æ®å…³è”ç­–ç•¥åˆ¤æ–­æ˜¯å¦å¯¹ ReturnedValue è¿›è¡Œ retain æ“ä½œ
    inline void retainReturnedValue() {
        if (_value && (_policy & OBJC_ASSOCIATION_GETTER_RETAIN)) {
            objc_retain(_value);
        }
    }
    
    // åœ¨ GETTER æ—¶ä½¿ç”¨ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦æŠŠ _value æ”¾è¿›è‡ªåŠ¨é‡Šæ”¾æ± 
    inline id autoreleaseReturnedValue() {
        if (slowpath(_value && (_policy & OBJC_ASSOCIATION_GETTER_AUTORELEASE))) {
            return objc_autorelease(_value);
        }
        return _value;
    }
};
```

&emsp;typedef DenseMap<const void *, ObjcAssociation> ObjectAssociationMap; **ObjectAssociationMap** æ˜¯ä¸€ä¸ª key æ˜¯ const void *ï¼Œvalue æ˜¯ ObjcAssociation çš„å“ˆå¸Œè¡¨ã€‚ï¼ˆconst void * æ˜¯æˆ‘ä»¬ç”¨äºå…³è”å¯¹è±¡æ—¶ä½¿ç”¨çš„ keyï¼‰

&emsp;typedef DenseMap<DisguisedPtr<objc_object>, ObjectAssociationMap> AssociationsHashMap; **AssociationsHashMap** æ˜¯ä¸€ä¸ª key æ˜¯ DisguisedPtr<objc_object>ï¼Œvalue æ˜¯ ObjectAssociationMap çš„å“ˆå¸Œè¡¨ã€‚ï¼ˆDisguisedPtr<objc_object>  æ˜¯æˆ‘ä»¬çš„æºå¯¹è±¡çš„æŒ‡é’ˆåœ°å€ï¼Œä¼ªè£…ä¸ºä¸€ä¸ªæ•´æ•°ä½¿ç”¨ï¼‰

&emsp;AssociationsManager çš„ç±»å®šä¹‰ä¸å¤æ‚ï¼Œä»æ•°æ®ç»“æ„è§’åº¦æ¥çœ‹çš„è¯å®ƒæ˜¯ä½œä¸ºä¸€ä¸ª key æ˜¯ DisguisedPtr<objc_object>ï¼Œvalue æ˜¯ ObjectAssociationMap çš„å“ˆå¸Œè¡¨æ¥ç”¨çš„ï¼Œè¿™ä¹ˆçœ‹å®ƒå¥½åƒå’Œä¸Šé¢çš„ AssociationsHashMap æœ‰äº›é‡åˆï¼Œå…¶å®å®ƒå†…éƒ¨æ­£æ˜¯å­˜å‚¨äº†ä¸€ä¸ªå±€éƒ¨é™æ€çš„ AssociationsHashMap ç”¨æ¥å­˜å‚¨ç¨‹åºä¸­ Associated Object æœºåˆ¶æ‰€æœ‰çš„å…³è”å¯¹è±¡ã€‚

```c++
class AssociationsManager {
    // Storage æ¨¡ç‰ˆç±»å
    using Storage = ExplicitInitDenseMap<DisguisedPtr<objc_object>, ObjectAssociationMap>;
    // é™æ€å˜é‡ _mapStoreageï¼Œç”¨äºå­˜å‚¨ AssociationsHashMap æ•°æ®
    static Storage _mapStorage;
    
    ...
    // è¿”å›å†…éƒ¨çš„ä¿å­˜çš„ AssociationsHashMapï¼Œ
    AssociationsHashMap &get() {
        return _mapStorage.get();
    }
    ...
};
```
&emsp;ç»¼ä¸Š Associated Object æ‰€ä½¿ç”¨çš„æ•°æ®ç»“æ„å¯æ€»ç»“å¦‚ä¸‹ï¼š

1. é€šè¿‡ AssociationsManager çš„ get å‡½æ•°å–å¾—ä¸€ä¸ªå…¨å±€çš„ AssociationsHashMapã€‚
2. æ ¹æ®æˆ‘ä»¬æºå¯¹è±¡çš„ DisguisedPtr<objc_object> ä» AssociationsHashMap å–å¾— ObjectAssociationMapã€‚
3. æ ¹æ®æˆ‘ä»¬æŒ‡å®šçš„å…³è” keyï¼ˆconst void *keyï¼‰ä» ObjectAssociationMap å–å¾— ObjcAssociationã€‚
4. ObjcAssociation çš„ä¸¤ä¸ªæˆå‘˜å˜é‡åˆ†åˆ«ä¿å­˜äº†æˆ‘ä»¬çš„å…³è”ç­–ç•¥ \_policy å’Œå…³è”å€¼ \_valueã€‚

&emsp;forbidsAssociatedObjectsï¼ˆè¡¨ç¤ºæ˜¯å¦å…è®¸æŸä¸ªç±»çš„å®ä¾‹å¯¹è±¡è¿›è¡Œ Associated Objectï¼‰
```c++
// class does not allow associated objects on its instances
#define RW_FORBIDS_ASSOCIATED_OBJECTS       (1<<20)

bool forbidsAssociatedObjects() {
    return (data()->flags & RW_FORBIDS_ASSOCIATED_OBJECTS);
}
```

&emsp;setHasAssociatedObjects è®¾ç½®å¯¹è±¡çš„ isa ä¸­çš„ uintptr_t has_assoc : 1; ä½ï¼Œæ ‡è®°è¯¥å¯¹è±¡å­˜åœ¨å…³è”å¯¹è±¡ï¼Œè¯¥å¯¹è±¡è¿›è¡Œ dealloc æ—¶åˆ™è¦è¿›è¡Œæ¸…ç†å·¥ä½œã€‚

&emsp;\_object_set_associative_reference å³æ˜¯ objc_setAssociatedObject å‡½æ•°çš„å†…éƒ¨å®ç°ï¼Œæ˜¯å®Œæ•´çš„ä¸ºæºå¯¹è±¡æ·»åŠ   Associated Object çš„è¿‡ç¨‹ã€‚
```c++
void
_object_set_associative_reference(id object, const void *key, id value, uintptr_t policy)
{
    // This code used to work when nil was passed for object and key. Some code
    // probably relies on that to not crash. Check and handle it explicitly.
    // rdar://problem/44094390
    if (!object && !value) return; // åˆ¤ç©ºå¯¹è±¡å’Œå…³è”å€¼éƒ½ä¸º nil åˆ™ return

    // åˆ¤æ–­è¯¥ç±»æ˜¯å¦å…è®¸å…³è”å¯¹è±¡
    if (object->getIsa()->forbidsAssociatedObjects())
        _objc_fatal("objc_setAssociatedObject called on instance (%p) of class %s which does not allow associated objects", object, object_getClassName(object));

    // ä¼ªè£… object æŒ‡é’ˆä¸º disguised
    DisguisedPtr<objc_object> disguised{(objc_object *)object};
    // æ ¹æ®å…¥å‚åˆ›å»ºä¸€ä¸ª association (å…³è”ç­–ç•¥å’Œå…³è”å€¼)
    ObjcAssociation association{policy, value};

    // retain the new value (if any) outside the lock.
    // åœ¨åŠ é”ä¹‹å‰æ ¹æ®å…³è”ç­–ç•¥åˆ¤æ–­æ˜¯å¦ retain/copy å…¥å‚ value 
    association.acquireValue();

    {
        // åˆ›å»º mananger ä¸´æ—¶å˜é‡
        // è¿™é‡Œè¿˜æœ‰ä¸€æ­¥è¿å¸¦æ“ä½œ
        // åœ¨å…¶æ„é€ å‡½æ•°ä¸­ AssociationsManagerLock.lock() åŠ é”
        AssociationsManager manager;
        // å–å¾—å…¨å±€çš„ AssociationsHashMap
        AssociationsHashMap &associations(manager.get());

        if (value) {
            // è¿™é‡Œ DenseMap å¯¹æˆ‘ä»¬è€Œè¨€æ˜¯ä¸€ä¸ªé»‘ç›’ï¼Œè¿™é‡Œåªè¦çœ‹ try_emplace å‡½æ•°
            
            // åœ¨å…¨å±€ AssociationsHashMap ä¸­å°è¯•æ’å…¥ <DisguisedPtr<objc_object>, ObjectAssociationMap> 
            // è¿”å›å€¼ç±»å‹æ˜¯ std::pair<iterator, bool>
            auto refs_result = associations.try_emplace(disguised, ObjectAssociationMap{});
            // å¦‚æœæ–°æ’å…¥æˆåŠŸ
            if (refs_result.second) {
                /* it's the first association we make */
                // ç¬¬ä¸€æ¬¡å»ºç«‹ association
                // è®¾ç½® uintptr_t has_assoc : 1; ä½ï¼Œæ ‡è®°è¯¥å¯¹è±¡å­˜åœ¨å…³è”å¯¹è±¡ 
                object->setHasAssociatedObjects();
            }

            /* establish or replace the association */
            // é‡å»ºæˆ–è€…æ›¿æ¢ association
            auto &refs = refs_result.first->second;
            
            auto result = refs.try_emplace(key, std::move(association));
            if (!result.second) {
                // æ›¿æ¢
                // å¦‚æœä¹‹å‰æœ‰æ—§å€¼çš„è¯æŠŠæ—§å€¼çš„æˆå‘˜å˜é‡äº¤æ¢åˆ° association
                // ç„¶ååœ¨ å‡½æ•°æ‰§è¡Œç»“æŸæ—¶æŠŠæ—§å€¼æ ¹æ®å¯¹åº”çš„å…³è”ç­–ç•¥åˆ¤æ–­æ‰§è¡Œ release
                association.swap(result.first->second);
            }
        } else {
            // value ä¸º nil çš„æƒ…å†µï¼Œè¡¨ç¤ºè¦æŠŠä¹‹å‰çš„å…³è”å¯¹è±¡ç½®ä¸º nil
            // ä¹Ÿå¯ç†è§£ä¸ºç§»é™¤æŒ‡å®šçš„å…³è”å¯¹è±¡
            auto refs_it = associations.find(disguised);
            if (refs_it != associations.end()) {
                auto &refs = refs_it->second;
                auto it = refs.find(key);
                if (it != refs.end()) {
                    association.swap(it->second);
                    // æ¸…é™¤æŒ‡å®šçš„å…³è”å¯¹è±¡
                    refs.erase(it);
                    // å¦‚æœå½“å‰ object çš„å…³è”å¯¹è±¡ä¸ºç©ºäº†ï¼Œåˆ™åŒæ—¶ä»å…¨å±€çš„ AssociationsHashMap
                    // ä¸­ç§»é™¤è¯¥å¯¹è±¡
                    if (refs.size() == 0) {
                        associations.erase(refs_it);
                    }
                }
            }
        }
        
        // ææ„ mananger ä¸´æ—¶å˜é‡
        // è¿™é‡Œè¿˜æœ‰ä¸€æ­¥è¿å¸¦æ“ä½œ
        // åœ¨å…¶ææ„å‡½æ•°ä¸­ AssociationsManagerLock.unlock() è§£é”
    }

    // release the old value (outside of the lock).
    // å¼€å§‹æ—¶ retain çš„æ˜¯æ–°å…¥å‚çš„ value, è¿™é‡Œé‡Šæ”¾çš„æ˜¯æ—§å€¼ï¼Œassociation å†…éƒ¨çš„ value å·²ç»è¢«æ›¿æ¢äº†
    association.releaseHeldValue();
}
```

&emsp;\_object_get_associative_reference å³æ˜¯ objc_getAssociatedObject å‡½æ•°çš„å†…éƒ¨å®ç°ï¼Œæ˜¯æ ¹æ® key è¯»å–æºå¯¹è±¡æŒ‡å®šçš„ Associated Objectã€‚ 
```c++
id
_object_get_associative_reference(id object, const void *key)
{
    // å±€éƒ¨å˜é‡
    ObjcAssociation association{};

    {
        // åŠ é”
        AssociationsManager manager;
        // å–å¾—å…¨å±€å”¯ä¸€çš„ AssociationsHashMap
        AssociationsHashMap &associations(manager.get());
        
        // ä»å…¨å±€çš„ AssociationsHashMap ä¸­å–å¾—å¯¹è±¡å¯¹åº”çš„ ObjectAssociationMap
        AssociationsHashMap::iterator i = associations.find((objc_object *)object);
        if (i != associations.end()) {
            // å¦‚æœå­˜åœ¨
            ObjectAssociationMap &refs = i->second;
            // ä» ObjectAssocationMap ä¸­å–å¾— key å¯¹åº”çš„ ObjcAssociation 
            ObjectAssociationMap::iterator j = refs.find(key);
            if (j != refs.end()) {
                // å¦‚æœå­˜åœ¨
                association = j->second;
                // æ ¹æ®å…³è”ç­–ç•¥åˆ¤æ–­æ˜¯å¦éœ€è¦å¯¹ _value æ‰§è¡Œ retain æ“ä½œ
                association.retainReturnedValue();
            }
        }
        // è§£é”
    }
    // è¿”å› _value å¹¶æ ¹æ®å…³è”ç­–ç•¥åˆ¤æ–­æ˜¯å¦éœ€è¦æ”¾å…¥è‡ªåŠ¨é‡Šæ”¾æ± 
    return association.autoreleaseReturnedValue();
}
```

&emsp;\_object_remove_assocations ç§»é™¤æ‰€æœ‰æºå¯¹è±¡çš„ Associated Objectsã€‚
```c++
// Unlike setting/getting an associated reference, 
// this function is performance sensitive because
// of raw isa objects (such as OS Objects) that can't
// track whether they have associated objects.

// ä¸ setting/getting å…³è”å¼•ç”¨ä¸åŒï¼Œæ­¤å‡½æ•°å¯¹æ€§èƒ½æ•æ„Ÿï¼Œ
// å› ä¸ºåŸå§‹çš„ isa å¯¹è±¡ï¼ˆä¾‹å¦‚ OS å¯¹è±¡ï¼‰æ— æ³•è·Ÿè¸ªå®ƒä»¬æ˜¯å¦å…·æœ‰å…³è”çš„å¯¹è±¡ã€‚
void
_object_remove_assocations(id object)
{
    // å¯¹è±¡å¯¹åº”çš„ ObjectAssociationMap
    ObjectAssociationMap refs{};

    {
        // åŠ é”
        AssociationsManager manager;
        // å–å¾—å…¨å±€çš„ AssociationsHashMap
        AssociationsHashMap &associations(manager.get());
        
        // å–å¾—å¯¹è±¡çš„å¯¹åº” ObjectAssociationMapï¼Œé‡Œé¢åŒ…å«æ‰€æœ‰çš„ (key, ObjcAssociation)
        AssociationsHashMap::iterator i = associations.find((objc_object *)object);
        if (i != associations.end()) {
            // æŠŠ i->second çš„å†…å®¹éƒ½è½¬å…¥ refs å¯¹è±¡ä¸­
            refs.swap(i->second);
            // ä»å…¨å±€ AssociationsHashMap ç§»é™¤å¯¹è±¡çš„ ObjectAssociationMap
            associations.erase(i);
        }
        
        // è§£é”
    }

    // release everything (outside of the lock).
    // éå†å¯¹è±¡çš„ ObjectAssociationMap ä¸­çš„ (key, ObjcAssociation)
    // å¯¹ ObjcAssociation çš„ _value æ ¹æ® _policy è¿›è¡Œé‡Šæ”¾
    for (auto &i: refs) {
        i.second.releaseHeldValue();
    }
}
```
&emsp;ä¸€ä¸ªå»¶ä¼¸ï¼š

&emsp;åœ¨åˆ†ç±»ä¸­åˆ°åº•èƒ½å¦å®ç°å±æ€§ï¼Ÿé¦–å…ˆè¦çŸ¥é“å±æ€§æ˜¯ä»€ä¹ˆï¼Œå±æ€§çš„æ¦‚å¿µå†³å®šäº†è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆã€‚

+ å¦‚æœæŠŠå±æ€§ç†è§£ä¸ºé€šè¿‡æ–¹æ³•è®¿é—®çš„å®ä¾‹å˜é‡ï¼Œé‚£è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆå°±æ˜¯ä¸èƒ½ï¼Œå› ä¸ºåˆ†ç±»ä¸èƒ½ä¸ºç±»å¢åŠ é¢å¤–çš„å®ä¾‹å˜é‡ã€‚
+ å¦‚æœå±æ€§åªæ˜¯ä¸€ä¸ªå­˜å–æ–¹æ³•ä»¥åŠå­˜å‚¨å€¼çš„å®¹å™¨çš„é›†åˆï¼Œé‚£ä¹ˆåˆ†ç±»å¯ä»¥å®ç°å±æ€§ã€‚

&emsp;åˆ†ç±»ä¸­å¯¹å±æ€§çš„å®ç°å…¶å®åªæ˜¯å®ç°äº†ä¸€ä¸ªçœ‹èµ·æ¥åƒå±æ€§çš„æ¥å£è€Œå·²ã€‚

## ğŸ‰ğŸ‰ğŸ‰ æœªå®Œå¾…ç»­...
