# iOSã€ŠConcurrency Programming Guide-Operation Queuesã€‹å®˜æ–¹æ–‡æ¡£

## Operation Queues
&emsp;Cocoa operations æ˜¯ä¸€ç§é¢å‘å¯¹è±¡çš„æ–¹æ³•ï¼Œç”¨äºå°è£…è¦å¼‚æ­¥æ‰§è¡Œçš„å·¥ä½œã€‚operations è¢«è®¾è®¡ä¸ºä¸ operation queue ä¸€èµ·ä½¿ç”¨ï¼Œæˆ–è€…å•ç‹¬ä½¿ç”¨ã€‚å› ä¸ºå®ƒä»¬æ˜¯åŸºäº Objective-C çš„ï¼Œæ‰€ä»¥ operations åœ¨ OS X å’Œ iOS ä¸­æœ€å¸¸ç”¨äº Cocoa-based çš„åº”ç”¨ç¨‹åºã€‚

&emsp;æœ¬ç« ä»‹ç»å¦‚ä½•å®šä¹‰å’Œä½¿ç”¨ operationsã€‚

### About Operation Objectsï¼ˆå…³äº Operation å¯¹è±¡ï¼‰
&emsp;operation å¯¹è±¡æ˜¯ NSOperation ç±»ï¼ˆåœ¨ Foundation framework ä¸­ï¼‰çš„å®ä¾‹ï¼Œç”¨äºå°è£…å¸Œæœ›åº”ç”¨ç¨‹åºæ‰§è¡Œçš„å·¥ä½œã€‚NSOperation ç±»æœ¬èº«æ˜¯ä¸€ä¸ªæŠ½è±¡åŸºç±»ï¼Œå¿…é¡»å¯¹å…¶è¿›è¡Œå­ç±»åŒ–æ‰èƒ½æ‰§è¡Œä»»ä½•æœ‰ç”¨çš„å·¥ä½œã€‚å°½ç®¡è¿™ä¸ªç±»æ˜¯æŠ½è±¡çš„ï¼Œä½†å®ƒç¡®å®æä¾›äº†å¤§é‡çš„ infrastructureï¼Œä»¥å°½é‡å‡å°‘ä½ åœ¨è‡ªå·±çš„å­ç±»ä¸­å¿…é¡»å®Œæˆçš„å·¥ä½œé‡ã€‚æ­¤å¤–ï¼ŒFoundation framework æä¾›äº†ä¸¤ä¸ªå…·ä½“çš„å­ç±»ï¼Œä½ å¯ä»¥åœ¨ç°æœ‰ä»£ç ä¸­ä½¿ç”¨å®ƒä»¬ã€‚è¡¨ 2-1 åˆ—å‡ºäº†è¿™äº›ç±»ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨æ¯ä¸ªç±»çš„æ‘˜è¦ã€‚

&emsp;Table 2-1  Operation classes of the Foundation framework

| Class | Description |
| --- | --- |
| NSInvocationOperation | ä½¿ç”¨çš„ç±»æ˜¯åŸºäºåº”ç”¨ç¨‹åºä¸­çš„å¯¹è±¡å’Œé€‰æ‹©å™¨åˆ›å»º operation å¯¹è±¡ã€‚å¦‚æœä½ å…·æœ‰å·²ç»æ‰§è¡Œæ‰€éœ€ä»»åŠ¡çš„ç°æœ‰æ–¹æ³•ï¼Œåˆ™å¯ä»¥ä½¿ç”¨æ­¤ç±»ã€‚å› ä¸ºå®ƒä¸éœ€è¦å­ç±»åŒ–ï¼Œæ‰€ä»¥è¿˜å¯ä»¥ä½¿ç”¨æ­¤ç±»ä»¥æ›´åŠ¨æ€çš„æ–¹å¼åˆ›å»º operation å¯¹è±¡ã€‚ æœ‰å…³å¦‚ä½•ä½¿ç”¨æ­¤ç±»çš„ä¿¡æ¯ï¼Œè¯·å‚è§ä¸‹é¢çš„ Creating an NSInvocationOperation Object |
| NSBlockOperation | as-is ä½¿ç”¨çš„ç±»ç”¨äºåŒæ—¶æ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ª block å¯¹è±¡ã€‚å› ä¸ºä¸€ä¸ª block operation å¯¹è±¡å¯ä»¥æ‰§è¡Œå¤šä¸ªå—ï¼Œæ‰€ä»¥å®ƒä½¿ç”¨ group è¯­ä¹‰è¿›è¡Œæ“ä½œï¼›åªæœ‰å½“æ‰€æœ‰ç›¸å…³çš„ blocks éƒ½æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œoperation æœ¬èº«æ‰è¢«è§†ä¸ºå·²å®Œæˆã€‚æœ‰å…³å¦‚ä½•ä½¿ç”¨æ­¤ç±»çš„ä¿¡æ¯ï¼Œè¯·å‚è§ä¸‹é¢çš„ Creating an NSBlockOperation Objectã€‚æ­¤ç±»åœ¨ OS X v10.6 å’Œæ›´é«˜ç‰ˆæœ¬ä¸­å¯ç”¨ã€‚æœ‰å…³ blocks çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ Blocks Programming Topicsã€‚ |
| NSOperation | ç”¨äºå®šä¹‰è‡ªå®šä¹‰ operation å¯¹è±¡çš„åŸºç±»ã€‚å­ç±»åŒ– NSOperation ä½¿ä½ èƒ½å¤Ÿå®Œå…¨æ§åˆ¶è‡ªå·±æ“ä½œçš„å®ç°ï¼ŒåŒ…æ‹¬æ›´æ”¹æ“ä½œæ‰§è¡Œå’ŒæŠ¥å‘Šå…¶çŠ¶æ€çš„é»˜è®¤æ–¹å¼ã€‚æœ‰å…³å¦‚ä½•å®šä¹‰è‡ªå®šä¹‰ operation å¯¹è±¡çš„ä¿¡æ¯ï¼Œè¯·å‚è§ Defining a Custom Operation Objectã€‚ |

&emsp;æ‰€æœ‰ operation å¯¹è±¡éƒ½æ”¯æŒä»¥ä¸‹å…³é”®åŠŸèƒ½ï¼š

+ æ”¯æŒåœ¨ operation å¯¹è±¡ä¹‹é—´å»ºç«‹ graph-based çš„ä¾èµ–å…³ç³»ã€‚è¿™äº›ä¾èµ–å…³ç³»é˜»æ­¢ç»™å®šçš„ operation åœ¨å…¶æ‰€ä¾èµ–çš„æ‰€æœ‰ operations å®Œæˆè¿è¡Œä¹‹å‰è¿è¡Œã€‚æœ‰å…³å¦‚ä½•é…ç½®ä¾èµ–é¡¹çš„ä¿¡æ¯ï¼Œè¯·å‚è§ Configuring Interoperation Dependenciesã€‚
+ æ”¯æŒå¯é€‰çš„å®Œæˆ blockï¼Œè¯¥ block åœ¨ operation çš„ä¸»ä»»åŠ¡å®Œæˆåæ‰§è¡Œã€‚ï¼ˆä»…é™ OS X v10.6 åŠæ›´é«˜ç‰ˆæœ¬ï¼‰æœ‰å…³å¦‚ä½•è®¾ç½®å®Œæˆ block çš„ä¿¡æ¯ï¼Œè¯·å‚è§ Setting Up a Completion Blockã€‚
+ æ”¯æŒä½¿ç”¨ KVO é€šçŸ¥ç›‘è§†å¯¹ operations æ‰§è¡ŒçŠ¶æ€çš„æ›´æ”¹ã€‚æœ‰å…³å¦‚ä½•è§‚å¯Ÿ KVO é€šçŸ¥çš„ä¿¡æ¯ï¼Œè¯·å‚è§ Key-Value Observing Programming Guideã€‚
+ æ”¯æŒå¯¹ operations è¿›è¡Œä¼˜å…ˆçº§æ’åºï¼Œä»è€Œå½±å“å®ƒä»¬çš„ç›¸å¯¹æ‰§è¡Œé¡ºåºã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ Changing an Operationâ€™s Execution Priorityã€‚
+ æ”¯æŒå–æ¶ˆè¯­ä¹‰ï¼Œå…è®¸ä½ åœ¨ operation æ‰§è¡Œæ—¶åœæ­¢æ“ä½œã€‚æœ‰å…³å¦‚ä½•å–æ¶ˆ operations çš„ä¿¡æ¯ï¼Œè¯·å‚è§ Canceling Operationsã€‚æœ‰å…³å¦‚ä½•åœ¨è‡ªå·±çš„ operations ä¸­æ”¯æŒå–æ¶ˆçš„ä¿¡æ¯ï¼Œè¯·å‚è§ Responding to Cancellation Eventsã€‚

&emsp;Operations æ—¨åœ¨å¸®åŠ©ä½ æé«˜åº”ç”¨ç¨‹åºä¸­çš„å¹¶å‘ç­‰çº§ã€‚Operations ä¹Ÿæ˜¯å°†åº”ç”¨ç¨‹åºçš„è¡Œä¸ºç»„ç»‡å’Œå°è£…ä¸ºç®€å•çš„ç¦»æ•£å—çš„å¥½æ–¹æ³•ã€‚ä½ å¯ä»¥å°†ä¸€ä¸ªæˆ–å¤šä¸ª operation å¯¹è±¡æäº¤åˆ°é˜Ÿåˆ—ï¼Œå¹¶è®©ç›¸åº”çš„å·¥ä½œåœ¨ä¸€ä¸ªæˆ–å¤šä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸Šå¼‚æ­¥æ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨åº”ç”¨ç¨‹åºçš„ä¸»çº¿ç¨‹ä¸Šè¿è¡Œä¸€äº›ä»£ç ã€‚

### Concurrent Versus Non-concurrent Operationsï¼ˆå¹¶è¡Œä¸éå¹¶è¡Œæ“ä½œï¼‰
&emsp;å°½ç®¡é€šå¸¸é€šè¿‡å°† operations æ·»åŠ åˆ° operation queue æ¥æ‰§è¡Œæ“ä½œï¼Œä½†ä¸éœ€è¦è¿™æ ·åšã€‚ä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨ operation å¯¹è±¡çš„ start æ–¹æ³•æ‰‹åŠ¨æ‰§è¡Œ operation å¯¹è±¡ï¼Œä½†è¿™æ ·åšå¹¶ä¸ä¿è¯ operation ä¸å…¶ä½™ä»£ç åŒæ—¶è¿è¡Œã€‚NSOperation ç±»çš„ isConcurrent æ–¹æ³•å‘Šè¯‰ä½ æ“ä½œç›¸å¯¹äºè°ƒç”¨å…¶ start æ–¹æ³•çš„çº¿ç¨‹æ˜¯åŒæ­¥è¿è¡Œè¿˜æ˜¯å¼‚æ­¥è¿è¡Œã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤æ–¹æ³•è¿”å› NOï¼Œè¿™æ„å‘³ç€ operation åœ¨è°ƒç”¨çº¿ç¨‹ä¸­åŒæ­¥è¿è¡Œã€‚

&emsp;å¦‚æœè¦å®ç°ä¸€ä¸ªå¹¶å‘ operationï¼Œä¹Ÿå°±æ˜¯ç›¸å¯¹äºè°ƒç”¨çº¿ç¨‹å¼‚æ­¥è¿è¡Œçš„ operationsï¼Œåˆ™å¿…é¡»ç¼–å†™é¢å¤–çš„ä»£ç ä»¥å¼‚æ­¥å¯åŠ¨è¯¥ operationã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥è°ƒåº¦ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ã€è°ƒç”¨ä¸€ä¸ªå¼‚æ­¥ç³»ç»Ÿå‡½æ•°æˆ–æ‰§è¡Œä»»ä½•å…¶ä»– operationsï¼Œä»¥ç¡®ä¿ start æ–¹æ³•å¯åŠ¨ä»»åŠ¡å¹¶ç«‹å³è¿”å›ï¼Œè€Œä¸”å¾ˆå¯èƒ½åœ¨ä»»åŠ¡å®Œæˆä¹‹å‰è¿”å›ã€‚

&emsp;å¤§å¤šæ•°å¼€å‘äººå‘˜ä¸åº”è¯¥éœ€è¦å®ç°å¹¶å‘ operation å¯¹è±¡ã€‚å¦‚æœæ€»æ˜¯å°† operations æ·»åŠ åˆ° operation queue ä¸­ï¼Œåˆ™ä¸éœ€è¦å®ç°å¹¶å‘ operationsã€‚å°†éå¹¶å‘ operation æäº¤åˆ° operation queue æ—¶ï¼Œé˜Ÿåˆ—æœ¬èº«ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥è¿è¡Œ operationã€‚å› æ­¤ï¼Œå°†éå¹¶å‘ operations æ·»åŠ åˆ° operation queue ä»ç„¶ä¼šå¯¼è‡´ operation å¯¹è±¡ä»£ç çš„å¼‚æ­¥æ‰§è¡Œã€‚åªæœ‰åœ¨éœ€è¦å¼‚æ­¥æ‰§è¡Œ operations è€Œä¸å°†å…¶æ·»åŠ åˆ° operation queue çš„æƒ…å†µä¸‹ï¼Œæ‰éœ€è¦å®šä¹‰å¹¶å‘æ“ä½œã€‚

&emsp;æœ‰å…³å¦‚ä½•åˆ›å»ºå¹¶å‘æ“ä½œï¼ˆconcurrent operationï¼‰çš„ä¿¡æ¯ï¼Œè¯·å‚è§ NSOperation Class Reference ä¸­çš„ Configuring Operations for Concurrent Executionã€‚

### Creating an NSInvocationOperation Objectï¼ˆåˆ›å»º NSInvocationOperation å¯¹è±¡ï¼‰
&emsp;NSInvocationOperation ç±»æ˜¯ NSOperation çš„ä¸€ä¸ªå…·ä½“å­ç±»ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œå®ƒä¼šè°ƒç”¨åœ¨æŒ‡å®šå¯¹è±¡ä¸ŠæŒ‡å®šçš„é€‰æ‹©å™¨ã€‚ä½¿ç”¨æ­¤ç±»å¯ä»¥é¿å…ä¸ºåº”ç”¨ç¨‹åºä¸­çš„æ¯ä¸ªä»»åŠ¡å®šä¹‰å¤§é‡è‡ªå®šä¹‰ operation å¯¹è±¡ï¼›å°¤å…¶æ˜¯åœ¨ä½ æ­£åœ¨ä¿®æ”¹ç°æœ‰åº”ç”¨ç¨‹åºå¹¶ä¸”å·²ç»æ‹¥æœ‰æ‰§è¡Œå¿…è¦ä»»åŠ¡æ‰€éœ€çš„å¯¹è±¡å’Œæ–¹æ³•çš„æƒ…å†µä¸‹ã€‚å¦‚æœè¦è°ƒç”¨çš„æ–¹æ³•å¯èƒ½ä¼šæ ¹æ®æƒ…å†µå‘ç”Ÿæ›´æ”¹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨è°ƒç”¨æ“ä½œæ¥æ‰§è¡ŒåŸºäºç”¨æˆ·è¾“å…¥åŠ¨æ€é€‰æ‹©çš„é€‰æ‹©å™¨ã€‚

&emsp;åˆ›å»º invocation operation çš„è¿‡ç¨‹å¾ˆç®€å•ã€‚åˆ›å»ºå¹¶åˆå§‹åŒ–ç±»çš„æ–°å®ä¾‹ï¼Œå°†è¦æ‰§è¡Œçš„æ‰€éœ€å¯¹è±¡å’Œé€‰æ‹©å™¨ä¼ é€’ç»™åˆå§‹åŒ–æ–¹æ³•ã€‚æ¸…å• 2-1 æ˜¾ç¤ºäº†ä¸€ä¸ªè‡ªå®šä¹‰ç±»ä¸­çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œå®ƒä»¬æ¼”ç¤ºäº†åˆ›å»ºè¿‡ç¨‹ã€‚taskWithData: æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„ invocation å¯¹è±¡ï¼Œå¹¶ä¸ºå…¶æä¾›å¦ä¸€ä¸ªæ–¹æ³•çš„åç§°ï¼Œè¯¥æ–¹æ³•åŒ…å«ä»»åŠ¡å®ç°ã€‚

&emsp;Listing 2-1  Creating an NSInvocationOperation object
```c++
@implementation MyCustomClass
- (NSOperation*)taskWithData:(id)data {
    NSInvocationOperation* theOp = [[NSInvocationOperation alloc] initWithTarget:self selector:@selector(myTaskMethod:) object:data];
    return theOp;
}
 
// This is the method that does the actual work of the task.
- (void)myTaskMethod:(id)data {
    // Perform the task.
}
@end
```

### Creating an NSBlockOperation Objectï¼ˆåˆ›å»º NSBlockOperation å¯¹è±¡ï¼‰
&emsp;NSBlockOperation ç±»æ˜¯ NSOperation çš„ä¸€ä¸ªå…·ä½“å­ç±»ï¼Œå®ƒå……å½“ä¸€ä¸ªæˆ–å¤šä¸ª block å¯¹è±¡çš„åŒ…è£…å™¨ã€‚æ­¤ç±»ä¸ºå·²ç»åœ¨ä½¿ç”¨ operation queues å¹¶ä¸”ä¸æƒ³åŒæ—¶åˆ›å»º dispatch queues çš„åº”ç”¨ç¨‹åºæä¾›äº†é¢å‘å¯¹è±¡çš„åŒ…è£…å™¨ã€‚ä½ è¿˜å¯ä»¥ä½¿ç”¨ block operations æ¥åˆ©ç”¨æ“ä½œä¾èµ–é¡¹ã€KVO é€šçŸ¥å’Œ dispatch queues ä¸­å¯èƒ½ä¸å¯ç”¨çš„å…¶ä»–åŠŸèƒ½ã€‚

&emsp;åˆ›å»º block operation æ—¶ï¼Œé€šå¸¸åœ¨åˆå§‹åŒ–æ—¶è‡³å°‘æ·»åŠ ä¸€ä¸ª blockï¼›ä»¥åå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤š blocksã€‚å½“æ‰§è¡Œä¸€ä¸ª NSBlockOperation å¯¹è±¡æ—¶ï¼Œè¯¥å¯¹è±¡å°†å…¶æ‰€æœ‰çš„ blocks æäº¤åˆ°é»˜è®¤ä¼˜å…ˆçº§å¹¶å‘ dispatch queueã€‚ç„¶åï¼Œå¯¹è±¡ç­‰å¾…æ‰€æœ‰ blocks æ‰§è¡Œå®Œæ¯•ã€‚å½“æœ€åä¸€ä¸ª block å®Œæˆæ‰§è¡Œæ—¶ï¼Œoperation å¯¹è±¡å°†è‡ªå·±æ ‡è®°ä¸ºå·²å®Œæˆã€‚å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨ block operation æ¥è·Ÿè¸ªä¸€ç»„æ­£åœ¨æ‰§è¡Œçš„ blocksï¼Œå°±åƒä½¿ç”¨çº¿ç¨‹è¿æ¥æ¥åˆå¹¶å¤šä¸ªçº¿ç¨‹çš„ç»“æœä¸€æ ·ã€‚åŒºåˆ«åœ¨äºï¼Œç”±äº block operation æœ¬èº«åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸Šè¿è¡Œï¼Œæ‰€ä»¥åº”ç”¨ç¨‹åºçš„å…¶ä»–çº¿ç¨‹å¯ä»¥åœ¨ç­‰å¾… block operation å®Œæˆæ—¶ç»§ç»­å·¥ä½œã€‚

&emsp;æ¸…å• 2-2 å±•ç¤ºäº†å¦‚ä½•åˆ›å»º NSBlockOperation å¯¹è±¡çš„ç®€å•ç¤ºä¾‹ã€‚block æœ¬èº«æ²¡æœ‰å‚æ•°ï¼Œä¹Ÿæ²¡æœ‰æ˜¾è‘—çš„è¿”å›ç»“æœã€‚

&emsp;Listing 2-2  Creating an NSBlockOperation object
```c++
NSBlockOperation* theOp = [NSBlockOperation blockOperationWithBlock: ^{
   NSLog(@"Beginning operation.\n");
   // Do some work.
}];
```
&emsp;åˆ›å»º block operation å¯¹è±¡åï¼Œå¯ä»¥ä½¿ç”¨ `addExecutionBlock:` æ–¹æ³•å‘å…¶æ·»åŠ æ›´å¤š blocksã€‚å¦‚æœéœ€è¦ä¸²è¡Œæ‰§è¡Œ blocksï¼Œåˆ™å¿…é¡»å°†å®ƒä»¬ç›´æ¥æäº¤åˆ°æ‰€éœ€çš„ dispatch queueã€‚

### Defining a Custom Operation Objectï¼ˆå®šä¹‰è‡ªå®šä¹‰ Operation å¯¹è±¡ï¼‰
&emsp;å¦‚æœ block operation å’Œ invocation operation å¯¹è±¡ä¸èƒ½å®Œå…¨æ»¡è¶³åº”ç”¨ç¨‹åºçš„éœ€è¦ï¼Œå¯ä»¥ç›´æ¥å°† NSOperation å­ç±»åŒ–ï¼Œå¹¶æ·»åŠ æ‰€éœ€çš„ä»»ä½•è¡Œä¸ºã€‚NSOperation ç±»ä¸ºæ‰€æœ‰ operation å¯¹è±¡æä¾›äº†ä¸€ä¸ªé€šç”¨çš„å­ç±»åŒ–ç‚¹ï¼ˆgeneral subclassing pointï¼‰ã€‚è¯¥ç±»è¿˜æä¾›äº†å¤§é‡çš„ infrastructure æ¥å¤„ç†ä¾èµ–é¡¹å’Œ KVO é€šçŸ¥æ‰€éœ€çš„å¤§éƒ¨åˆ†å·¥ä½œã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶ä½ å¯èƒ½ä»éœ€è¦è¡¥å……ç°æœ‰çš„ infrastructureï¼Œä»¥ç¡®ä¿ä½ çš„ operations æ­£å¸¸è¿è¡Œã€‚ä½ éœ€è¦åšçš„é¢å¤–å·¥ä½œçš„æ•°é‡å–å†³äºä½ æ˜¯å®ç°éå¹¶å‘ operation è¿˜æ˜¯å¹¶å‘ operationã€‚

&emsp;å®šä¹‰éå¹¶å‘ operation æ¯”å®šä¹‰å¹¶å‘ operation ç®€å•å¾—å¤šã€‚å¯¹äºéå¹¶å‘ operationï¼Œä½ æ‰€è¦åšçš„å°±æ˜¯æ‰§è¡Œä¸»ä»»åŠ¡å¹¶é€‚å½“åœ°å“åº”å–æ¶ˆäº‹ä»¶ï¼›ç°æœ‰çš„ç±» infrastructure ä¸ºä½ å®Œæˆæ‰€æœ‰å…¶ä»–å·¥ä½œã€‚å¯¹äºå¹¶å‘æ“ä½œï¼Œå¿…é¡»ç”¨è‡ªå®šä¹‰ä»£ç æ›¿æ¢ä¸€äº›ç°æœ‰çš„ infrastructureã€‚ä»¥ä¸‹éƒ¨åˆ†å°†å‘ä½ å±•ç¤ºå¦‚ä½•å®ç°è¿™ä¸¤ç§ç±»å‹çš„å¯¹è±¡ã€‚

#### Performing the Main Taskï¼ˆæ‰§è¡Œä¸»è¦ä»»åŠ¡ï¼‰
&emsp;æ¯ä¸ª operation å¯¹è±¡è‡³å°‘åº”å®ç°ä»¥ä¸‹æ–¹æ³•ï¼š

+ è‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•ï¼ˆA custom initialization methodï¼‰
+ `main` 

&emsp;ä½ éœ€è¦ä¸€ä¸ªè‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•æ¥å°† operation å¯¹è±¡ç½®äºå·²çŸ¥çŠ¶æ€ï¼ˆknown stateï¼‰ï¼Œå¹¶éœ€è¦ä¸€ä¸ªè‡ªå®šä¹‰ `main` æ–¹æ³•æ¥æ‰§è¡Œä»»åŠ¡ã€‚å½“ç„¶ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦å®ç°å…¶ä»–æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š

+ ä½ è®¡åˆ’ä» `main` æ–¹æ³•çš„å®ç°ä¸­è°ƒç”¨çš„è‡ªå®šä¹‰æ–¹æ³•
+ ç”¨äºè®¾ç½®æ•°æ®å€¼å’Œè®¿é—® operation ç»“æœçš„è®¿é—®å™¨æ–¹æ³•ï¼ˆAccessor methodsï¼‰
+ NSCoding åè®®çš„æ–¹æ³•ï¼Œå…è®¸ä½  archive and unarchive operation å¯¹è±¡

&emsp;æ¸…å• 2-3 æ˜¾ç¤ºäº†ä¸€ä¸ªè‡ªå®šä¹‰ NSOperation å­ç±»çš„å¯åŠ¨æ¨¡æ¿ã€‚ï¼ˆæ­¤æ¸…å•æ²¡æœ‰æ˜¾ç¤ºå¦‚ä½•å¤„ç†å–æ¶ˆï¼Œä½†æ˜¾ç¤ºäº†é€šå¸¸ä½¿ç”¨çš„æ–¹æ³•ã€‚æœ‰å…³å¤„ç†å–æ¶ˆçš„ä¿¡æ¯ï¼Œè¯·å‚è§  Responding to Cancellation Eventsã€‚ï¼‰æ­¤ç±»çš„åˆå§‹åŒ–æ–¹æ³•å°†å•ä¸ªå¯¹è±¡ä½œä¸ºæ•°æ®å‚æ•°ï¼Œå¹¶åœ¨ operation å¯¹è±¡ä¸­å­˜å‚¨å¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨ã€‚åœ¨å°†ç»“æœè¿”å›ç»™åº”ç”¨ç¨‹åºä¹‹å‰ï¼Œ`main` æ–¹æ³•è¡¨é¢ä¸Šå°†å¯¹è¯¥æ•°æ®å¯¹è±¡èµ·ä½œç”¨ã€‚

&emsp;Listing 2-3  Defining a simple operation object
```c++
@interface MyNonConcurrentOperation : NSOperation

@property id (strong) myData;
- (id)initWithData:(id)data;

@end
 
@implementation MyNonConcurrentOperation

- (id)initWithData:(id)data {
   if (self = [super init])
      myData = data;
   return self;
}
 
- (void)main {
   @try {
      // Do some work on myData and report the results.
   }
   @catch(...) {
      // Do not rethrow exceptions.
   }
}

@end
```
&emsp;æœ‰å…³å¦‚ä½•å®ç° NSOperation å­ç±»çš„è¯¦ç»†ç¤ºä¾‹ï¼Œè¯·å‚è§ [NSOperationSample](https://developer.apple.com/library/archive/samplecode/NSOperationSample/Introduction/Intro.html#//apple_ref/doc/uid/DTS10004184)ã€‚

#### Responding to Cancellation Eventsï¼ˆå“åº”å–æ¶ˆäº‹ä»¶ï¼‰
&emsp;åœ¨ä¸€ä¸ª operation å¼€å§‹æ‰§è¡Œä¹‹åï¼Œå®ƒç»§ç»­æ‰§è¡Œå®ƒçš„ä»»åŠ¡ï¼Œç›´åˆ°å®ƒå®Œæˆæˆ–è€…ç›´åˆ°ä½ çš„ä»£ç æ˜¾å¼å–æ¶ˆè¯¥ operation ä¸ºæ­¢ã€‚å–æ¶ˆå¯ä»¥åœ¨ä»»ä½•æ—¶å€™å‘ç”Ÿï¼Œç”šè‡³åœ¨ operation å¼€å§‹æ‰§è¡Œä¹‹å‰ã€‚å°½ç®¡ NSOperation ç±»ä¸º clients æä¾›äº†å–æ¶ˆ operation çš„æ–¹æ³•ï¼Œä½†æ ¹æ®éœ€è¦ï¼Œè¯†åˆ«å–æ¶ˆäº‹ä»¶æ˜¯è‡ªæ„¿çš„ï¼ˆrecognizing the cancellation event is voluntary by necessityï¼‰ã€‚å¦‚æœä¸€ä¸ª operation è¢«å®Œå…¨ç»ˆæ­¢ï¼Œå¯èƒ½å°±æ²¡æœ‰åŠæ³•å›æ”¶å·²åˆ†é…çš„èµ„æºã€‚å› æ­¤ï¼Œoperation å¯¹è±¡éœ€è¦æ£€æŸ¥å–æ¶ˆäº‹ä»¶ï¼Œå¹¶åœ¨å®ƒä»¬å‘ç”Ÿåœ¨æ“ä½œè¿‡ç¨‹ä¸­æ—¶æ­£å¸¸é€€å‡ºã€‚

&emsp;è¦åœ¨ operation å¯¹è±¡ä¸­æ”¯æŒå–æ¶ˆï¼Œä½ æ‰€è¦åšçš„å°±æ˜¯å®šæœŸä»è‡ªå®šä¹‰ä»£ç ä¸­è°ƒç”¨å¯¹è±¡çš„ `isCancelled` æ–¹æ³•ï¼Œå¦‚æœè¿”å› YESï¼Œåˆ™ç«‹å³è¿”å›ã€‚æ— è®ºæ“ä½œçš„æŒç»­æ—¶é—´å¦‚ä½•ï¼Œæˆ–è€…ä½ æ˜¯ç›´æ¥å°† NSOperation å­ç±»åŒ–è¿˜æ˜¯ä½¿ç”¨å…¶å…·ä½“å­ç±»ä¹‹ä¸€ï¼Œæ”¯æŒå–æ¶ˆæ“ä½œéƒ½å¾ˆé‡è¦ã€‚`isCancelled` æ–¹æ³•æœ¬èº«æ˜¯éå¸¸è½»é‡çº§çš„ï¼Œå¯ä»¥é¢‘ç¹è°ƒç”¨ï¼Œè€Œä¸ä¼šé€ æˆä»»ä½•æ˜æ˜¾çš„æ€§èƒ½æŸå¤±ã€‚åœ¨è®¾è®¡ operation å¯¹è±¡æ—¶ï¼Œåº”è€ƒè™‘åœ¨ä»£ç ä¸­çš„ä»¥ä¸‹ä½ç½®è°ƒç”¨ `isCancelled` æ–¹æ³•ï¼š

+ åœ¨æ‰§è¡Œä»»ä½•å®é™…å·¥ä½œä¹‹å‰
+ åœ¨å¾ªç¯çš„æ¯æ¬¡è¿­ä»£ä¸­è‡³å°‘ä¸€æ¬¡ï¼Œå¦‚æœæ¯æ¬¡è¿­ä»£ç›¸å¯¹è¾ƒé•¿ï¼Œåˆ™æ›´é¢‘ç¹
+ åœ¨ä»£ç ä¸­ç›¸å¯¹å®¹æ˜“ä¸­æ­¢æ“ä½œçš„ä»»ä½•åœ°æ–¹

&emsp;æ¸…å• 2-4 æä¾›äº†ä¸€ä¸ªéå¸¸ç®€å•çš„ç¤ºä¾‹ï¼Œè¯´æ˜å¦‚ä½•åœ¨ operation å¯¹è±¡çš„ `main` æ–¹æ³•ä¸­å“åº”å–æ¶ˆäº‹ä»¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¯æ¬¡é€šè¿‡ while å¾ªç¯è°ƒç”¨ `isCancelled` æ–¹æ³•ï¼Œå…è®¸åœ¨å·¥ä½œå¼€å§‹ä¹‹å‰å¿«é€Ÿé€€å‡ºï¼Œå¹¶å®šæœŸå†æ¬¡è°ƒç”¨ã€‚

&emsp;Listing 2-4  Responding to a cancellation request
```c++
- (void)main {
   @try {
      BOOL isDone = NO;
 
      while (![self isCancelled] && !isDone) {
          // Do some work and set isDone to YES when finished
      }
   }
   @catch(...) {
      // Do not rethrow exceptions.
   }
}
```
&emsp;å°½ç®¡å‰é¢çš„ç¤ºä¾‹ä¸åŒ…å«æ¸…ç†ä»£ç ï¼Œä½†æ˜¯ä½ è‡ªå·±çš„ä»£ç åº”è¯¥ç¡®ä¿é‡Šæ”¾è‡ªå®šä¹‰ä»£ç åˆ†é…çš„æ‰€æœ‰èµ„æºã€‚

#### Configuring Operations for Concurrent Executionï¼ˆä¸ºå¹¶å‘æ‰§è¡Œé…ç½® Operationsï¼‰
&emsp;é»˜è®¤æƒ…å†µä¸‹ï¼ŒOperation å¯¹è±¡ä»¥åŒæ­¥æ–¹å¼æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä»¬åœ¨è°ƒç”¨å…¶ `start` æ–¹æ³•çš„çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ã€‚ä½†æ˜¯ï¼Œç”±äº operation queues ä¸ºéå¹¶å‘ operations æä¾›çº¿ç¨‹ï¼Œå› æ­¤å¤§å¤šæ•° operations ä»ç„¶å¼‚æ­¥è¿è¡Œã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ è®¡åˆ’æ‰‹åŠ¨æ‰§è¡Œ operationsï¼Œä½†ä»å¸Œæœ›å®ƒä»¬å¼‚æ­¥è¿è¡Œï¼Œåˆ™å¿…é¡»é‡‡å–é€‚å½“çš„æ“ä½œä»¥ç¡®ä¿å®ƒä»¬èƒ½å¤Ÿå¼‚æ­¥è¿è¡Œã€‚ä½ å¯ä»¥é€šè¿‡å°† operations å¯¹è±¡å®šä¹‰ä¸ºå¹¶å‘ operations æ¥å®ç°è¿™ä¸€ç‚¹ã€‚

&emsp;è¡¨ 2-2 åˆ—å‡ºäº†ä¸ºå®ç°å¹¶å‘ operation è€Œé€šå¸¸é‡å†™çš„æ–¹æ³•ã€‚

&emsp;Table 2-2  Methods to override for concurrent operations

| Method | Description |
| --- | --- |
| start | ï¼ˆRequiredï¼‰æ‰€æœ‰å¹¶å‘ operations éƒ½å¿…é¡»é‡å†™æ­¤æ–¹æ³•ï¼Œå¹¶ç”¨è‡ªå·±çš„è‡ªå®šä¹‰å®ç°æ›¿æ¢é»˜è®¤å®ç°ã€‚è¦æ‰‹åŠ¨æ‰§è¡Œæ“ä½œï¼Œå¯ä»¥è°ƒç”¨å…¶ start æ–¹æ³•ã€‚å› æ­¤ï¼Œæ­¤æ–¹æ³•çš„å®ç°æ˜¯æ“ä½œçš„èµ·ç‚¹ï¼Œä¹Ÿæ˜¯è®¾ç½®æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æˆ–å…¶ä»–æ‰§è¡Œç¯å¢ƒçš„åœ°æ–¹ã€‚ä½ çš„å®ç°åœ¨ä»»ä½•æ—¶å€™éƒ½ä¸èƒ½è°ƒç”¨ superã€‚ |
| main | ï¼ˆOptionalï¼‰æ­¤æ–¹æ³•é€šå¸¸ç”¨äºå®ç°ä¸ operations å¯¹è±¡å…³è”çš„ä»»åŠ¡ã€‚å°½ç®¡å¯ä»¥åœ¨ start æ–¹æ³•ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œä½†ä½¿ç”¨æ­¤æ–¹æ³•å®ç°ä»»åŠ¡å¯ä»¥ä½¿è®¾ç½®ä»£ç å’Œä»»åŠ¡ä»£ç æ›´æ¸…æ™°åœ°åˆ†ç¦»ã€‚ |
| isExecuting isFinished | ï¼ˆRequiredï¼‰å¹¶å‘ operations è´Ÿè´£è®¾ç½®å…¶æ‰§è¡Œç¯å¢ƒï¼Œå¹¶å‘å¤–éƒ¨ clients æŠ¥å‘Šè¯¥ç¯å¢ƒçš„çŠ¶æ€ã€‚å› æ­¤ï¼Œå¹¶å‘ operations å¿…é¡»ç»´æŠ¤ä¸€äº›çŠ¶æ€ä¿¡æ¯ï¼Œä»¥ä¾¿çŸ¥é“å®ƒä½•æ—¶æ‰§è¡Œä»»åŠ¡ä»¥åŠä½•æ—¶å®Œæˆä»»åŠ¡ã€‚ç„¶åï¼Œå®ƒå¿…é¡»ä½¿ç”¨è¿™äº›æ–¹æ³•æŠ¥å‘Šè¯¥çŠ¶æ€ã€‚è¿™äº›æ–¹æ³•çš„å®ç°å¿…é¡»èƒ½å¤Ÿå®‰å…¨åœ°åŒæ—¶ä»å…¶ä»–çº¿ç¨‹è°ƒç”¨ã€‚æ›´æ”¹è¿™äº›æ–¹æ³•æŠ¥å‘Šçš„å€¼æ—¶ï¼Œè¿˜å¿…é¡»ä¸ºé¢„æœŸçš„ key path ç”Ÿæˆé€‚å½“çš„ KVO é€šçŸ¥ã€‚ |
| isConcurrent | ï¼ˆRequiredï¼‰è¦å°† operations æ ‡è¯†ä¸ºå¹¶å‘æ“ä½œï¼Œè¯·é‡å†™æ­¤æ–¹æ³•å¹¶è¿”å› YESã€‚ |

&emsp;æœ¬èŠ‚çš„å…¶ä½™éƒ¨åˆ†å±•ç¤ºäº† MyOperation ç±»çš„ç¤ºä¾‹å®ç°ï¼Œå®ƒæ¼”ç¤ºäº†å®ç°å¹¶å‘æ“ä½œæ‰€éœ€çš„åŸºæœ¬ä»£ç ã€‚MyOperation ç±»åªæ˜¯åœ¨å®ƒåˆ›å»ºçš„å•ç‹¬çº¿ç¨‹ä¸Šæ‰§è¡Œè‡ªå·±çš„ main æ–¹æ³•ã€‚main æ–¹æ³•æ‰§è¡Œçš„å®é™…å·¥ä½œä¸æ­¤æ— å…³ã€‚ç¤ºä¾‹çš„é‡ç‚¹æ˜¯æ¼”ç¤ºåœ¨å®šä¹‰å¹¶å‘æ“ä½œæ—¶éœ€è¦æä¾›çš„åŸºç¡€ç»“æ„ã€‚

&emsp;æ¸…å• 2-5 æ˜¾ç¤ºäº† MyOperation ç±»çš„æ¥å£å’Œéƒ¨åˆ†å®ç°ã€‚MyOperation ç±»çš„ `isConcurrent`ã€`isExecuting` å’Œ `isFinished` æ–¹æ³•çš„å®ç°ç›¸å¯¹ç®€å•ã€‚`isConcurrent` æ–¹æ³•åº”è¯¥ç®€å•åœ°è¿”å› YES ä»¥æŒ‡ç¤ºè¿™æ˜¯ä¸€ä¸ªå¹¶å‘æ“ä½œã€‚`isExecuting` å’Œ `isFinished` æ–¹æ³•åªè¿”å›å­˜å‚¨åœ¨ç±»æœ¬èº«çš„å®ä¾‹å˜é‡ä¸­çš„å€¼ã€‚

&emsp;Listing 2-5  Defining a concurrent operation
```c++
@interface MyOperation : NSOperation {
    BOOL        executing;
    BOOL        finished;
}

- (void)completeOperation;
@end
 
@implementation MyOperation
- (id)init {
    self = [super init];
    if (self) {
        executing = NO;
        finished = NO;
    }
    return self;
}
 
- (BOOL)isConcurrent {
    return YES;
}
 
- (BOOL)isExecuting {
    return executing;
}
 
- (BOOL)isFinished {
    return finished;
}
@end
```

&emsp;æ¸…å• 2-6 æ˜¾ç¤ºäº† MyOperation çš„ `start` æ–¹æ³•ã€‚è¿™ç§æ–¹æ³•çš„å®ç°æ˜¯æœ€å°çš„ï¼Œä»¥ä¾¿æ¼”ç¤ºä½ ç»å¯¹å¿…é¡»æ‰§è¡Œçš„ä»»åŠ¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯¥æ–¹æ³•åªéœ€å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹å¹¶å°†å…¶é…ç½®ä¸ºè°ƒç”¨ `main` æ–¹æ³•ã€‚è¯¥æ–¹æ³•è¿˜æ›´æ–°æ‰§è¡Œæˆå‘˜å˜é‡ï¼Œå¹¶ä¸º `isExecuting` key path ç”Ÿæˆ KVO é€šçŸ¥ï¼Œä»¥åæ˜ è¯¥å€¼ä¸­çš„æ›´æ”¹ã€‚å®Œæˆå·¥ä½œåï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›ï¼Œè®©æ–°åˆ†ç¦»ï¼ˆæ–°å¼€è¾Ÿï¼‰çš„çº¿ç¨‹æ‰§è¡Œå®é™…ä»»åŠ¡ã€‚

&emsp;Listing 2-6  The start method
```c++
- (void)start {
   // Always check for cancellation before launching the task.
   if ([self isCancelled]) {
      // Must move the operation to the finished state if it is canceled.
      [self willChangeValueForKey:@"isFinished"];
      finished = YES;
      [self didChangeValueForKey:@"isFinished"];
      return;
   }
 
   // If the operation is not canceled, begin executing the task.
   [self willChangeValueForKey:@"isExecuting"];
   [NSThread detachNewThreadSelector:@selector(main) toTarget:self withObject:nil];
   executing = YES;
   [self didChangeValueForKey:@"isExecuting"];
}
```
&emsp;æ¸…å• 2-7 æ˜¾ç¤ºäº† MyOperation ç±»çš„å…¶ä½™å®ç°ã€‚å¦‚æ¸…å• 2-6 æ‰€ç¤ºï¼Œ`main` æ–¹æ³•æ˜¯æ–°çº¿ç¨‹çš„å…¥å£ç‚¹ã€‚å®ƒæ‰§è¡Œä¸æ“ä½œå¯¹è±¡ç›¸å…³è”çš„å·¥ä½œï¼Œå¹¶åœ¨è¯¥å·¥ä½œæœ€ç»ˆå®Œæˆæ—¶è°ƒç”¨è‡ªå®šä¹‰ `completeOperation` æ–¹æ³•ã€‚`completeOperation` æ–¹æ³•ç„¶åä¸º `isExecuting` å’Œ `isFinished` key path ç”Ÿæˆæ‰€éœ€çš„ KVO é€šçŸ¥ï¼Œä»¥åæ˜ æ“ä½œçŠ¶æ€çš„æ›´æ”¹ã€‚

&emsp;Listing 2-7  Updating an operation at completion time
```c++
- (void)main {
   @try {
       // Do the main work of the operation here.
       [self completeOperation];
   }
   @catch(...) {
      // Do not rethrow exceptions.
   }
}
 
- (void)completeOperation {
    [self willChangeValueForKey:@"isFinished"];
    [self willChangeValueForKey:@"isExecuting"];
 
    executing = NO;
    finished = YES;
 
    [self didChangeValueForKey:@"isExecuting"];
    [self didChangeValueForKey:@"isFinished"];
}
```
&emsp;å³ä½¿ operation è¢«å–æ¶ˆï¼Œä½ ä¹Ÿåº”è¯¥å§‹ç»ˆé€šçŸ¥ KVO è§‚å¯Ÿè€…ä½ çš„æ“ä½œç°åœ¨å·²ç»å®Œæˆäº†å®ƒçš„å·¥ä½œã€‚å½“ä¸€ä¸ª operation å¯¹è±¡ä¾èµ–äºå…¶ä»– operation å¯¹è±¡çš„å®Œæˆæ—¶ï¼Œå®ƒç›‘è§†è¿™äº›å¯¹è±¡çš„ isFinished key pathã€‚åªæœ‰å½“æ‰€æœ‰å¯¹è±¡éƒ½æŠ¥å‘Šå®ƒä»¬å·²å®Œæˆæ—¶ï¼Œä¾èµ– operation æ‰ä¼šå‘å‡ºå‡†å¤‡è¿è¡Œçš„ä¿¡å·ã€‚å› æ­¤ï¼Œæœªèƒ½ç”Ÿæˆå®Œæˆé€šçŸ¥å¯èƒ½ä¼šé˜»æ­¢åœ¨åº”ç”¨ç¨‹åºä¸­æ‰§è¡Œå…¶ä»– operationsã€‚

#### Maintaining KVO Complianceï¼ˆä¿æŒ KVO åˆè§„æ€§ï¼‰
&emsp;å¯¹äºä»¥ä¸‹ key pathsï¼ŒNSOperation ç±»ä¸ key-value observingï¼ˆKVOï¼‰å…¼å®¹ï¼š

+ isCancelled
+ isConcurrent
+ isExecuting
+ isFinished
+ isReady
+ dependencies
+ queuePriority
+ completionBlock

&emsp;å¦‚æœä½ é‡å†™ `start` æ–¹æ³•æˆ–å¯¹ NSOperation å¯¹è±¡è¿›è¡Œä»»ä½•é‡è¦çš„è‡ªå®šä¹‰ï¼ˆè€Œä¸æ˜¯é‡å†™ mainï¼‰ï¼Œåˆ™å¿…é¡»ç¡®ä¿ä½ çš„è‡ªå®šä¹‰å¯¹è±¡å¯¹è¿™äº› key paths ä¿æŒ KVO å…¼å®¹ã€‚é‡å†™ start æ–¹æ³•æ—¶ï¼Œä½ åº”è¯¥æœ€å…³æ³¨çš„ key paths æ˜¯ isExecuting å’Œ isFinishedã€‚è¿™äº›æ˜¯é‡æ–°å®ç°è¯¥æ–¹æ³•æœ€å¸¸è§çš„ key pathsã€‚

&emsp;å¦‚æœè¦å®ç°å¯¹é™¤å…¶ä»– operation å¯¹è±¡ä¹‹å¤–çš„å…¶ä»–å¯¹è±¡çš„ä¾èµ–å…³ç³»çš„æ”¯æŒï¼Œè¿˜å¯ä»¥é‡å†™ `isReady` æ–¹æ³•å¹¶å¼ºåˆ¶å®ƒè¿”å› NOï¼Œç›´åˆ°æ»¡è¶³è‡ªå®šä¹‰ä¾èµ–å…³ç³»ã€‚ï¼ˆå¦‚æœå®ç°è‡ªå®šä¹‰ä¾èµ–é¡¹ï¼Œå¦‚æœä»ç„¶æ”¯æŒ NSOperation ç±»æä¾›çš„é»˜è®¤ä¾èµ–é¡¹ç®¡ç†ç³»ç»Ÿï¼Œè¯·ç¡®ä¿ä» `isReady` æ–¹æ³•è°ƒç”¨ superã€‚ï¼‰å½“ operation å¯¹è±¡çš„å°±ç»ªçŠ¶æ€æ›´æ”¹æ—¶ï¼Œä¸º `isReady` key path ç”Ÿæˆ KVO é€šçŸ¥ä»¥æŠ¥å‘Šè¿™äº›æ›´æ”¹ã€‚é™¤éé‡å†™ `addDependency:` æˆ– `removeDependency:` æ–¹æ³•ï¼Œå¦åˆ™ä¸å¿…æ‹…å¿ƒä¸ºä¾èµ–é¡¹ key path ç”Ÿæˆ KVO é€šçŸ¥ã€‚

&emsp;å°½ç®¡ä½ å¯ä»¥ä¸º NSOperation çš„å…¶ä»– key paths ç”Ÿæˆ KVO é€šçŸ¥ï¼Œä½†ä½ ä¸å¤ªå¯èƒ½éœ€è¦è¿™æ ·åšã€‚å¦‚æœéœ€è¦å–æ¶ˆæ“ä½œï¼Œåªéœ€è°ƒç”¨ç°æœ‰çš„ `cancel` æ–¹æ³•å³å¯ã€‚ç±»ä¼¼åœ°ï¼Œä¸éœ€è¦ä¿®æ”¹ operation å¯¹è±¡ä¸­çš„é˜Ÿåˆ—ä¼˜å…ˆçº§ä¿¡æ¯ã€‚æœ€åï¼Œé™¤é operation èƒ½å¤ŸåŠ¨æ€æ›´æ”¹å…¶å¹¶å‘çŠ¶æ€ï¼Œå¦åˆ™ä¸éœ€è¦ä¸º `isConcurrent` key path æä¾› KVO é€šçŸ¥ã€‚

&emsp;æœ‰å…³é”®å€¼è§‚å¯Ÿä»¥åŠå¦‚ä½•åœ¨è‡ªå®šä¹‰å¯¹è±¡ä¸­æ”¯æŒå®ƒçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ Key-Value Observing Programming Guideã€‚

### Customizing the Execution Behavior of an Operation Objectï¼ˆè‡ªå®šä¹‰ Operation å¯¹è±¡çš„æ‰§è¡Œè¡Œä¸ºï¼‰
&emsp;Operation å¯¹è±¡çš„é…ç½®å‘ç”Ÿåœ¨åˆ›å»ºå®ƒä»¬ä¹‹åï¼Œä½†åœ¨å°†å®ƒä»¬æ·»åŠ åˆ°é˜Ÿåˆ—ä¹‹å‰ã€‚æœ¬èŠ‚ä¸­æè¿°çš„é…ç½®ç±»å‹å¯ä»¥åº”ç”¨äºæ‰€æœ‰ operation å¯¹è±¡ï¼Œæ— è®ºä½ æ˜¯è‡ªå·±å°† NSOperation å­ç±»åŒ–è¿˜æ˜¯ä½¿ç”¨ç°æœ‰å­ç±»ã€‚

#### Configuring Interoperation Dependenciesï¼ˆé…ç½®äº’æ“ä½œä¾èµ–é¡¹ï¼‰
&emsp;ä¾èµ–é¡¹æ˜¯åºåˆ—åŒ–ä¸åŒ operation å¯¹è±¡çš„æ‰§è¡Œçš„ä¸€ç§æ–¹æ³•ã€‚ä¾èµ–äºå…¶ä»– operation çš„ operation åœ¨å…¶ä¾èµ–çš„æ‰€æœ‰ operations å®Œæˆæ‰§è¡Œä¹‹å‰ä¸èƒ½å¼€å§‹æ‰§è¡Œã€‚å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨ä¾èµ–å…³ç³»åœ¨ä¸¤ä¸ª operation å¯¹è±¡ä¹‹é—´åˆ›å»ºç®€å•çš„ä¸€å¯¹ä¸€ä¾èµ–å…³ç³»ï¼Œæˆ–è€…æ„å»ºå¤æ‚çš„å¯¹è±¡ä¾èµ–å…³ç³»å›¾ã€‚

&emsp;è¦åœ¨ä¸¤ä¸ª operation å¯¹è±¡ä¹‹é—´å»ºç«‹ä¾èµ–å…³ç³»ï¼Œå¯ä»¥ä½¿ç”¨ NSOperation çš„ `addDependency:` æ–¹æ³•ã€‚æ­¤æ–¹æ³•åˆ›å»ºä»å½“å‰ operation å¯¹è±¡åˆ°æŒ‡å®šä¸ºå‚æ•°çš„ç›®æ ‡ operation çš„å•å‘ä¾èµ–å…³ç³»ã€‚æ­¤ä¾èµ–å…³ç³»æ„å‘³ç€åœ¨ç›®æ ‡å¯¹è±¡å®Œæˆæ‰§è¡Œä¹‹å‰ï¼Œå½“å‰å¯¹è±¡æ— æ³•å¼€å§‹æ‰§è¡Œã€‚ä¾èµ–å…³ç³»ä¹Ÿä¸é™äºåŒä¸€é˜Ÿåˆ—ä¸­çš„ operationã€‚operation å¯¹è±¡ç®¡ç†å®ƒä»¬è‡ªå·±çš„ä¾èµ–å…³ç³»ï¼Œå› æ­¤åœ¨ operation ä¹‹é—´åˆ›å»ºä¾èµ–å…³ç³»å¹¶å°†å®ƒä»¬å…¨éƒ¨æ·»åŠ åˆ°ä¸åŒçš„é˜Ÿåˆ—æ˜¯å®Œå…¨å¯ä»¥æ¥å—çš„ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€ä»¶äº‹æ˜¯ä¸å¯æ¥å—çš„ï¼Œé‚£å°±æ˜¯åœ¨ operation ä¹‹é—´åˆ›å»ºå¾ªç¯ä¾èµ–å…³ç³»ã€‚è¿™æ ·åšæ˜¯ç¨‹åºå‘˜çš„é”™è¯¯ï¼Œå®ƒå°†é˜»æ­¢å—å½±å“çš„ operation è¿è¡Œã€‚

&emsp;å½“ä¸€ä¸ª operation çš„æ‰€æœ‰ä¾èµ–é¡¹éƒ½å·²å®Œæˆæ‰§è¡Œæ—¶ï¼Œä¸€ä¸ª operation å¯¹è±¡é€šå¸¸å°±å¯ä»¥æ‰§è¡Œäº†ã€‚ï¼ˆå¦‚æœè‡ªå®šä¹‰ isReady æ–¹æ³•çš„è¡Œä¸ºï¼Œåˆ™ operation çš„å‡†å¤‡çŠ¶æ€ç”±è®¾ç½®çš„æ¡ä»¶ç¡®å®šã€‚ï¼‰å¦‚æœ operation å¯¹è±¡ä½äºé˜Ÿåˆ—ä¸­ï¼Œåˆ™é˜Ÿåˆ—å¯ä»¥éšæ—¶å¼€å§‹æ‰§è¡Œè¯¥ operationã€‚å¦‚æœè®¡åˆ’æ‰‹åŠ¨æ‰§è¡Œè¯¥ operationï¼Œåˆ™ç”±ä½ è°ƒç”¨è¯¥ operation çš„ start æ–¹æ³•ã€‚

> Important: åœ¨è¿è¡Œ operations æˆ–å°†å®ƒä»¬æ·»åŠ åˆ° operation queue ä¹‹å‰ï¼Œåº”è¯¥å§‹ç»ˆé…ç½®ä¾èµ–é¡¹ã€‚ä¹‹åæ·»åŠ çš„ä¾èµ–é¡¹å¯èƒ½ä¸ä¼šé˜»æ­¢ç»™å®šçš„ operation å¯¹è±¡è¿è¡Œã€‚

&emsp;ä¾èµ–å…³ç³»ä¾èµ–äºæ¯ä¸ª operation å¯¹è±¡åœ¨å¯¹è±¡çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶å‘é€é€‚å½“çš„ KVO é€šçŸ¥ã€‚å¦‚æœè‡ªå®šä¹‰ operation å¯¹è±¡çš„è¡Œä¸ºï¼Œåˆ™å¯èƒ½éœ€è¦ä»è‡ªå®šä¹‰ä»£ç ç”Ÿæˆé€‚å½“çš„ KVO é€šçŸ¥ï¼Œä»¥é¿å…é€ æˆä¾èµ–æ€§é—®é¢˜ã€‚æœ‰å…³ KVO é€šçŸ¥å’Œ operation å¯¹è±¡çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ Maintaining KVO Complianceã€‚æœ‰å…³é…ç½®ä¾èµ–é¡¹çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ NSOperation Class Referenceã€‚

#### Changing an Operationâ€™s Execution Priorityï¼ˆæ›´æ”¹ Operation çš„æ‰§è¡Œä¼˜å…ˆçº§ï¼‰
&emsp;å¯¹äºæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„ operationï¼Œæ‰§è¡Œé¡ºåºé¦–å…ˆç”±æ’é˜Ÿæ“ä½œçš„å°±ç»ªçŠ¶æ€å†³å®šï¼Œç„¶åç”±å®ƒä»¬çš„ç›¸å¯¹ä¼˜å…ˆçº§å†³å®šã€‚å‡†å¤‡å°±ç»ªç”± operation å¯¹å…¶ä»– operation çš„ä¾èµ–å…³ç³»å†³å®šï¼Œä½†ä¼˜å…ˆçº§æ˜¯ operation å¯¹è±¡æœ¬èº«çš„å±æ€§ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æ–° operation å¯¹è±¡éƒ½å…·æœ‰ "normal" ä¼˜å…ˆçº§ï¼Œä½†ä½ å¯ä»¥æ ¹æ®éœ€è¦é€šè¿‡è°ƒç”¨å¯¹è±¡çš„ `setQueuePriority:` æ–¹æ³•æ¥å¢åŠ æˆ–å‡å°‘è¯¥ä¼˜å…ˆçº§ã€‚

&emsp;ä¼˜å…ˆçº§ä»…é€‚ç”¨äºåŒä¸€æ“ä½œé˜Ÿåˆ—ä¸­çš„ operationã€‚å¦‚æœä½ çš„åº”ç”¨ç¨‹åºæœ‰å¤šä¸ªæ“ä½œé˜Ÿåˆ—ï¼Œåˆ™æ¯ä¸ªé˜Ÿåˆ—ç‹¬ç«‹äºä»»ä½•å…¶ä»–é˜Ÿåˆ—å¯¹è‡ªå·±çš„ operation è¿›è¡Œä¼˜å…ˆçº§æ’åºã€‚å› æ­¤ï¼Œä½ä¼˜å…ˆçº§ operation ä»ç„¶å¯ä»¥åœ¨ä¸åŒé˜Ÿåˆ—ä¸­çš„é«˜ä¼˜å…ˆçº§ operation ä¹‹å‰æ‰§è¡Œã€‚

&emsp;ä¼˜å…ˆçº§ä¸èƒ½æ›¿ä»£ä¾èµ–å…³ç³»ã€‚ä¼˜å…ˆçº§å†³å®šæ“ä½œé˜Ÿåˆ—ä»…å¼€å§‹æ‰§è¡Œå½“å‰å‡†å¤‡å°±ç»ªçš„ operation çš„é¡ºåºã€‚ä¾‹å¦‚ï¼Œå¦‚æœé˜Ÿåˆ—åŒæ—¶åŒ…å«é«˜ä¼˜å…ˆçº§å’Œä½ä¼˜å…ˆçº§ operationï¼Œå¹¶ä¸”ä¸¤ä¸ª operations éƒ½å·²å°±ç»ªï¼Œåˆ™é˜Ÿåˆ—é¦–å…ˆæ‰§è¡Œé«˜ä¼˜å…ˆçº§ operationã€‚ä½†æ˜¯ï¼Œå¦‚æœé«˜ä¼˜å…ˆçº§ operation æ²¡æœ‰å‡†å¤‡å¥½ï¼Œè€Œä½ä¼˜å…ˆçº§ operation å‡†å¤‡å¥½ï¼Œåˆ™é˜Ÿåˆ—é¦–å…ˆæ‰§è¡Œä½ä¼˜å…ˆçº§ operationã€‚å¦‚æœè¦é˜»æ­¢ä¸€ä¸ª operation åœ¨å¦ä¸€ä¸ª operation å®Œæˆä¹‹å‰å¯åŠ¨ï¼Œåˆ™å¿…é¡»æ”¹ç”¨ä¾èµ–é¡¹ï¼ˆå¦‚é…ç½®äº’æ“ä½œä¾èµ–é¡¹ä¸­æ‰€è¿°ï¼‰ã€‚

#### Changing the Underlying Thread Priorityï¼ˆæ›´æ”¹åº•å±‚çº¿ç¨‹ä¼˜å…ˆçº§ï¼‰
&emsp;åœ¨ OS X v10.6 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥é…ç½® operation çš„åº•å±‚çº¿ç¨‹çš„æ‰§è¡Œä¼˜å…ˆçº§ã€‚ç³»ç»Ÿä¸­çš„çº¿ç¨‹ç­–ç•¥æœ¬èº«ç”±å†…æ ¸ç®¡ç†ï¼Œä½†é€šå¸¸é«˜ä¼˜å…ˆçº§çº¿ç¨‹æ¯”ä½ä¼˜å…ˆçº§çº¿ç¨‹æœ‰æ›´å¤šçš„è¿è¡Œæœºä¼šã€‚åœ¨ operation å¯¹è±¡ä¸­ï¼Œå°†çº¿ç¨‹ä¼˜å…ˆçº§æŒ‡å®šä¸º 0.0 åˆ° 1.0 ä¹‹é—´çš„æµ®ç‚¹å€¼ï¼Œå…¶ä¸­ 0.0 æ˜¯æœ€ä½ä¼˜å…ˆçº§ï¼Œ1.0 æ˜¯æœ€é«˜ä¼˜å…ˆçº§ã€‚å¦‚æœæœªæŒ‡å®šæ˜¾å¼çº¿ç¨‹ä¼˜å…ˆçº§ï¼Œåˆ™ operation å°†ä»¥é»˜è®¤çº¿ç¨‹ä¼˜å…ˆçº§ 0.5 è¿è¡Œã€‚

&emsp;è¦è®¾ç½® operation çš„çº¿ç¨‹ä¼˜å…ˆçº§ï¼Œå¿…é¡»å…ˆè°ƒç”¨ operation å¯¹è±¡çš„ `setThreadPriority:` æ–¹æ³•ï¼Œç„¶åå†å°†å…¶æ·»åŠ åˆ°é˜Ÿåˆ—ï¼ˆæˆ–æ‰‹åŠ¨æ‰§è¡Œï¼‰ã€‚åœ¨æ‰§è¡Œ operation æ—¶ï¼Œé»˜è®¤çš„ `start` æ–¹æ³•ä½¿ç”¨ä½ æŒ‡å®šçš„å€¼æ¥ä¿®æ”¹å½“å‰çº¿ç¨‹çš„ä¼˜å…ˆçº§ã€‚æ­¤æ–°ä¼˜å…ˆçº§ä»…åœ¨ operation çš„ `main` æœŸé—´æœ‰æ•ˆã€‚æ‰€æœ‰å…¶ä»–ä»£ç ï¼ˆåŒ…æ‹¬ operation çš„å®Œæˆ blockï¼‰éƒ½ä»¥é»˜è®¤çº¿ç¨‹ä¼˜å…ˆçº§è¿è¡Œã€‚å¦‚æœåˆ›å»ºå¹¶å‘ operationï¼Œå› æ­¤é‡å†™ `start` æ–¹æ³•ï¼Œåˆ™å¿…é¡»è‡ªå·±é…ç½®çº¿ç¨‹ä¼˜å…ˆçº§ã€‚

#### Setting Up a Completion Blockï¼ˆè®¾ç½®å®Œæˆ blockï¼‰
&emsp;åœ¨ OS X v10.6 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œä¸€ä¸ª operation å¯ä»¥åœ¨å…¶ä¸»ä»»åŠ¡å®Œæˆæ‰§è¡Œæ—¶æ‰§è¡Œå®Œæˆ blockã€‚ä½ å¯ä»¥ä½¿ç”¨å®Œæˆ block æ¥æ‰§è¡Œä¸å±äºä¸»ä»»åŠ¡çš„ä»»ä½•å·¥ä½œã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨æ­¤ block é€šçŸ¥æ„Ÿå…´è¶£çš„ clients operation æœ¬èº«å·²å®Œæˆã€‚å¹¶å‘æ“ä½œå¯¹è±¡å¯èƒ½ä½¿ç”¨æ­¤å®Œæˆ block ç”Ÿæˆå…¶æœ€ç»ˆ KVO é€šçŸ¥ã€‚

&emsp;è¦è®¾ç½®å®Œæˆ blockï¼Œè¯·ä½¿ç”¨ NSOperation çš„ `setCompletionBlock:` æ–¹æ³•ã€‚ä¼ é€’ç»™æ­¤æ–¹æ³•çš„ block ä¸åº”æœ‰å‚æ•°å’Œè¿”å›å€¼ã€‚

### Tips for Implementing Operation Objectsï¼ˆå®ç° Operation å¯¹è±¡çš„æŠ€å·§ï¼‰
&emsp;å°½ç®¡ operation å¯¹è±¡å¾ˆå®¹æ˜“å®ç°ï¼Œä½†åœ¨ç¼–å†™ä»£ç æ—¶ï¼Œæœ‰å‡ ä»¶äº‹ä½ åº”è¯¥æ³¨æ„ã€‚ä»¥ä¸‹éƒ¨åˆ†æè¿°äº†åœ¨ä¸º operation å¯¹è±¡ç¼–å†™ä»£ç æ—¶åº”è€ƒè™‘çš„å› ç´ ã€‚

#### Managing Memory in Operation Objectsï¼ˆç®¡ç† Operation å¯¹è±¡ä¸­çš„å†…å­˜ï¼‰
&emsp;ä»¥ä¸‹å„èŠ‚æè¿°äº† operation å¯¹è±¡ä¸­è‰¯å¥½å†…å­˜ç®¡ç†çš„å…³é”®å…ƒç´ ã€‚æœ‰å…³ Objective-C ç¨‹åºä¸­å†…å­˜ç®¡ç†çš„ä¸€èˆ¬ä¿¡æ¯ï¼Œè¯·å‚è§ Advanced Memory Management Programming Guideã€‚
##### Avoid Per-Thread Storageï¼ˆé¿å…æŒ‰çº¿ç¨‹å­˜å‚¨ï¼‰
&emsp;å°½ç®¡å¤§å¤šæ•° operation éƒ½åœ¨çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œä½†åœ¨éå¹¶å‘æ“ä½œçš„æƒ…å†µä¸‹ï¼Œè¯¥çº¿ç¨‹é€šå¸¸ç”± operation queue æä¾›ã€‚å¦‚æœä¸€ä¸ª operation queue ä¸ºä½ æä¾›äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œä½ åº”è¯¥è®¤ä¸ºè¯¥çº¿ç¨‹å±äºè¯¥ queueï¼Œè€Œä¸æ˜¯è¢«ä½ çš„ operation æ‰€è§¦åŠã€‚ç‰¹åˆ«åœ°ï¼Œä½ ä¸åº”è¯¥å°†ä»»ä½•æ•°æ®ä¸ä½ è‡ªå·±ä¸åˆ›å»ºæˆ–ç®¡ç†çš„çº¿ç¨‹ç›¸å…³è”ã€‚ç”±æ“ä½œé˜Ÿåˆ—ç®¡ç†çš„çº¿ç¨‹æ¥æ¥å¾€å¾€å–å†³äºç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºçš„éœ€æ±‚ã€‚å› æ­¤ï¼Œä½¿ç”¨ Per-Thread Storage åœ¨ operation ä¹‹é—´ä¼ é€’æ•°æ®æ˜¯ä¸å¯é çš„ï¼Œè€Œä¸”å¾ˆå¯èƒ½å¤±è´¥ã€‚

&emsp;å¯¹äº operation å¯¹è±¡ï¼Œåœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸åº”è¯¥ä½¿ç”¨ per-thread storageã€‚åˆå§‹åŒ– operation å¯¹è±¡æ—¶ï¼Œåº”è¯¥ä¸ºå¯¹è±¡æä¾›æ‰§è¡Œå…¶ä»»åŠ¡æ‰€éœ€çš„ä¸€åˆ‡ã€‚å› æ­¤ï¼Œoperation å¯¹è±¡æœ¬èº«æä¾›äº†æ‰€éœ€çš„ä¸Šä¸‹æ–‡å­˜å‚¨ã€‚æ‰€æœ‰ä¼ å…¥å’Œä¼ å‡ºçš„æ•°æ®éƒ½åº”è¯¥å­˜å‚¨åœ¨é‚£é‡Œï¼Œç›´åˆ°å¯ä»¥é‡æ–°é›†æˆåˆ°åº”ç”¨ç¨‹åºä¸­æˆ–ä¸å†éœ€è¦ã€‚

##### Keep References to Your Operation Object As Neededï¼ˆæ ¹æ®éœ€è¦ä¿ç•™å¯¹ Operation å¯¹è±¡çš„å¼•ç”¨ï¼‰
&emsp;ä»…ä»…å› ä¸º operation å¯¹è±¡æ˜¯å¼‚æ­¥è¿è¡Œçš„ï¼Œä½ å°±ä¸åº”è¯¥å‡è®¾ä½ å¯ä»¥åˆ›å»ºå®ƒä»¬è€Œå¿½ç•¥å®ƒä»¬ã€‚å®ƒä»¬ä»ç„¶åªæ˜¯å¯¹è±¡ï¼Œç”±ä½ æ¥ç®¡ç†ä»£ç æ‰€éœ€çš„å¯¹å®ƒä»¬çš„ä»»ä½•å¼•ç”¨ã€‚å¦‚æœéœ€è¦åœ¨æ“ä½œå®Œæˆåä»ä¸­æ£€ç´¢ç»“æœæ•°æ®ï¼Œè¿™ä¸€ç‚¹å°¤å…¶é‡è¦ã€‚

&emsp;ä½ åº”è¯¥å§‹ç»ˆä¿ç•™è‡ªå·±å¯¹ operation çš„å¼•ç”¨çš„åŸå› æ˜¯ï¼Œä½ ä»¥åå¯èƒ½æ²¡æœ‰æœºä¼šå‘é˜Ÿåˆ—è¯·æ±‚å¯¹è±¡ã€‚é˜Ÿåˆ—å°½ä¸€åˆ‡åŠªåŠ›å°½å¯èƒ½å¿«åœ°è°ƒåº¦å’Œæ‰§è¡Œ operationã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œé˜Ÿåˆ—å‡ ä¹åœ¨æ·»åŠ åç«‹å³å¼€å§‹æ‰§è¡Œ operationã€‚å½“ä½ è‡ªå·±çš„ä»£ç è¿”å›åˆ°é˜Ÿåˆ—ä»¥è·å–å¯¹è¯¥ operation çš„å¼•ç”¨æ—¶ï¼Œè¯¥ operation å¯èƒ½å·²ç»å®Œæˆå¹¶ä»é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚

#### Handling Errors and Exceptionsï¼ˆå¤„ç†é”™è¯¯å’Œå¼‚å¸¸ï¼‰
&emsp;å› ä¸º operation æœ¬è´¨ä¸Šæ˜¯åº”ç”¨ç¨‹åºä¸­çš„ç¦»æ•£å®ä½“ï¼Œæ‰€ä»¥å®ƒä»¬è´Ÿè´£å¤„ç†å‡ºç°çš„ä»»ä½•é”™è¯¯æˆ–å¼‚å¸¸ã€‚åœ¨ OS X v10.6 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼ŒNSOperation ç±»æä¾›çš„é»˜è®¤ `start` æ–¹æ³•ä¸ä¼šæ•è·å¼‚å¸¸ã€‚ï¼ˆåœ¨ OS X v10.5 ä¸­ï¼Œ`start` æ–¹æ³•ç¡®å®æ•æ‰å¹¶æŠ‘åˆ¶å¼‚å¸¸ã€‚ï¼‰ä½ è‡ªå·±çš„ä»£ç åº”è¯¥æ€»æ˜¯ç›´æ¥æ•æ‰å¹¶æŠ‘åˆ¶å¼‚å¸¸ã€‚å®ƒè¿˜åº”è¯¥æ£€æŸ¥é”™è¯¯ä»£ç ï¼Œå¹¶æ ¹æ®éœ€è¦é€šçŸ¥åº”ç”¨ç¨‹åºçš„ç›¸åº”éƒ¨åˆ†ã€‚å¦‚æœæ›¿æ¢ `start` æ–¹æ³•ï¼ŒåŒæ ·å¿…é¡»æ•è·è‡ªå®šä¹‰å®ç°ä¸­çš„ä»»ä½•å¼‚å¸¸ï¼Œä»¥é˜²æ­¢å®ƒä»¬ç¦»å¼€åº•å±‚çº¿ç¨‹çš„ä½œç”¨åŸŸã€‚

&emsp;ä½ åº”è¯¥å‡†å¤‡å¥½å¤„ç†ä»¥ä¸‹ç±»å‹çš„é”™è¯¯æƒ…å†µï¼š

+ æ£€æŸ¥å¹¶å¤„ç† UNIX errno æ ·å¼é”™è¯¯ä»£ç ã€‚
+ æ£€æŸ¥æ–¹æ³•å’Œå‡½æ•°è¿”å›çš„æ˜¾å¼é”™è¯¯ä»£ç ã€‚
+ æ•è·ç”±ä½ è‡ªå·±çš„ä»£ç æˆ–å…¶ä»–ç³»ç»Ÿæ¡†æ¶å¼•å‘çš„å¼‚å¸¸ã€‚
+ æ•è· NSOperation ç±»æœ¬èº«å¼•å‘çš„å¼‚å¸¸ï¼Œè¯¥ç±»åœ¨ä»¥ä¸‹æƒ…å†µä¸‹å¼•å‘å¼‚å¸¸ï¼š
  + å½“ operation å°šæœªå‡†å¤‡å¥½æ‰§è¡Œä½†è°ƒç”¨äº†å…¶ `start` æ–¹æ³•æ—¶
  + å½“ operation æ­£åœ¨æ‰§è¡Œæˆ–å®Œæˆï¼ˆå¯èƒ½æ˜¯å› ä¸ºå®ƒè¢«å–æ¶ˆï¼‰å¹¶å†æ¬¡è°ƒç”¨å…¶ `start` æ–¹æ³•æ—¶
  + å½“ä½ å°è¯•å°†å®Œæˆ block æ·»åŠ åˆ°å·²æ‰§è¡Œæˆ–å·²å®Œæˆçš„ operation æ—¶
  + å°è¯•æ£€ç´¢å·²å–æ¶ˆçš„ NSInvocationOperation å¯¹è±¡çš„ç»“æœæ—¶

&emsp;å¦‚æœä½ çš„è‡ªå®šä¹‰ä»£ç ç¡®å®é‡åˆ°å¼‚å¸¸æˆ–é”™è¯¯ï¼Œä½ åº”è¯¥é‡‡å–ä»»ä½•å¿…è¦çš„æ­¥éª¤å°†è¯¥é”™è¯¯ä¼ æ’­åˆ°åº”ç”¨ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†ã€‚NSOperation ç±»ä¸æä¾›æ˜¾å¼æ–¹æ³•å°†é”™è¯¯ç»“æœä»£ç æˆ–å¼‚å¸¸ä¼ é€’ç»™åº”ç”¨ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†ã€‚å› æ­¤ï¼Œå¦‚æœè¿™äº›ä¿¡æ¯å¯¹åº”ç”¨ç¨‹åºå¾ˆé‡è¦ï¼Œåˆ™å¿…é¡»æä¾›å¿…è¦çš„ä»£ç ã€‚

### Determining an Appropriate Scope for Operation Objectsï¼ˆç¡®å®š operation å¯¹è±¡çš„é€‚å½“èŒƒå›´ï¼‰
&emsp;å°½ç®¡å¯ä»¥å‘ operation queue ä¸­æ·»åŠ ä»»æ„æ•°é‡çš„ operationsï¼Œä½†è¿™æ ·åšé€šå¸¸æ˜¯ä¸åˆ‡å®é™…çš„ã€‚ä¸ä»»ä½•å¯¹è±¡ä¸€æ ·ï¼ŒNSOperation ç±»çš„å®ä¾‹æ¶ˆè€—å†…å­˜ï¼Œå¹¶å…·æœ‰ä¸å…¶æ‰§è¡Œç›¸å…³çš„å®é™…æˆæœ¬ã€‚å¦‚æœä½ çš„æ¯ä¸ª operation å¯¹è±¡åªåšå°‘é‡çš„å·¥ä½œï¼Œå¹¶ä¸”ä½ åˆ›å»ºäº†æ•°ä»¥ä¸‡è®¡çš„ operations å¯¹è±¡ï¼Œé‚£ä¹ˆä½ å¯èƒ½ä¼šå‘ç°è°ƒåº¦ operation æ‰€èŠ±çš„æ—¶é—´æ¯”å®é™…å·¥ä½œè¿˜è¦å¤šã€‚å¦‚æœä½ çš„åº”ç”¨ç¨‹åºå·²ç»å—åˆ°å†…å­˜é™åˆ¶ï¼Œä½ å¯èƒ½ä¼šå‘ç°ä»…ä»…åœ¨å†…å­˜ä¸­æœ‰æˆåƒä¸Šä¸‡ä¸ª operation å¯¹è±¡å¯èƒ½ä¼šè¿›ä¸€æ­¥é™ä½æ€§èƒ½ã€‚

&emsp;æœ‰æ•ˆä½¿ç”¨ operations çš„å…³é”®æ˜¯åœ¨ä½ éœ€è¦åšçš„å·¥ä½œé‡å’Œä¿æŒè®¡ç®—æœºç¹å¿™ä¹‹é—´æ‰¾åˆ°ä¸€ä¸ªé€‚å½“çš„å¹³è¡¡ç‚¹ã€‚å°½é‡ç¡®ä¿ä½ çš„å·¥ä½œåšå¾—åˆç†ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåº”ç”¨ç¨‹åºåˆ›å»º 100 ä¸ª operation å¯¹è±¡æ¥å¯¹ 100 ä¸ªä¸åŒçš„å€¼æ‰§è¡Œç›¸åŒçš„ä»»åŠ¡ï¼Œè¯·è€ƒè™‘åˆ›å»º10 ä¸ª operation å¯¹è±¡æ¥åˆ†åˆ«å¤„ç† 10 ä¸ªå€¼ã€‚

&emsp;ä½ è¿˜åº”è¯¥é¿å…ä¸€æ¬¡å‘é˜Ÿåˆ—ä¸­æ·»åŠ å¤§é‡æ“ä½œï¼Œæˆ–è€…é¿å…è¿ç»­å‘é˜Ÿåˆ—ä¸­æ·»åŠ  operation å¯¹è±¡çš„é€Ÿåº¦å¿«äºå¤„ç†å®ƒä»¬çš„é€Ÿåº¦ã€‚ä¸å…¶ç”¨ operation å¯¹è±¡æ·¹æ²¡é˜Ÿåˆ—ï¼Œä¸å¦‚æˆæ‰¹åˆ›å»ºè¿™äº›å¯¹è±¡ã€‚å½“ä¸€æ‰¹å¤„ç†å®Œæˆæ‰§è¡Œæ—¶ï¼Œä½¿ç”¨å®Œæˆ block é€šçŸ¥åº”ç”¨ç¨‹åºåˆ›å»ºä¸€æ‰¹æ–°å¤„ç†ã€‚å½“ä½ æœ‰å¾ˆå¤šå·¥ä½œè¦åšæ—¶ï¼Œä½ å¸Œæœ›è®©é˜Ÿåˆ—ä¸­å……æ»¡è¶³å¤Ÿçš„ operationï¼Œä»¥ä¾¿è®¡ç®—æœºä¿æŒå¿™ç¢Œï¼Œä½†æ˜¯ä½ ä¸å¸Œæœ›ä¸€æ¬¡åˆ›å»ºå¤ªå¤šçš„ operations è€Œå¯¼è‡´åº”ç”¨ç¨‹åºå†…å­˜ä¸è¶³ã€‚

&emsp;å½“ç„¶ï¼Œä½ åˆ›å»ºçš„ operation å¯¹è±¡çš„æ•°é‡ä»¥åŠåœ¨æ¯ä¸ª operation å¯¹è±¡ä¸­æ‰§è¡Œçš„å·¥ä½œé‡æ˜¯å¯å˜çš„ï¼Œå¹¶ä¸”å®Œå…¨å–å†³äºä½ çš„åº”ç”¨ç¨‹åºã€‚ä½ åº”è¯¥ç»å¸¸ä½¿ç”¨å·¥å…·ï¼Œæ¯”å¦‚ Instruments æ¥å¸®åŠ©ä½ åœ¨æ•ˆç‡å’Œé€Ÿåº¦ä¹‹é—´æ‰¾åˆ°ä¸€ä¸ªé€‚å½“çš„å¹³è¡¡ç‚¹ã€‚æœ‰å…³å¯ç”¨äºæ”¶é›†ä»£ç åº¦é‡çš„å·¥å…·å’Œå…¶ä»–æ€§èƒ½å·¥å…·çš„æ¦‚è¿°ï¼Œè¯·å‚é˜… Performance Overviewã€‚

### Executing Operationsï¼ˆæ‰§è¡Œ Operationsï¼‰
&emsp;æœ€ç»ˆï¼Œåº”ç”¨ç¨‹åºéœ€è¦æ‰§è¡Œ operations æ‰èƒ½å®Œæˆç›¸å…³çš„å·¥ä½œã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œä½ å°†å­¦ä¹ å‡ ç§æ‰§è¡Œ operation çš„æ–¹æ³•ï¼Œä»¥åŠå¦‚ä½•åœ¨è¿è¡Œæ—¶æ“çºµ operation çš„æ‰§è¡Œã€‚

#### Adding Operations to an Operation Queueï¼ˆå°† operations æ·»åŠ åˆ°æ“ä½œé˜Ÿåˆ—ï¼‰
&emsp;åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‰§è¡Œ operation çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨æ“ä½œé˜Ÿåˆ—ï¼Œå®ƒæ˜¯ NSOperationQueue ç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚åº”ç”¨ç¨‹åºè´Ÿè´£åˆ›å»ºå’Œç»´æŠ¤å®ƒæ‰“ç®—ä½¿ç”¨çš„ä»»ä½•æ“ä½œé˜Ÿåˆ—ã€‚ä¸€ä¸ªåº”ç”¨ç¨‹åºå¯ä»¥æœ‰ä»»æ„æ•°é‡çš„é˜Ÿåˆ—ï¼Œä½†æ˜¯åœ¨ç»™å®šçš„æ—¶é—´ç‚¹ä¸Šæ‰§è¡Œçš„ operation æ•°é‡æ˜¯æœ‰å®é™…é™åˆ¶çš„ã€‚æ“ä½œé˜Ÿåˆ—ä¸ç³»ç»Ÿä¸€èµ·å·¥ä½œï¼Œå°†å¹¶å‘ operation çš„æ•°é‡é™åˆ¶ä¸ºé€‚åˆå¯ç”¨å†…æ ¸å’Œç³»ç»Ÿè´Ÿè½½çš„å€¼ã€‚å› æ­¤ï¼Œåˆ›å»ºé¢å¤–çš„é˜Ÿåˆ—å¹¶ä¸æ„å‘³ç€ä½ å¯ä»¥æ‰§è¡Œé¢å¤–çš„æ“ä½œã€‚

&emsp;è¦åˆ›å»ºé˜Ÿåˆ—ï¼Œå¯ä»¥åƒåœ¨ä»»ä½•å…¶ä»–å¯¹è±¡ä¸­ä¸€æ ·åœ¨åº”ç”¨ç¨‹åºä¸­åˆ†é…å®ƒï¼š
```c++
NSOperationQueue* aQueue = [[NSOperationQueue alloc] init];
```
&emsp;è¦å‘é˜Ÿåˆ—æ·»åŠ  operationsï¼Œå¯ä»¥ä½¿ç”¨ `addOperation:` æ–¹æ³•ã€‚åœ¨ OS X v10.6 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `addOperations:waitUntilFinished:` æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ `addOperationWithBlock:` æ–¹æ³•å°† block å¯¹è±¡ç›´æ¥æ·»åŠ åˆ°é˜Ÿåˆ—ï¼ˆæ²¡æœ‰ç›¸åº”çš„ operation å¯¹è±¡ï¼‰ã€‚è¿™äº›æ–¹æ³•ä¸­çš„æ¯ä¸€ä¸ªéƒ½å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ“ä½œæ’é˜Ÿï¼Œå¹¶é€šçŸ¥é˜Ÿåˆ—å®ƒåº”è¯¥å¼€å§‹å¤„ç†å®ƒä»¬ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œoperation åœ¨æ·»åŠ åˆ°é˜Ÿåˆ—åä¸ä¹…æ‰§è¡Œï¼Œä½†æ˜¯æ“ä½œé˜Ÿåˆ—å¯èƒ½ä¼šç”±äºä»¥ä¸‹ä»»ä½•åŸå› è€Œå»¶è¿Ÿé˜Ÿåˆ—æ“ä½œçš„æ‰§è¡Œã€‚å…·ä½“åœ°è¯´ï¼Œå¦‚æœæ’é˜Ÿçš„ operation ä¾èµ–äºå°šæœªå®Œæˆçš„å…¶ä»– operationsï¼Œåˆ™æ‰§è¡Œå¯èƒ½ä¼šå»¶è¿Ÿã€‚å¦‚æœæ“ä½œé˜Ÿåˆ—æœ¬èº«å·²æŒ‚èµ·æˆ–å·²åœ¨æ‰§è¡Œå…¶æœ€å¤§å¹¶å‘æ“ä½œæ•°ï¼Œåˆ™æ‰§è¡Œä¹Ÿå¯èƒ½ä¼šå»¶è¿Ÿã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å‘é˜Ÿåˆ—æ·»åŠ  operations çš„åŸºæœ¬è¯­æ³•ã€‚
```c++
[aQueue addOperation:anOp]; // Add a single operation
[aQueue addOperations:anArrayOfOps waitUntilFinished:NO]; // Add multiple operations
[aQueue addOperationWithBlock:^{
   /* Do something. */
}];
```
&emsp;Important: åœ¨å°† operation å¯¹è±¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¹‹å‰ï¼Œåº”è¯¥å¯¹å…¶è¿›è¡Œæ‰€æœ‰å¿…è¦çš„é…ç½®å’Œä¿®æ”¹ï¼Œå› ä¸ºä¸€æ—¦æ·»åŠ ï¼Œè¯¥ operation å¯èƒ½éšæ—¶éƒ½ä¼šè¿è¡Œï¼Œè¿™å¯¹äºæ›´æ”¹äº§ç”Ÿçš„é¢„æœŸæ•ˆæœæ¥è¯´å¯èƒ½å¤ªæ™šäº†ã€‚

&emsp;å°½ç®¡ NSOperationQueue ç±»æ˜¯ä¸ºå¹¶å‘æ‰§è¡Œ operation è€Œè®¾è®¡çš„ï¼Œä½†æ˜¯å¯ä»¥å¼ºåˆ¶å•ä¸ªé˜Ÿåˆ—ä¸€æ¬¡åªè¿è¡Œä¸€ä¸ªæ“ä½œã€‚`setMaxConcurrentOperationCount:` æ–¹æ³•å…è®¸ä½ ä¸ºæ“ä½œé˜Ÿåˆ—å¯¹è±¡é…ç½®æœ€å¤§å¹¶å‘æ“ä½œæ•°ã€‚å°†å€¼ 1 ä¼ é€’ç»™æ­¤æ–¹æ³•ä¼šå¯¼è‡´é˜Ÿåˆ—ä¸€æ¬¡åªæ‰§è¡Œä¸€ä¸ª operationã€‚å°½ç®¡ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ª operationï¼Œä½†æ‰§è¡Œé¡ºåºä»ç„¶åŸºäºå…¶ä»–å› ç´ ï¼Œä¾‹å¦‚æ¯ä¸ª operation çš„å‡†å¤‡æƒ…å†µåŠå…¶åˆ†é…çš„ä¼˜å…ˆçº§ã€‚å› æ­¤ï¼Œåºåˆ—åŒ–æ“ä½œé˜Ÿåˆ—æä¾›çš„è¡Œä¸ºä¸ Grand Central Dispatch ä¸­çš„ä¸²è¡Œè°ƒåº¦é˜Ÿåˆ—ä¸åŒã€‚å¦‚æœ operation å¯¹è±¡çš„æ‰§è¡Œé¡ºåºå¯¹ä½ å¾ˆé‡è¦ï¼Œé‚£ä¹ˆåœ¨å°† operation æ·»åŠ åˆ°é˜Ÿåˆ—ä¹‹å‰ï¼Œåº”è¯¥ä½¿ç”¨ä¾èµ–å…³ç³»æ¥å»ºç«‹è¯¥é¡ºåºã€‚æœ‰å…³é…ç½®ä¾èµ–é¡¹çš„ä¿¡æ¯ï¼Œè¯·å‚è§ Configuring Interoperation Dependenciesã€‚

&emsp;æœ‰å…³ä½¿ç”¨æ“ä½œé˜Ÿåˆ—çš„ä¿¡æ¯ï¼Œè¯·å‚è§ NSOperationQueue Class Referenceã€‚æœ‰å…³ä¸²è¡Œè°ƒåº¦é˜Ÿåˆ—çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ Creating Serial Dispatch Queuesã€‚

#### Executing Operations Manuallyï¼ˆæ‰‹åŠ¨æ‰§è¡Œæ“ä½œï¼‰
&emsp;å°½ç®¡æ“ä½œé˜Ÿåˆ—æ˜¯è¿è¡Œ operation å¯¹è±¡æœ€æ–¹ä¾¿çš„æ–¹å¼ï¼Œä½†ä¹Ÿå¯ä»¥åœ¨æ²¡æœ‰é˜Ÿåˆ—çš„æƒ…å†µä¸‹æ‰§è¡Œ operationã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ é€‰æ‹©æ‰‹åŠ¨æ‰§è¡Œ operationï¼Œé‚£ä¹ˆåœ¨ä»£ç ä¸­åº”è¯¥é‡‡å–ä¸€äº›é¢„é˜²æªæ–½ã€‚ç‰¹åˆ«æ˜¯ï¼Œoperation å¿…é¡»å‡†å¤‡å¥½è¿è¡Œï¼Œå¹¶ä¸”å¿…é¡»å§‹ç»ˆä½¿ç”¨å…¶ `start` æ–¹æ³•å¯åŠ¨å®ƒã€‚

&emsp;åœ¨ `isReady` æ–¹æ³•è¿”å› YES ä¹‹å‰ï¼Œoperation è¢«è®¤ä¸ºæ— æ³•è¿è¡Œã€‚`isReady` æ–¹æ³•é›†æˆåˆ° NSOperation ç±»çš„ä¾èµ–å…³ç³»ç®¡ç†ç³»ç»Ÿä¸­ï¼Œä»¥æä¾› operation ä¾èµ–å…³ç³»çš„çŠ¶æ€ã€‚åªæœ‰å½“å…¶ä¾èµ–é¡¹è¢«æ¸…é™¤æ—¶ï¼ˆè¢«å…¨éƒ¨æ‰§è¡Œå®Œæˆåï¼‰ï¼Œoperation æ‰å¯ä»¥è‡ªç”±åœ°å¼€å§‹æ‰§è¡Œã€‚

&emsp;æ‰‹åŠ¨æ‰§è¡Œ operation æ—¶ï¼Œåº”å§‹ç»ˆä½¿ç”¨ `start` æ–¹æ³•å¼€å§‹æ‰§è¡Œã€‚ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œè€Œä¸æ˜¯ `main` æˆ–å…¶ä»–æ–¹æ³•ï¼Œå› ä¸º `start` æ–¹æ³•åœ¨å®é™…è¿è¡Œè‡ªå®šä¹‰ä»£ç ä¹‹å‰ä¼šæ‰§è¡Œä¸€äº›å®‰å…¨æ£€æŸ¥ã€‚ç‰¹åˆ«æ˜¯ï¼Œé»˜è®¤ `start` æ–¹æ³•ç”Ÿæˆ operation æ­£ç¡®å¤„ç†å…¶ä¾èµ–å…³ç³»æ‰€éœ€çš„ KVO é€šçŸ¥ã€‚å¦‚æœ operation å·²è¢«å–æ¶ˆï¼Œæ­¤æ–¹æ³•è¿˜å¯ä»¥æ­£ç¡®åœ°é¿å…æ‰§è¡Œè¯¥ operationï¼›å¦‚æœ operation å®é™…ä¸Šè¿˜æ²¡æœ‰å‡†å¤‡å¥½è¿è¡Œï¼Œåˆ™ä¼šå¼•å‘å¼‚å¸¸ã€‚

&emsp;å¦‚æœåº”ç”¨ç¨‹åºå®šä¹‰äº†å¹¶å‘ operation å¯¹è±¡ï¼Œåˆ™è¿˜åº”è€ƒè™‘åœ¨å¯åŠ¨å®ƒä»¬ä¹‹å‰è°ƒç”¨ `isConcurrent` æ“ä½œæ–¹æ³•ã€‚å¦‚æœæ­¤æ–¹æ³•è¿”å› NOï¼Œåˆ™æœ¬åœ°ä»£ç å¯ä»¥å†³å®šæ˜¯åœ¨å½“å‰çº¿ç¨‹ä¸­åŒæ­¥æ‰§è¡Œ operationï¼Œè¿˜æ˜¯å…ˆåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ã€‚ç„¶è€Œï¼Œå®ç°è¿™ç§æ£€æŸ¥å®Œå…¨å–å†³äºä½ ã€‚

&emsp;æ¸…å• 2-8 ç»™å‡ºäº†ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œè¯´æ˜åœ¨æ‰‹åŠ¨æ‰§è¡Œ operation ä¹‹å‰åº”è¯¥æ‰§è¡Œå“ªäº›æ£€æŸ¥ã€‚å¦‚æœè¯¥æ–¹æ³•è¿”å› NOï¼Œåˆ™å¯ä»¥å®‰æ’ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œç¨åå†æ¬¡è°ƒç”¨è¯¥æ–¹æ³•ã€‚ç„¶åç»§ç»­é‡æ–°å®‰æ’è®¡æ—¶å™¨ï¼Œç›´åˆ°æ–¹æ³•è¿”å› YESï¼Œè¿™å¯èƒ½æ˜¯å› ä¸º operation è¢«å–æ¶ˆã€‚

&emsp;Listing 2-8  Executing an operation object manually
```c++
- (BOOL)performOperation:(NSOperation*)anOp {
   BOOL ranIt = NO;
   
   if ([anOp isReady] && ![anOp isCancelled]) {
      if (![anOp isConcurrent])
         [anOp start];
      else
         [NSThread detachNewThreadSelector:@selector(start) toTarget:anOp withObject:nil];
         
      ranIt = YES;
   } else if ([anOp isCancelled]) {
      // If it was canceled before it was started, move the operation to the finished state.
      [self willChangeValueForKey:@"isFinished"];
      [self willChangeValueForKey:@"isExecuting"];
      executing = NO;
      finished = YES;
      [self didChangeValueForKey:@"isExecuting"];
      [self didChangeValueForKey:@"isFinished"];
 
      // Set ranIt to YES to prevent the operation from
      // being passed to this method again in the future.
      ranIt = YES;
   }
   return ranIt;
}
```

#### Canceling Operationsï¼ˆå–æ¶ˆ Operationsï¼‰
&emsp;ä¸€æ—¦æ·»åŠ åˆ°æ“ä½œé˜Ÿåˆ—ä¸­ï¼Œoperation å¯¹è±¡å®é™…ä¸Šå°±å½’é˜Ÿåˆ—æ‰€æœ‰ï¼Œä¸èƒ½åˆ é™¤ã€‚ä½¿ operation å‡ºé˜Ÿçš„å”¯ä¸€æ–¹æ³•æ˜¯å–æ¶ˆ operationã€‚ä½ å¯ä»¥é€šè¿‡è°ƒç”¨å•ä¸ª operation å¯¹è±¡çš„ cancel æ–¹æ³•æ¥å–æ¶ˆå®ƒï¼Œä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨é˜Ÿåˆ—å¯¹è±¡çš„ `cancelAllOperations` æ–¹æ³•æ¥å–æ¶ˆé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ operation å¯¹è±¡ã€‚

&emsp;åªæœ‰åœ¨ç¡®å®šä¸å†éœ€è¦ operations æ—¶ï¼Œæ‰åº”å–æ¶ˆè¿™äº› operationsã€‚å‘å‡º cancel å‘½ä»¤ä¼šå°† operation å¯¹è±¡ç½®äº "canceled" çŠ¶æ€ï¼Œè¿™ä¼šé˜»æ­¢å®ƒè¿è¡Œã€‚ç”±äºå–æ¶ˆçš„ operation ä»è¢«è§†ä¸º "finished"ï¼Œå› æ­¤ä¾èµ–äºå®ƒçš„å¯¹è±¡å°†æ”¶åˆ°ç›¸åº”çš„ KVO é€šçŸ¥ä»¥æ¸…é™¤è¯¥ä¾èµ–å…³ç³»ã€‚å› æ­¤ï¼Œå“åº”äºä¸€äº›é‡è¦äº‹ä»¶ï¼ˆå¦‚åº”ç”¨ç¨‹åºé€€å‡ºæˆ–ç”¨æˆ·ç‰¹åˆ«è¯·æ±‚å–æ¶ˆï¼‰è€Œå–æ¶ˆæ‰€æœ‰æ’é˜Ÿçš„ operations æ¯”é€‰æ‹©æ€§åœ°å–æ¶ˆ operation æ›´ä¸ºå¸¸è§ã€‚

#### Waiting for Operations to Finishï¼ˆç­‰å¾… Operations å®Œæˆï¼‰
&emsp;ä¸ºäº†è·å¾—æœ€ä½³æ€§èƒ½ï¼Œä½ åº”è¯¥å°† operation è®¾è®¡ä¸ºå°½å¯èƒ½å¼‚æ­¥ï¼Œè®©åº”ç”¨ç¨‹åºåœ¨ operation æ‰§è¡Œæ—¶å¯ä»¥è‡ªç”±åœ°æ‰§è¡Œå…¶ä»–å·¥ä½œã€‚å¦‚æœåˆ›å»º operation çš„ä»£ç ä¹Ÿå¤„ç†è¯¥ operation çš„ç»“æœï¼Œåˆ™å¯ä»¥ä½¿ç”¨ NSOperation çš„ `waitUntilFinished` æ–¹æ³•é˜»å¡è¯¥ä»£ç ï¼Œç›´åˆ°æ“ä½œå®Œæˆã€‚ä¸è¿‡ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼Œæœ€å¥½é¿å…è°ƒç”¨æ­¤æ–¹æ³•ã€‚é˜»å¡å½“å‰çº¿ç¨‹å¯èƒ½æ˜¯ä¸€ä¸ªæ–¹ä¾¿çš„è§£å†³æ–¹æ¡ˆï¼Œä½†å®ƒç¡®å®ä¼šåœ¨ä»£ç ä¸­å¼•å…¥æ›´å¤šçš„åºåˆ—åŒ–ï¼Œå¹¶é™åˆ¶æ€»ä½“å¹¶å‘é‡ã€‚

> Important: æ°¸è¿œä¸è¦ç­‰å¾…æ¥è‡ªåº”ç”¨ç¨‹åºä¸»çº¿ç¨‹çš„æ“ä½œã€‚ä½ åªèƒ½ä»è¾…åŠ©çº¿ç¨‹æˆ–å…¶ä»–æ“ä½œä¸­æ‰§è¡Œæ­¤æ“ä½œã€‚é˜»å¡ä¸»çº¿ç¨‹ä¼šé˜»æ­¢åº”ç”¨ç¨‹åºå“åº”ç”¨æˆ·äº‹ä»¶ï¼Œå¹¶å¯èƒ½ä½¿åº”ç”¨ç¨‹åºçœ‹èµ·æ¥æ²¡æœ‰å“åº”ã€‚

&emsp;é™¤äº†ç­‰å¾…å•ä¸ª operation å®Œæˆå¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡è°ƒç”¨ NSOperationQueue çš„ `waitUntillalOperationsRefished` æ–¹æ³•æ¥ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ operationsã€‚åœ¨ç­‰å¾…æ•´ä¸ªé˜Ÿåˆ—å®Œæˆæ—¶ï¼Œè¯·æ³¨æ„åº”ç”¨ç¨‹åºçš„å…¶ä»–çº¿ç¨‹ä»ç„¶å¯ä»¥å‘é˜Ÿåˆ—æ·»åŠ  operationsï¼Œä»è€Œå»¶é•¿ç­‰å¾…æ—¶é—´ã€‚

#### Suspending and Resuming Queuesï¼ˆæŒ‚èµ·å’Œæ¢å¤é˜Ÿåˆ—ï¼‰
&emsp;å¦‚æœè¦ä¸´æ—¶åœæ­¢ operations çš„æ‰§è¡Œï¼Œå¯ä»¥ä½¿ç”¨ `setSuspended:` æ–¹æ³•æŒ‚èµ·ç›¸åº”çš„æ“ä½œé˜Ÿåˆ—ã€‚æŒ‚èµ·é˜Ÿåˆ—ä¸ä¼šå¯¼è‡´å·²åœ¨æ‰§è¡Œçš„ operations åœ¨ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æš‚åœã€‚å®ƒåªæ˜¯é˜²æ­¢æ–° operations è¢«å®‰æ’æ‰§è¡Œã€‚ä½ å¯ä»¥æŒ‚èµ·é˜Ÿåˆ—ä»¥å“åº”ç”¨æˆ·è¯·æ±‚ï¼Œä»è€Œæš‚åœä»»ä½•æ­£åœ¨è¿›è¡Œçš„å·¥ä½œï¼Œå› ä¸ºé¢„æœŸç”¨æˆ·æœ€ç»ˆå¯èƒ½å¸Œæœ›æ¢å¤è¯¥å·¥ä½œã€‚

## å‚è€ƒé“¾æ¥
**å‚è€ƒé“¾æ¥:ğŸ”—**
+ [NSOperation](https://developer.apple.com/documentation/foundation/nsoperation?language=occ)
+ [NSBlockOperation](https://developer.apple.com/documentation/foundation/nsblockoperation?language=occ)
+ [NSInvocationOperation](https://developer.apple.com/documentation/foundation/nsinvocationoperation?language=occ)
+ [NSOperationQueue](https://developer.apple.com/documentation/foundation/nsoperationqueue?language=occ)
+ [Operation Queues](https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationObjects/OperationObjects.html#//apple_ref/doc/uid/TP40008091-CH101-SW1)
+ [iOS å¤šçº¿ç¨‹ï¼šã€NSOperationã€NSOperationQueueã€è¯¦å°½æ€»ç»“](https://www.jianshu.com/p/4b1d77054b35)
+ [å¹¶å‘ç¼–ç¨‹ï¼šAPI åŠæŒ‘æˆ˜](https://objccn.io/issue-2-1/)
