# iOS App å¯åŠ¨ä¼˜åŒ–(ä¹)ï¼šfishhook å»¶å±•é˜…è¯»

> &emsp;æœ¬ç¯‡æ ‡é¢˜æ˜¯å¯¹ fishhook å»¶å±•é˜…è¯»ï¼Œå®åˆ™æ˜¯å¯¹ fishhook æ¶‰åŠåˆ°çš„åŸºç¡€çŸ¥è¯†ç‚¹è¿›è¡Œç»Ÿä¸€å­¦ä¹ å’Œå·©å›ºï¼Œæ‰€ä»¥æœ¬ç¯‡è¿˜æ˜¯å¯¹ mach-o å’Œ dyld åŠ è½½è¿‡ç¨‹æ¶‰åŠçš„åŸºç¡€çŸ¥è¯†ç‚¹çš„å­¦ä¹ ï¼Œåªè¦æŠŠåŸºç¡€çŸ¥è¯†ç‚¹éƒ½å­¦å¥½äº†ï¼Œåé¢æˆ‘ä»¬ä¾¿æœ‰æ— é™çš„å¯èƒ½ï¼

## hook æ¦‚è¿°

&emsp;hookï¼šåœ¨è¿›ç¨‹ä¸­å‹¾ä½æŸä¸€ä¸ªå‡½æ•°æˆ–è€…åœ¨è®¡ç®—æœºä¸­é’©ä½æŸä¸€ä¸ªè¿›ç¨‹ï¼Œä»è€Œæ‰©å±•ç¨‹åºçš„åŠŸèƒ½æˆ–è€…æ”¹å˜ç¨‹åºè¿è¡Œçš„æµç¨‹ã€‚iOS ä¸­ hook ä½¿ç”¨åœºæ™¯ï¼šåŸ‹ç‚¹ã€Crash é˜²æŠ¤ã€åº”ç”¨åŠ å›ºã€åº”ç”¨éš”ç¦»ç­‰ç­‰ã€‚

## fishhook ä¸ºä»€ä¹ˆä¸èƒ½ hook è‡ªå®šä¹‰å‡½æ•°ï¼ˆC å‡½æ•°ï¼‰

&emsp;è¿è¡Œæµ‹è¯•å¦‚ä¸‹ä»£ç ï¼Œå¯å‘ç°æˆ‘ä»¬å®šä¹‰çš„ `func` å‡½æ•°å¹¶ä¸èƒ½è¢« fishhook hook åˆ°ã€‚ï¼ˆåœ¨è¿™é‡Œå¯ä»¥å­¦åˆ°ä¸€äº›å‡½æ•°ä½äºä¸åŒåˆ†åŒºçš„çŸ¥è¯†ç‚¹ï¼‰

```c++
#import "ViewController.h"
#import "fishhook.h"

// åŸå‡½æ•°
static void func(void) {
    printf("â™»ï¸â™»ï¸â™»ï¸ %s \n", __func__);
}

// æ–°å‡½æ•°
static void hook_func(void) {
    printf("â™»ï¸â™»ï¸â™»ï¸ %s \n", __func__);
}

@interface ViewController ()

@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    NSLog(@"âœ³ï¸âœ³ï¸âœ³ï¸ NSLog: %p", NSLog);
    
    func();
    
    // hook func
    struct rebinding func_reb;
    func_reb.name = "func";
    func_reb.replacement = hook_func;
    func_reb.replaced = nil;

    // å®šä¹‰éœ€è¦ hook çš„å‡½æ•°çš„ç»“æ„ä½“æ•°ç»„å˜é‡
    struct rebinding rebs[] = {func_reb};
    
    // å¾ˆç®€å•ï¼Œä¼ é€’ç»“æ„ä½“æ•°ç»„åœ°å€åŠå…¶æˆå‘˜å˜é‡æ•°ç›®
    rebind_symbols(rebs, 1);
    
    func();
}

// æ§åˆ¶å°è¾“å‡º:
â™»ï¸â™»ï¸â™»ï¸ func 
â™»ï¸â™»ï¸â™»ï¸ func 
```

&emsp;é€šè¿‡ä¸Šä¸€ç¯‡çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å·²çŸ¥çš„ fishhook ä»…èƒ½ hook Lazy Symbol Pointers å’Œ Non-lazy Symbol Pointers ä¸­çš„ç¬¦å·æŒ‡é’ˆï¼ˆè¿™äº›ç¬¦å·æŒ‡é’ˆæ‰€æŒ‡å‘çš„ç¬¦å·éƒ½æ¥è‡ªåŠ¨æ€é“¾æ¥åº“ï¼‰ï¼Œå·²çŸ¥å®ƒä»¬ä»…åœ¨ `(__DATA, __got)/(__DATA_CONST, __got)`ã€`(__DATA, __la_symbol_ptr)`ã€`(__DATA, __nl_symbol_ptr)` è¿™äº› Section ä¸­å­˜åœ¨ï¼Œè€Œæˆ‘ä»¬çš„è‡ªå®šä¹‰å‡½æ•°åˆ™æ˜¯ä½äº `(_TEXT, __text)` Section ä¸­çš„ï¼ˆæ˜¯æŒ‡å‡½æ•°å®šä¹‰ï¼Œä¸æ˜¯å¦‚å‰å‡ ä¸ªåˆ†åŒºä¸­æ˜¯ç¬¦å·æŒ‡é’ˆï¼‰ï¼Œæˆ‘ä»¬å·²çŸ¥çš„ `__DATA` æ®µçš„å†…å®¹å¯è¯»å¯å†™ï¼Œè€Œ `__TEXT` æ®µçš„å†…å®¹åªå¯è¯»å¯æ‰§è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬ä½äº `(__TEXT, __text)` Section ä¸­çš„è‡ªå®šä¹‰å‡½æ•°ä»…ä»…å¯è¯»å¯æ‰§è¡Œï¼ˆå¯è°ƒç”¨ï¼‰ï¼Œä¸”æˆ‘ä»¬çš„è‡ªå®šä¹‰å‡½æ•°çš„è°ƒç”¨æ˜¯ç›´æ¥é€šè¿‡å‡½æ•°åœ°å€è°ƒç”¨ï¼Œå¹¶æ²¡æœ‰é‡‡ç”¨ Symbol Pointer è¿›è¡ŒåŠ¨æ€ç»‘å®šï¼Œå³å†™æƒé™é™åˆ¶ + é€šè¿‡åœ°å€ç›´æ¥è°ƒç”¨ä¸¤ä¸ªåŸå› ä¸‹ï¼Œfishhook ä¸èƒ½å¯¹æˆ‘ä»¬çš„è‡ªå®šä¹‰å‡½æ•°è¿›è¡Œ hookã€‚

&emsp;ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸åŒçš„æ–¹å¼éªŒè¯ä¸€ä¸‹æˆ‘çš„è‡ªå®šä¹‰å‡½æ•°ä½äº `__TEXT` æ®µä¸­ã€‚

+ ä½¿ç”¨ `image list` å–å¾—å½“å‰è¿›ç¨‹çš„å†…å­˜é¦–åœ°å€ï¼Œç„¶åä½¿ç”¨ `func` å‡½æ•°çš„èµ·å§‹åœ°å€å‡å»å®ƒï¼Œä¾¿å¯å¾—åˆ° `func` å‡½æ•°åœ¨å½“å‰è¿›ç¨‹çš„ mach-o äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„åç§»é‡ï¼Œç„¶åé€šè¿‡ MachOView å¯è§†åŒ–æ‰¾åˆ°è¯¥åç§»é‡åœ¨ mach-o äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„ä½ç½®å¹¶æŸ¥çœ‹å…¶å†…å®¹ã€‚

&emsp;åœ¨ `func();` å¤„æ‰“ä¸€ä¸ªæ–­ç‚¹ï¼Œæ‰§è¡Œç¨‹åºè¿›å…¥åˆ°è¯¥æ–­ç‚¹ï¼Œç„¶å `p func` æ‰“å°ï¼š`(void (*)()) $0 = 0x000000010027d520 (TEST_Fishhook func at ViewController.m:12)` çœ‹åˆ° `func` å‡½æ•°çš„åœ°å€æ˜¯ï¼š`0x000000010027d520`ï¼Œä½œä¸ºå¯¹æ¯”æˆ‘ä»¬åŒæ · `p NSLog` æ‰“å°æ¥è‡ª Foundation.framework åŠ¨æ€åº“ä¸­çš„ `NSLog` å‡½æ•°çš„åœ°å€ï¼š`(void (*)(NSString * _Nonnull __strong, ...)) $1 = 0x00007fff20805d0d (Foundation NSLog)`ï¼Œå¯çœ‹åˆ° `NSLog` çš„å‡½æ•°åœ°å€å’Œ `func` å‡½æ•°çš„åœ°å€å®Œå…¨ä¸åœ¨ä¸€ä¸ª Levelï¼ˆå› ä¸º `NSLog` æ ¹æœ¬ä¸å±äºè¯¥è¿›ç¨‹ï¼Œå®ƒæ˜¯å½“å‰ç¨‹åºå¯åŠ¨åè¢«åŠ¨æ€ç»‘å®šçš„ï¼‰ï¼Œç„¶åä½¿ç”¨ `image list -h` æ‰“å°å‡ºä¸€ç»„å†…å­˜åœ°å€ï¼Œå®ƒä»¬ä¾¿æ˜¯å½“å‰è¿›ç¨‹å’Œå…¶ä¾èµ–çš„å„ç§åº“çš„å†…å­˜åœ°å€ï¼Œç¬¬ä¸€ä¸ªåœ°å€æ˜¯ä¾¿æ˜¯å½“å‰è¿›ç¨‹çš„å†…å­˜åœ°å€ï¼š`[  0] 0x000000010027c000`ï¼Œç„¶åé€šè¿‡ `(lldb) p/x 0x000000010027d520-0x000000010027c000 (long) $1 = 0x0000000000001520` æ‰“å°å¯çœ‹åˆ° `func` å‡½æ•°åœ¨å½“å‰è¿›ç¨‹çš„ mach-o äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„åç§»é‡æ˜¯ `0x0000000000001520`ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡ MachOView æŸ¥æ‰¾ï¼Œå¯çœ‹åˆ°å…¶ä½ç½®åœ¨ `(__TEXT, __text)` Section ä¸­ã€‚

![æˆªå±2021-08-07 ä¸Šåˆ5.20.02.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f4f720cd887347d18469b28e6defcfbe~tplv-k3u1fbpfcp-watermark.image)

![æˆªå±2021-08-07 ä¸Šåˆ5.20.09.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ed7397158eb8481bbc53e26b548ed75c~tplv-k3u1fbpfcp-watermark.image)

![æˆªå±2021-08-07 ä¸Šåˆ5.19.10.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bd23e873e67b4a9bad78e95aa31dc2e4~tplv-k3u1fbpfcp-watermark.image)

&emsp;ä¸‹é¢æˆ‘ä»¬å†å»¶ä¼¸ä¸€ä¸‹ï¼Œé¡ºç€  `0x0000000000001520` çš„åç§»å¾€ä¸‹è¯»ï¼Œå¯çœ‹åˆ°æ±‡ç¼–è·³è½¬æŒ‡ä»¤ï¼š`call 0x10000238c` å®ƒä¾¿æ˜¯ `printf` çš„è°ƒç”¨ï¼ˆ`func` å‡½æ•°å®šä¹‰å†…éƒ¨æ˜¯ `printf` å‡½æ•°çš„è°ƒç”¨ï¼‰ï¼Œåç§»é‡ `0x238c` å¤„æ˜¯ `(__TEXT, __stubs)` åŒºï¼Œå¯çœ‹åˆ° Value æ ‡è¯†çš„æ˜¯ `_printf`ã€‚ï¼ˆè¿™é‡Œå…ˆé¢„å‘Šä¸€ä¸ªç»“è®ºï¼šå½“å‰è¿›ç¨‹ä½¿ç”¨åˆ°çš„ç³»ç»ŸåŠ¨æ€åº“ä¸­çš„å‡½æ•°ä¼šåœ¨è¿›ç¨‹å¯åŠ¨æ—¶å’Œè¢«ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶è¿›è¡ŒåŠ¨æ€ç»‘å®šã€‚ï¼‰ 

![æˆªå±2021-08-07 ä¸Šåˆ5.43.31.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/31a8733b2b764f689d423d97a5193bca~tplv-k3u1fbpfcp-watermark.image)

+ ä½¿ç”¨ Hopper Disassembler åæ±‡ç¼–å½“å‰è¿›ç¨‹çš„ mach-o äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ¥éªŒè¯ä¸Šé¢çš„å‡½æ•°åœ°å€ï¼Œå¯å‘ç°æ±‡ç¼–æŒ‡ä»¤çš„åœ°å€å’Œæˆ‘ä»¬ä¸Šé¢è®¡ç®—æ‰“å°å‡ºçš„åç§»é‡å®Œå…¨ä¸€è‡´ã€‚ï¼ˆè¿™é‡Œè¿˜ç‰µæ¶‰åˆ°ä¸€ä¸ª Symbol Pointer çš„æ‡’åŠ è½½é—®é¢˜ï¼Œæˆ‘ä»¬ç•™åœ¨ä¸‹ä¸€å°èŠ‚ä¸­å…·ä½“åˆ†æã€‚ï¼‰

&emsp;å¯çœ‹åˆ° fishhook hook å‰åï¼Œå¯¹ `_func` å‡½æ•°çš„è°ƒç”¨æ²¡æœ‰å‘ç”Ÿä»»ä½•å˜åŒ–ï¼Œå³ fishhook ä¸èƒ½å¯¹æˆ‘ä»¬çš„è‡ªå®šä¹‰å‡½æ•°è¿›è¡Œ hookã€‚

![æˆªå±2021-08-07 ä¸Šåˆ5.49.07.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/16c50506bcc3483dba467db56d270e10~tplv-k3u1fbpfcp-watermark.image)

&emsp;ç„¶åæˆ‘ä»¬åŒå‡» `_func` å‡½æ•°ï¼ˆæ ‡ç­¾ï¼‰ï¼Œè·³è½¬åˆ° `_func` å‡½æ•°çš„ä½ç½®ï¼Œå‘ç°å®ƒçš„åç§»é‡æ˜¯ `0x1520` å’Œä¸Šé¢æˆ‘ä»¬æ‰‹åŠ¨è®¡ç®—åˆ°çš„ä¸€æ ·ï¼Œç„¶åçœ‹åˆ°å®ƒå†…éƒ¨å¯¹ `printf` çš„è°ƒç”¨å…¶å®æ˜¯ `imp___stubs__printf` çš„è°ƒç”¨ï¼Œ`printf` åŒ `NSLog` å‡½æ•°ç±»ä¼¼ï¼Œéƒ½æ˜¯æ¥è‡ªç³»ç»ŸåŠ¨æ€åº“ä¸­çš„å‡½æ•°ï¼ˆ`printf` å‡½æ•°åœ¨ MachOView ä¸­çœ‹åˆ°æ˜¯ä½äº `libSystem.B.dylib` ä¸­ï¼Œä½†æ˜¯åœ¨è¿›ç¨‹ä¸­æ‰“å°æ—¶å´åœ¨ `libsystem_c.dylib` ä¸­ï¼‰ï¼Œå¯çœ‹åˆ° `printf` å‡½æ•°çš„è°ƒç”¨æ–¹å¼å’Œ `func` å‡½æ•°å®Œå…¨ä¸åŒï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ `func` å‡½æ•°æˆ‘ä»¬èƒ½ç›´æ¥åœ¨å½“å‰è¿›ç¨‹çš„ mach-o äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æ‰¾åˆ°å…¶å‡½æ•°å®šä¹‰çš„ä½ç½®ï¼Œè€Œå½“å‰è¿›ç¨‹ä½¿ç”¨åˆ°çš„ç³»ç»Ÿçš„åŠ¨æ€åº“ä¸­çš„å‡½æ•°åˆ™æ˜¯åªåœ¨å½“å‰è¿›ç¨‹çš„ mach-o äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªæ¡©å¯¹åº”ï¼Œåœ¨ç¨‹åºå¯åŠ¨ååˆ™æ˜¯è°ƒç”¨ `dyld_stub_binder` è¿›è¡Œç»‘å®šã€‚

![æˆªå±2021-08-07 ä¸Šåˆ5.49.20.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e80345eda36a44279c7cbdaf33997b08~tplv-k3u1fbpfcp-watermark.image)

&emsp;åŒå‡» `imp___stubs__printf` è·³è½¬åˆ° `imp___stubs__printf` å®šä¹‰å¤„ï¼Œå¯çœ‹åˆ°å®ƒçš„åç§»åŒæ ·æ˜¯ `0x238c`ï¼Œæ­¤æ—¶å†æ¬¡åŒå‡» `_printf_ptr`ã€‚

![æˆªå±2021-08-07 ä¸Šåˆ5.49.56.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0596c6ad93a948aba917cba534c0c39a~tplv-k3u1fbpfcp-watermark.image)

&emsp;æ­¤æ—¶å°±æ¥åˆ°äº† `(__DATA, __la_symbol_ptr)` çš„ä½ç½®ï¼Œå…¶å¯¹åº”çš„æ­£æ˜¯ Lazy Symbol Pointers ä¸­çš„ `_printf` è¿™ä¸ªç¬¦å·æŒ‡é’ˆï¼Œèµ°åˆ°è¿™é‡Œæˆ‘ä»¬å°±å‘ç°äº†å¯¹ `printf` çš„è°ƒç”¨æ˜¯ä» `_printf` è¿™ä¸ª Lazy Symbol Pointer å¯»å€è°ƒç”¨çš„ï¼Œå¹¶ä¸åƒæˆ‘ä»¬è‡ªå·±çš„è‡ªå®šä¹‰å‡½æ•°ï¼Œè°ƒç”¨æ—¶å°±ç›´æ¥æ‹¿åˆ°å‡½æ•°çš„åœ°å€è¿›è¡Œè°ƒç”¨ï¼Œä¸”è¿™é‡Œæˆ‘ä»¬çœ‹åˆ° `_printf` ç¬¦å·æŒ‡é’ˆä½äº `_DATA` æ•°æ®æ®µä¸­ï¼Œæ•°æ®æ®µçš„å†…å®¹å¯è¯»å¯ä¿®æ”¹ï¼Œå› æ­¤è¿™ä¹Ÿæ˜¯ fishhook èƒ½å¤Ÿ hook åŠ¨æ€é“¾æ¥åº“ `Foundation.framework` ä¸­çš„ `printf` çš„ä¸€ä¸ªé‡è¦åŸå› ã€‚ 

![æˆªå±2021-08-07 ä¸Šåˆ5.53.55.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4c215ca7c1b444169df64b58c0705f49~tplv-k3u1fbpfcp-watermark.image)

![æˆªå±2021-08-07 ä¸Šåˆ5.54.04.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d76caf17f4954ba5b0683a527582b582~tplv-k3u1fbpfcp-watermark.image)

### Lazy Sympol Pointers å’Œ Non-Lazy Symbol Pointers ä¸­çš„ç¬¦å·æŒ‡é’ˆçš„é»˜è®¤æŒ‡å‘

&emsp;æˆ‘ä»¬æ¥ç€ä¸Šä¸€æ®µçš„å†…å®¹ç»§ç»­æè¿°ã€‚çœŸæ­£çš„ `printf` å‡½æ•°å®šä¹‰ä½äºç³»ç»ŸåŠ¨æ€é“¾æ¥åº“ `libSystem.B.dylib` ä¸­ï¼Œæ‰€ä»¥å¯¹å½“å‰è¿›ç¨‹æ¥è¯´ `printf` æ˜¯ä¸€ä¸ªå¤–éƒ¨ç¬¦å·ï¼Œç”±äº `ASLR` åç§»é‡ï¼ŒåŠ¨æ€é“¾æ¥åº“æ¯æ¬¡åŠ è½½åˆ°å†…å­˜çš„åœ°å€æ˜¯ä¸å®šçš„ï¼Œæ‰€ä»¥éœ€è¦å¯æ‰§è¡Œæ–‡ä»¶åŠ è½½åˆ°å†…å­˜æ—¶å¯¹ç¬¦å·è¡¨ä¸­ç¬¦å·è¿›è¡Œé‡æ–°ç»‘å®šï¼ˆLazy/Non_Lazyï¼‰ï¼Œä»¥ä¿®æ­£ç¬¦å·è¡¨ä¸­æ¯ä¸ª `nlist_64` ç»“æ„ä½“çš„ `n_value` çš„å€¼ï¼Œè€Œè¿™é‡Œä¾¿æ˜¯æŠŠ `printf` å¯¹åº”çš„ç¬¦å·è¡¨ä¸­çš„ `nlist_64` ç»“æ„ä½“çš„ `n_value` çš„å€¼æ›¿æ¢ä¸º `printf` åœ¨ `libSystem.B.dylib` ä¸­çš„åœ°å€ï¼ˆæˆ–è€…è¯´æ˜¯ `printf` å‡½æ•°å®šä¹‰åœ¨å†…å­˜ä¸­çš„åœ°å€æ›´å‡†ç¡®ä¸€ç‚¹ï¼‰ã€‚ Lazy Symbol Pointers ä¸­çš„ç¬¦å·æŒ‡é’ˆæŒ‡å‘çš„ç¬¦å·ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶æ‰è¿›è¡Œé‡ç»‘å®šï¼ŒNon-Lazy Symbol Pointers ä¸­çš„ç¬¦å·æŒ‡é’ˆæŒ‡å‘çš„ç¬¦å·åˆ™æ˜¯åœ¨ç¨‹åºå¯åŠ¨æ—¶å°±è¿›è¡Œç¬¦å·é‡ç»‘å®šï¼Œä¸”åœ¨ç¨‹åºçš„ mach-o äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼ŒLazy Symbol Pointer é»˜è®¤æŒ‡å‘ `dyld_stub_binder`ï¼Œè€Œ Non-Lazy Symbol Pointer åˆ™é»˜è®¤æŒ‡å‘ `0x000000`ã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡ MachOView æ¥çœ‹ä¸€ä¸‹ã€‚

![æˆªå±2021-08-08 ä¸‹åˆ12.30.44.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6a08fb2428634f0cb195d917393338b4~tplv-k3u1fbpfcp-watermark.image)

![æˆªå±2021-08-08 ä¸‹åˆ12.39.16.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b8a90c2a50a043fea3c26f1c606678f8~tplv-k3u1fbpfcp-watermark.image)

&emsp;å¦‚å›¾æ‰€ç¤ºå¯çœ‹åˆ° Non-Lazy Symbol Pointers ä¸­çš„æ‰€æœ‰çš„ç¬¦å·æŒ‡é’ˆé»˜è®¤éƒ½æ˜¯æŒ‡å‘ `0000000000000000`ï¼Œç¬¦å·è¡¨ä¸­ `objc_msgSend` ç¬¦å·çš„ `n_value` çš„å€¼ä¹Ÿä¸º `0000000000000000`ï¼Œç¨‹åºå¯åŠ¨æ—¶ä¼šå¯¹ç¬¦å·è¡¨ä¸­å½“å‰è¿›ç¨‹ä¸­æ‰€æœ‰çš„ Non-Lazy Symbol Pointers å¯¹åº”çš„ç¬¦å·è¿›è¡Œé‡ç»‘å®šï¼ŒåŒæ—¶ Non-Lazy Symbol Pointer ä¹Ÿä¼šä¿®æ”¹æ­£ç¡®çš„æŒ‡å‘ã€‚  

&emsp;Lazy Symbol Pointers ä¸­çš„ç¬¦å·æŒ‡é’ˆåˆ™é»˜è®¤éƒ½ä¼šæŒ‡å‘åˆ° `dyld_stub_binder` ä¸­å»ã€‚

![æˆªå±2021-08-08 ä¸‹åˆ12.57.11.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d45032fd54cd47d5a30753fe1202aca5~tplv-k3u1fbpfcp-watermark.image)

&emsp;å¦‚å›¾å¯çœ‹åˆ° Lazy Symbol Pointers ä¸­çš„ `_printf` ç¬¦å·æŒ‡é’ˆæŒ‡å‘ `0x10000246E`ï¼Œä¸”ä½äº `_printf` å‰åä¸åŒä½ç½®çš„ç¬¦å·æŒ‡é’ˆçš„æŒ‡å‘å‡ ä¹éƒ½æ˜¯é¡ºåºæ’åˆ—çš„ `0x100002400`ã€`0x100002478`ã€`0x100002482` ç­‰ç­‰ã€‚

![æˆªå±2021-08-08 ä¸‹åˆ12.56.57.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/09530b568bf9419baa3ede5d8aa1fda1~tplv-k3u1fbpfcp-watermark.image)

&emsp;å¦‚å›¾å¯çœ‹åˆ° `0x10000246E` ä½äº `(__TEXT, __stub_helper)` Section ä¸­ï¼Œç„¶åæ±‡ç¼–æŒ‡ä»¤è½¬æ¢çœ‹åˆ°éƒ½æœ‰ä¸€ä¸ªè·³è½¬æŒ‡ä»¤ï¼š`jmp 0x1000023a0`ã€‚å…¶ä¸­å·²çŸ¥ `0x2478` æ˜¯ `_strcmp` ç¬¦å·æŒ‡é’ˆçš„æŒ‡å‘ï¼Œ`0x245A` æ˜¯ `_malloc` ç¬¦å·æŒ‡é’ˆçš„æŒ‡å‘ï¼Œ`0x2450` æ˜¯ `_free` ç¬¦å·æŒ‡é’ˆçš„æŒ‡å‘ï¼Œç„¶åæˆ‘ä»¬ä¸Šä¸‹ç¿»åŠ¨ `(__TEXT, __stub_helper)` Section ä¸­çš„å†…å®¹ï¼Œå¯çœ‹åˆ°æ¯ä¸ªæŒ‡å‘è¿™é‡Œçš„ Lazy Symbol Pointers ä¸­çš„ç¬¦å·æŒ‡é’ˆé»˜è®¤éƒ½ä¼šè·³è½¬åˆ° `0x1000023a0` è¿™ä¸ªåœ°å€ã€‚ 

![æˆªå±2021-08-08 ä¸‹åˆ12.57.56.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/799db8ec4b084185b3a1e526455166af~tplv-k3u1fbpfcp-watermark.image)

&emsp;`0x23A0` æ˜¯ `(__TEXT, __stub_helper)` Section çš„èµ·å§‹ä½ç½®ï¼Œå…¶ä¸­çš„ `jmp qword ptr [rip + 0xec71]` ä¾¿æ˜¯è·³è½¬åˆ° `dyld_stub_binder`ï¼Œ`dyld_stub_binder` ä¾¿æ˜¯ dyld è¿›è¡Œæ¡©ç»‘å®šï¼Œå³ dyld è¿›è¡Œç¬¦å·ç»‘å®šã€‚

## Lazy Symbol Pointer çš„åŠ¨æ€ç»‘å®šè¿‡ç¨‹ï¼ˆdyld_stub_binderï¼‰ 

&emsp;å·²çŸ¥åœ¨ `(__DATA, __got)/(__DATA_CONST, __got)`ã€`(__DATA, __la_symbol_ptr)`ã€`(__DATA, __nl_symbol_ptr)` è¿™äº› Section ä¸­ä¿å­˜çš„åˆ†åˆ«æ˜¯ Lazy Symbol Pointers å’Œ Non-Lazy Symbol Pointersï¼Œå³åˆ†åˆ«ä¸º Lazy Binding æŒ‡é’ˆè¡¨å’Œ Non Lazy Binding æŒ‡é’ˆè¡¨ã€‚å…¶ä¸­çš„ Lazy Binding æŒ‡é’ˆè¡¨æ¯”è¾ƒç‰¹æ®Šï¼Œæˆ‘ä»¬ä»åå­—å¯ä»¥çœ‹å‡ºå®ƒæ˜¯ä¸€ä¸ªæ‡’ç»‘å®šæŒ‡é’ˆè¡¨ï¼Œå½“ mach-o äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶é€šè¿‡ dyld åŠ è½½æ—¶å¹¶æ²¡æœ‰åœ¨åŠ è½½  Lazy Binding æŒ‡é’ˆè¡¨çš„è¿‡ç¨‹ä¸­ç›´æ¥å¯¹å…¶ä¸­çš„ç¬¦å·æŒ‡é’ˆè¿›è¡Œç»‘å®šï¼ˆç¡®å®šå®ƒä»¬æŒ‡å‘çš„ç¬¦å·åœ°å€ï¼‰ï¼Œè€Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥ç¬¦å·æŒ‡é’ˆå¯¹åº”çš„å‡½æ•°æ—¶ï¼Œé€šè¿‡ PLT(Procedure Linkage Table) æ¥è¿›è¡Œä¸€æ¬¡ Lazy Bindingã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡å¦‚ä¸‹ç¤ºä¾‹ä»£ç è¿›è¡ŒéªŒè¯ã€‚

```c++
#include <stdio.h>

int main(int argc, char * argv[]) {
    
    printf("â™»ï¸â™»ï¸â™»ï¸ %s \n", "hello world");
    printf("â™»ï¸â™»ï¸â™»ï¸ %s \n", "hello desgard");
    
    return 0;
}
```

&emsp;ç„¶åæˆ‘ä»¬ä½¿ç”¨ Hopper Disassembler æŸ¥çœ‹å…¶æ±‡ç¼–å®ç°å¦‚ä¸‹ï¼š

```c++
_main:
0000000100002160         push       rbp
0000000100002161         mov        rbp, rsp
0000000100002164         sub        rsp, 0x20
0000000100002168         mov        dword [rbp+var_4], 0x0
000000010000216f         mov        dword [rbp+var_8], edi
0000000100002172         mov        qword [rbp+var_10], rsi
0000000100002176         lea        rdi, qword [aXe2x99xbbxefxb] ; argument "format" for method imp___stubs__printf, "\\xE2\\x99\\xBB\\xEF\\xB8\\x8F\\xE2\\x99\\xBB\\xEF\\xB8\\x8F\\xE2\\x99\\xBB\\xEF\\xB8\\x8F %s \\n"
000000010000217d         lea        rsi, qword [aHelloWorld]     ; "hello world"
0000000100002184         mov        al, 0x0
0000000100002186         call       imp___stubs__printf          ; printf
000000010000218b         lea        rdi, qword [aXe2x99xbbxefxb] ; argument "format" for method imp___stubs__printf, "\\xE2\\x99\\xBB\\xEF\\xB8\\x8F\\xE2\\x99\\xBB\\xEF\\xB8\\x8F\\xE2\\x99\\xBB\\xEF\\xB8\\x8F %s \\n"
0000000100002192         lea        rsi, qword [aHelloDesgard]   ; "hello desgard"
0000000100002199         mov        dword [rbp+var_14], eax
000000010000219c         mov        al, 0x0
000000010000219e         call       imp___stubs__printf          ; printf
00000001000021a3         xor        ecx, ecx
00000001000021a5         mov        dword [rbp+var_18], eax
00000001000021a8         mov        eax, ecx
00000001000021aa         add        rsp, 0x20
00000001000021ae         pop        rbp
00000001000021af         ret
   ; endp
```

&emsp;å¯çœ‹åˆ°è°ƒç”¨ `printf` å‡½æ•°çš„æ—¶å€™ä¼šè§¦å‘ `call imp___stubs__printf ; printf` æŒ‡ä»¤ï¼ŒåŒå‡» `imp___stubs__printf` è¿›å…¥å…¶å­˜å‚¨ä½ç½®æŸ¥çœ‹ï¼š

```c++
imp___stubs__printf:        // printf
0000000100002452         jmp        qword [_printf_ptr] ; _printf_ptr, _printf_ptr,_printf, CODE XREF=_main+38, _main+62
   ; endp
```

&emsp;ç„¶åå†åŒå‡» `_printf_ptr` å¯çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š

```c++
_printf_ptr:
0000000100008028         extern     _printf ; DATA XREF=imp___stubs__printf
```

&emsp;é€šè¿‡ä¸Šé¢çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œæˆ‘ä»¬çœ‹åˆ° `imp___stubs__printf` æŒ‡é’ˆæŒ‡å‘äº† `0x0000000100008028`ï¼Œå³å¯ä»¥çŸ¥é“æˆ‘ä»¬çš„ `(__DATA, __la_symbol_ptr)` Section ä¸­çš„ `_printf` è¿™ä¸ªæŒ‡é’ˆåœ¨ mach-o äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶çš„åç§»å€¼æ˜¯ `0x8028`ã€‚ä¸‹é¢æˆ‘ä»¬åœ¨ä¸¤ä¸ª `printf` æ–¹æ³•å‰åŠ ä¸Šæ–­ç‚¹ï¼Œç„¶åä½¿ç”¨ LLDB å¯¹å…¶è¿›è¡Œè°ƒè¯•ï¼š

&emsp;é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ `image list` æŒ‡ä»¤è·å¾—å½“å‰è¿›ç¨‹åœ¨å†…å­˜ä¸­çš„é¦–åœ°å€ `0x000000010b941000`ã€‚

```c++
(lldb) image list
[  0] 7FE17B7A-D271-3133-9A56-A92A3780D8BC 0x000000010b941000 /Users/hmc/Library/Developer/Xcode/DerivedData/TEST_Fishhook-guvclcyaszalpmdldofnoxqksebw/Build/Products/Debug-iphonesimulator/TEST_Fishhook.app/TEST_Fishhook 
...
```

&emsp;ç„¶åæˆ‘ä»¬ä½¿ç”¨ `memory read 0x000000010b941000+0x8028` æŒ‡ä»¤æŸ¥çœ‹ `_printf` ç¬¦å·æŒ‡é’ˆçš„æŒ‡å‘å†…å®¹ï¼Œå·²çŸ¥ iOS æ˜¯å°ç«¯æ¨¡å¼ï¼Œå¯çŸ¥ `_printf` ç¬¦å·æŒ‡é’ˆæŒ‡å‘ `0x010b94349a`

```c++
(lldb) memory read 0x000000010b941000+0x8028
0x10b949028: 9a 34 94 0b 01 00 00 00 81 00 00 00 28 00 00 00  .4..........(...
0x10b949038: 28 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  (...............
(lldb) 
```

&emsp;ç„¶åæˆ‘ä»¬ä½¿ç”¨ `dis -s 0x010b94349a` æŠŠæ­¤åœ°å€çš„æ•°æ®è½¬æ¢ä¸ºæ±‡ç¼–æŒ‡ä»¤ï¼Œçœ‹åˆ°å…¶ä¸­æœ‰ä¸€ä¸ª `jmp 0x10b943458` æŒ‡ä»¤è·³è½¬ã€‚

```c++
(lldb) dis -s 0x010b94349a
    0x10b94349a: pushq  $0x91
    0x10b94349f: jmp    0x10b943458
    0x10b9434a4: jbe    0x10b94350f               ; ""
    0x10b9434a6: ja     0x10b9434ed               ; "ector:"
    0x10b9434a9: imull  $0x72006461, 0x6f(%rsp,%rcx,2), %esp ; imm = 0x72006461 
    0x10b9434b1: outsl  (%rsi), %dx
    0x10b9434b2: insb   %dx, %es:(%rdi)
    0x10b9434b3: addb   %ch, %gs:0x6e(%rcx)
(lldb) 
```

&emsp;ç„¶åæˆ‘ä»¬ä½¿ç”¨ `dis -s 0x10b943458` æŸ¥çœ‹ `0x10b943458` ä¸­çš„å†…å®¹ï¼Œå¯çœ‹åˆ°å…¶ä¸­å¯¹ `dyld_stub_binder` çš„è°ƒç”¨ï¼Œ`dyld_stub_binder` æ–¹æ³•çš„ä½œç”¨ç®€å•æ¥è®²å°±æ˜¯è®¡ç®—å¯¹åº”çš„å‡½æ•°åœ°å€è¿›è¡Œç»‘å®šï¼Œä¹‹åè¿›è€Œè°ƒç”¨å¯¹åº”å‡½æ•°ã€‚

```c++
(lldb) dis -s 0x10b943458
    0x10b943458: leaq   0x7019(%rip), %r11        ; _dyld_private
    0x10b94345f: pushq  %r11
    0x10b943461: jmpq   *0x1ba9(%rip)             ; (void *)0x00007fff2025cbb4: dyld_stub_binder
    0x10b943467: nop    
    0x10b943468: pushq  $0x0
    0x10b94346d: jmp    0x10b943458
    0x10b943472: pushq  $0x12
(lldb) 
```

&emsp;æ­¤æ—¶æˆ‘ä»¬å†å•æ­¥æ‰§è¡Œï¼Œåˆ°è¾¾ç¬¬äºŒä¸ªæ–­ç‚¹ï¼Œçœ‹åˆ°æ§åˆ¶å°è¾“å‡ºäº† `â™»ï¸â™»ï¸â™»ï¸ hello world ` æ­¤æ—¶è¡¨ç¤ºæˆ‘ä»¬ç¬¬ä¸€æ¬¡è°ƒç”¨ `printf` å‡½æ•°ç»“æŸäº†ã€‚æ­¤æ—¶æˆ‘ä»¬å†æ¬¡è°ƒç”¨ `memory read 0x000000010b941000+0x8028` æŸ¥çœ‹ `_printf` ç¬¦å·æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ã€‚ 

```c++
(lldb) memory read 0x000000010b941000+0x8028
0x10b949028: e8 f4 0b 20 ff 7f 00 00 81 00 00 00 28 00 00 00  ... ........(...
0x10b949038: 28 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  (...............
(lldb) 
```

&emsp;å¯çœ‹åˆ°æ­¤æ—¶ `_printf` ç¬¦å·æŒ‡é’ˆæŒ‡å‘ `0x7fff200bf4e8`ï¼Œç„¶åæˆ‘ä»¬ä½¿ç”¨ `dis -s 0x7fff200bf4e8` æŸ¥çœ‹å†…å®¹ï¼Œæ­¤æ—¶ä¾¿å¯çœ‹åˆ° `_printf` ç¬¦å·æŒ‡é’ˆæ­¤æ—¶ä¾¿æŒ‡å‘ `libsystem_c.dylib printf` å‡½æ•°äº†ã€‚

```c++
(lldb) dis -s 0x7fff200bf4e8
libsystem_c.dylib`printf:
    0x7fff200bf4e8 <+0>:  pushq  %rbp
    0x7fff200bf4e9 <+1>:  movq   %rsp, %rbp
    0x7fff200bf4ec <+4>:  pushq  %r14
    0x7fff200bf4ee <+6>:  pushq  %rbx
    0x7fff200bf4ef <+7>:  subq   $0xd0, %rsp
    0x7fff200bf4f6 <+14>: movq   %rdi, %r14
    0x7fff200bf4f9 <+17>: testb  %al, %al
    0x7fff200bf4fb <+19>: je     0x7fff200bf526            ; <+62>
    0x7fff200bf4fd <+21>: movaps %xmm0, -0xb0(%rbp)
(lldb) 
```

&emsp;å³æˆ‘ä»¬çš„ Lazy Binding æŒ‡é’ˆåœ¨ç¬¬ä¸€è°ƒç”¨æ—¶é€šè¿‡ `dyld_stub_binder` å‡½æ•°å¯¹å…¶è¿›è¡Œæ­£ç¡®çš„ç»‘å®šï¼Œå¹¶è¿›è¡Œè°ƒç”¨ï¼Œç„¶ååç»­å†å¯¹å…¶è°ƒç”¨å°±æ˜¯ç›´æ¥è°ƒç”¨ Lazy Symbol Pointer æ‰€æŒ‡å‘çš„å‡½æ•°äº†ã€‚ 

## ASLR ç®€è¿°

&emsp;ASLR(Address Space Layout Randomizationï¼Œåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–)ï¼Œæ˜¯ä¸€ç§é’ˆå¯¹ç¼“å†²åŒºæº¢å‡ºçš„å®‰å…¨ä¿æŠ¤æŠ€æœ¯ã€‚å€ŸåŠ© ASLRï¼Œmach-o äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶æ¯æ¬¡åŠ è½½åˆ°å†…å­˜çš„èµ·å§‹åœ°å€éƒ½ä¼šéšæœºå˜åŒ–ã€‚ç›®å‰å¤§éƒ¨åˆ†ä¸»æµæ“ä½œç³»ç»Ÿéƒ½å·²ç»å®ç°äº† ASLRï¼Œå¦‚ Windows Vistaã€Linux 2.6.12ã€Mac OS X 10.7ã€iOS 4.3 ä»¥åŠ Android 4.0 å‡ä»æ­¤ç‰ˆæœ¬å¼€å§‹æ”¯æŒ ASLRã€‚

&emsp;ç®€å•è¯´ï¼ŒASLR ä½¿å¾—æ¸—é€ï¼ˆåŸºäºç¼“å†²åŒºæº¢å‡ºï¼‰æ”»å‡»çš„éš¾åº¦æ˜æ˜¾æå‡ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚ä½†æ˜¯ï¼Œå¯¹äºä¸æ˜¯æå®‰å…¨/é€†å‘çš„ Programmer æ¥è¯´ï¼Œåœ¨è°ƒè¯•ç¨‹åºæ—¶è¿™å°±ç•¥æ˜¾è›‹ç–¼ã€‚æ§åˆ¶å˜é‡æ˜¯è°ƒè¯•é˜¶æ®µçš„ä¸€å¤§åŸåˆ™ã€‚

## PIC ç®€è¿°

&emsp;è‹¹æœä¸ºäº†èƒ½åœ¨ mach-O äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ä¸­è®¿é—®å¤–éƒ¨å‡½æ•°ï¼ˆç³»ç»ŸåŠ¨æ€é“¾æ¥åº“/å…±äº«ç¼“å­˜åº“ä¸­çš„å‡½æ•°ï¼‰ï¼Œé‡‡ç”¨äº†ä¸€ä¸ªæŠ€æœ¯ï¼Œå«åš PICï¼ˆPosition-independent code ä½ç½®ä»£ç ç‹¬ç«‹ï¼‰æŠ€æœ¯ã€‚

&emsp;C è¯­è¨€æ˜¯é™æ€çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç¼–è¯‘çš„æ—¶å€™å°±å·²ç»ç¡®å®šäº†å‡½æ•°çš„åœ°å€ï¼Œè€Œç³»ç»ŸåŠ¨æ€åº“ä¸­çš„å‡½æ•°å¹¶ä¸ä¼šç›´æ¥ç¼–è¯‘è¿› mach-o äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥åœ¨ mach-o äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶æ²¡æœ‰å¯åŠ¨ä¹‹å‰ï¼Œæ˜¯æ— æ³•ç¡®å®šå¼•ç”¨åˆ°çš„ç³»ç»ŸåŠ¨æ€åº“ä¸­çš„å‡½æ•°çš„åœ°å€çš„ï¼Œåªæœ‰åœ¨ mach-o äºŒè¿›åˆ¶æ–‡ä»¶å¯åŠ¨è¿è¡Œçš„æ—¶å€™æ‰èƒ½å€Ÿç”± dyld å¯¹ä½¿ç”¨åˆ°çš„ç³»ç»ŸåŠ¨æ€åº“ä¸­çš„å‡½æ•°è¿›è¡Œç»‘å®šï¼Œç¡®è®¤å…¶å‡½æ•°åœ°å€ã€‚æ‰€ä»¥ä¸ºäº†è¿™äº›å¼•ç”¨åˆ°çš„ç³»ç»ŸåŠ¨æ€åº“ä¸­å‡½æ•°ï¼Œè‹¹æœé’ˆå¯¹ mach-o äºŒè¿›åˆ¶æ–‡ä»¶æä¾›äº† PIC æŠ€æœ¯ï¼Œé¦–å…ˆåœ¨ mach-o äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ä¸­æ·»åŠ äº† Lazy Symbol Pointers æ‡’åŠ è½½ç¬¦å·æŒ‡é’ˆè¡¨å’Œ Non-Lazy Symbol Pointers éæ‡’åŠ è½½ç¬¦å·æŒ‡é’ˆè¡¨ï¼Œå®ƒä»¬ä¸­è®°å½•çš„éƒ½æ˜¯ä½¿ç”¨åˆ°çš„ç³»ç»ŸåŠ¨æ€åº“ä¸­çš„ç¬¦å·ï¼Œåœ¨ mach-o äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å¯åŠ¨ä¹‹å‰ Lazy Symbol Pointer é»˜è®¤æŒ‡å‘ `dyld_stub_binder`ï¼Œè€Œ Non-Lazy Symbol Pointer åˆ™é»˜è®¤æŒ‡å‘ `0x000000`ï¼Œå¯åŠ¨ä¹‹åï¼Œåˆ™é€šè¿‡ dyld å¯¹è¿™äº›ç¬¦å·æŒ‡é’ˆè¿›è¡Œç»‘å®šï¼Œä¸ºå®ƒä»¬èµ‹å€¼åŠ¨æ€ç¼“å­˜åº“ä¸­ç¡®å®šçš„å‡½æ•°åœ°å€ã€‚

&emsp;å½“åº”ç”¨ç¨‹åºæƒ³è¦è°ƒç”¨ mach-o äºŒè¿›åˆ¶æ–‡ä»¶å¤–éƒ¨çš„å‡½æ•°æ—¶ï¼Œæˆ–è€…è¯´æ˜¯å¦‚æœ mach-o äºŒè¿›åˆ¶æ–‡ä»¶å†…éƒ¨éœ€è¦è°ƒç”¨ç³»ç»Ÿçš„åº“å‡½æ•°æ—¶ï¼Œmach-o æ–‡ä»¶ä¼šåœ¨ `__DATA` æ®µä¸­å»ºç«‹å¯¹åº”çš„ç¬¦å·æŒ‡é’ˆè¡¨ï¼Œè¿™äº›ç¬¦å·æŒ‡é’ˆæŒ‡å‘å¤–éƒ¨å‡½æ•°ï¼Œdyld ä¼šå¯¹å®ƒä»¬è¿›è¡ŒåŠ¨æ€ç»‘å®šå°†å®ƒä»¬æŒ‡å‘æ­£ç¡®çš„å‡½æ•°åœ°å€ã€‚

&emsp;æ‰€ä»¥è¿™ä¹ˆçœ‹çš„è¯ï¼Œmach-o äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ä¸­ä½¿ç”¨åˆ°çš„ç³»ç»ŸåŠ¨æ€åº“ä¸­çš„ C å‡½æ•°åœ¨ mach-o äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å¯åŠ¨è¿è¡Œè¿›å†…å­˜çš„æ—¶å€™ä¹Ÿæœ‰äº†åŠ¨æ€çš„è¡¨ç°ï¼ŒC åœ¨å†…éƒ¨å‡½æ•°çš„æ—¶å€™æ˜¯é™æ€çš„ï¼Œåœ¨ç¼–è¯‘åå‡½æ•°çš„åœ°å€å°±ç¡®å®šäº†ï¼Œä½†æ˜¯ï¼Œå¼•ç”¨åˆ°çš„å¤–éƒ¨çš„å‡½æ•°æ˜¯ä¸èƒ½ç¡®å®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ C çš„åº•å±‚ä¹Ÿæœ‰äº†åŠ¨æ€ç‰¹æ€§ã€‚fishhook æ­£æ˜¯å€ŸåŠ©äºè¿™ä¸€ç‚¹ï¼Œfishhook çš„åŸç†å…¶å®å°±æ˜¯ï¼Œå°†æŒ‡å‘ç³»ç»Ÿæ–¹æ³•ï¼ˆå¤–éƒ¨å‡½æ•°ï¼‰çš„ç¬¦å·æŒ‡é’ˆé‡æ–°è¿›è¡Œç»‘å®šæŒ‡å‘å†…éƒ¨çš„å‡½æ•°ã€‚è¿™æ ·å°±æŠŠç³»ç»Ÿæ–¹æ³•ä¸è‡ªå·±å®šä¹‰çš„æ–¹æ³•è¿›è¡Œäº†äº¤æ¢ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ C çš„å†…éƒ¨å‡½æ•°ä¿®æ”¹ä¸äº†ï¼Œè‡ªå®šä¹‰çš„å‡½æ•°ä¿®æ”¹ä¸äº†ï¼Œåªèƒ½ä¿®æ”¹ mach-o å¤–éƒ¨ã€å…±äº«ç¼“å­˜åº“ä¸­ã€‘çš„å‡½æ•°ã€‚  

> &emsp;å¤§å®¶éƒ½çŸ¥é“ OC çš„æ–¹æ³•ä¹‹æ‰€ä»¥å¯ä»¥ HOOK æ˜¯å› ä¸ºå®ƒçš„è¿è¡Œæ—¶ç‰¹æ€§ï¼ŒOC çš„æ–¹æ³•è°ƒç”¨åœ¨åº•å±‚éƒ½æ˜¯ msg_sendï¼ˆid,SELï¼‰çš„å½¢å¼ï¼Œè¿™ä¸ºæˆ‘ä»¬æä¾›äº†äº¤æ¢æ–¹æ³•å®ç°ï¼ˆIMPï¼‰çš„æœºä¼šï¼Œä½† C å‡½æ•°åœ¨ç¼–è¯‘é“¾æ¥æ—¶å°±ç¡®å®šäº†å‡½æ•°æŒ‡é’ˆçš„åœ°å€åç§»é‡ï¼ˆOffsetï¼‰ï¼Œè¿™ä¸ªåç§»é‡åœ¨ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­æ˜¯å›ºå®šçš„ï¼Œè€Œå¯æ‰§è¡Œæ–‡ä»¶æ¯æ¬¡è¢«é‡æ–°è£…è½½åˆ°å†…å­˜ä¸­æ—¶è¢«ç³»ç»Ÿåˆ†é…çš„èµ·å§‹åœ°å€ï¼ˆåœ¨ lldb ä¸­ç”¨å‘½ä»¤ image List è·å–ï¼‰æ˜¯ä¸æ–­å˜åŒ–çš„ã€‚è¿è¡Œä¸­çš„é™æ€å‡½æ•°æŒ‡é’ˆåœ°å€å…¶å®å°±ç­‰äºä¸Šè¿° Offset + mach-o æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„é¦–åœ°å€ã€‚ï¼ˆæˆ‘ä»¬çŸ¥é“ C å‡½æ•°æ˜¯é™æ€çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨å°±çŸ¥é“äº†å®ƒçš„å®ç°åœ°å€ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ C å‡½æ•°åªå†™å‡½æ•°å£°æ˜è°ƒç”¨æ—¶ä¼šæŠ¥é”™ã€‚ï¼‰
> &emsp;æ—¢ç„¶ C å‡½æ•°çš„æŒ‡é’ˆåœ°å€æ˜¯ç›¸å¯¹å›ºå®šä¸”ä¸å¯ä¿®æ”¹çš„ï¼Œé‚£ä¹ˆ fishhook åˆæ˜¯æ€ä¹ˆå®ç° å¯¹ C å‡½æ•°çš„ HOOK å‘¢ï¼Ÿå…¶å®å†…éƒ¨/è‡ªå®šä¹‰çš„ C å‡½æ•° fishhook ä¹Ÿ HOOK ä¸äº†ï¼Œå®ƒåªèƒ½ HOOK Mach-O å¤–éƒ¨ï¼ˆå…±äº«ç¼“å­˜åº“ä¸­ï¼‰çš„å‡½æ•°ã€‚fishhook åˆ©ç”¨äº† MachO çš„åŠ¨æ€ç»‘å®šæœºåˆ¶ï¼Œè‹¹æœçš„å…±äº«ç¼“å­˜åº“ä¸ä¼šè¢«ç¼–è¯‘è¿›æˆ‘ä»¬çš„ MachO æ–‡ä»¶ï¼Œè€Œæ˜¯åœ¨åŠ¨æ€é“¾æ¥æ—¶æ‰å»é‡æ–°ç»‘å®šã€‚è‹¹æœé‡‡ç”¨äº†PICï¼ˆPosition-independent codeï¼‰æŠ€æœ¯æˆåŠŸè®© C çš„åº•å±‚ä¹Ÿèƒ½æœ‰åŠ¨æ€çš„è¡¨ç°ã€‚
>  + ç¼–è¯‘æ—¶åœ¨ Mach-O æ–‡ä»¶ _DATA æ®µçš„ç¬¦å·è¡¨ä¸­ä¸ºæ¯ä¸€ä¸ªè¢«å¼•ç”¨çš„ç³»ç»Ÿ C å‡½æ•°å»ºç«‹ä¸€ä¸ªæŒ‡é’ˆï¼ˆ8 å­—èŠ‚çš„æ•°æ®ï¼Œæ”¾çš„å…¨æ˜¯ 0ï¼‰ï¼Œè¿™ä¸ªæŒ‡é’ˆç”¨äºåŠ¨æ€ç»‘å®šæ—¶é‡å®šä½åˆ°å…±äº«åº“ä¸­çš„å‡½æ•°å®ç°ã€‚
>  + åœ¨è¿è¡Œæ—¶å½“ç³»ç»Ÿ C å‡½æ•°è¢«ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ä¼šåŠ¨æ€ç»‘å®šä¸€æ¬¡ï¼Œç„¶åå°† Mach-O ä¸­çš„ _DATA æ®µç¬¦å·è¡¨ä¸­å¯¹åº”çš„æŒ‡é’ˆï¼ŒæŒ‡å‘å¤–éƒ¨å‡½æ•°ï¼ˆå…¶åœ¨å…±äº«åº“ä¸­çš„å®é™…å†…å­˜åœ°å€ï¼‰ã€‚
>  
>  &emsp;fishhook æ­£æ˜¯åˆ©ç”¨äº† PIC æŠ€æœ¯åšäº†è¿™ä¹ˆä¸¤ä¸ªæ“ä½œï¼š
>  
>  + å°†æŒ‡å‘ç³»ç»Ÿæ–¹æ³•ï¼ˆå¤–éƒ¨å‡½æ•°ï¼‰çš„æŒ‡é’ˆé‡æ–°è¿›è¡Œç»‘å®šæŒ‡å‘å†…éƒ¨å‡½æ•°/è‡ªå®šä¹‰ C å‡½æ•°ã€‚
>  + å°†å†…éƒ¨å‡½æ•°çš„æŒ‡é’ˆåœ¨åŠ¨æ€é“¾æ¥æ—¶æŒ‡å‘ç³»ç»Ÿæ–¹æ³•çš„åœ°å€ã€‚
>  
>  &emsp;è¿™æ ·å°±æŠŠç³»ç»Ÿæ–¹æ³•ä¸è‡ªå·±å®šä¹‰çš„æ–¹æ³•è¿›è¡Œäº†äº¤æ¢ï¼Œè¾¾åˆ° HOOK ç³»ç»Ÿ C å‡½æ•°ï¼ˆå…±äº«åº“ä¸­çš„ï¼‰çš„ç›®çš„ã€‚[fishhookçš„å®ç°åŸç†æµ…æ](https://juejin.cn/post/6844903789783154702)


> &emsp;ç”±äº iOS ç³»ç»Ÿä¸­çš„ UIKit / Foundation ç³»ç»Ÿåº“æ¯ä¸ªåº”ç”¨éƒ½ä¼šé€šè¿‡ dyld åŠ è½½åˆ°å†…å­˜ä¸­, å› æ­¤, ä¸ºäº†èŠ‚çº¦ç©ºé—´, è‹¹æœå°†è¿™äº›ç³»ç»Ÿåº“æ”¾åœ¨äº†ä¸€ä¸ªåœ°æ–¹ : åŠ¨æ€åº“å…±äº«ç¼“å­˜åŒºï¼ˆdyld shared cacheï¼‰ã€‚ï¼ˆMac OS ä¸€æ ·æœ‰ï¼‰ã€‚å› æ­¤ , ç±»ä¼¼ NSLog çš„å‡½æ•°å®ç°åœ°å€ï¼Œå¹¶ä¸ä¼šä¹Ÿä¸å¯èƒ½ä¼šåœ¨æˆ‘ä»¬è‡ªå·±çš„å·¥ç¨‹çš„ Mach-O ä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„å·¥ç¨‹æƒ³è¦è°ƒç”¨ NSLog æ–¹æ³•ï¼Œå¦‚ä½•èƒ½æ‰¾åˆ°å…¶çœŸå®çš„å®ç°åœ°å€å‘¢?
> &emsp;å…¶æµç¨‹å¦‚ä¸‹ï¼š
>
> + åœ¨å·¥ç¨‹ç¼–è¯‘æ—¶ï¼Œæ‰€äº§ç”Ÿçš„ Mach-O å¯æ‰§è¡Œæ–‡ä»¶ä¸­ä¼šé¢„ç•™å‡ºä¸€æ®µç©ºé—´, è¿™ä¸ªç©ºé—´å…¶å®å°±æ˜¯ç¬¦å·è¡¨ï¼ˆå’Œæ‡’åŠ è½½å’Œéæ‡’åŠ è½½ç¬¦å·æŒ‡é’ˆè¡¨ï¼‰ï¼Œå­˜æ”¾åœ¨ _DATA æ•°æ®æ®µä¸­ï¼ˆå› ä¸º _DATA æ®µåœ¨è¿è¡Œæ—¶æ˜¯å¯è¯»å¯å†™çš„ï¼‰ 
> + ç¼–è¯‘æ—¶ï¼šå·¥ç¨‹ä¸­æ‰€æœ‰å¼•ç”¨äº†å…±äº«ç¼“å­˜åŒºä¸­çš„ç³»ç»Ÿåº“æ–¹æ³• , å…¶æŒ‡å‘çš„åœ°å€è®¾ç½®æˆç¬¦å·åœ°å€ï¼Œï¼ˆä¾‹å¦‚å·¥ç¨‹ä¸­æœ‰ä¸€ä¸ª NSLogï¼Œé‚£ä¹ˆç¼–è¯‘æ—¶å°±ä¼šåœ¨ Mach-O ä¸­åˆ›å»ºä¸€ä¸ª NSLog çš„ç¬¦å·ï¼ˆä»¥åŠåœ¨æ‡’åŠ è½½ç¬¦å·æŒ‡é’ˆè¡¨ä¸­ï¼Œæœ‰ä¸€ä¸ªç¬¦å·æŒ‡é’ˆç­‰å¾…ç€æŒ‡å‘ NSLog å‡½æ•°åœ°å€ï¼‰ï¼Œå·¥ç¨‹ä¸­çš„ NSLog å°±æŒ‡å‘è¿™ä¸ªç¬¦å·ï¼‰ 
> + è¿è¡Œæ—¶ï¼šå½“ dyld å°†åº”ç”¨åŠ è½½åˆ°å†…å­˜ä¸­æ—¶ï¼Œæ ¹æ® load commands ä¸­åˆ—å‡ºçš„éœ€è¦åŠ è½½å“ªäº›åº“æ–‡ä»¶ï¼Œå»åšç»‘å®šçš„æ“ä½œï¼ˆä»¥ NSLog ä¸ºä¾‹ï¼Œdyld å°±ä¼šå»æ‰¾åˆ° Foundation ä¸­ NSLog çš„çœŸå®åœ°å€å†™åˆ° _DATA æ®µçš„ç¬¦å·è¡¨ä¸­ NSLog çš„ç¬¦å·ä¸Šé¢ï¼ˆä»¥åŠæ‡’åŠ è½½ç¬¦å·æŒ‡é’ˆè¡¨ä¸­ NSLog ç¬¦å·æŒ‡é’ˆå†…ï¼‰ï¼‰ 
>
> &emsp;è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸º PIC æŠ€æœ¯ã€‚ï¼ˆPosition Independent Codeï¼šä½ç½®ä»£ç ç‹¬ç«‹ï¼‰ 
> &emsp;é‚£ä¹ˆäº†è§£äº†ç³»ç»Ÿå‡½æ•°çš„æ•´ä¸ªåŠ è½½è¿‡ç¨‹ , æˆ‘ä»¬å†æ¥çœ‹ fishhook çš„å‡½æ•°åç§° :
> rebind_symbols :: é‡ç»‘å®šç¬¦å· ä¹Ÿå°±ç®€å•æ˜äº†äº†.
> &emsp;å…¶åŸç†å°±æ˜¯ :
>
> å°†ç¼–è¯‘åç³»ç»Ÿåº“å‡½æ•°æ‰€æŒ‡å‘çš„ç¬¦å·ï¼Œåœ¨è¿è¡Œæ—¶é‡ç»‘å®šåˆ°ç”¨æˆ·æŒ‡å®šçš„å‡½æ•°åœ°å€ï¼Œç„¶åå°†åŸç³»ç»Ÿå‡½æ•°çš„çœŸå®åœ°å€èµ‹å€¼åˆ°ç”¨æˆ·æŒ‡å®šçš„æŒ‡é’ˆä¸Šã€‚
>
> &emsp;é‚£ä¹ˆå†å›å¤´çœ‹è‡ªå®šä¹‰çš„ C å‡½æ•°ä¸ºä»€ä¹ˆ hook ä¸äº† ?
> &emsp;é‚£ç­”æ¡ˆå°±å¾ˆç®€å•äº† :
>
> &emsp;è‡ªå®šä¹‰ C å‡½æ•°å®é™…åœ°å€å°±åœ¨è‡ªå·±çš„ Mach-O å†… , å¹¶æ²¡æœ‰ç¬¦å·æŒ‡é’ˆå’Œé‡ç»‘å®šçš„è¿‡ç¨‹ã€‚
> &emsp;ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šäº†ï¼Œå¹¶æ²¡æœ‰åŠæ³•æ“ä½œã€‚ [iOS é€†å‘ - Hook / fishHook åŸç†ä¸ç¬¦å·è¡¨](https://juejin.cn/post/6844903992904908814)


## æ€»ç»“

&emsp;è‡³æ­¤ï¼Œfishhook ç›¸å…³çš„å†…å®¹å°±å…¨éƒ¨ææ‡‚äº†ï¼Œè¯´å®è¯æ”¶è·å·¨å¤§ï¼Œç‰¹åˆ«æ˜¯å¯¹ mach-o æ–‡ä»¶çš„äº†è§£æ›´åŠ æ·±å…¥äº†ï¼Œè¯´å®è¯ fishhook æ€»å…± 200 è¡Œçš„æºç å¹¶ä¸å¤æ‚ï¼Œå¤æ‚å°±å¤æ‚åœ¨å¯¹ mach-o ç¬¦å·ç›¸å…³çš„éƒ¨åˆ†çš„ç»“æ„è¦äº†å¦‚æŒ‡æŒï¼Œä»¥åŠå¯¹åŠ¨æ€é“¾æ¥åº“çš„é‡ç»‘å®šæœºåˆ¶ä¹Ÿè¦äº†å¦‚æŒ‡æŒï¼Œæ„Ÿè°¢ fishhookï¼Œæ„Ÿè°¢ facebookï¼

&emsp;æŠŠ **è¿è¡Œæ—¶åº“çš„é“¾æ¥è¿‡ç¨‹** æ¨è¿Ÿåˆ°äº† **è¿è¡Œæ—¶** å†è¿›è¡Œï¼Œè¿™å°±æ˜¯ **åŠ¨æ€é“¾æ¥ï¼ˆDynamic Linkingï¼‰** çš„åŸºæœ¬æ€æƒ³ã€‚

## å‚è€ƒé“¾æ¥
**å‚è€ƒé“¾æ¥:ğŸ”—**
+ [LLDB Quick Start Guide](https://developer.apple.com/library/archive/documentation/IDEs/Conceptual/gdb_to_lldb_transition_guide/document/Introduction.html#//apple_ref/doc/uid/TP40012917-CH1-SW1)
+ [LLDBè°ƒè¯•å™¨ä½¿ç”¨ç®€ä»‹](http://southpeak.github.io/2015/01/25/tool-lldb/)
+ [å iOSé€†å‘- hopper disassembler](https://www.jianshu.com/p/20077ceb2f75)
+ [iOSé€†å‘ä¹‹Hopperè¿›é˜¶](https://www.jianshu.com/p/384dc5bc1cb4)
+ [ä¸€æ–‡è¯»æ‡‚fishhookåŸç†](https://juejin.cn/post/6857699952563978247)
+ [åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ASLR](https://www.jianshu.com/p/d3f094b4443d)
