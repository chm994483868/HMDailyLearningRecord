# Flutter æºç æ¢³ç†ç³»åˆ—ï¼ˆå…«ï¼‰ï¼š`State<T extends StatefulWidget> class`

&emsp;State ç”¨æ¥è¡¨ç¤º StatefulWidget çš„é€»è¾‘å’Œå†…éƒ¨çŠ¶æ€ã€‚å­¦ä¹ è¿‡ç¨‹ä¸­ç›®å…‰ä¸»è¦èšé›†åœ¨ StatefulElement ç±»å³å¯ã€‚ç›¸æ¯” Element ç±»çš„å­¦ä¹ ç®€å•äº†éå¸¸å¤šã€‚

# `_StateLifecycle`

&emsp;å½“å¯ç”¨æ–­è¨€æ—¶ï¼Œä¼šè·Ÿè¸ª State å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œ`_StateLifecycle` æšä¸¾å®šä¹‰äº†ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸã€‚

+ createdï¼šå·²åˆ›å»º State å¯¹è±¡ã€‚æ­¤æ—¶è°ƒç”¨ State.initStateã€‚
+ initializedï¼šState.initState æ–¹æ³•å·²è¢«è°ƒç”¨ï¼Œä½† State å¯¹è±¡å°šæœªå‡†å¤‡å¥½ buildã€‚æ­¤æ—¶ä¼šè°ƒç”¨ State.didChangeDependenciesã€‚
+ readyï¼šState å¯¹è±¡å·²ç»å‡†å¤‡å¥½ buildï¼Œè€Œ State.dispose è¿˜æ²¡æœ‰è¢«è°ƒç”¨ã€‚
+ defunctï¼šå·²è°ƒç”¨ State.dispose æ–¹æ³•å¹¶ä¸” State å¯¹è±¡ä¸å†èƒ½å¤Ÿ buildã€‚

```dart
enum _StateLifecycle {
  created,
  initialized,
  ready,
  defunct,
}
```

# StateSetter

&emsp;State.setState å‡½æ•°çš„ç­¾åã€‚

```dart
// ç­¾åæ— å‚æ•°ä¸”ä¸è¿”å›æ•°æ®çš„å›è°ƒå‡½æ•°
typedef VoidCallback = void Function();

typedef StateSetter = void Function(VoidCallback fn);
```

# State

&emsp;State ç”¨æ¥è¡¨ç¤º StatefulWidget çš„é€»è¾‘å’Œå†…éƒ¨çŠ¶æ€ã€‚

&emsp;State æ˜¯ï¼ˆ1ï¼‰åœ¨æ„å»º widget æ—¶å¯ä»¥åŒæ­¥è¯»å–çš„ä¿¡æ¯ï¼Œå¹¶ä¸”ï¼ˆ2ï¼‰åœ¨ widget çš„ç”Ÿå‘½å‘¨æœŸä¸­å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚å½“å‘ç”Ÿè¿™ç§çŠ¶æ€å˜åŒ–æ—¶ï¼ŒWidget å®ç°è€…æœ‰è´£ä»»ç¡®ä¿ State åŠæ—¶å¾—åˆ°é€šçŸ¥ï¼Œä½¿ç”¨ State.setStateã€‚

&emsp;å½“å°† StatefulWidget æ’å…¥æ ‘ä¸­æ—¶ï¼Œframework ä¼šé€šè¿‡è°ƒç”¨ StatefulWidget.createState æ–¹æ³•æ¥åˆ›å»º State å¯¹è±¡ã€‚ç”±äºç»™å®šçš„ StatefulWidget å®ä¾‹å¯ä»¥è¢«å¤šæ¬¡æ’å…¥ï¼ˆä¾‹å¦‚ï¼ŒStatefulWidget åŒæ—¶æ”¾ç½®åœ¨æ ‘ä¸­çš„å¤šä¸ªä½ç½®ï¼‰ï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ªä¸ç»™å®š StatefulWidget å®ä¾‹ç›¸å…³è”çš„ State å¯¹è±¡ã€‚åŒæ ·ï¼Œå¦‚æœä»æ ‘ä¸­ç§»é™¤ StatefulWidgetï¼Œç„¶åå†æ¬¡å°†å…¶æ’å…¥æ ‘ä¸­ï¼Œframework å°†å†æ¬¡è°ƒç”¨ StatefulWidget.createState æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ State å¯¹è±¡ï¼Œç®€åŒ– State å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚

&emsp;State å¯¹è±¡æœ‰å¦‚ä¸‹ç”Ÿå‘½å‘¨æœŸï¼š

+ Framework é€šè¿‡è°ƒç”¨ StatefulWidget.createState æ¥åˆ›å»ºä¸€ä¸ª State å¯¹è±¡ã€‚ï¼ˆåˆè§ï¼šStatefulElement æ„é€ å‡½æ•°çš„åˆå§‹åŒ–è¯åˆ—è¡¨è°ƒç”¨ widget.createState() å‡½æ•°åˆ›å»º State å¯¹è±¡ï¼Œå³ State å¯¹è±¡æ˜¯å’Œ StatefulElement ä¸€èµ·åˆ›å»ºçš„ï¼‰

+ æ–°åˆ›å»ºçš„ State å¯¹è±¡ä¸ä¸€ä¸ª BuildContext ç›¸å…³è”ã€‚è¿™ç§å…³è”æ˜¯æ°¸ä¹…çš„ï¼šState å¯¹è±¡æ°¸è¿œä¸ä¼šæ”¹å˜å…¶ BuildContextã€‚ç„¶è€Œï¼ŒBuildContext æœ¬èº«å¯ä»¥éšç€å…¶å­æ ‘åœ¨æ ‘ä¸­ç§»åŠ¨ã€‚åœ¨è¿™ä¸€ç‚¹ä¸Šï¼ŒState å¯¹è±¡è¢«è®¤ä¸ºæ˜¯å·²æŒ‚è½½çš„(mounted)ã€‚ï¼ˆBuildContext å³æ˜¯ StatefulElement å¯¹è±¡ï¼ŒState å¯¹è±¡å’Œ StatefulElement å¯¹è±¡æ˜¯ç›¸äº’å¼•ç”¨çš„ã€‚`_state`ã€`_widget`ã€`_element`ï¼Œè€Œä¸”å®ƒä»¬éƒ½ä¼šå¼•ç”¨ `_widget`ï¼Œ`_widget` å¯èƒ½ä¼šæ›´æ–°ï¼Œä½†æ˜¯ `_element` æ˜¯ä¸ä¼šæ›´æ–°çš„ã€‚ï¼‰

+ Framework è°ƒç”¨ initStateã€‚State çš„å­ç±»åº”è¯¥é‡å†™ initState æ–¹æ³•ï¼Œä»¥æ‰§è¡Œä¾èµ–äº BuildContext æˆ– widget çš„ä¸€æ¬¡æ€§åˆå§‹åŒ–æ“ä½œã€‚å½“è°ƒç”¨ initState æ–¹æ³•æ—¶ï¼ŒBuildContext å’Œ widget åˆ†åˆ«ä½œä¸º context å’Œ widget å±æ€§å¯ç”¨ã€‚ï¼ˆå½“ StatefulElement å¯¹è±¡è°ƒç”¨ `_firstBuild` å‡½æ•°æ—¶ï¼Œä¼šç›´æ¥è°ƒç”¨ `state.initState()`ï¼Œå³åˆæ¬¡æ„å»ºæ—¶ä¼šå›è°ƒ State çš„ initState å‡½æ•°ï¼Œå…¨ç”Ÿå‘½å‘¨æœŸå†…ä»…æ­¤ä¸€æ¬¡ã€‚ï¼‰

+ Framework ä¼šè°ƒç”¨ didChangeDependencies æ–¹æ³•ã€‚State çš„å­ç±»åº”è¯¥é‡å†™ didChangeDependencies æ–¹æ³•æ¥æ‰§è¡Œæ¶‰åŠ InheritedWidget çš„åˆå§‹åŒ–æ“ä½œã€‚å¦‚æœè°ƒç”¨ BuildContext.dependOnInheritedWidgetOfExactType æ–¹æ³•ï¼Œå¦‚æœåç»­ç»§æ‰¿çš„ InheritedWidget å‘ç”Ÿå˜åŒ–æˆ– widget åœ¨æ ‘ä¸­ç§»åŠ¨ï¼ŒdidChangeDependencies æ–¹æ³•å°†å†æ¬¡è¢«è°ƒç”¨ã€‚ï¼ˆå½“ StatefulElement å¯¹è±¡ä¾èµ–äº† InheritedElement çš„è¯ï¼Œå½“å…¶æ›´æ–°æ—¶ï¼Œæ­¤ StatefulElement ä¹Ÿä¼šé‡å»ºï¼Œå¹¶ä¸” state å¯¹è±¡å›è°ƒï¼šdidChangeDependencies å‡½æ•°ã€‚ï¼‰

+ æ­¤æ—¶ï¼ŒState å¯¹è±¡å·²ç»å®Œå…¨åˆå§‹åŒ–ï¼ŒFramework å¯èƒ½ä¼šè°ƒç”¨å…¶ build æ–¹æ³•ä»»æ„æ¬¡æ•°ï¼Œä»¥è·å–è¯¥å­æ ‘ç”¨æˆ·ç•Œé¢çš„æè¿°ï¼ˆbuild å‡½æ•°è¿”å›çš„ Widget å¯¹è±¡ï¼Œå³ç”¨äºæ„å»º Element å­èŠ‚ç‚¹ï¼‰ã€‚State å¯¹è±¡å¯ä»¥é€šè¿‡è°ƒç”¨å…¶ setState æ–¹æ³•è‡ªå‘åœ°è¯·æ±‚é‡æ–°æ„å»ºå…¶å­æ ‘ï¼Œè¿™è¡¨æ˜å®ƒä»¬çš„ä¸€äº›å†…éƒ¨çŠ¶æ€å·²ç»ä»¥å¯èƒ½å½±å“è¯¥å­æ ‘ç”¨æˆ·ç•Œé¢çš„æ–¹å¼å‘ç”Ÿäº†å˜åŒ–ã€‚ï¼ˆsetState å¯¹è±¡è°ƒç”¨åï¼Œå³æŠŠå½“å‰ StatefulElement æ ‡è®°ä¸ºè„ï¼Œåœ¨ä¸‹ä¸€å¸§ï¼Œæ­¤ StatefulElement å¯¹è±¡ä¼šè¿›è¡Œé‡å»ºï¼‰

+ åœ¨æ­¤æœŸé—´ï¼Œçˆ¶çº§ Widget å¯èƒ½ä¼šé‡æ–°æ„å»ºï¼Œå¹¶è¯·æ±‚åœ¨æ ‘ä¸­çš„è¯¥ä½ç½®æ›´æ–°ä»¥æ˜¾ç¤ºä¸€ä¸ªå…·æœ‰ç›¸åŒ runtimeType å’Œ key çš„æ–° Widgetã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼ŒFramework å°†ä¼šæ›´æ–° `_widget` å±æ€§ä»¥æŒ‡å‘æ–°çš„ widget å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ didUpdateWidget æ–¹æ³•ï¼Œå¹¶å°†å…ˆå‰çš„ widget ä½œä¸ºå‚æ•°ä¼ é€’(æ—§çš„ oldWidget)ã€‚State å¯¹è±¡åº”è¯¥é‡å†™ didUpdateWidget æ¥å“åº”å…¶å…³è” Widget å¯¹è±¡çš„æ›´æ”¹ï¼ˆä¾‹å¦‚ï¼Œå¯åŠ¨éšå¼åŠ¨ç”»ï¼‰ã€‚Framework å§‹ç»ˆåœ¨è°ƒç”¨ didUpdateWidget åè°ƒç”¨ buildï¼Œè¿™æ„å‘³ç€åœ¨ didUpdateWidget ä¸­è¿›è¡Œçš„ä»»ä½• setState è°ƒç”¨éƒ½æ˜¯å¤šä½™çš„ã€‚ï¼ˆå³ StatefulElement å¯¹è±¡ä½¿ç”¨æ–° Widget ä»£æ›¿æ—§ Widget çš„æ›´æ–°æ“ä½œï¼Œåé¢è¯¦ç»†çœ‹ StatefulElement.uptate å‡½æ•°å†…å®¹å³å¯ã€‚ï¼‰

+ åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‘ç”Ÿçƒ­é‡è½½ï¼ˆä¸ç®¡æ˜¯é€šè¿‡å‘½ä»¤è¡Œçš„ flutter å·¥å…·æŒ‰ä¸‹ r è¿›è¡Œçš„ï¼Œè¿˜æ˜¯é€šè¿‡ IDE è¿›è¡Œçš„ï¼‰ï¼Œåˆ™ä¼šè°ƒç”¨ reassemble æ–¹æ³•ã€‚è¿™æä¾›äº†é‡æ–°åˆå§‹åŒ–åœ¨ initState æ–¹æ³•ä¸­å‡†å¤‡çš„ä»»ä½•æ•°æ®çš„æœºä¼šã€‚ï¼ˆå³ reassemble å‡½æ•°ï¼Œé™¤äº†å›è°ƒ State.ressembleï¼ŒElement.ressemble ä¹Ÿä¼šæ‰§è¡Œï¼Œä¼šæ ‡è®° Element å¯¹è±¡ä¸ºè„ï¼Œå¹¶ä¸”ä¼šè°ƒç”¨ Element å¯¹è±¡æ‰€æœ‰å­çº§çš„ ressemble å‡½æ•°ã€‚ï¼‰

+ å¦‚æœåŒ…å« State å¯¹è±¡çš„å­æ ‘ä»æ ‘ä¸­ç§»é™¤ï¼ˆä¾‹å¦‚ï¼Œå› ä¸ºçˆ¶çº§æ„å»ºäº†ä¸€ä¸ªå…·æœ‰ä¸åŒ runtimeType æˆ– key çš„ Widgetï¼‰ï¼Œåˆ™ framework ä¼šè°ƒç”¨ deactivate æ–¹æ³•ã€‚å­ç±»åº”è¯¥é‡å†™æ­¤æ–¹æ³•ï¼Œä»¥æ¸…ç†è¯¥å¯¹è±¡ä¸æ ‘ä¸­å…¶ä»–å…ƒç´ ä¹‹é—´çš„ä»»ä½•é“¾æ¥ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœä½ å‘ç¥–å…ˆæä¾›äº†æŒ‡å‘å­å…ƒç´  RenderObject çš„æŒ‡é’ˆï¼‰ã€‚ï¼ˆå³ StatefulElement å¯¹è±¡ä» Element tree ä¸­ç§»é™¤æ—¶ï¼Œä¹Ÿä¼šå›è°ƒ State.deactivateã€‚ï¼‰

+ æ­¤æ—¶ï¼Œframework å¯èƒ½ä¼šå°†æ­¤å­æ ‘é‡æ–°æ’å…¥åˆ°æ ‘çš„å¦ä¸€ä¸ªéƒ¨åˆ†ã€‚å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œframework å°†ç¡®ä¿è°ƒç”¨ buildï¼Œä»¥ä½¿ State å¯¹è±¡æœ‰æœºä¼šé€‚åº”å…¶åœ¨æ ‘ä¸­çš„æ–°ä½ç½®ã€‚å¦‚æœ framework é‡æ–°æ’å…¥æ­¤å­æ ‘ï¼Œå®ƒå°†åœ¨ä»æ ‘ä¸­ç§»é™¤è¯¥å­æ ‘çš„åŠ¨ç”»å¸§ç»“æŸä¹‹å‰è¿™æ ·åšã€‚å› æ­¤ï¼ŒState å¯¹è±¡å¯ä»¥æ¨è¿Ÿé‡Šæ”¾å¤§å¤šæ•°èµ„æºï¼Œç›´åˆ°æ¡†æ¶è°ƒç”¨å…¶ dispose æ–¹æ³•ã€‚ï¼ˆå³ State å¯¹è±¡ä¼šè·Ÿç€ StatefulElement å¯¹è±¡ä¸€èµ·è¢«å¤ç”¨ï¼Œå¦‚æœçœŸçš„æ— æ³•è¢«å¤ç”¨çš„è¯ï¼Œå¯ä»¥åœ¨ State.dispose å›è°ƒä¸­æ¸…ç†èµ„æºï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚ï¼‰

+ å¦‚æœ framework åœ¨å½“å‰åŠ¨ç”»å¸§ç»“æŸä¹‹å‰æ²¡æœ‰é‡æ–°æ’å…¥æ­¤å­æ ‘ï¼Œæ¡†æ¶å°†è°ƒç”¨ disposeï¼Œè¿™è¡¨ç¤ºæ­¤ State å¯¹è±¡å°†ä¸ä¼šå†æ„å»ºã€‚å­ç±»åº”è¯¥é‡å†™æ­¤æ–¹æ³•ï¼Œä»¥é‡Šæ”¾æ­¤å¯¹è±¡ä¿ç•™çš„ä»»ä½•èµ„æºï¼ˆä¾‹å¦‚ï¼Œåœæ­¢ä»»ä½•æ´»åŠ¨çš„åŠ¨ç”»ï¼‰ã€‚ï¼ˆå³åœ¨ State.dispose ä¸­æ¸…ç†èµ„æºï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚ï¼‰

+ åœ¨æ¡†æ¶è°ƒç”¨ dispose åï¼ŒState å¯¹è±¡è¢«è§†ä¸ºå·²å¸è½½ï¼Œå¹¶ä¸” mounted å±æ€§ä¸º falseã€‚æ­¤æ—¶è°ƒç”¨ setState æ˜¯é”™è¯¯çš„ã€‚æ­¤ç”Ÿå‘½å‘¨æœŸé˜¶æ®µæ˜¯ç»ˆç«¯çš„ï¼šæ— æ³•é‡æ–°æŒ‚è½½å·²è¢«å¤„ç†çš„ State å¯¹è±¡ã€‚ï¼ˆå¤„äºç­‰å¾…è¢« GC å›æ”¶å†…å­˜â™»ï¸ã€‚ï¼‰

&emsp;OKï¼Œä¸‹é¢å¼€å§‹çœ‹ State çš„æºç ã€‚æ³›å‹ T æ˜¯ StatefulWidget çš„å­ç±»ã€‚

```dart
@optionalTypeArgs
abstract class State<T extends StatefulWidget> with Diagnosticable {
  // ...
}
```

## widget

&emsp;Widget ä¸ä»…ä½œä¸º Element çš„é…ç½®ï¼Œå…¶å®ä¹Ÿæ˜¯ä½œä¸º State çš„é…ç½®çš„ã€‚State å¯¹è±¡ä¼šç›´æ¥å¼•ç”¨åˆ›å»ºå®ƒçš„ StatefulWidget å¯¹è±¡ã€‚

&emsp;ä¸€ä¸ª State å¯¹è±¡çš„é…ç½®æ˜¯å¯¹åº”çš„ StatefulWidget å¯¹è±¡å®ä¾‹ã€‚è¿™ä¸ªå±æ€§åœ¨è°ƒç”¨ initState ä¹‹å‰ç”± framework è¿›è¡Œåˆå§‹åŒ–ã€‚å¦‚æœçˆ¶ widget æ›´æ–°äº†æ ‘ä¸­æ­¤ä½ç½®åˆ°ä¸€ä¸ªæ–°çš„ widgetï¼Œè€Œè¿™ä¸ªæ–°çš„ widget å…·æœ‰å’Œå½“å‰é…ç½®ç›¸åŒçš„ runtimeType å’Œ Widget.keyï¼Œframework ä¼šæ›´æ–°è¿™ä¸ªå±æ€§æŒ‡å‘æ–°çš„ widgetï¼Œç„¶åè°ƒç”¨ didUpdateWidgetï¼Œå°†æ—§çš„ widget ä½œä¸ºå‚æ•°ä¼ é€’è¿›å»ã€‚(åœ¨åˆ›å»º State å¯¹è±¡æ—¶ï¼Œå·²ç»æŠŠ Widget å¯¹è±¡èµ‹å€¼ç»™å®ƒäº†ï¼Œå½“ StatefulElement æ›´æ–°æ—¶ï¼Œä¼šæ›´æ–°æ­¤ Widget å¯¹è±¡ï¼Œå¹¶ä¸”ä¼šå›è°ƒ State.didUpdateWidget å‡½æ•°ï¼Œå¯ä»¥æ‹¿åˆ°å…¥å‚ oldWidget æ·»åŠ ä¸€äº›æ¶ˆå¤±åŠ¨ç”»ã€‚)

```dart
  T get widget => _widget!;
  T? _widget;
```

## `_debugLifecycleState`

&emsp;é»˜è®¤å°±æ˜¯ created å·²åˆ›å»ºçš„çŠ¶æ€ã€‚

&emsp;è¡¨ç¤ºè¿™ä¸ª State å¯¹è±¡å½“å‰æ‰€å¤„çš„ç”Ÿå‘½å‘¨æœŸé˜¶æ®µã€‚å½“å¯ç”¨æ–­è¨€æ—¶ï¼Œè¯¥å­—æ®µä¼šè¢« framework ä½¿ç”¨ï¼Œä»¥éªŒè¯ State å¯¹è±¡æ˜¯å¦æŒ‰ç…§ä¸€å®šçš„é¡ºåºè¿›è¡Œç”Ÿå‘½å‘¨æœŸå˜åŒ–çš„ã€‚

```dart
  _StateLifecycle _debugLifecycleState = _StateLifecycle.created;
```

## context

&emsp;è·å– State å¯¹è±¡çš„ä¸Šä¸‹æ–‡ï¼Œå³ State å¯¹è±¡å¯¹åº”çš„ StatefulElement å¯¹è±¡ã€‚

&emsp;æ­¤å°éƒ¨ä»¶æ„å»ºçš„æ ‘ä¸­çš„ä½ç½®ã€‚

&emsp;framework åœ¨ä½¿ç”¨ StatefulWidget.createState åˆ›å»º State å¯¹è±¡åï¼Œåœ¨è°ƒç”¨ initState ä¹‹å‰å°†å…¶ä¸ BuildContext å…³è”èµ·æ¥ã€‚è¿™ç§å…³è”æ˜¯æ°¸ä¹…çš„ï¼šState å¯¹è±¡ä¸ä¼šæ”¹å˜å…¶ BuildContextã€‚ä½†æ˜¯ï¼ŒBuildContext æœ¬èº«å¯ä»¥åœ¨æ ‘ä¸­ç§»åŠ¨ã€‚

&emsp;åœ¨è°ƒç”¨ dispose åï¼Œframework ä¼šåˆ‡æ–­ State å¯¹è±¡ä¸ BuildContext çš„è¿æ¥ã€‚

```dart
  BuildContext get context {
    return _element!;
  }
```

## `_element`

&emsp;åœ¨ State å¯¹è±¡åˆ›å»ºåç›´æ¥èµ‹å€¼å…¶ StatefulElement å¯¹è±¡ï¼š`state._element = this;`ã€‚

```dart
  StatefulElement? _element;
```

## mounted

&emsp;è¡¨ç¤ºå½“å‰è¿™ä¸ª State å¯¹è±¡æ˜¯å¦åœ¨æ ‘ä¸­ã€‚

&emsp;åœ¨åˆ›å»º State å¯¹è±¡ä¹‹åï¼Œåœ¨è°ƒç”¨ initState ä¹‹å‰ï¼Œframework ä¼šé€šè¿‡å°†å…¶ä¸ BuildContext å…³è”æ¥ "mount" State å¯¹è±¡ã€‚State å¯¹è±¡ä¿æŒæŒ‚è½½çŠ¶æ€ï¼Œç›´åˆ° framework è°ƒç”¨ disposeï¼Œä¹‹å framework å°†ä¸å†è¦æ±‚ State å¯¹è±¡å†æ¬¡æ„å»ºã€‚

&emsp;åœ¨ mounted ä¸º true ä¹‹å‰è°ƒç”¨ setState æ˜¯ä¸€ä¸ªé”™è¯¯ã€‚

```dart
  bool get mounted => _element != null;
```

## initState

&emsp;å½“æ­¤å¯¹è±¡è¢«æ’å…¥åˆ°æ ‘ä¸­æ—¶è°ƒç”¨ã€‚(å³ StatefulElement å¯¹è±¡æ’å…¥ Element tree ä¸­)

&emsp;framework ä¼šä¸ºåˆ›å»ºçš„æ¯ä¸ª State å¯¹è±¡ä»…è°ƒç”¨æ­¤æ–¹æ³•ä¸€æ¬¡ã€‚

&emsp;é‡å†™æ­¤æ–¹æ³•ä»¥æ‰§è¡Œä¾èµ–äºæ­¤å¯¹è±¡æ’å…¥æ ‘çš„ä½ç½®ï¼ˆå³ contextï¼‰æˆ–ç”¨äºé…ç½®æ­¤å¯¹è±¡çš„å°éƒ¨ä»¶ï¼ˆå³ widgetï¼‰çš„åˆå§‹åŒ–æ“ä½œã€‚

&emsp;å¦‚æœ State çš„ build æ–¹æ³•ä¾èµ–äºä¸€ä¸ªå¯ä»¥æ”¹å˜çŠ¶æ€çš„å¯¹è±¡ï¼Œä¾‹å¦‚ ChangeNotifier æˆ– Streamï¼Œæˆ–è€…ä¸€äº›å…¶ä»–å¯ä»¥è®¢é˜…ä»¥æ¥æ”¶é€šçŸ¥çš„å¯¹è±¡ï¼Œé‚£ä¹ˆè¯·ç¡®ä¿åœ¨ initStateã€didUpdateWidget å’Œ dispose ä¸­æ­£ç¡®åœ°è®¢é˜…å’Œå–æ¶ˆè®¢é˜…ï¼š

1. åœ¨ initState ä¸­ï¼Œè®¢é˜…å¯¹è±¡ã€‚
2. åœ¨ didUpdateWidget ä¸­ï¼Œå–æ¶ˆè®¢é˜…æ—§å¯¹è±¡å¹¶è®¢é˜…æ–°å¯¹è±¡ï¼ˆå¦‚æœæ›´æ–°åçš„ Widget é…ç½®éœ€è¦æ›¿æ¢å¯¹è±¡ï¼‰ã€‚
3. åœ¨ dispose ä¸­ï¼Œå–æ¶ˆè®¢é˜…å¯¹è±¡ã€‚

&emsp;ä¸åº”è¯¥åœ¨æ­¤æ–¹æ³•ä¸­ä½¿ç”¨ BuildContext.dependOnInheritedWidgetOfExactTypeã€‚ç„¶è€Œï¼ŒdidChangeDependencies ä¼šåœ¨æ­¤æ–¹æ³•ä¹‹åç«‹å³è°ƒç”¨ï¼Œå¯ä»¥åœ¨é‚£é‡Œä½¿ç”¨ BuildContext.dependOnInheritedWidgetOfExactTypeã€‚

&emsp;æ­¤æ–¹æ³•çš„å®ç°åº”è¯¥ä»è°ƒç”¨ç»§æ‰¿æ–¹æ³•å¼€å§‹ï¼Œå¦‚ super.initState()ã€‚

```dart
  @protected
  @mustCallSuper
  void initState() {
    // ...
  }
```

## didUpdateWidget

&emsp;å½“ Widget çš„é…ç½®å‘ç”Ÿå˜åŒ–æ—¶è¢«è°ƒç”¨ã€‚

&emsp;å¦‚æœçˆ¶çº§ Widget é‡å»ºå¹¶è¯·æ±‚åœ¨æ ‘ä¸­çš„æ­¤ä½ç½®æ›´æ–°ä»¥æ˜¾ç¤ºä¸€ä¸ªå…·æœ‰ç›¸åŒ runtimeType å’Œ key çš„æ–° widgetï¼Œåˆ™ framework å°†æ›´æ–°æ­¤ State å¯¹è±¡çš„ widget å±æ€§ä»¥å¼•ç”¨æ–° widgetï¼Œç„¶åç”¨å…ˆå‰çš„ widget ä½œä¸ºå‚æ•°è°ƒç”¨æ­¤æ–¹æ³•ã€‚

&emsp;é‡å†™æ­¤æ–¹æ³•ä»¥åœ¨ Widget æ›´æ”¹æ—¶åšå‡ºå“åº”ï¼ˆä¾‹å¦‚ï¼Œå¼€å§‹éšå¼åŠ¨ç”»ï¼‰ã€‚

&emsp;åœ¨è°ƒç”¨ didUpdateWidget åï¼Œframework æ€»æ˜¯ä¼šè°ƒç”¨ buildï¼Œè¿™æ„å‘³ç€åœ¨ didUpdateWidget ä¸­å¯¹ setState çš„ä»»ä½•è°ƒç”¨éƒ½æ˜¯å¤šä½™çš„ã€‚

&emsp;å¦‚æœä¸€ä¸ª State çš„ build æ–¹æ³•ä¾èµ–äºä¸€ä¸ªå¯ä»¥è‡ªèº«æ”¹å˜çŠ¶æ€çš„å¯¹è±¡ï¼Œä¾‹å¦‚ ChangeNotifier æˆ– Streamï¼Œæˆ–è€…å…¶ä»–å¯ä»¥è®¢é˜…ä»¥æ¥æ”¶é€šçŸ¥çš„å¯¹è±¡ï¼Œåˆ™åŠ¡å¿…åœ¨ initStateã€didUpdateWidget å’Œ dispose ä¸­æ­£ç¡®è®¢é˜…å’Œå–æ¶ˆè®¢é˜…ï¼š

1. åœ¨ initState ä¸­ï¼Œè®¢é˜…å¯¹è±¡ã€‚
2. åœ¨ didUpdateWidget ä¸­å–æ¶ˆè®¢é˜…æ—§å¯¹è±¡å¹¶è®¢é˜…æ–°å¯¹è±¡ï¼ˆå¦‚æœæ›´æ–°åçš„ Widget é…ç½®éœ€è¦æ›¿æ¢å¯¹è±¡ï¼‰ã€‚
3. åœ¨ dispose ä¸­ï¼Œå–æ¶ˆè®¢é˜…å¯¹è±¡ã€‚

&emsp;æ­¤æ–¹æ³•çš„å®ç°åº”è¯¥ä»¥è°ƒç”¨ç»§æ‰¿æ–¹æ³•å¼€å§‹ï¼Œå¦‚ super.didUpdateWidget(oldWidget) ä¸­æ‰€ç¤ºã€‚

```dart
  @mustCallSuper
  @protected
  void didUpdateWidget(covariant T oldWidget) { }
```

## reassemble

&emsp;åœ¨è°ƒè¯•æœŸé—´é‡æ–°ç»„è£…åº”ç”¨ç¨‹åºæ—¶è°ƒç”¨ï¼Œä¾‹å¦‚åœ¨çƒ­é‡è½½æœŸé—´ã€‚

&emsp;è¿™ä¸ªæ–¹æ³•åº”é‡æ–°è¿è¡Œä»»ä½•ä¾èµ–å…¨å±€çŠ¶æ€çš„åˆå§‹åŒ–é€»è¾‘ï¼Œä¾‹å¦‚ä»èµ„æºåŒ…ä¸­åŠ è½½å›¾åƒï¼ˆå› ä¸ºèµ„æºåŒ…å¯èƒ½å·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼‰ã€‚

&emsp;è¿™ä¸ªå‡½æ•°åªä¼šåœ¨å¼€å‘ç¯å¢ƒä¸­è¢«è°ƒç”¨ã€‚åœ¨å‘å¸ƒç‰ˆæœ¬ä¸­ï¼Œext.flutter.reassemble é’©å­ä¸å¯ç”¨ï¼Œå› æ­¤è¿™æ®µä»£ç å°†æ°¸è¿œä¸ä¼šæ‰§è¡Œã€‚

```dart
  @protected
  @mustCallSuper
  void reassemble() { }
```

## setState

&emsp;é€šçŸ¥ frameworkï¼Œè¯¥ State å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€å·²æ›´æ”¹ã€‚

&emsp;æ¯å½“æ›´æ”¹ State å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€æ—¶ï¼Œè¯·åœ¨ä¼ é€’ç»™ setState çš„å‡½æ•°ä¸­è¿›è¡Œæ›´æ”¹ï¼š

```dart
setState(() { _myState = newValue; });
```

&emsp;æä¾›çš„å›è°ƒå‡½æ•°ä¼šç«‹å³åŒæ­¥è°ƒç”¨ã€‚å®ƒä¸èƒ½è¿”å›ä¸€ä¸ª Futureï¼ˆå›è°ƒå‡½æ•°ä¸èƒ½æ˜¯å¼‚æ­¥çš„ï¼‰ï¼Œå› ä¸ºè¿™æ ·ä¼šä¸æ¸…æ¥šå®é™…ä¸ŠçŠ¶æ€ä½•æ—¶è¢«è®¾ç½®ã€‚

&emsp;è°ƒç”¨ setState é€šçŸ¥ frameworkï¼Œæ­¤ State å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€å·²ç»ä»¥å¯èƒ½å½±å“æ­¤å­æ ‘ä¸­çš„ç”¨æˆ·ç•Œé¢çš„æ–¹å¼å‘ç”Ÿäº†æ”¹å˜ï¼Œè¿™ä¼šå¯¼è‡´ framework ä¸ºè¯¥ State å¯¹è±¡å®‰æ’ä¸€ä¸ªæ„å»ºã€‚

&emsp;å¦‚æœä½ ç›´æ¥æ›´æ”¹çŠ¶æ€è€Œä¸è°ƒç”¨ setStateï¼Œåˆ™ framework å¯èƒ½ä¸ä¼šå®‰æ’ä¸€ä¸ªæ„å»ºï¼Œè¿™ä¸ªå­æ ‘çš„ç”¨æˆ·ç•Œé¢å¯èƒ½ä¸ä¼šæ›´æ–°ä»¥åæ˜ æ–°çš„çŠ¶æ€ã€‚

&emsp;é€šå¸¸å»ºè®®åªåœ¨å®é™…æ›´æ”¹çŠ¶æ€æ—¶ä½¿ç”¨ setState æ–¹æ³•æ¥åŒ…è£…ï¼Œè€Œä¸æ˜¯ä»»ä½•å¯èƒ½ä¸æ›´æ”¹ç›¸å…³çš„è®¡ç®—ã€‚ä¾‹å¦‚ï¼Œè¿™é‡Œä¸€ä¸ªè¢« build å‡½æ•°ä½¿ç”¨çš„å€¼è¢«å¢åŠ ï¼Œç„¶åæ›´æ”¹è¢«å†™å…¥ç£ç›˜ï¼Œä½†åªæœ‰å¢é‡è¢«åŒ…å«åœ¨ setState ä¸­ï¼š

```dart
Future<void> _incrementCounter() async {
  setState(() {
    _counter++;
  });
  
  Directory directory = await getApplicationDocumentsDirectory(); // from path_provider package
  final String dirName = directory.path;
  await File('$dirName/counter.txt').writeAsString('$_counter');
}
```

&emsp;æœ‰æ—¶ï¼Œå·²æ›´æ”¹çš„çŠ¶æ€ä½äºå¦ä¸€ä¸ªä¸ç”± Widget çŠ¶æ€æ‹¥æœ‰çš„å¯¹è±¡ä¸­ï¼Œä½†æ˜¯ Widget ä»ç„¶éœ€è¦æ›´æ–°ä»¥å“åº”æ–°çŠ¶æ€ã€‚è¿™åœ¨ä½¿ç”¨ Listenablesï¼ˆä¾‹å¦‚ AnimationControllersï¼‰æ—¶å°¤å…¶å¸¸è§ã€‚

&emsp;åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨ä¼ é€’ç»™ setState çš„å›è°ƒä¸­ç•™ä¸‹ä¸€ä¸ªæ³¨é‡Šï¼Œè§£é‡Šå“ªäº›çŠ¶æ€å·²æ›´æ”¹æ˜¯ä¸€ä¸ªè‰¯å¥½çš„å®è·µï¼š

```dart
void _update() {
  setState(() { /* The animation changed. */ });
}

//...
animation.addListener(_update);
```

&emsp;åœ¨ framework è°ƒç”¨ dispose åè°ƒç”¨æ­¤æ–¹æ³•æ˜¯é”™è¯¯çš„ã€‚ä½ å¯ä»¥é€šè¿‡æ£€æŸ¥ mounted å±æ€§æ˜¯å¦ä¸º true æ¥ç¡®å®šæ˜¯å¦å¯ä»¥è°ƒç”¨æ­¤æ–¹æ³•ã€‚å°½ç®¡å¦‚æ­¤ï¼Œæœ€å¥½çš„åšæ³•æ˜¯å–æ¶ˆå¯èƒ½è§¦å‘ setState çš„ä»»ä½•å·¥ä½œï¼Œè€Œä¸ä»…ä»…æ˜¯åœ¨è°ƒç”¨ setState ä¹‹å‰æ£€æŸ¥æ˜¯å¦å·²ç» mountedï¼Œå¦åˆ™ä¼šæµªè´¹ CPU å‘¨æœŸã€‚

### Design discussion

&emsp;è¿™ä¸ª API çš„æœ€åˆç‰ˆæœ¬æ˜¯ä¸€ä¸ªå«åš markNeedsBuild çš„æ–¹æ³•ï¼Œä»¥ä¿æŒä¸ RenderObject.markNeedsLayoutã€RenderObject.markNeedsPaint ç­‰æ–¹æ³•çš„ä¸€è‡´æ€§ã€‚

&emsp;ç„¶è€Œï¼ŒFlutter æ¡†æ¶çš„æ—©æœŸç”¨æˆ·æµ‹è¯•è¡¨æ˜ï¼Œäººä»¬ä¼šæ¯”å¿…è¦çš„æƒ…å†µæ›´é¢‘ç¹åœ°è°ƒç”¨ markNeedsBuild() æ–¹æ³•ã€‚å®è´¨ä¸Šï¼Œäººä»¬ä½¿ç”¨å®ƒå°±åƒä¸€ä¸ªå¹¸è¿ç¬¦å·ï¼Œæ¯å½“ä»–ä»¬ä¸ç¡®å®šæ˜¯å¦éœ€è¦è°ƒç”¨å®ƒæ—¶ï¼Œä»–ä»¬å°±ä¼šè°ƒç”¨å®ƒï¼Œä»¥é˜²ä¸‡ä¸€ã€‚

&emsp;è‡ªç„¶åœ°ï¼Œè¿™å¯¼è‡´äº†åº”ç”¨ç¨‹åºçš„æ€§èƒ½é—®é¢˜ã€‚

&emsp;å½“ API è¢«æ”¹ä¸ºæ¥å—ä¸€ä¸ªå›è°ƒå‡½æ•°æ—¶ï¼Œè¿™ç§åšæ³•å¤§å¤§å‡å°‘äº†ã€‚ä¸€ä¸ªå‡è®¾æ˜¯ï¼Œé€šè¿‡ä¿ƒä½¿å¼€å‘äººå‘˜åœ¨å›è°ƒä¸­å®é™…æ›´æ–°å…¶çŠ¶æ€ï¼Œå¼•å¯¼å¼€å‘äººå‘˜æ›´ä»”ç»†åœ°è€ƒè™‘åˆ°åº•æ˜¯ä»€ä¹ˆè¢«æ›´æ–°ï¼Œä»è€Œæé«˜äº†ä»–ä»¬å¯¹äºè°ƒç”¨æ–¹æ³•çš„é€‚å½“æ—¶æœºçš„ç†è§£ã€‚

&emsp;å®é™…ä¸Šï¼ŒsetState æ–¹æ³•çš„å®ç°éå¸¸ç®€å•ï¼šå®ƒåŒæ­¥æ‰§è¡Œæ‰€æä¾›çš„å›è°ƒï¼Œç„¶åè°ƒç”¨ Element.markNeedsBuildã€‚

### Performance considerations

&emsp;è°ƒç”¨è¯¥å‡½æ•°çš„ç›´æ¥å¼€é”€å¾ˆå°ï¼Œå¹¶ä¸”é¢„è®¡æ¯å¸§æœ€å¤šè°ƒç”¨ä¸€æ¬¡ï¼Œå› æ­¤è¿™ç§å¼€é”€åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½æ˜¯å¯ä»¥å¿½ç•¥çš„ã€‚å°½ç®¡å¦‚æ­¤ï¼Œæœ€å¥½è¿˜æ˜¯è¦é¿å…åœ¨ç´§å¯†å¾ªç¯ä¸­å¤šæ¬¡å†—ä½™è°ƒç”¨è¯¥å‡½æ•°ï¼Œå› ä¸ºè¿™æ¶‰åŠåˆ›å»ºé—­åŒ…å¹¶æ‰§è¡Œå®ƒã€‚è¯¥æ–¹æ³•æ˜¯å¹‚ç­‰çš„ï¼Œæ¯å¸§æ¯ä¸ª State å¤šæ¬¡è°ƒç”¨å®ƒä¹Ÿæ²¡æœ‰å¥½å¤„ã€‚

&emsp;ç„¶è€Œï¼Œé€ æˆè°ƒç”¨è¯¥å‡½æ•°çš„é—´æ¥æˆæœ¬å¾ˆé«˜ï¼šå®ƒä¼šå¯¼è‡´ Widget é‡å»ºï¼Œå¯èƒ½è§¦å‘æ•´ä¸ªä»¥è¯¥ Widget ä¸ºæ ¹çš„å­æ ‘çš„é‡å»ºï¼Œå¹¶è¿›ä¸€æ­¥è§¦å‘æ•´ä¸ªç›¸åº”çš„ RenderObject å­æ ‘çš„å¸ƒå±€å’Œé‡ç»˜ã€‚

&emsp;å› æ­¤ï¼Œåªæœ‰åœ¨ build æ–¹æ³•å°†å› æ£€æµ‹åˆ°çš„ä»»ä½•çŠ¶æ€æ›´æ”¹è€Œä½¿å…¶ç»“æœæœ‰æ„ä¹‰åœ°æ”¹å˜æ—¶ï¼Œæ‰åº”è°ƒç”¨è¯¥æ–¹æ³•ã€‚

&emsp;OKï¼ŒsetState å‡½æ•°çš„æ³¨é‡Šå°±è¿™ä¹ˆå¤šï¼Œå®ƒçš„å®é™…æ‰§è¡Œçš„å†…å®¹ä¹Ÿå¾ˆå¥½ï¼šåŒæ­¥æ‰§è¡Œä¼ å…¥çš„é—­åŒ…ï¼Œç„¶åæŠŠå½“å‰ Element æ ‡è®°ä¸ºè„ï¼Œç­‰å¾…ä¸‹ä¸€å¸§æ­¤ Element å¯¹è±¡çš„é‡å»ºã€‚å®ƒå†…éƒ¨çš„å‡ ä¸ªæ–­è¨€ä¹Ÿå‘Šè¯‰äº†æˆ‘ä»¬è°ƒç”¨ setState å‡½æ•°çš„æ³¨æ„äº‹é¡¹ï¼š

+ State å¯¹è±¡å·²æ‰§è¡Œ dispose åä¸èƒ½è°ƒç”¨ setStateã€‚
+ State å¯¹è±¡åˆšåˆ›å»ºï¼Œè¿˜æœªæŒ‚è½½åˆ°æ ‘ä¸Šæ—¶ä¸èƒ½è°ƒç”¨ setStateã€‚
+ è°ƒç”¨ setState ä¼ å…¥çš„ VoidCallback ä¸èƒ½æ˜¯ä¸ªå¼‚æ­¥äº‹ä»¶ã€‚

```dart
  @protected
  void setState(VoidCallback fn) {
    final Object? result = fn() as dynamic;
    _element!.markNeedsBuild();
  }
```

## deactivate

&emsp;å½“è¿™ä¸ªå¯¹è±¡ä»æ ‘ä¸­ç§»é™¤æ—¶è°ƒç”¨ã€‚(ç”± StatefulElement çš„ deactivate è°ƒç”¨ã€‚)

&emsp;åœ¨å°†è¿™ä¸ª State å¯¹è±¡ä»æ ‘ä¸­ç§»é™¤æ—¶ï¼Œframework ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œframework ä¼šé‡æ–°å°†è¿™ä¸ª State å¯¹è±¡é‡æ–°æ’å…¥åˆ°æ ‘çš„å¦ä¸€ä¸ªéƒ¨åˆ†ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœåŒ…å«è¿™ä¸ª State å¯¹è±¡çš„å­æ ‘ç”±äºä½¿ç”¨ GlobalKey è€Œä»æ ‘ä¸­çš„ä¸€ä¸ªä½ç½®ç§»åŠ¨åˆ°å¦ä¸€ä¸ªä½ç½®ï¼‰ã€‚å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œframework å°†è°ƒç”¨ activate æ–¹æ³•ï¼Œè®© State å¯¹è±¡æœ‰æœºä¼šé‡æ–°è·å–åœ¨ deactivate ä¸­é‡Šæ”¾çš„ä»»ä½•èµ„æºã€‚ç„¶åè¿˜ä¼šè°ƒç”¨ build æ–¹æ³•ï¼Œè®© State å¯¹è±¡æœ‰æœºä¼šé€‚åº”æ ‘ä¸­çš„æ–°ä½ç½®ã€‚å¦‚æœ framework ç¡®å®é‡æ–°æ’å…¥è¿™ä¸ªå­æ ‘ï¼Œå®ƒä¼šåœ¨ä»æ ‘ä¸­ç§»é™¤å­æ ‘çš„åŠ¨ç”»å¸§ç»“æŸä¹‹å‰è¿™æ ·åšã€‚å› æ­¤ï¼ŒState å¯¹è±¡å¯ä»¥æ¨è¿Ÿé‡Šæ”¾å¤§å¤šæ•°èµ„æºï¼Œç›´åˆ° framework è°ƒç”¨å®ƒä»¬çš„ dispose æ–¹æ³•ã€‚

&emsp;å­ç±»åº”è¯¥é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œæ¸…ç†è¿™ä¸ªå¯¹è±¡ä¸æ ‘ä¸­å…¶ä»–å…ƒç´ ä¹‹é—´çš„ä»»ä½•é“¾æ¥ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœä½ å‘ç¥–å…ˆæä¾›äº†æŒ‡å‘åä»£ RenderObject çš„æŒ‡é’ˆï¼‰ã€‚

&emsp;è¿™ä¸ªæ–¹æ³•çš„å®ç°åº”è¯¥ä»¥è°ƒç”¨ç»§æ‰¿çš„æ–¹æ³•ç»“æŸï¼Œä¾‹å¦‚ super.deactivate()ã€‚

&emsp;å½“æ°¸ä¹…ä»æ ‘ä¸­ç§»é™¤ Widget åä¼šè°ƒç”¨ disposeã€‚

```dart
  @protected
  @mustCallSuper
  void deactivate() { }
```

## activate

&emsp;åœ¨é€šè¿‡ deactivate æ–¹æ³•ç§»é™¤åï¼Œå½“æ­¤ State å¯¹è±¡é‡æ–°æ’å…¥åˆ°æ ‘ä¸­æ—¶ä¼šè°ƒç”¨æ­¤æ–¹æ³•ã€‚

&emsp;åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå½“ä¸€ä¸ª State å¯¹è±¡è¢«åœç”¨åï¼Œå®ƒä¸ä¼šè¢«é‡æ–°æ’å…¥åˆ°æ ‘ä¸­ï¼Œå…¶ dispose æ–¹æ³•å°†ä¼šè¢«è°ƒç”¨ä»¥è¡¨ç¤ºå®ƒå¯ä»¥è¢« GC å›æ”¶â™»ï¸ã€‚

&emsp;ç„¶è€Œï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œä¸€ä¸ª State å¯¹è±¡åœ¨è¢«åœç”¨åï¼Œframework ä¼šå°†å…¶é‡æ–°æ’å…¥åˆ°æ ‘çš„å¦ä¸€ä¸ªéƒ¨åˆ†ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœåŒ…å«è¯¥ State å¯¹è±¡çš„å­æ ‘ç”±äºä½¿ç”¨ GlobalKey è€Œä»æ ‘çš„ä¸€ä¸ªä½ç½®ç§»æ¤åˆ°å¦ä¸€ä¸ªä½ç½®ï¼‰ã€‚å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œæ¡†æ¶å°†è°ƒç”¨ activate æ–¹æ³•ï¼Œè®© State å¯¹è±¡æœ‰æœºä¼šé‡æ–°è·å–åœ¨ deactivate ä¸­é‡Šæ”¾çš„ä»»ä½•èµ„æºã€‚ç„¶åè¿˜ä¼šè°ƒç”¨ build æ–¹æ³•ï¼Œè®©å¯¹è±¡æœ‰æœºä¼šé€‚åº”æ ‘ä¸­çš„æ–°ä½ç½®ã€‚å¦‚æœæ¡†æ¶é‡æ–°æ’å…¥è¿™ä¸ªå­æ ‘ï¼Œå®ƒå°†ä¼šåœ¨å­æ ‘ä»æ ‘ä¸­ç§»é™¤çš„åŠ¨ç”»å¸§ç»“æŸå‰è¿™æ ·åšã€‚å› æ­¤ï¼ŒState å¯¹è±¡å¯ä»¥æ¨è¿Ÿé‡Šæ”¾å¤§å¤šæ•°èµ„æºï¼Œç›´åˆ°æ¡†æ¶è°ƒç”¨å®ƒä»¬çš„ dispose æ–¹æ³•ã€‚

&emsp;æ¡†æ¶ä¸ä¼šåœ¨ç¬¬ä¸€æ¬¡å°† State å¯¹è±¡æ’å…¥åˆ°æ ‘æ—¶è°ƒç”¨æ­¤æ–¹æ³•ã€‚ç›¸åï¼Œåœ¨é‚£ç§æƒ…å†µä¸‹ï¼Œæ¡†æ¶ä¼šè°ƒç”¨ initStateã€‚

&emsp;æ­¤æ–¹æ³•çš„å®ç°åº”è¯¥ä»¥è°ƒç”¨ç»§æ‰¿æ–¹æ³•å¼€å§‹ï¼Œå°±åƒ super.activate() ä¸€æ ·ã€‚

```dart
  @protected
  @mustCallSuper
  void activate() { }
```

## dispose

&emsp;å½“æ­¤ State å¯¹è±¡æ°¸ä¹…ä»æ ‘ä¸­ç§»é™¤æ—¶è°ƒç”¨ã€‚

&emsp;å½“ framework è°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼Œè¡¨ç¤ºæ­¤ State å¯¹è±¡å°†æ°¸è¿œä¸ä¼šå†æ„å»º(ä¸ä¼šå†è¢«å¤ç”¨äº†ï¼Œå¯ä»¥è¿›å…¥ GC å›æ”¶æµç¨‹äº†)ã€‚åœ¨ framework è°ƒç”¨ dispose åï¼ŒState å¯¹è±¡è¢«è§†ä¸ºå·²å¸è½½ï¼Œmounted å±æ€§ä¸º falseã€‚åœ¨æ­¤æ—¶è°ƒç”¨ setState æ˜¯é”™è¯¯çš„ã€‚è¿™ä¸ªç”Ÿå‘½å‘¨æœŸé˜¶æ®µæ˜¯ç»ˆæ­¢çš„ï¼šæ— æ³•é‡æ–°æŒ‚è½½å·²è¢« dispose çš„ State å¯¹è±¡ã€‚

&emsp;å­ç±»åº”è¯¥é‡å†™æ­¤æ–¹æ³•æ¥é‡Šæ”¾è¯¥å¯¹è±¡ä¿ç•™çš„ä»»ä½•èµ„æºï¼ˆä¾‹å¦‚ï¼Œåœæ­¢ä»»ä½•æ´»åŠ¨çš„åŠ¨ç”»ï¼‰ã€‚

&emsp;å¦‚æœä¸€ä¸ª State çš„ build æ–¹æ³•ä¾èµ–äºä¸€ä¸ªå¯ä»¥æ”¹å˜çŠ¶æ€çš„å¯¹è±¡ï¼Œä¾‹å¦‚ä¸€ä¸ª ChangeNotifier æˆ– Streamï¼Œæˆ–è€…å…¶ä»–ä¸€äº›å¯ä»¥è®¢é˜…ä»¥æ¥æ”¶é€šçŸ¥çš„å¯¹è±¡ï¼Œåˆ™ç¡®ä¿åœ¨ initStateã€didUpdateWidget å’Œ dispose ä¸­æ­£ç¡®è®¢é˜…å’Œå–æ¶ˆè®¢é˜…ï¼š

1. åœ¨ initState ä¸­ï¼Œè®¢é˜…è¯¥å¯¹è±¡ã€‚
2. åœ¨ didUpdateWidget ä¸­ï¼Œä»æ—§å¯¹è±¡å–æ¶ˆè®¢é˜…å¹¶è®¢é˜…æ–°å¯¹è±¡ï¼ˆå¦‚æœæ›´æ–°çš„ widget é…ç½®éœ€è¦æ›¿æ¢è¯¥å¯¹è±¡ï¼‰ã€‚
3. åœ¨ dispose ä¸­ï¼Œä»å¯¹è±¡å–æ¶ˆè®¢é˜…ã€‚

&emsp;æ­¤æ–¹æ³•çš„å®ç°åº”è¯¥ä»¥è°ƒç”¨ç»§æ‰¿æ–¹æ³•ç»“æŸï¼Œå¦‚ super.dispose()ã€‚

### Caveats

&emsp;è¿™ä¸ªæ–¹æ³•åœ¨æŸäº›å¼€å‘è€…å¯èƒ½æœŸæœ›å®ƒè¢«è°ƒç”¨çš„æ—¶æœºå¹¶ä¸ä¼šè¢«è§¦å‘ï¼Œæ¯”å¦‚åº”ç”¨ç¨‹åºå…³é—­æˆ–é€šè¿‡å¹³å° Native æ–¹æ³•å…³é—­æ—¶ã€‚

&emsp;åº”ç”¨ç¨‹åºå…³é—­ï¼šæ— æ³•é¢„æµ‹åº”ç”¨ç¨‹åºå…³é—­å°†åœ¨ä½•æ—¶å‘ç”Ÿã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·çš„ç”µæ± å¯èƒ½ä¼šç€ç«ï¼Œæˆ–ç”¨æˆ·å¯èƒ½ä¼šå°†è®¾å¤‡æ‰å…¥æ¸¸æ³³æ± ï¼Œæˆ–è€…æ“ä½œç³»ç»Ÿå¯èƒ½ä¼šç”±äºå†…å­˜å‹åŠ›è€Œå•æ–¹é¢ç»ˆæ­¢åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚

&emsp;åº”ç”¨ç¨‹åºåº”è¯¥è´Ÿè´£ç¡®ä¿å³ä½¿åœ¨å¿«é€Ÿçš„æœªç»å®‰æ’çš„ç»ˆæ­¢æƒ…å†µä¸‹ï¼Œå®ƒä»¬ä»ç„¶è¡¨ç°è‰¯å¥½ã€‚

&emsp;ä¸ºäº†äººä¸ºå¯¼è‡´æ•´ä¸ª Widget æ ‘è¢«é‡Šæ”¾ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨åƒ SizedBox.shrink è¿™æ ·çš„ Widget è°ƒç”¨ runAppã€‚

&emsp;è¦ç›‘å¬å¹³å°å…³é—­æ¶ˆæ¯ï¼ˆä»¥åŠå…¶ä»–ç”Ÿå‘½å‘¨æœŸæ›´æ”¹ï¼‰ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ AppLifecycleListener APIã€‚

### Dismissing Flutter UI via platform native methods

&emsp;ä¸€ä¸ªåº”ç”¨ç¨‹åºå¯èƒ½åŒæ—¶åŒ…å« Flutter UI å’Œé Flutter UIã€‚å¦‚æœåº”ç”¨ç¨‹åºè°ƒç”¨é Flutter æ–¹æ³•æ¥ç§»é™¤åŸºäº Flutter çš„ UIï¼Œæ¯”å¦‚ä½¿ç”¨å¹³å° Native API æ¥æ“ä½œå¹³å° Native çš„å¯¼èˆªæ ˆï¼Œé‚£ä¹ˆ framework å°±ä¸çŸ¥é“å¼€å‘äººå‘˜æ˜¯å¦æ‰“ç®—è¿…é€Ÿé‡Šæ”¾èµ„æºã€‚Widget æ ‘ä»ç„¶è¢«åŠ è½½å¹¶å‡†å¤‡ç€ï¼Œåœ¨ä¸‹æ¬¡æ˜¾ç¤ºæ—¶å¯ä»¥ç«‹å³æ¸²æŸ“ã€‚

&emsp;è¯·å‚è€ƒç”¨äºå¼•å¯¼åº”ç”¨ç¨‹åºçš„æ–¹æ³•ï¼ˆä¾‹å¦‚ runApp æˆ– runWidgetï¼‰æ¥äº†è§£å¦‚ä½•æ›´ç§¯æåœ°é‡Šæ”¾èµ„æºçš„å»ºè®®ã€‚[runApp](https://api.flutter.dev/flutter/widgets/runApp.html) [runWidget](https://api.flutter.dev/flutter/widgets/runWidget.html)

```dart
  @protected
  @mustCallSuper
  void dispose() {
    // ...
  }
```

## build

&emsp;æè¿°äº†ç”±è¯¥ Widget è¡¨ç¤ºçš„ç”¨æˆ·ç•Œé¢çš„éƒ¨åˆ†ã€‚

&emsp;Framework åœ¨è®¸å¤šä¸åŒæƒ…å†µä¸‹è°ƒç”¨æ­¤æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š

+ åœ¨è°ƒç”¨ initState ä¹‹åã€‚
+ åœ¨è°ƒç”¨ didUpdateWidget ä¹‹åã€‚
+ åœ¨æ¥æ”¶åˆ°è°ƒç”¨ setState åã€‚
+ åœ¨æ­¤ State å¯¹è±¡çš„æŸä¸ªä¾èµ–é¡¹æ›´æ”¹åï¼ˆä¾‹å¦‚ï¼Œä¹‹å‰æ„å»ºä¸­å¼•ç”¨çš„ InheritedWidget æ›´æ”¹åï¼‰ã€‚
+ åœ¨è°ƒç”¨ deactivate å¹¶å°† State å¯¹è±¡é‡æ–°æ’å…¥æ ‘çš„å¦ä¸€ä¸ªä½ç½®åã€‚

&emsp;è¯¥æ–¹æ³•å¯èƒ½åœ¨æ¯ä¸€å¸§ä¸­éƒ½è¢«è°ƒç”¨ï¼Œä¸åº”è¯¥äº§ç”Ÿé™¤äº†æ„å»º Widget ä¹‹å¤–çš„ä»»ä½•å‰¯ä½œç”¨ã€‚

&emsp;Framework ä½¿ç”¨æ­¤æ–¹æ³•è¿”å›çš„ Widget å¯¹è±¡æ›¿æ¢æ­¤ Widget ä¸‹æ–¹çš„å­æ ‘ï¼Œå¯èƒ½é€šè¿‡æ›´æ–°ç°æœ‰å­æ ‘æˆ–é€šè¿‡ç§»é™¤å­æ ‘å¹¶ inflate ä¸€ä¸ªæ–°çš„å­æ ‘æ¥å®Œæˆï¼Œå…·ä½“å–å†³äºè°ƒç”¨ Widget.canUpdate æ¥ç¡®å®šæ­¤æ–¹æ³•è¿”å›çš„ Widget æ˜¯å¦å¯ä»¥æ›´æ–°ç°æœ‰å­æ ‘çš„æ ¹ã€‚

&emsp;é€šå¸¸çš„å®ç°ä¼šè¿”å›ä¸€ç»„æ–°åˆ›å»ºçš„ Widgetï¼Œè¿™äº› Widget ä½¿ç”¨äº†æ¥è‡ªæ­¤ Widget æ„é€ å‡½æ•°ã€ç»™å®šçš„ BuildContext å’Œæ­¤ State å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€çš„ä¿¡æ¯ã€‚

&emsp;ç»™å®šçš„ BuildContext åŒ…å«äº†æœ‰å…³è¯¥ Widget æ­£åœ¨æ„å»ºçš„æ ‘ä¸­ä½ç½®çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œè¯¥ä¸Šä¸‹æ–‡ä¸ºè¯¥æ ‘ä¸­æ­¤ä½ç½®æä¾›äº†ä¸€ç»„ InheritedWidgetã€‚BuildContext å‚æ•°å§‹ç»ˆä¸æ­¤ State å¯¹è±¡çš„ context å±æ€§ç›¸åŒï¼Œå¹¶ä¸”åœ¨è¯¥å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå†…å°†ä¿æŒä¸å˜ã€‚BuildContext å‚æ•°åœ¨è¿™é‡Œæä¾›å†—ä½™ï¼Œä»¥ä½¿æ­¤æ–¹æ³•ä¸ WidgetBuilder çš„ç­¾ååŒ¹é…ã€‚

### Design discussion

&emsp;ä¸ºä»€ä¹ˆ build æ–¹æ³•æ”¾åœ¨ State ä¸Šï¼Œè€Œä¸æ˜¯ StatefulWidget ä¸Šï¼Ÿ

&emsp;å°†ä¸€ä¸ª Widget build(BuildContext context) æ–¹æ³•æ”¾åœ¨ State ä¸Šï¼Œè€Œä¸æ˜¯åœ¨ StatefulWidget ä¸Šæ”¾ä¸€ä¸ª Widget build(BuildContext context, State state) æ–¹æ³•ï¼Œå¯ä»¥åœ¨å­ç±»åŒ– StatefulWidget æ—¶ç»™å¼€å‘è€…æ›´å¤šçš„çµæ´»æ€§ã€‚

&emsp;ä¾‹å¦‚ï¼ŒAnimatedWidget æ˜¯ StatefulWidget çš„ä¸€ä¸ªå­ç±»ï¼Œå®ƒå¼•å…¥äº†ä¸€ä¸ªæŠ½è±¡çš„ Widget build(BuildContext context) æ–¹æ³•ä¾›å…¶å­ç±»å®ç°ã€‚å¦‚æœ StatefulWidget å·²ç»æœ‰äº†ä¸€ä¸ªæ¥å— State å‚æ•°çš„ build æ–¹æ³•ï¼Œé‚£ä¹ˆ AnimatedWidget å°±å¿…é¡»å¼ºåˆ¶è¦æ±‚å…¶å­ç±»æä¾› State å¯¹è±¡ï¼Œå³ä½¿å…¶ State å¯¹è±¡æ˜¯ AnimatedWidget çš„å†…éƒ¨å®ç°ç»†èŠ‚ã€‚

&emsp;åœ¨æ¦‚å¿µä¸Šï¼ŒStatelessWidget ä¹Ÿå¯ä»¥ä»¥ç±»ä¼¼çš„æ–¹å¼å®ç°ä¸º StatefulWidget çš„å­ç±»ã€‚å¦‚æœ build æ–¹æ³•åœ¨ StatefulWidget ä¸Šè€Œä¸æ˜¯ State ä¸Šçš„è¯ï¼Œé‚£å°±ä¸å¯èƒ½äº†ã€‚

&emsp;å°† build å‡½æ•°æ”¾åœ¨ State ä¸Šè€Œä¸æ˜¯æ”¾åœ¨ StatefulWidget ä¸Šè¿˜æœ‰åŠ©äºé¿å…ä¸éšå¼æ•è· this å…³è”çš„ä¸€ç±»é”™è¯¯ã€‚å¦‚æœåœ¨ StatefulWidget çš„ build å‡½æ•°ä¸­å®šä¹‰ä¸€ä¸ªé—­åŒ…ï¼Œé‚£ä¹ˆè¯¥é—­åŒ…ä¼šéšå¼æ•è· thisï¼Œå³å½“å‰ Widget å¯¹è±¡å®ä¾‹ï¼Œå¹¶ä¸”ä¼šä½¿è¯¥å®ä¾‹çš„ï¼ˆä¸å¯å˜çš„ï¼‰å­—æ®µåœ¨ä½œç”¨åŸŸä¸­ï¼š

```dart
// (this is not valid Flutter code)
class MyButton extends StatefulWidgetX {
  MyButton({super.key, required this.color});

  final Color color;

  @override
  Widget build(BuildContext context, State state) {
    return SpecialWidget(
      handler: () { print('color: $color'); },
    );
  }
}
```

&emsp;ä¾‹å¦‚ï¼Œå‡è®¾çˆ¶çº§ä½¿ç”¨ blue æ„å»ºäº†ä¸€ä¸ªåä¸º MyButton çš„æŒ‰é’®ï¼Œè¿™æ—¶ print å‡½æ•°ä¸­çš„ $color å°±æŒ‡ä»£ blueï¼Œè¿™æ˜¯ç¬¦åˆé¢„æœŸçš„ã€‚ç°åœ¨ï¼Œå‡è®¾çˆ¶çº§ä¿®æ”¹ä¸º green å†æ¬¡æ„å»º MyButtonã€‚ç¬¬ä¸€æ¬¡æ„å»ºæ—¶åˆ›å»ºçš„é—­åŒ…ä»ç„¶éšå«åœ°æŒ‡å‘åŸå§‹çš„ Widgetï¼Œå› æ­¤ $color ä»ç„¶æ‰“å°è“è‰²ï¼Œå³ä½¿éƒ¨ä»¶å·²æ›´æ–°ä¸ºç»¿è‰²ï¼›å¦‚æœè¯¥é—­åŒ…ç”Ÿå­˜æ—¶é—´è¶…å‡ºå…¶éƒ¨ä»¶çš„ç”Ÿå­˜å‘¨æœŸï¼Œå®ƒå°†æ‰“å°è¿‡æ—¶çš„ä¿¡æ¯ã€‚

&emsp;ç›¸æ¯”ä¹‹ä¸‹ï¼Œåœ¨ State å¯¹è±¡ä¸Šçš„ build å‡½æ•°ä¸­ï¼Œé—­åŒ…åœ¨æ„å»ºè¿‡ç¨‹ä¸­éšå«åœ°æ•è·äº† State å®ä¾‹è€Œä¸æ˜¯ Widget å®ä¾‹ï¼š

```dart
class MyButton extends StatefulWidget {
  const MyButton({super.key, this.color = Colors.teal});

  final Color color;
  // ...
}

class MyButtonState extends State<MyButton> {
  // ...
  
  @override
  Widget build(BuildContext context) {
    return SpecialWidget(
      handler: () { print('color: ${widget.color}'); },
    );
  }
}
```

&emsp;ç°åœ¨ï¼Œå½“çˆ¶ç»„ä»¶ä½¿ç”¨ green é‡å»º MyButton æ—¶ï¼Œç¬¬ä¸€æ¬¡æ„å»ºç”Ÿæˆçš„é—­åŒ…ä»ç„¶å¼•ç”¨ State å¯¹è±¡ï¼Œè¯¥å¯¹è±¡è·¨é‡å»ºä¿ç•™ï¼Œå¹¶ä¸” framework å·²æ›´æ–°è¯¥ State å¯¹è±¡çš„ widget å±æ€§ï¼Œä»¥å¼•ç”¨æ–°çš„ MyButton å®ä¾‹ï¼Œè€Œ ${widget.color} æ‰“å°ä¸ºç»¿è‰²ï¼Œæ­£å¦‚é¢„æœŸçš„é‚£æ ·ã€‚

&emsp;è¯´å®è¯ï¼Œè¿™é‡Œæ²¡çœ‹æ‡‚é—­åŒ…æ•è·çš„é—®é¢˜ï¼Œæœ‰å°ä¼™ä¼´èƒ½è§£ç­”ä¸€ä¸‹å—ï¼Ÿ

```dart
  @protected
  Widget build(BuildContext context);
```

## didChangeDependencies

&emsp;å½“æ­¤ State å¯¹è±¡çš„ä¾èµ–é¡¹å‘ç”Ÿæ›´æ”¹æ—¶è°ƒç”¨ã€‚

&emsp;ä¾‹å¦‚ï¼Œå¦‚æœå‰ä¸€æ¬¡å¯¹ build çš„è°ƒç”¨å¼•ç”¨äº†åæ¥å‘ç”Ÿæ›´æ”¹çš„ InheritedWidgetï¼Œé‚£ä¹ˆ framework å°†è°ƒç”¨æ­¤æ–¹æ³•æ¥é€šçŸ¥æ­¤å¯¹è±¡å‘ç”Ÿæ›´æ”¹ã€‚

&emsp;æ­¤æ–¹æ³•ä¹Ÿä¼šåœ¨ initState ä¹‹åç«‹å³è°ƒç”¨ã€‚å¯ä»¥åœ¨æ­¤æ–¹æ³•ä¸­å®‰å…¨åœ°è°ƒç”¨ BuildContext.dependOnInheritedWidgetOfExactTypeã€‚

&emsp;å­ç±»å¾ˆå°‘é‡å†™æ­¤æ–¹æ³•ï¼Œå› ä¸º framework å§‹ç»ˆåœ¨ä¾èµ–é¡¹æ›´æ”¹åè°ƒç”¨ buildã€‚ä¸€äº›å­ç±»ç¡®å®ä¼šé‡å†™æ­¤æ–¹æ³•ï¼Œå› ä¸ºå®ƒä»¬åœ¨å…¶ä¾èµ–é¡¹æ›´æ”¹æ—¶éœ€è¦æ‰§è¡Œä¸€äº›æ˜‚è´µçš„å·¥ä½œï¼ˆä¾‹å¦‚ï¼Œç½‘ç»œè·å–ï¼‰ï¼Œå¹¶ä¸”è¿™äº›å·¥ä½œå¯¹äºæ¯æ¬¡ build æ¥è¯´éƒ½å¤ªæ˜‚è´µäº†ã€‚

&emsp;å†æ¢³ç†ä¸€ä¸‹å½“ä¾èµ–çš„ InheritedElement å‘ç”Ÿæ›´æ–°æ—¶æ˜¯å¦‚ä½•å›è°ƒåˆ° State çš„ didChangeDependencies çš„ï¼š

1. InheritedElement ä¼šç›´æ¥è°ƒç”¨ä¾èµ–è€…çš„ didChangeDependencies å‡½æ•°ã€‚
2. StatefulElement çš„ didChangeDependencies å‡½æ•°å†…ï¼šå…ˆç›´æ¥è°ƒç”¨ `super.didChangeDependencies()`ï¼ˆå…¶å†…éƒ¨åªæœ‰ä¸€å¥ï¼šæŠŠæ­¤ element æ ‡è®°ä¸ºéœ€è¦é‡å»ºï¼š`markNeedsBuild()`ï¼‰ï¼Œç„¶åæŠŠ StatefulElement å¯¹è±¡çš„ `_didChangeDependencies = true` æ ‡è®°ä¸º trueã€‚
3. ä¸‹ä¸€å¸§ï¼Œå½“ StatefulElement å¯¹è±¡æ‰§è¡Œ performRebuild æ—¶ï¼Œä¼šæ ¹æ® `_didChangeDependencies` æ˜¯å¦ä¸º true è°ƒç”¨ `state.didChangeDependencies()`ã€‚

&emsp;è¿™æ ·å°±å›è°ƒåˆ° State.didChangeDependencies äº†ã€‚

&emsp;å¦‚æœæ˜¯å…¶å®ƒç±»å‹çš„ Element ä¾èµ– InheritedElement çš„è¯ï¼Œå¦‚ï¼šStatelessElementï¼Œå®ƒå‘¢å°±æ²¡æœ‰å¿…è¦é‡å†™ didChangeDependencies å‡½æ•°ï¼Œå®ƒæ˜¯ç›´æ¥ä½¿ç”¨ Element çˆ¶ç±»çš„å³å¯ï¼Œå†…éƒ¨ä»…ä¸€å¥ `markNeedsBuild()`ï¼ŒæŠŠè‡ªå·±æ ‡è®°ä¸ºè„ï¼Œç„¶ååˆ°ä¸‹ä¸€å¸§æ‰§è¡Œé‡å»ºå³å¯ã€‚ 

```dart
  @protected
  @mustCallSuper
  void didChangeDependencies() { }
```

## State æ€»ç»“

&emsp;å› ä¸ºå·²ç»è¯»å®Œäº† Element ç±»çš„å†…å®¹ï¼Œæ‰€ä»¥å†è¯» State çš„å†…å®¹çš„è¯è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°å¿«é€Ÿçš„ã€‚å†åŠ ä¸Š State çš„å†…å®¹å‡ ä¹å’Œ StatefulElement å’Œ StatefulWidget ç»‘å®šåœ¨ä¸€èµ·ï¼Œæ‰€ä»¥çœ‹èµ·æ¥æ¯”è¾ƒæ¸…æ™°ã€‚

&emsp;ä¸€å¯¹ State å¯¹è±¡å’Œ StatefulElement å¯¹è±¡æ˜¯ä¸€ç”Ÿéƒ½ç»‘å®šåœ¨ä¸€èµ·çš„ã€‚ä¸ä¼šåƒå®ƒä»¬å¼•ç”¨çš„ widget å¯¹è±¡ä¸€æ ·ï¼Œå‘ç”Ÿå˜åŒ–ã€‚

&emsp;ç„¶åå†ä¸‹é¢æœ€é‡è¦ä¸¤ç‚¹ï¼š1. State å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚2. setState éƒ½å¹²äº†ä»€ä¹ˆã€‚

&emsp;State å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼š

1. StatefulElement å¯¹è±¡åˆ›å»ºæ—¶ï¼Œæ„é€ å‡½æ•°çš„åˆå§‹åŒ–åˆ—è¡¨å¤„ï¼š`_state = widget.createState()`ï¼Œå³åŒæ—¶åˆ›å»ºäº† State å¯¹è±¡ã€‚
2. StatefulElement å¯¹è±¡åˆ›å»ºå¥½åï¼Œå°±è¦æŒ‚è½½åˆ° Element tree ä¸Šäº†ï¼Œä¼šè°ƒç”¨å®ƒçš„ mount å‡½æ•°ï¼Œç„¶åæŒ‚è½½å¥½åï¼Œå°±è¦è¿›è¡Œåˆæ¬¡ build äº†ï¼Œå³è°ƒç”¨ï¼š` _firstBuild()`ï¼Œç„¶åè¿›å…¥ StatefulElement çš„ `_firstBuild` å‡½æ•°ï¼Œç¬¬ä¸€å¥å°±æ˜¯è°ƒç”¨ï¼š`state.initState()`ã€‚1ï¸âƒ£ï¼šinitState æ‰§è¡Œã€‚
3. è¿˜æ˜¯ StatefulElement çš„ `_firstBuild` å‡½æ•°ï¼Œç´§æ¥ç€è°ƒç”¨ï¼š`state.didChangeDependencies()`ã€‚2ï¸âƒ£ï¼šdidChangeDependencies æ‰§è¡Œã€‚
4. StatefulElement çœŸæ­£å¼€å§‹æ„å»º `performRebuild` æ‰§è¡Œï¼Œ`state.build()` æ‰§è¡Œã€‚3ï¸âƒ£ï¼šbuild æ‰§è¡Œã€‚ï¼ˆåç»­ StatefulElement å¯¹è±¡å¦‚æœé‡å»ºï¼Œæ­¤ state.build éƒ½ä¼šæ‰§è¡Œã€‚ï¼‰
5. å½“ StatefulElement å¯¹è±¡åŒç±»å‹ Widget æ›´æ–°æ—¶ï¼Œä¼šæ‰§è¡Œ update å‡½æ•°ï¼Œå†…éƒ¨è°ƒç”¨ï¼š`state.didUpdateWidget(oldWidget)`ã€‚4ï¸âƒ£ï¼šdidUpdateWidget æ‰§è¡Œã€‚
6. é™¤äº†åˆæ¬¡æ„å»ºæ—¶è°ƒç”¨ `state.didChangeDependencies()`ï¼Œå½“ StatefulElement ä¾èµ–äº† InheritedElement çš„è¯ï¼Œå½“ InheritedElement æ›´æ–°æ—¶ï¼ŒStatefulElement ä¹Ÿä¼šè¢«é€šçŸ¥é‡å»ºï¼Œå½“ `performRebuild` æ‰§è¡Œæ—¶ï¼Œä¼šåˆ¤æ–­æ˜¯å¦æ˜¯ä¾èµ–æ›´æ–°ï¼ˆ`_didChangeDependencies`ï¼‰ï¼Œå†æ¬¡è°ƒç”¨ï¼š`state.didChangeDependencies()`ã€‚2ï¸âƒ£ï¼šdidChangeDependencies æ‰§è¡Œã€‚
7. å½“ StatefulElement å¯¹è±¡ä» Element tree ç§»é™¤æ—¶ï¼Œåˆ«è°ƒç”¨ deactivateï¼ŒåŒæ—¶è°ƒç”¨ï¼š`state.deactivate()`ã€‚5ï¸âƒ£ï¼šdeactivate æ‰§è¡Œã€‚
8. å¦‚æœ StatefulElement å¯¹è±¡è¢«å¤ç”¨å†æ¬¡è¢«æ¿€æ´»æ—¶ï¼ŒåŒæ—¶è°ƒç”¨ï¼š`state.activate()`ã€‚6ï¸âƒ£ï¼šactivate æ‰§è¡Œã€‚
9. å½“ StatefulElement å¯¹è±¡å†ä¹Ÿç”¨ä¸åˆ°äº†ï¼Œæ‰§è¡Œ unmount æ—¶ï¼ŒåŒæ—¶è°ƒç”¨ï¼š`state.dispose()`ã€‚7ï¸âƒ£ï¼šdispose æ‰§è¡Œã€‚

&emsp;ç„¶åæ˜¯ setState éƒ½å¹²äº†ä»€ä¹ˆï¼Ÿå†…éƒ¨çš„è¯ä»…æ˜¯ä¸¤è¡Œä»£ç ï¼š`final Object? result = fn() as dynamic;` å’Œ `_element!.markNeedsBuild()`ï¼Œé¦–å…ˆæ‰§è¡Œä¼ å…¥çš„å›è°ƒï¼Œæ›´æ–° State å¯¹è±¡çš„æ•°æ®ï¼Œç„¶åæŠŠå¯¹åº”çš„ StatefulElement å¯¹è±¡æ ‡è®°ä¸ºè„ï¼Œå¹¶æŠŠå®ƒæ·»åŠ åˆ°å…¨å±€çš„è„åˆ—è¡¨é‡Œï¼š`_dirtyElements.add(element)`ï¼Œç­‰å¾…ç€ä¸‹ä¸€å¸§è¿›è¡Œé‡å»ºã€‚ 

&emsp;OKï¼Œ`State<T extends StatefulWidget> class` ç±»å†…å®¹çœ‹å®Œäº†ï¼Œå¦‚æœå·²ç»å¯¹ Element æ„å»ºå’Œæ›´æ–°æµç¨‹å¾ˆç†Ÿæ‚‰çš„è¯ï¼Œé‚£ä¹ˆ State çš„å†…å®¹çœ‹èµ·æ¥ä¹Ÿæ˜¯æ¸…æ™°å¼‚å¸¸ã€‚ 

## å‚è€ƒé“¾æ¥
**å‚è€ƒé“¾æ¥:ğŸ”—**
+ [`State<T extends StatefulWidget> class`](https://api.flutter.dev/flutter/widgets/Element-class.html)
+ [StatefulElement class](https://api.flutter.dev/flutter/widgets/StatefulElement-class.html)
+ [StatelessElement class](https://api.flutter.dev/flutter/widgets/StatelessElement-class.html)
