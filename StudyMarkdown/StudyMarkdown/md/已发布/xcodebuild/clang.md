# Clang å­¦ä¹ ç¬”è®°

## clang æ¦‚è¿°

> &emsp;clang - the Clang C, C++, Objective-C, and Objective-C++ compiler

&emsp;Clang æ˜¯ä¸€ä¸ª C/C++/Objective-C/Objective-C++ çš„ç¼–è¯‘å™¨å‰ç«¯ï¼ˆclang ç¼–è¯‘å™¨å‰ç«¯ï¼Œä¸»è¦å¤„ç†ä¸€äº›å’Œå…·ä½“æœºå™¨æ— å…³çš„é’ˆå¯¹è¯­è¨€çš„åˆ†ææ“ä½œï¼ŒLLVM ä½œä¸ºç¼–è¯‘å™¨åç«¯ï¼Œå¯è¿›ä¸€æ­¥ç¼–è¯‘ä¸ºä¸å¹³å°ç›¸å…³çš„æœºå™¨è¯­è¨€ï¼‰ï¼Œè€Œ clang å‘½ä»¤åˆ™æä¾›çš„äº†å®Œæ•´çš„ç¼–è¯‘ã€é“¾æ¥åŠŸèƒ½ï¼Œclang å‘½ä»¤èƒ½å¤Ÿè°ƒç”¨èµ·æ¥ç¼–è¯‘å™¨çš„æ•´ä¸ªå·¥ä½œæµç¨‹ï¼Œæ‰€ä»¥ Clang ä¸æ­¢æ˜¯å‰ç«¯ç¼–è¯‘å™¨ï¼Œæ›´æ˜¯è¿æ¥äº† LLVM æ•´ä¸ªç¼–è¯‘è¿‡ç¨‹å’Œå…¶ä»–å·¥å…·çš„ä¸€ä¸ªé©±åŠ¨ç¨‹åºã€‚

> &emsp;Clangï¼ˆå‘éŸ³ä¸º /ËˆklÃ¦Å‹/ ç±»ä¼¼è‹±æ–‡å•å­— clangï¼‰æ˜¯ä¸€ä¸ª Cã€C++ã€Objective-C å’Œ Objective-C++ ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘å™¨å‰ç«¯ã€‚
  Clang æ˜¯ LLVM ç¼–è¯‘å™¨å·¥å…·é›†çš„å‰ç«¯ï¼ˆfront-endï¼‰ï¼Œç›®çš„æ˜¯è¾“å‡ºå¼€å‘è€…ç¼–å†™çš„æºä»£ç å¯¹åº”çš„æŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Tree, ASTï¼‰ï¼Œå¹¶å°†æºä»£ç ç¼–è¯‘æˆ LLVM Bitcodeï¼Œæ¥ç€åœ¨åç«¯ï¼ˆback-endï¼‰ä½¿ç”¨ LLVM ç¼–è¯‘æˆå¹³å°ç›¸å…³çš„æœºå™¨è¯­è¨€ã€‚Clang æ”¯æŒ Cã€C++ã€Objective Cã€‚
  Clang é¡¹ç›®ï¼ˆæ³¨æ„è¿™é‡Œæ¢ç§°å‘¼äº†ï¼‰é‡‡ç”¨äº† LLVM ä½œä¸ºå…¶åç«¯ï¼Œç”± LLVM 2.6 å¼€å§‹ï¼Œä¸€èµ·å‘å¸ƒæ–°ç‰ˆæœ¬ã€‚å®ƒçš„ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ª GNU ç¼–è¯‘å™¨å¥—è£…ï¼ˆè‹±è¯­ï¼šGNU Compiler Collectionï¼Œç¼©å†™ä¸º GCCï¼ŒåŸåä¸º GNU C è¯­è¨€ç¼–è¯‘å™¨ï¼ˆGNU C Compilerï¼‰ï¼Œå› ä¸ºå®ƒåŸæœ¬åªèƒ½å¤„ç† C è¯­è¨€ã€‚GCC åœ¨å‘å¸ƒåå¾ˆå¿«åœ°å¾—åˆ°æ‰©å±•ï¼Œå˜å¾—å¯å¤„ç† C++ï¼Œä¹‹åä¹Ÿå˜å¾—å¯å¤„ç† Fortranã€Pascalã€Objective-Cã€Javaã€Adaï¼ŒGo ä¸å…¶ä»–è¯­è¨€ã€‚[GCC](https://zh.wikipedia.org/wiki/GCC)ï¼‰çš„æ›¿ä»£å“ï¼Œæ”¯æŒäº† GNU ç¼–è¯‘å™¨å¤§å¤šæ•°çš„ç¼–è¯‘è®¾ç½®ä»¥åŠéå®˜æ–¹è¯­è¨€çš„æ‰©å±•ï¼Œä½œè€…æ˜¯å…‹é‡Œæ–¯Â·æ‹‰ç‰¹çº³ï¼ˆChris Lattnerï¼‰ï¼Œåœ¨è‹¹æœå…¬å¸çš„èµåŠ©æ”¯æŒä¸‹è¿›è¡Œå¼€å‘ï¼Œè€Œæºä»£ç è®¸å¯æ˜¯ä½¿ç”¨ç±» BSD çš„ä¼Šåˆ©è¯ºä¼Šå¤§å­¦å„å·´çº³-é¦™æ§Ÿåˆ†æ ¡å¼€æºç è®¸å¯ã€‚
  Clang åŒ…æ‹¬ Clang å‰ç«¯å’Œ Clang é™æ€åˆ†æå™¨ç­‰ã€‚[Clang](https://zh.wikipedia.org/wiki/Clang)
  Clang é¡¹ç›®åœ¨ 2005 å¹´ç”±è‹¹æœå…¬å¸å‘èµ·ã€‚
  
&emsp;è¿™é‡Œå¤§å®¶å¯èƒ½å¯¹ Clang å’Œ LLVM çš„å…³ç³»æœ‰äº›æ‡µï¼Œå¯ä»¥çœ‹è¿™ä¸ªï¼š[æ·±å…¥ç ”ç©¶Clangï¼ˆä¸€ï¼‰Clangå’ŒLLVMçš„å…³ç³»åŠæ•´ä½“æ¶æ„](https://zhuanlan.zhihu.com/p/26223459)ã€‚

&emsp;æˆ‘ä»¬å¯ä»¥é€šè¿‡ `which clang` å‘½ä»¤çœ‹åˆ° Clang ä½äºï¼š/usr/bin/clang å¤§æ¦‚æ˜¯æœ‰ç›´æ¥é›†æˆåœ¨ macOS ä¸­çš„ï¼Œç„¶åé€šè¿‡ `clang -v` å‘½ä»¤åˆçœ‹åˆ° Xcode ä¸­ä¹Ÿé›†æˆäº† Clangï¼ŒInstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clangã€‚

```c++
hmc@localhost ~ % which clang
/usr/bin/clang
```

```c++
hmc@localhost ~ % clang -v
Apple clang version 13.0.0 (clang-1300.0.29.3)
Target: x86_64-apple-darwin21.1.0
Thread model: posix
InstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin
```

&emsp;(è¿™é‡Œæ˜¯æˆ‘è‡ªå·±çš„ä¸€äº›æƒ³æ³•ï¼Œå¯èƒ½æ˜¯é”™çš„ï¼šæˆ‘ä»¬è¦å¯¹ "Clang æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨å‰ç«¯" å’Œ "clang å‘½ä»¤" åšå‡ºç†è§£ä¸Šçš„åŒºåˆ«ï¼Œè¯´ Clang æ˜¯ç¼–è¯‘å™¨å‰ç«¯ç›´è§‰ä¸Šå¥½åƒç»™äººè¯´ Clang åªæ˜¯ç¼–è¯‘å™¨çš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼Œé‚£ä¹ˆä½œä¸ºä¸€ä¸ªç»„æˆéƒ¨åˆ†æ˜¯ä¸æ˜¯å°±ä¸èƒ½ç›´æ¥æä¾›å®Œæ•´çš„ç¼–è¯‘ã€é“¾æ¥åŠŸèƒ½ï¼ˆè¿™é‡Œæ˜¯æŒ‡æŠŠæˆ‘ä»¬çš„ç¨‹åºä»æºç æ–‡ä»¶ "å®Œå…¨è½¬æ¢" ä¸ºå¯æ‰§è¡Œç¨‹åºï¼‰ï¼Œè€Œåªèƒ½æä¾›å…¶ä¸­ä¸€ç¯çš„æ”¯æŒï¼Ÿclang å‘½ä»¤åˆ™ä¸æ˜¯ï¼Œå®ƒæ˜¯é›†æˆäº†å®Œæ•´çš„ç¼–è¯‘ã€é“¾æ¥åŠŸèƒ½çš„ï¼Œä¾‹å¦‚: é€šè¿‡ `clang main.m` å‘½ä»¤æˆ‘ä»¬å¯ä»¥ç›´æ¥å¾—åˆ°ä¸€ä¸ªåä¸º `a.out` çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆa æ˜¯é»˜è®¤åï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ `-o` é€‰é¡¹æŒ‡å®šè‡ªå®šä¹‰çš„å¯æ‰§è¡Œæ–‡ä»¶çš„åå­—ï¼‰ï¼Œé€šè¿‡ `./a.out` ä¾¿å¯ç›´æ¥æ‰§è¡Œè¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œé€šè¿‡ `file a.out` æˆ‘ä»¬å¯å¾—å‡ºç±»ä¼¼ä¿¡æ¯ï¼š`a.out: Mach-O 64-bit executable x86_64`ï¼Œå³å½“å‰æƒ…å†µä¸‹ a.out æ˜¯ä¸€ä¸ª x86_64 æ¶æ„ä¸‹çš„ Mach-O æ ¼å¼çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç„¶åæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ `clang` å‘½ä»¤åé¢æŒ‡å®šä¸åŒçš„é€‰é¡¹ `-Eã€-Sã€-c` æ¥åˆ†åˆ«æŸ¥çœ‹å®Œæ•´ç¼–è¯‘ã€é“¾æ¥è¿‡ç¨‹ä¸­çš„ä¸åŒé˜¶æ®µçš„æƒ…å†µï¼ˆä»¥åŠæŒ‡å®šé˜¶æ®µçš„è¾“å‡ºæ–‡ä»¶ï¼‰ï¼šé¢„ç¼–è¯‘æ–‡ä»¶ã€æ±‡ç¼–æ–‡ä»¶ã€ç›®æ ‡æ–‡ä»¶ï¼Œæ‰€ä»¥å•æŒ‡ Clang å¯ä»¥è¯´å®ƒæ˜¯ä¸€ä¸ªç¼–è¯‘å™¨æˆ–è€…ç¼–è¯‘å™¨å‰ç«¯ï¼Œclang å‘½ä»¤çš„è¯åˆ™æ˜¯é«˜åº¦é›†æˆçš„ï¼Œå®ƒå¯ä»¥åˆ†é˜¶æ®µæˆ–è€…å®Œæ•´çš„æ‰§è¡Œæ•´ä¸ªç¼–è¯‘ã€é“¾æ¥è¿‡ç¨‹ã€‚)

&emsp;æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ `man clang` å‘½ä»¤æ¥æŸ¥çœ‹ Clang çš„è¯¦ç»†ä¿¡æ¯ã€‚

> &emsp;clang is a C, C++, and Objective-C compiler which encompasses preprocessing, parsing, optimization, code generation, assembly, and linking.  Depending on which high-level mode setting is passed, Clang will stop before doing a full link. While Clang is highly integrated, it is important to understand the stages of compilation, to understand how to invoke it.  These stages are:

&emsp;Clang åŒ…æ‹¬å¦‚ä¸‹åŠŸèƒ½ï¼špreprocessingï¼ˆé¢„å¤„ç†ï¼‰ã€parsingï¼ˆè¯­æ³•åˆ†æï¼‰ã€optimizationï¼ˆä¼˜åŒ–ï¼‰ã€code generationï¼ˆä»£ç ç”Ÿæˆï¼ŒAST åˆ° LLVM IRï¼‰ã€assemblyï¼ˆæ±‡ç¼–ï¼‰ã€linkingï¼ˆé“¾æ¥ï¼‰ï¼š

+ é¢„å¤„ç†ï¼ˆ.i .ii .mi .mii æ–‡ä»¶ï¼‰ã€
+ è¯­æ³•åˆ†æå’Œè¯­ä¹‰åˆ†æï¼ˆAST æŠ½è±¡è¯­æ³•æ ‘ï¼‰ã€
+ ä»£ç ç”Ÿæˆï¼ˆLLVM IRï¼‰å’Œä¼˜åŒ–ï¼ˆ.sï¼‰ã€
+ æ±‡ç¼–ï¼ˆ.oï¼‰å’Œé“¾æ¥ï¼ˆ.out .dylib .soï¼‰ã€‚
 
&emsp;Clang æ ¹æ®ä¼ é€’çš„ high-level mode settingï¼ˆå³ä½¿ç”¨ clang å‘½ä»¤æ—¶æŒ‡å®šçš„é‚£äº›é€‰é¡¹ï¼‰ï¼ŒClang å°†åœ¨æ‰§è¡Œå®Œæ•´é“¾æ¥ï¼ˆfull linkï¼‰ä¹‹å‰åœæ­¢ã€‚clang å‘½ä»¤çš„æä¾›çš„é€‰é¡¹æœ‰å¦‚ä¸‹å‡ ç»„ï¼š

+ Stage Selection Optionsï¼ˆæœ€é‡è¦çš„é€‰é¡¹ï¼‰

```c++
hmc@HMdeMac-mini compile_test % clang -ccc-print-phases main.m
               +- 0: input, "main.m", objective-c
            +- 1: preprocessor, {0}, objective-c-cpp-output
         +- 2: compiler, {1}, ir
      +- 3: backend, {2}, assembler
   +- 4: assembler, {3}, object
+- 5: linker, {4}, image
6: bind-arch, "x86_64", {5}, image
```

&emsp;è™½ç„¶ Clang æ˜¯é«˜åº¦é›†æˆçš„ï¼Œä½†é‡è¦çš„æ˜¯è¦äº†è§£ç¼–è¯‘çš„å„ä¸ªé˜¶æ®µï¼Œäº†è§£å¦‚ä½•è°ƒç”¨å®ƒã€‚ è¿™äº›é˜¶æ®µæ˜¯ï¼š


+ Driverï¼šclang å¯æ‰§è¡Œæ–‡ä»¶å®é™…ä¸Šæ˜¯ä¸€ä¸ªå°é©±åŠ¨ç¨‹åºï¼Œå®ƒæ§åˆ¶å…¶ä»–å·¥å…·ï¼ˆå¦‚ç¼–è¯‘å™¨ã€æ±‡ç¼–å™¨å’Œé“¾æ¥å™¨ï¼‰çš„æ•´ä½“æ‰§è¡Œã€‚é€šå¸¸ï¼Œä½ ä¸éœ€è¦ä¸é©±åŠ¨ç¨‹åºäº¤äº’ï¼Œä½†å¯ä»¥é€æ˜åœ°ä½¿ç”¨å®ƒä»¥è¿è¡Œå…¶ä»–å·¥å…·ã€‚
+ Preprocessingï¼ˆé¢„å¤„ç†ï¼‰ï¼šæ­¤é˜¶æ®µå¤„ç†è¾“å…¥æºæ–‡ä»¶çš„æ ‡è®°åŒ–ã€å®æ‰©å±•ã€#include æ‰©å±•å’Œå…¶ä»–é¢„å¤„ç†å™¨æŒ‡ä»¤çš„å¤„ç†ã€‚æ­¤é˜¶æ®µçš„è¾“å‡ºé€šå¸¸ç§°ä¸º ".i"ï¼ˆç”¨äº Cï¼‰ã€".ii"ï¼ˆç”¨äº C++ï¼‰ã€".mi"ï¼ˆç”¨äº Objective-Cï¼‰æˆ– ".mii"ï¼ˆç”¨äº Objective-C++ï¼‰æ–‡ä»¶ã€‚
+ Parsing and Semantic Analysisï¼ˆè¯­æ³•åˆ†æå’Œè¯­ä¹‰åˆ†æï¼‰ï¼šæ­¤é˜¶æ®µåˆ†æè¾“å…¥æ–‡ä»¶ï¼Œå°†é¢„å¤„ç†å™¨ä»¤ç‰Œè½¬æ¢ä¸ºåˆ†ææ ‘ã€‚ ä¸€æ—¦é‡‡ç”¨è§£ææ ‘çš„å½¢å¼ï¼Œå®ƒå°±ä¼šå°†è¯­ä¹‰åˆ†æåº”ç”¨äºè¡¨è¾¾å¼çš„è®¡ç®—ç±»å‹ï¼Œå¹¶ç¡®å®šä»£ç æ˜¯å¦è‰¯å¥½å½¢æˆã€‚æ­¤é˜¶æ®µè´Ÿè´£ç”Ÿæˆå¤§å¤šæ•°ç¼–è¯‘å™¨è­¦å‘Šä»¥åŠåˆ†æé”™è¯¯ã€‚æ­¤é˜¶æ®µçš„è¾“å‡ºæ˜¯â€œæŠ½è±¡è¯­æ³•æ ‘â€ï¼ˆASTï¼‰ã€‚
+ Code Generation and Optimizationï¼šæ­¤é˜¶æ®µå°† AST è½¬æ¢ä¸ºä½çº§ä¸­é—´ä»£ç ï¼ˆç§°ä¸º "LLVM IR"ï¼‰ï¼Œå¹¶æœ€ç»ˆè½¬æ¢ä¸ºæœºå™¨ä»£ç ã€‚ æ­¤é˜¶æ®µè´Ÿè´£ä¼˜åŒ–ç”Ÿæˆçš„ä»£ç å¹¶å¤„ç†ç‰¹å®šäºç›®æ ‡çš„ä»£ç ç”Ÿæˆã€‚æ­¤é˜¶æ®µçš„è¾“å‡ºé€šå¸¸ç§°ä¸º ".s" æ–‡ä»¶æˆ–æ±‡ç¼–æ–‡ä»¶ã€‚Clang è¿˜æ”¯æŒä½¿ç”¨é›†æˆæ±‡ç¼–ç¨‹åºï¼Œå…¶ä¸­ä»£ç ç”Ÿæˆå™¨ç›´æ¥ç”Ÿæˆå¯¹è±¡æ–‡ä»¶ã€‚è¿™é¿å…äº†ç”Ÿæˆâ€œ.sâ€æ–‡ä»¶å’Œè°ƒç”¨ç›®æ ‡æ±‡ç¼–ç¨‹åºçš„å¼€é”€ã€‚
+ Assemblerï¼šæ­¤é˜¶æ®µè¿è¡Œç›®æ ‡æ±‡ç¼–ç¨‹åºä»¥å°†ç¼–è¯‘å™¨çš„è¾“å‡ºè½¬æ¢ä¸ºç›®æ ‡å¯¹è±¡æ–‡ä»¶ã€‚æ­¤é˜¶æ®µçš„è¾“å‡ºé€šå¸¸ç§°ä¸º â€œ.oâ€ æ–‡ä»¶æˆ–â€œå¯¹è±¡â€æ–‡ä»¶ã€‚
+ Linkerï¼šæ­¤é˜¶æ®µè¿è¡Œç›®æ ‡é“¾æ¥å™¨ä»¥å°†å¤šä¸ªå¯¹è±¡æ–‡ä»¶åˆå¹¶åˆ°å¯æ‰§è¡Œæ–‡ä»¶æˆ–åŠ¨æ€åº“ä¸­ã€‚æ­¤é˜¶æ®µçš„è¾“å‡ºé€šå¸¸ç§°ä¸º â€œa.outâ€ã€â€œ.dylibâ€ æˆ– â€œ.soâ€ æ–‡ä»¶ã€‚
+ Clang Static Analyzerï¼šClang é™æ€åˆ†æå™¨æ˜¯ä¸€ç§æ‰«ææºä»£ç ä»¥å°è¯•é€šè¿‡ä»£ç åˆ†ææ¥æŸ¥æ‰¾ bug çš„å·¥å…·ã€‚ æ­¤å·¥å…·ä½¿ç”¨ Clang çš„è®¸å¤šéƒ¨åˆ†ï¼Œå¹¶å†…ç½®äºåŒä¸€é©±åŠ¨ç¨‹åºä¸­ã€‚

## Driverï¼ˆé©±åŠ¨ç¨‹åºï¼‰

> &emsp;The clang executable is actually a small driver which controls the overall execution of other tools such as the compiler, assembler and linker.
  Typically you do not need to interact with the driver, but you transparently use it to run the other tools.
  "clang executable" æ˜¯æŒ‡æˆ‘ä»¬æ‰€ä½¿ç”¨çš„ clang å‘½ä»¤æ‰€å¯¹åº”çš„ clang å¯æ‰§è¡Œç¨‹åºã€‚

&emsp;clang å¯æ‰§è¡Œç¨‹åºå®é™…ä¸Šæ˜¯ä¸€ä¸ªå°çš„é©±åŠ¨ç¨‹åºï¼Œå®ƒæ§åˆ¶ LLVM æ¡†æ¶ä¸­çš„å…¶ä»–å·¥å…·ï¼ˆå¦‚ç¼–è¯‘å™¨ã€æ±‡ç¼–å™¨å’Œé“¾æ¥å™¨ï¼‰çš„æ•´ä½“æ‰§è¡Œã€‚







## clang å’Œ GNU çš„è”ç³»



## å‚è€ƒé“¾æ¥
**å‚è€ƒé“¾æ¥:ğŸ”—**
+ [Clangä¸LLVMçš„å…³ç³»](https://blog.csdn.net/u010164190/article/details/104901279)
+ [iOSç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»-ç¼–è¯‘ã€é“¾æ¥è¿‡ç¨‹ï¼ˆä¸€ï¼‰](https://juejin.cn/post/6844903912147795982)
+ [clangå¸¸ç”¨è¯­æ³•ä»‹ç»](https://www.jianshu.com/p/96058bf1ecc2)
+ [Clangç¼–è¯‘æ­¥éª¤åŠå‘½ä»¤æ¢³ç†](https://bbs.huaweicloud.com/blogs/314686?utm_source=zhihu&utm_medium=bbs-ex&utm_campaign=paas&utm_content=content)
+ [è°è¯´ä¸èƒ½ä¸é¾™ä¸€èµ·è·³èˆï¼šClang / LLVM (1)](https://zhuanlan.zhihu.com/p/21889573)
+ [LLVMåŸºæœ¬æ¦‚å¿µå…¥é—¨](https://zhuanlan.zhihu.com/p/140462815)
+ [clang æºç å¯¼è¯»ï¼ˆ2ï¼‰: clang driver æµç¨‹ç®€ä»‹](https://cloud.tencent.com/developer/article/1803206)
+ [GNU GCCä½¿ç”¨ldé“¾æ¥å™¨è¿›è¡Œé“¾æ¥çš„å®Œæ•´è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ](https://www.zhihu.com/question/27386057)
+ [clang driver](https://www.jianshu.com/p/e816e0209827)
