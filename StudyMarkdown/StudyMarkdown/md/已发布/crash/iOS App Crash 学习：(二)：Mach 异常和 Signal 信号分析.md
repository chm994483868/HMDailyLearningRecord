# iOS App Crash å­¦ä¹ ï¼š(äºŒ)ï¼šMach å¼‚å¸¸å’Œ Signal ä¿¡å·åˆ†æ

&emsp;Objective-C å¼‚å¸¸æ˜¯åº”ç”¨å±‚é¢çš„å¼‚å¸¸ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `@try` `@catch`ï¼ˆæ•è·ï¼‰æˆ– `NSSetUncaughtExceptionHandler`ï¼ˆè®°å½•ï¼‰å‡½æ•°æ¥æ•è·æˆ–è®°å½•å¼‚å¸¸ï¼ˆå¤„ç†å¼‚å¸¸ï¼‰ï¼Œè¿™é‡Œä¹‹æ‰€ä»¥è¯´ Objective-C å¼‚å¸¸æ˜¯åº”ç”¨å±‚é¢çš„å¼‚å¸¸æ˜¯å› ä¸ºå½“å‘ç”Ÿ Objective-C å¼‚å¸¸æ—¶å°±ä»…æ˜¯ä¸€ä¸ª NSException å¯¹è±¡è¢« raise/@throw ä»…ä»…åœ¨æœªæ•è·å¤„ç†æ­¤ NSException å¯¹è±¡çš„æƒ…å†µä¸‹æœ€ç»ˆæ‰ä¼šå¯¼è‡´è¿›ç¨‹ä¸­æ­¢ï¼Œä¸”æœ€ç»ˆè¿›ç¨‹ä¸­æ­¢çš„è¿‡ç¨‹æ˜¯ç³»ç»Ÿè°ƒç”¨äº† abort å‡½æ•°ï¼Œabort å†…éƒ¨è°ƒç”¨äº† (void)pthread_kill(pthread_self(), SIGABRT) å‘å½“å‰çº¿ç¨‹å‘é€äº† SIGABRT ä¿¡å·å¯¼è‡´äº†è¿›ç¨‹ä¸­æ­¢ã€‚Objective-C å¼‚å¸¸ä¹‹å¤–çš„ä¾‹å¦‚å¯¹å†…å­˜è®¿é—®é”™è¯¯ã€é‡å¤é‡Šæ”¾ç­‰é”™è¯¯å¼•èµ·çš„ Mach å¼‚å¸¸éœ€è¦é€šè¿‡å…¶ä»–æ–¹å¼è¿›è¡Œå¤„ç†ï¼ˆå¦‚é‡æŒ‡é’ˆè®¿é—®ã€MRC ä¸‹é‡å¤ release ç­‰ä¼šé€ æˆ EXC_BAD_ACCESS ç±»å‹çš„ Mach å¼‚å¸¸å¯¼è‡´è¿›ç¨‹ä¸­æ­¢ï¼‰ï¼Œæœ¬ç¯‡æˆ‘ä»¬ä¾¿å¼€å§‹å­¦ä¹  Mach å¼‚å¸¸å¤„ç†å’Œ signal ä¿¡å·å¤„ç†ã€‚

&emsp;NSException æ˜¯åº”ç”¨å±‚é¢çš„å¼‚å¸¸ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ Objective-C å¼‚å¸¸ï¼Œå®ƒä¸å…¶ä»–ä¸¤è€…çš„æœ€å¤§åŒºåˆ«å°±æ˜¯ Mach å¼‚å¸¸ä¸ Unix ä¿¡å·æ˜¯ç¡¬ä»¶å±‚é¢çš„å¼‚å¸¸ï¼ŒNSException æ˜¯è½¯ä»¶å±‚é¢çš„å¼‚å¸¸ï¼Œä¸”å®ƒä»¬ä¸‰è€…ä¸­ä¸¤è€…æœ‰ä¸€äº›è½¬åŒ–å…³ç³»ã€‚

&emsp;


+ å½“å‘ç”Ÿ Objective-C å¼‚å¸¸ï¼Œä¸”ä¸è¿›è¡Œæ•è·æ—¶ï¼Œæœ€ç»ˆç¨‹åºä¼šå› å½“å‰çº¿ç¨‹æ”¶åˆ° `SIGABRT` ä¿¡å·è€Œç»ˆæ­¢ï¼Œæ­¤æ—¶æˆ‘ä»¬åªèƒ½ä½¿ç”¨ try catch æˆ– NSSetUncaughtExceptionHandler æ¥è®°å½•å¤„ç†ï¼Œæœ€ç»ˆæŠ›å‡ºçš„ `SIGABRT` ä¿¡å·ï¼Œæˆ‘ä»¬ä½¿ç”¨ `signal(SIGABRT, SignalHandler);` å¹¶ä¸èƒ½æ”¶åˆ°å›è°ƒã€‚ï¼ˆNSException -> Signalï¼‰
+ Mach å¼‚å¸¸åŸºæœ¬éƒ½ä¼šè½¬æ¢æˆ Signalï¼Œä½†æ˜¯æœ‰äº›æƒ…å†µä¸‹ï¼ŒMach è¿˜æ²¡è½¬æ¢æˆ Signalï¼Œç¨‹åºå°±å·²ç»è¢«æ€æ­»äº†ï¼ˆå¦‚æ­»å¾ªç¯å¯¼è‡´çš„å†…å­˜æº¢å‡ºï¼‰ï¼Œè¿™æ—¶å€™å°±æ— æ³•æ•è· Signal äº†ã€‚ï¼ˆMach -> Signalï¼‰
+ æœ‰äº›å¼‚å¸¸ä¸ä¼šç»è¿‡ Mach Exceptionï¼Œä¹Ÿä¸ä¼šè¢« NSException æ•è·ï¼Œåªèƒ½é€šè¿‡ Signal æ•è·ï¼ŒåŸå› æ˜¯åº•å±‚ç›´æ¥è°ƒç”¨äº† `__pthread_kill` å‡½æ•°ç›´æ¥å‘æŸæ¡çº¿ç¨‹å‘é€äº† Signalã€‚


â¬‡ï¸â¬‡ï¸â¬‡ï¸â¬‡ï¸â¬‡ï¸â¬‡ï¸ è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š ï¼ˆå¦‚é‡æŒ‡é’ˆè®¿é—®ã€MRC ä¸‹é‡å¤ release ç­‰ï¼‰ è¿™é‡Œæ˜¯å•çº¯çš„ Mach å¼‚å¸¸ï¼ˆæ­£å¸¸æƒ…å†µä¸‹éƒ½ä¼šè½¬åŒ–ä¸º signal ä¿¡å·ï¼Œä½†æ˜¯æ¯”å¦‚æ”¶é›†åˆ° Mach å¼‚å¸¸åï¼Œç›´æ¥è°ƒç”¨äº† `exit()` å‡½æ•°å°±ä¼šå¯¼è‡´ç¨‹åºç»ˆæ­¢è€Œæ²¡æœ‰äº§ç”Ÿå¯¹åº”çš„ signal ä¿¡å·ï¼‰ï¼Œè¿˜æ˜¯ Mach å¼‚å¸¸åä¼šå‘é€ signal ä¿¡å·ï¼Œåé¢è¦éªŒè¯ä¸€ä¸‹ï¼š

è¿™ç§é”™è¯¯æŠ›å‡ºçš„æ˜¯ `signal`ï¼Œæ‰€ä»¥éœ€è¦ä¸“é—¨åš `signal` å¤„ç†ï¼‰ä¸èƒ½å¾—åˆ° signalï¼Œå¦‚æœè¦å¤„ç† signal éœ€è¦åˆ©ç”¨ unix æ ‡å‡†çš„ signal æœºåˆ¶ï¼Œæ³¨å†Œ `SIGABRT`ã€`SIGBUS`ã€`SIGSEGV` ç­‰ signal å‘ç”Ÿæ—¶çš„å¤„ç†å‡½æ•°ã€‚

&emsp;ä¾‹å¦‚æˆ‘ä»¬ç¼–å†™å¦‚ä¸‹ä»£ç ï¼Œç„¶åç›´æ¥è¿è¡Œï¼Œç¨‹åºä¼šç›´æ¥ crash ä¸­æ­¢è¿è¡Œï¼Œç„¶å `NSLog(@"âœ³ï¸âœ³ï¸âœ³ï¸ objc: %@", objc);` è¡Œæ˜¾ç¤ºçº¢è‰²çš„é”™è¯¯ä¿¡æ¯ï¼š`Thread 1: EXC_BAD_ACCESS (code=1, address=0x3402e8d4c25c)` (objc å¯¹è±¡å·²ç»è¢«é‡Šæ”¾ï¼Œç„¶å NSLog è¯­å¥ä¸­åˆå»è®¿é—® objc å·²ç»è¢«é‡Šæ”¾çš„å†…å­˜ï¼Œé€ æˆé‡æŒ‡é’ˆè®¿é—®) æŒ‡å‡ºæˆ‘ä»¬çš„ç¨‹åºæ­¤æ—¶æœ‰ä¸€ä¸ª `EXC_BAD_ACCESS` å¼‚å¸¸ï¼Œå¯¼è‡´é€€å‡ºï¼Œä¸”æ­¤æ—¶å¯å‘ç°æˆ‘ä»¬é€šè¿‡ `NSSetUncaughtExceptionHandler` è®¾ç½®çš„ **æœªæ•è·å¼‚å¸¸å¤„ç†å‡½æ•°** åœ¨ç¨‹åºä¸­æ­¢ä¹‹å‰å¹¶æ²¡æœ‰å¾—åˆ°æ‰§è¡Œï¼ 

```c++
__unsafe_unretained NSObject *objc = [[NSObject alloc] init];
NSLog(@"âœ³ï¸âœ³ï¸âœ³ï¸ objc: %@", objc);
```

&emsp;åœ¨æµ‹è¯•é™¤é›¶æ“ä½œæ—¶ï¼ˆæˆ‘ä»¬éƒ½çŸ¥é“ 0 ä¸èƒ½åšé™¤æ•°ğŸ˜‚ï¼‰å¦‚ä¸‹ç¤ºä¾‹ä»£ç ï¼Œå‘ç°è¿è¡Œç»“æœä¸ Build Settings çš„ Optimization Level çš„é€‰é¡¹å€¼æœ‰å…³ç³»ï¼Œå½“æˆ‘ä»¬é€‰æ‹© None[-O0] æ—¶ä¼š crashï¼ŒæŠ¥å‡ºï¼š`Thread 1: EXC_ARITHMETIC (code=EXC_I386_DIV, subcode=0x0)` é”™è¯¯ï¼Œè€Œåœ¨å…¶ä»–ä»»æ„ Fast[-O, O1]ã€Faster[-O2]ã€Fastest[-O3]ã€Fastest,Smallest[-Os]ã€Fastest,Aggressive Optimizations[-Ofast]ã€Smallest,Aggressive Size Optimizations[-Oz] é€‰é¡¹ä¸‹ç¨‹åºéƒ½æ­£å¸¸è¿è¡Œæ²¡æœ‰ crash é€€å‡ºï¼Œä¸”æ¯æ¬¡è¿è¡Œ result çš„å€¼éƒ½æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„éšæœºæ•°ã€‚

```c++
int a = 0;
int b = 1;
int result = b / a;
NSLog(@"ğŸµğŸµğŸµ %d", result);
```

&emsp;é’ˆå¯¹ä¸Šè¿°ä¸¤æ®µä»£ç å¯¼è‡´çš„ crashï¼Œæˆ‘ä»¬åœ¨ç¨‹åºé€€å‡ºååœ¨ xcode åº•éƒ¨çš„è°ƒè¯•æ§åˆ¶å°è¾“å…¥ bt æŒ‡ä»¤å¹¶å›è½¦ï¼Œå¯çœ‹åˆ°ç¨‹åºåœæ­¢è¿è¡Œçš„åŸå› åˆ†åˆ«å¦‚ä¸‹ï¼š`EXC_ARITHMETIC`ã€`EXC_BAD_ACCESS`ã€`signal SIGABRT`ã€‚ è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå°ç»†èŠ‚ï¼Œå°±æ˜¯ç¨‹åºé€€å‡ºå¤§æ¦‚æ˜¯æŸæ¡çº¿ç¨‹çš„é€€å‡ºï¼Œå¯ä»¥æ˜¯ä¸»çº¿ç¨‹ä¹Ÿå¯æ˜¯æŸæ¡å­çº¿ç¨‹ï¼Œå½“æˆ‘ä»¬æŠŠä¸Šè¿°ä»£ç æ”¾åœ¨ä¸€æ¡å­çº¿ç¨‹æ‰§è¡Œçš„è¯ï¼Œä¾¿ä¼šçœ‹åˆ°æ§åˆ¶å°è¾“å‡ºä¸­æœ€åä¸€æ¡æ˜¯å­çº¿ç¨‹çš„åœæ­¢åŸå› ã€‚

&emsp;é™¤é›¶æ“ä½œï¼ˆEXC_ARITHMETICï¼‰ï¼š

```c++
// å½“å‰åœ¨ä¸»çº¿ç¨‹ crash
(lldb) bt
* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_ARITHMETIC (code=EXC_I386_DIV, subcode=0x0)
  * frame #0: 0x0000000102d06daf dSYMDemo`-[AppDelegate application:didFinishLaunchingWithOptions:](self=0x0000600002bb82c0, _cmd="application:didFinishLaunchingWithOptions:", application=0x00007fe1dbc06f50, launchOptions=0x0000000000000000) at AppDelegate.m:59:20
  ...
  
// å½“å‰åœ¨å­çº¿ç¨‹ crash
(lldb) bt all
  thread #1, queue = 'com.apple.main-thread'
    frame #0: 0x00007fff203b69a4 CoreFoundation`__CFStringHash + 151
    ...
    
* thread #8, queue = 'com.apple.root.default-qos', stop reason = EXC_ARITHMETIC (code=EXC_I386_DIV, subcode=0x0)
  * frame #0: 0x00000001029a0daf dSYMDemo`__57-[AppDelegate application:didFinishLaunchingWithOptions:]_block_invoke(.block_descriptor=0x00000001029a6048) at AppDelegate.m:60:24
  ...
```

&emsp;é‡æŒ‡é’ˆè®¿é—®ï¼ˆEXC_BAD_ACCESSï¼‰ï¼š

```c++
// å½“å‰åœ¨ä¸»çº¿ç¨‹ crash
(lldb) bt
* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x539e0d66c11c)
    frame #0: 0x00007fff20190d18 libobjc.A.dylib`objc_opt_respondsToSelector + 16
    ...

// å½“å‰åœ¨å­çº¿ç¨‹ crash
thread #1, queue = 'com.apple.main-thread'
  frame #0: 0x00007fff2468f57e UIKitCore`+[_UIBackgroundTaskInfo backgroundTaskAssertionQueue]
  ...
  
* thread #4, queue = 'com.apple.root.default-qos', stop reason = EXC_BAD_ACCESS (code=1, address=0xbc637211426c)
    frame #0: 0x00007fff20190d18 libobjc.A.dylib`objc_opt_respondsToSelector + 16
    ...
```

&emsp;é™„åŠ ä¸€ä¸ªæ•°ç»„è¶Šç•Œçš„ crash ä½œä¸ºå¯¹æ¯”ï¼ˆå®ƒæœ€ç»ˆæ˜¯ `abort` å‡½æ•°è°ƒç”¨ `pthread_kill` å‘é€äº†ä¸€ä¸ª `SIGABRT` ä¿¡å·åœæ­¢æŸæ¡çº¿ç¨‹åï¼Œè¿å¸¦ç¨‹åºä¸­æ­¢ï¼‰ï¼š

```c++
// å½“å‰åœ¨ä¸»çº¿ç¨‹ crash
(lldb) bt 
* thread #1, queue = 'com.apple.main-thread', stop reason = signal SIGABRT
    frame #0: 0x00007fff61131462 libsystem_kernel.dylib`__pthread_kill + 10
    frame #1: 0x00007fff6116a610 libsystem_pthread.dylib`pthread_kill + 263
    frame #2: 0x00007fff200fab94 libsystem_c.dylib`abort + 120
    ...

// å½“å‰åœ¨å­çº¿ç¨‹ crash
(lldb) bt all
  thread #1, queue = 'com.apple.main-thread'
    frame #0: 0x00007fff204318a9 CoreFoundation`-[NSSet anyObject]
    ...

* thread #5, queue = 'com.apple.root.default-qos', stop reason = signal SIGABRT
  * frame #0: 0x00007fff61131462 libsystem_kernel.dylib`__pthread_kill + 10
    frame #1: 0x00007fff6116a610 libsystem_pthread.dylib`pthread_kill + 263
    frame #2: 0x00007fff200fab94 libsystem_c.dylib`abort + 120
    ...
```

&emsp;Objective-C çš„å¼‚å¸¸å¦‚æœä¸åšä»»ä½•å¤„ç†çš„è¯ï¼ˆtry catch æ•è·å¤„ç†ï¼‰ï¼Œæœ€ç»ˆä¾¿ä¼šè§¦å‘ç¨‹åºä¸­æ­¢é€€å‡ºï¼Œæ­¤æ—¶é€ æˆé€€å‡ºçš„åŸå› æ˜¯ç¨‹åºå‘è‡ªèº«å‘é€äº† `SIGABRT` ä¿¡å·ã€‚ï¼ˆå¯¹äºæœªæ•è·çš„ Objective-C å¼‚å¸¸ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `NSSetUncaughtExceptionHandler` å‡½æ•°è®¾ç½® **æœªæ•è·å¼‚å¸¸å¤„ç†å‡½æ•°** åœ¨å…¶ä¸­è®°å½•å­˜å‚¨å¼‚å¸¸æ—¥å¿—ï¼Œç„¶ååœ¨ APP ä¸‹æ¬¡å¯åŠ¨æ—¶è¿›è¡Œä¸Šä¼ ï¼ˆ**æœªæ•è·å¼‚å¸¸å¤„ç†å‡½æ•°** å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œç¨‹åºä¹ŸåŒæ ·ä¼šè¢«ç»ˆæ­¢ï¼Œæ­¤æ—¶æ²¡æœ‰æœºä¼šç»™æˆ‘ä»¬è¿›è¡Œç½‘ç»œè¯·æ±‚ä¸Šä¼ æ•°æ®ï¼‰ï¼Œå¦‚æœå¼‚å¸¸æ—¥å¿—è®°å½•å¾—å½“ï¼Œç„¶åå†é…åˆä¸€äº›å¼‚å¸¸å‘ç”Ÿæ—¶ç”¨æˆ·çš„æ“ä½œè¡Œä¸ºæ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥åˆ†æå’Œè§£å†³å¤§éƒ¨åˆ†çš„å´©æºƒé—®é¢˜ã€‚ï¼‰

&emsp;ä¸Šç¯‡æˆ‘ä»¬å·²ç»åˆ†æè¿‡ Objective-C çš„å¼‚å¸¸æ•è·å¤„ç†ï¼Œä¸‹é¢æˆ‘ä»¬å¼€å§‹è¯¦ç»†å­¦ä¹  Mach å¼‚å¸¸å’Œ signal å¤„ç†ã€‚

```c++
#import "AppDelegate.h"
#import <execinfo.h>

void mySignalHandler(int signal) {
    NSMutableString *mstr = [[NSMutableString alloc] init];
    [mstr appendString:@"Stack:\n"];
    
    void *callstack[128];
    int frames = backtrace(callstack, 128);
    char ** strs = backtrace_symbols(callstack, frames);
    
    printf("ğŸµğŸµğŸµ char ** æ€ä¹ˆæ‰“å°ï¼š%p", strs);
    
//    kill(<#pid_t#>, <#int#>)
    
}

- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
    // Override point for customization after application launch.
    
    // ä¿¡å·é‡æˆªæ–­
    signal(SIGABRT, mySignalHandler);
    signal(SIGILL, mySignalHandler);
    signal(SIGSEGV, mySignalHandler);
    signal(SIGFPE, mySignalHandler);
    signal(SIGBUS, mySignalHandler);
    signal(SIGPIPE, mySignalHandler);
    
    return YES;
}
```

&emsp;SignalHandler ä¸è¦åœ¨ debug ç¯å¢ƒä¸‹æµ‹è¯•ã€‚å› ä¸ºç³»ç»Ÿçš„ debug ä¼šä¼˜å…ˆå»æ‹¦æˆªã€‚æˆ‘ä»¬è¦è¿è¡Œä¸€æ¬¡åï¼Œå…³é—­ debug çŠ¶æ€ã€‚åº”è¯¥ç›´æ¥åœ¨æ¨¡æ‹Ÿå™¨ä¸Šç‚¹å‡»æˆ‘ä»¬ build ä¸Šå»çš„ App å»è¿è¡Œã€‚è€Œ UncaughtExceptionHandler å¯ä»¥åœ¨è°ƒè¯•çŠ¶æ€ä¸‹æ•æ‰ã€‚




### Mach å¼‚å¸¸ 

&emsp;Machï¼ˆå¾®å†…æ ¸ï¼‰æ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹æœ‰ç‚¹å¤šï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬é¦–å…ˆç¨å¾®æ¢³ç†é“ºå«ä¸€ä¸‹ï¼Œå¤§æ¦‚ä¼šæ¶‰åŠåˆ°ï¼šBSDã€Machã€GUIã€NeXTSTEPã€macOSã€POSIXã€IPCã€system callã€Kernelã€å®å†…æ ¸ã€å¾®å†…æ ¸ã€æ··åˆå†…æ ¸ã€XNUã€Darwin ç­‰ä»¥åŠä»–ä»¬ä¹‹é—´çš„ä¸€äº›è”ç³»æˆ–è€…å…³ç³»ã€‚

&emsp;ä¸‹é¢æˆ‘ä»¬å¯¹ç»´åŸºç™¾ç§‘ä¸­å¯¹ä»¥ä¸Šåè¯çš„ä»‹ç»è¿›è¡Œæ‘˜å½•ï¼š

&emsp;[BSD](https://zh.wikipedia.org/wiki/BSD)ä¼¯å…‹åˆ©è½¯ä»¶åŒ…ï¼šBerkeley Software Distributionï¼Œç¼©å†™ï¼šBSDï¼Œä¹Ÿè¢«ç§°ä¸ºä¼¯å…‹åˆ© Unix æˆ– Berkeley Unixï¼Œæ˜¯ä¸€ä¸ªæ´¾ç”Ÿè‡ª Unixï¼ˆç±» Unixï¼‰çš„æ“ä½œç³»ç»Ÿï¼Œ1970 å¹´ä»£ç”±ä¼¯å…‹åˆ©åŠ å·å¤§å­¦çš„å­¦ç”Ÿæ¯”å°”Â·ä¹”ä¼Šå¼€åˆ›ï¼Œä¹Ÿè¢«ç”¨æ¥ä»£è¡¨å…¶æ´¾ç”Ÿå‡ºçš„å„ç§åŒ…ã€‚

&emsp;[Mach](https://zh.wikipedia.org/wiki/Mach)ï¼ˆå›½é™…å‘éŸ³ï¼š[mÊŒk]ï¼‰æ˜¯ä¸€ä¸ªç”±å¡å†…åŸºæ¢…éš†å¤§å­¦å¼€å‘çš„è®¡ç®—æœºæ“ä½œç³»ç»Ÿå¾®å†…æ ¸ï¼ŒMach å¼€å‘é¡¹ç›®åœ¨å¡å†…åŸºæ¢…éš†å¤§å­¦ä» 1985 å¹´è¿è¡Œåˆ° 1994 å¹´ï¼Œåˆ° Mach 3.0 ç‰ˆç»“æŸï¼Œå…¶ä»–è¿˜æœ‰è®¸å¤šäººç»§ç»­ Mach çš„ç ”ç©¶ã€‚Mach çš„å¼€å‘æ˜¯ä¸ºäº†å–ä»£ BSD çš„ UNIX æ ¸å¿ƒï¼Œæ‰€ä»¥æ˜¯è®¸å¤šæ–°çš„æ“ä½œç³»ç»Ÿçš„è®¾è®¡åŸºç¡€ã€‚Mach çš„ç ”ç©¶è‡³ä»Šä¼¼ä¹æ˜¯åœæ­¢äº†ï¼Œè™½ç„¶æœ‰è®¸å¤šå•†ä¸šåŒ–æ“ä½œç³»ç»Ÿï¼Œå¦‚ NEXTSTEP ä¸ OPENSTEPï¼Œç‰¹åˆ«æ˜¯ Mac OS Xï¼ˆä½¿ç”¨ XNU æ ¸å¿ƒï¼‰éƒ½æ˜¯ä½¿ç”¨ Mach æˆ–å…¶æ´¾ç”Ÿç³»ç»Ÿã€‚

&emsp;[GUI](https://zh.wikipedia.org/wiki/å›¾å½¢ç”¨æˆ·ç•Œé¢) å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼šGraphical User Interfaceï¼Œç¼©å†™ï¼šGUIï¼Œæ˜¯æŒ‡é‡‡ç”¨å›¾å½¢æ–¹å¼æ˜¾ç¤ºçš„è®¡ç®—æœºæ“ä½œç”¨æˆ·ç•Œé¢ã€‚ä¸æ—©æœŸè®¡ç®—æœºä½¿ç”¨çš„å‘½ä»¤è¡Œç•Œé¢ç›¸æ¯”ï¼Œé™¤äº†é™ä½ç”¨æˆ·çš„æ“ä½œè´Ÿæ‹…ä¹‹å¤–ï¼Œå¯¹äºæ–°ç”¨æˆ·è€Œè¨€ï¼Œå›¾å½¢ç•Œé¢å¯¹äºç”¨æˆ·æ¥è¯´åœ¨è§†è§‰ä¸Šæ›´æ˜“äºæ¥å—ï¼Œå­¦ä¹ æˆæœ¬å¤§å¹…ä¸‹é™ï¼Œä¹Ÿè®©ç”µè„‘çš„å¤§ä¼—åŒ–å¾—ä»¥å®ç°ã€‚

&emsp;[NeXTSTEP](https://zh.wikipedia.org/wiki/NeXTSTEP)ï¼ˆåˆå†™ä½œ NeXTstepã€NeXTStepã€NEXTSTEP)æ˜¯ç”± NeXT.Inc æ‰€å¼€å‘çš„æ“ä½œç³»ç»Ÿã€‚NeXT æ˜¯ä¹”å¸ƒæ–¯åœ¨ 1985 å¹´ç¦»å¼€è‹¹æœå…¬å¸åæ‰€åˆ›ç«‹çš„å…¬å¸ã€‚è¿™å¥—ç³»ç»Ÿæ˜¯ä»¥ Mach å’Œ BSD ä¸ºåŸºç¡€ï¼Œä»¥ Objective-C ä½œä¸ºåŸç”Ÿè¯­è¨€ï¼Œå…·æœ‰å¾ˆå…ˆè¿›çš„ GUIã€‚1.0 ç‰ˆæ¨å‡ºæ—¶é—´æ˜¯åœ¨ 1989 å¹´ 9 æœˆ 18 æ—¥ã€‚åæ¥è‹¹æœç”µè„‘åœ¨ 1997 å¹´ 2 æœˆå°† NeXT ä¹°ä¸‹ï¼Œæˆä¸º Mac OS X çš„åŸºç¡€ã€‚

&emsp;[macOS](https://zh.wikipedia.org/wiki/MacOS)/ËŒmÃ¦kÊ”oÊŠËˆÉ›s/ æ˜¯è‹¹æœå…¬å¸æ¨å‡ºçš„åŸºäº GUI çš„æ“ä½œç³»ç»Ÿï¼Œä¸ºéº¦é‡‘å¡”ï¼ˆMacintoshï¼Œç®€ç§° Macï¼‰ç³»åˆ—ç”µè„‘çš„ä¸»æ“ä½œç³»ç»Ÿã€‚Classic Mac OSï¼ˆæ“ä½œç³»ç»Ÿï¼Œç®€ç§° Mac OSï¼Œæ³¨æ„è¿™é‡Œæ˜¯æ²¡æœ‰ X çš„ï¼‰æ‰€æŒ‡çš„æ˜¯è‹¹æœå…¬å¸ä» 1984 å¹´è‡³ 2001 å¹´é—´ä¸ºéº¦é‡‘å¡”ç³»åˆ—ç”µè„‘æ‰€å¼€å‘çš„ä¸€ç³»åˆ—æ“ä½œç³»ç»Ÿï¼Œå§‹äº System 1ï¼Œç»ˆç»“äº Mac OS 9ï¼Œ1997 å¹´ï¼Œå²è’‚å¤«Â·ä¹”å¸ƒæ–¯é‡å›è‹¹æœå…¬å¸ï¼Œç»è¿‡ä¸ºæœŸå››å¹´çš„å¼€å‘ï¼Œè‹¹æœå…¬å¸äº 2001 å¹´ä»¥æ–°çš„æ“ä½œç³»ç»Ÿ Mac OS X å–ä»£äº† Classic Mac OSã€‚å®ƒä¿ç•™äº† Classic Mac OS çš„å¤§éƒ¨åˆ† GUI è®¾è®¡å…ƒç´ ï¼Œå¹¶ä¸”åº”ç”¨ç¨‹åºæ¡†æ¶ä¸ºäº†å…¼å®¹æ€§è€Œå­˜åœ¨ç€ä¸€äº›é‡å ï¼Œä½†è¿™ä¸¤ä¸ªæ“ä½œç³»ç»Ÿçš„èµ·æºå’Œç»“æ„ä»¥åŠåº•å±‚ä»£ç å®Œå…¨ä¸åŒã€‚ç®€å•æ¥è¯´ï¼ŒMac OS X å®ƒæ˜¯ Mac OS ç‰ˆæœ¬ 10 çš„åˆ†æ”¯ï¼Œç„¶è€Œå®ƒä¸æ—©æœŸå‘è¡Œçš„ Mac OS ç›¸æ¯”ï¼Œåœ¨ Mac OS çš„å†å²ä¸Šæ˜¯å½»åº•èµ°å‘ç‹¬ç«‹å‘å±•çš„ã€‚è‡ª 2001 å¹´æ¨å‡ºèµ·ï¼ŒMac OS X è¿™ä¸ªåå­—éšç€æ—¶é—´çš„æ¨ç§»ä¹Ÿå‘ç”Ÿäº†ä¸€äº›å˜åŒ–ï¼Œ2001 å¹´è‡³ 2011 å¹´é—´ç§°ä½œ Mac OS Xï¼Œ2012 å¹´è‡³ 2015 å¹´ç§° OS Xï¼Œ2016 å¹´ 6 æœˆï¼Œè‹¹æœå…¬å¸å®£å¸ƒ OS X æ›´åä¸º macOSï¼Œä»¥ä¾¿ä¸è‹¹æœå…¶ä»–æ“ä½œç³»ç»Ÿ iOSã€watchOS å’Œ tvOS ä¿æŒç»Ÿä¸€çš„å‘½åé£æ ¼ã€‚

&emsp;[POSIX](https://zh.wikipedia.org/wiki/å¯ç§»æ¤æ“ä½œç³»ç»Ÿæ¥å£) å¯ç§»æ¤æ“ä½œç³»ç»Ÿæ¥å£ï¼šPortable Operating System Interfaceï¼Œç¼©å†™ï¼šPOSIXï¼Œæ˜¯ IEEEï¼ˆç”µæ°”ç”µå­å·¥ç¨‹å¸ˆå­¦ä¼šï¼‰ä¸ºè¦åœ¨å„ç§ UNIX æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œè½¯ä»¶ï¼Œè€Œå®šä¹‰ API çš„ä¸€ç³»åˆ—äº’ç›¸å…³è”çš„æ ‡å‡†çš„æ€»ç§°ï¼Œå…¶æ­£å¼ç§°å‘¼ä¸º IEEE Std 1003ï¼Œè€Œå›½é™…æ ‡å‡†åç§°ä¸º ISO/IEC 9945ã€‚æ­¤æ ‡å‡†æºäºä¸€ä¸ªå¤§çº¦å¼€å§‹äº 1985 å¹´çš„é¡¹ç›®ã€‚POSIX è¿™ä¸ªåç§°æ˜¯ç”±ç†æŸ¥å¾·Â·æ–¯æ‰˜æ›¼ï¼ˆRMSï¼‰åº” IEEE çš„è¦æ±‚è€Œæè®®çš„ä¸€ä¸ªæ˜“äºè®°å¿†çš„åç§°ã€‚å®ƒåŸºæœ¬ä¸Šæ˜¯ Portable Operating System Interfaceï¼ˆå¯ç§»æ¤æ“ä½œç³»ç»Ÿæ¥å£ï¼‰çš„ç¼©å†™ï¼Œè€Œæœ€åä¸€ä¸ªå­—æ¯ X åˆ™è¡¨æ˜å…¶å¯¹ Unix API çš„ä¼ æ‰¿ã€‚

&emsp;Mac OS X æ˜¯ä¸å…ˆå‰çš„ Mac OS å½»åº•åœ°åˆ†ç¦»å¼€æ¥çš„ä¸€ä¸ªæ“ä½œç³»ç»Ÿï¼Œå®ƒçš„åº•å±‚ä»£ç ä¸å…ˆå‰ç‰ˆæœ¬å®Œå…¨ä¸åŒã€‚Mac OS X æ–°çš„æ ¸å¿ƒåä¸º Darwinï¼Œæ˜¯ä¸€å¥—å¼€æ”¾æºç ã€ç¬¦åˆ POSIX æ ‡å‡†çš„æ“ä½œç³»ç»Ÿï¼Œä¼´éšç€æ ‡å‡†çš„ Unix å‘½ä»¤è¡Œä¸å…¶å¼ºå¤§çš„åº”ç”¨å·¥å…·ã€‚macOS åŒ…å«ä¸¤ä¸ªä¸»è¦çš„éƒ¨åˆ†ï¼š

1. æ ¸å¿ƒï¼šåä¸º Darwinï¼Œæ˜¯ä»¥ BSD æºä»£ç å’Œ Mach å¾®æ ¸å¿ƒä¸ºåŸºç¡€ï¼Œç”±è‹¹æœå…¬å¸å’Œç‹¬ç«‹å¼€å‘è€…ç¤¾ç¾¤åˆä½œå¼€å‘
2. GUIï¼šç”±è‹¹æœå…¬å¸å¼€å‘ï¼Œåä¸º Aqua çš„ä¸“åˆ©çš„å›¾å½¢ç”¨æˆ·ç•Œé¢ã€‚ï¼ˆAqua æ˜¯ macOSï¼ˆæ—§ç§° Mac OS X å’Œ OS Xï¼‰çš„ GUI ä¹‹å•†æ ‡åç§°ï¼‰

&emsp;[IPC](https://zh.wikipedia.org/wiki/è¡Œç¨‹é–“é€šè¨Š) è¿›ç¨‹é—´é€šä¿¡ï¼šInter-Process Communicationï¼Œç¼©å†™ï¼šIPCï¼ŒæŒ‡è‡³å°‘ä¸¤ä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹é—´ä¼ é€æ•°æ®æˆ–ä¿¡å·çš„ä¸€äº›æŠ€æœ¯æˆ–æ–¹æ³•ã€‚IPC å¯¹**å¾®å†…æ ¸**å’Œ nano å†…æ ¸çš„è®¾è®¡è¿‡ç¨‹éå¸¸é‡è¦ã€‚ å¾®å†…æ ¸å‡å°‘äº†å†…æ ¸æä¾›çš„åŠŸèƒ½æ•°é‡ï¼Œç„¶åé€šè¿‡ IPC ä¸æœåŠ¡å™¨é€šä¿¡è·å¾—è¿™äº›åŠŸèƒ½ï¼Œä¸æ™®é€šçš„å®å†…æ ¸ç›¸æ¯”ï¼ŒIPC çš„æ•°é‡å¤§å¹…å¢åŠ ã€‚

&emsp;[ç³»ç»Ÿè°ƒç”¨](https://zh.wikipedia.org/wiki/ç³»ç»Ÿè°ƒç”¨) åœ¨ç”µè„‘ä¸­ï¼Œç³»ç»Ÿè°ƒç”¨ï¼ˆè‹±è¯­ï¼šsystem callï¼‰ï¼ŒæŒ‡è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´çš„ç¨‹åºå‘æ“ä½œç³»ç»Ÿå†…æ ¸è¯·æ±‚éœ€è¦æ›´é«˜æƒé™è¿è¡Œçš„æœåŠ¡ã€‚ç³»ç»Ÿè°ƒç”¨æä¾›ç”¨æˆ·ç¨‹åºä¸æ“ä½œç³»ç»Ÿä¹‹é—´çš„æ¥å£ã€‚å¤§å¤šæ•°ç³»ç»Ÿäº¤äº’å¼æ“ä½œéœ€æ±‚åœ¨å†…æ ¸æ€æ‰§è¡Œã€‚å¦‚è®¾å¤‡ IO æ“ä½œæˆ–è€…è¿›ç¨‹é—´é€šä¿¡ã€‚æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹ç©ºé—´å¯åˆ†ä¸ºç”¨æˆ·ç©ºé—´ï¼ˆç”¨æˆ·æ€ï¼‰å’Œå†…æ ¸ç©ºé—´ï¼ˆå†…æ ¸æ€ï¼‰ï¼Œå®ƒä»¬éœ€è¦ä¸åŒçš„æ‰§è¡Œæƒé™ï¼Œå…¶ä¸­ç³»ç»Ÿè°ƒç”¨è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ã€‚ç³»ç»Ÿè°ƒç”¨å’Œæ™®é€šåº“å‡½æ•°è°ƒç”¨éå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯ç³»ç»Ÿè°ƒç”¨ç”±æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›ï¼Œè¿è¡Œäºå†…æ ¸æ€ï¼Œè€Œæ™®é€šçš„åº“å‡½æ•°è°ƒç”¨ç”±å‡½æ•°åº“æˆ–ç”¨æˆ·è‡ªå·±æä¾›ï¼Œè¿è¡Œäºç”¨æˆ·æ€ã€‚ï¼ˆé€šè¿‡ä¸­æ–­å®ç°å†…æ ¸æ€å’Œç”¨æˆ·æ€çš„åˆ‡æ¢ï¼Œåç»­è¿˜éœ€è¦å­¦ä¹ ä¸€ä¸‹ã€‚ï¼‰

&emsp;[Kernel](https://zh.wikipedia.org/wiki/å†…æ ¸) å†…æ ¸/æ ¸å¿ƒï¼šKernelï¼Œåœ¨è®¡ç®—æœºç§‘å­¦ä¸­æ˜¯ä¸€ä¸ªç”¨æ¥**ç®¡ç†**è½¯ä»¶å‘å‡ºçš„èµ„æ–™ I/Oï¼ˆè¾“å…¥ä¸è¾“å‡ºï¼‰è¦æ±‚çš„ç”µè„‘ç¨‹åºï¼Œå°†è¿™äº›è¦æ±‚è½¬è¯‘ä¸ºèµ„æ–™å¤„ç†çš„æŒ‡ä»¤å¹¶äº¤ç”±ä¸­å¤®å¤„ç†å™¨ï¼ˆCPUï¼‰åŠç”µè„‘ä¸­å…¶ä»–ç”µå­ç»„ä»¶è¿›è¡Œå¤„ç†ï¼Œæ˜¯ç°ä»£æ“ä½œç³»ç»Ÿä¸­æœ€åŸºæœ¬çš„éƒ¨åˆ†ã€‚å®ƒæ˜¯ä¸ºä¼—å¤šåº”ç”¨ç¨‹åºæä¾›å¯¹è®¡ç®—æœºç¡¬ä»¶çš„å®‰å…¨è®¿é—®çš„ä¸€éƒ¨åˆ†è½¯ä»¶ï¼Œè¿™ç§è®¿é—®æ˜¯æœ‰é™çš„ï¼Œå¹¶ç”±å†…æ ¸å†³å®šä¸€ä¸ªç¨‹åºåœ¨ä»€ä¹ˆæ—¶å€™å¯¹æŸéƒ¨åˆ†ç¡¬ä»¶æ“ä½œå¤šé•¿æ—¶é—´ã€‚ç›´æ¥å¯¹ç¡¬ä»¶æ“ä½œæ˜¯éå¸¸å¤æ‚çš„ï¼Œæ‰€ä»¥å†…æ ¸é€šå¸¸æä¾›ä¸€ç§ç¡¬ä»¶æŠ½è±¡çš„æ–¹æ³•ï¼Œæ¥å®Œæˆè¿™äº›æ“ä½œã€‚æœ‰äº†è¿™ä¸ªï¼Œé€šè¿‡ **è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼ˆIPCï¼‰** åŠ **ç³»ç»Ÿè°ƒç”¨**ï¼Œåº”ç”¨è¿›ç¨‹å¯é—´æ¥æ§åˆ¶æ‰€éœ€çš„ç¡¬ä»¶èµ„æºï¼ˆç‰¹åˆ«æ˜¯å¤„ç†å™¨åŠ IO è®¾å¤‡ï¼‰ã€‚ï¼ˆå†…æ ¸å¤§æ¦‚å¯ç†è§£ä¸ºæä¾›äº†åº”ç”¨è¿›ç¨‹å’Œè®¡ç®—æœºç¡¬ä»¶ä¹‹é—´çš„æ¡¥æ¢ï¼‰

![æˆªå±2021-11-24 ä¸‹åˆ11.10.44.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e663e3c00bf842c4a203f79effbad3d5~tplv-k3u1fbpfcp-watermark.image?)

&emsp;ç”µè„‘è½¯ç¡¬ä¹‹é—´çš„æ¶æ„ä¸å…³ç³»å›¾ï¼Œå¯ä»¥çœ‹åˆ°å†…æ ¸è¿›è¡Œçš„æ˜¯åº”ç”¨è½¯ä»¶å’Œè®¡ç®—æœºç¡¬ä»¶çš„äº¤äº’å·¥ä½œã€‚

&emsp;å†…æ ¸åœ¨è®¾è®¡ä¸Šå¯ä»¥æ¦‚åˆ†ä¸ºå®å†…æ ¸ä¸å¾®å†…æ ¸ä¸¤å¤§æ¶æ„ã€‚åœ¨å®å†…æ ¸ä¸å¾®å†…æ ¸ä¹‹é—´ï¼Œè¿›è¡Œå¦¥åçš„è®¾è®¡ï¼Œè¿™ç§°ä¸ºæ··åˆå†…æ ¸ï¼Œä½†æ˜¯æ··åˆå†…æ ¸èƒ½å¦è¢«åˆ—ä¸ºç¬¬ä¸‰å¤§æ¶æ„ï¼Œç›®å‰ä»ç„¶æœ‰äº‰è®®ã€‚

&emsp;[å®å†…æ ¸](https://zh.wikipedia.org/wiki/æ•´å¡Šæ€§æ ¸å¿ƒ) å®å†…æ ¸ç»“æ„åœ¨ç¡¬ä»¶ä¹‹ä¸Šï¼Œå®šä¹‰äº†ä¸€ä¸ªé«˜é˜¶çš„æŠ½è±¡æ¥å£ï¼Œåº”ç”¨ä¸€ç»„åŸè¯­ï¼ˆæˆ–è€…å«ç³»ç»Ÿè°ƒç”¨ï¼ˆSystem callï¼‰ï¼‰æ¥å®ç°æ“ä½œç³»ç»Ÿçš„åŠŸèƒ½ï¼Œä¾‹å¦‚è¿›ç¨‹ç®¡ç†ï¼Œæ–‡ä»¶ç³»ç»Ÿï¼Œå’Œå­˜å‚¨ç®¡ç†ç­‰ç­‰ï¼Œè¿™äº›åŠŸèƒ½ç”±å¤šä¸ªè¿è¡Œåœ¨å†…æ ¸æ€çš„æ¨¡å—æ¥å®Œæˆã€‚å°½ç®¡æ¯ä¸€ä¸ªæ¨¡å—éƒ½æ˜¯å•ç‹¬åœ°æœåŠ¡è¿™äº›æ“ä½œï¼Œä½†æ˜¯å†…æ ¸ä»£ç æ˜¯é«˜åº¦é›†æˆçš„ï¼Œè€Œä¸”éš¾ä»¥ç¼–å†™æ­£ç¡®ã€‚å› ä¸ºæ‰€æœ‰çš„æ¨¡å—éƒ½åœ¨åŒä¸€ä¸ªå†…æ ¸ç©ºé—´ä¸Šè¿è¡Œï¼Œä¸€ä¸ªå¾ˆå°çš„ bug éƒ½ä¼šä½¿æ•´ä¸ªç³»ç»Ÿå´©æºƒã€‚ç„¶è€Œï¼Œå¦‚æœå¼€å‘é¡ºåˆ©ï¼Œå®å†…æ ¸ç»“æ„å°±å¯ä»¥ä»è¿è¡Œæ•ˆç‡ä¸Šå¾—åˆ°å¥½å¤„ã€‚å®å†…æ ¸ç»“æ„æ˜¯éå¸¸æœ‰å¸å¼•åŠ›çš„ä¸€ç§è®¾è®¡ï¼Œç”±äºåœ¨åŒä¸€ä¸ªåœ°å€ç©ºé—´ä¸Šå®ç°æ‰€æœ‰å¤æ‚çš„ä½é˜¶æ“ä½œç³»ç»Ÿæ§åˆ¶ä»£ç çš„æ•ˆç‡ä¼šæ¯”åœ¨ä¸åŒåœ°å€ç©ºé—´ä¸Šå®ç°æ›´é«˜äº›ã€‚

&emsp;[å¾®å†…æ ¸](https://zh.wikipedia.org/wiki/å¾®å…§æ ¸) å¾®å†…æ ¸ç»“æ„ç”±ä¸€ä¸ªéå¸¸ç®€å•çš„ç¡¬ä»¶æŠ½è±¡å±‚å’Œä¸€ç»„æ¯”è¾ƒå…³é”®çš„åŸè¯­æˆ–ç³»ç»Ÿè°ƒç”¨ç»„æˆï¼›è¿™äº›åŸè¯­ï¼Œä»…ä»…åŒ…æ‹¬äº†åˆ›å»ºä¸€ä¸ªç³»ç»Ÿå¿…éœ€çš„å‡ ä¸ªéƒ¨åˆ†ï¼›å¦‚çº¿ç¨‹ç®¡ç†ï¼Œåœ°å€ç©ºé—´å’Œè¿›ç¨‹é—´é€šä¿¡ç­‰ã€‚å¾®å†…æ ¸çš„ç›®æ ‡æ˜¯å°†ç³»ç»ŸæœåŠ¡çš„å®ç°å’Œç³»ç»Ÿçš„åŸºæœ¬æ“ä½œè§„åˆ™åˆ†ç¦»å¼€æ¥ã€‚ä¾‹å¦‚ï¼Œè¿›ç¨‹çš„è¾“å…¥/è¾“å‡ºé”å®šæœåŠ¡å¯ä»¥ç”±è¿è¡Œåœ¨å¾®æ ¸ä¹‹å¤–çš„ä¸€ä¸ªæœåŠ¡ç»„ä»¶æ¥æä¾›ã€‚è¿™äº›éå¸¸æ¨¡å—åŒ–çš„ç”¨æˆ·æ€æœåŠ¡å™¨ç”¨äºå®Œæˆæ“ä½œç³»ç»Ÿä¸­æ¯”è¾ƒé«˜çº§çš„æ“ä½œï¼Œè¿™æ ·çš„è®¾è®¡ä½¿å†…æ ¸ä¸­æœ€å†…æ ¸çš„éƒ¨åˆ†çš„è®¾è®¡æ›´ç®€å•ã€‚ä¸€ä¸ªæœåŠ¡ç»„ä»¶çš„å¤±æ•ˆå¹¶ä¸ä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿçš„å´©æºƒï¼Œå†…æ ¸éœ€è¦åšçš„ï¼Œä»…ä»…æ˜¯é‡æ–°å¯åŠ¨è¿™ä¸ªç»„ä»¶ï¼Œè€Œä¸å¿…å½±å“å…¶å®ƒçš„éƒ¨åˆ†ã€‚

&emsp;[æ··åˆå†…æ ¸](https://zh.wikipedia.org/wiki/æ··åˆæ ¸å¿ƒ) Hybrid kernelï¼Œåˆç§°ä¸ºæ··åˆå¼æ ¸å¿ƒã€æ··åˆå†…æ ¸ï¼Œæ˜¯æŒ‡ä¸€ç§æ“ä½œç³»ç»Ÿå†…æ ¸æ¶æ„ã€‚ä¼ ç»Ÿä¸Šçš„æ“ä½œç³»ç»Ÿå†…æ ¸å¯ä»¥åˆ†ä¸ºå®å†…æ ¸ï¼ˆMonolithic kernelï¼‰ä¸å¾®æ ¸å¿ƒï¼ˆMicro kernelï¼‰ä¸¤å¤§åŸºæœ¬æ¶æ„ï¼Œæ··åˆæ ¸å¿ƒç»“åˆäº†è¿™ä¸¤ç§æ ¸å¿ƒæ¶æ„ï¼Œæ··åˆæ ¸å¿ƒçš„åŸºæœ¬è®¾è®¡ç†å¿µï¼Œæ˜¯ä»¥å¾®æ ¸å¿ƒæ¶æ„æ¥è®¾è®¡æ“ä½œç³»ç»Ÿæ ¸å¿ƒï¼Œä½†åœ¨å®ç°ä¸Šåˆ™é‡‡ç”¨å®å†…æ ¸çš„åšæ³•ã€‚æ··åˆæ ¸å¿ƒå®è´¨ä¸Šæ˜¯å¾®æ ¸å¿ƒï¼Œåªä¸è¿‡å®ƒè®©ä¸€äº›å¾®æ ¸ç»“æ„æ‰§è¡Œåœ¨ç”¨æˆ·ç©ºé—´çš„ä»£ç æ‰§è¡Œåœ¨æ ¸å¿ƒç©ºé—´ï¼Œè¿™æ ·è®©æ ¸å¿ƒçš„æ‰§è¡Œæ•ˆç‡æ›´é«˜äº›ã€‚è¿™æ˜¯ä¸€ç§å¦¥ååšæ³•ï¼Œè®¾è®¡è€…å‚è€ƒäº†å¾®æ ¸å¿ƒç»“æ„çš„ç³»ç»Ÿæ‰§è¡Œé€Ÿåº¦ä¸ä½³çš„ç†è®ºã€‚

&emsp;[XNU](https://zh.wikipedia.org/wiki/XNU) XNU æ˜¯ä¸€ä¸ªç”±è‹¹æœç”µè„‘å¼€å‘ç”¨äº macOS æ“ä½œç³»ç»Ÿçš„æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚å®ƒæ˜¯ Darwin æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œè·Ÿéšç€ Darwin ä¸€åŒä½œä¸ºè‡ªç”±åŠå¼€æ”¾æºä»£ç è½¯ä»¶è¢«å‘å¸ƒã€‚å®ƒè¿˜æ˜¯ iOSã€tvOS å’Œ watchOS æ“ä½œç³»ç»Ÿçš„å†…æ ¸ã€‚XNU æ˜¯ X is Not Unix çš„ç¼©å†™ã€‚XNU æœ€æ—©æ˜¯ NeXT å…¬å¸ä¸ºäº† NeXTSTEP æ“ä½œç³»ç»Ÿè€Œå‘å±•çš„ã€‚å®ƒæ˜¯ä¸€ç§æ··åˆå¼æ ¸å¿ƒï¼ˆHybrid kernelï¼‰ï¼Œç»“åˆäº†ç”±å¡å†…åŸºç¾éš†å¤§å­¦å‘å±•çš„ Mach 2.5 ç‰ˆï¼Œ4.3 BSDï¼Œä¸ç§°ä¸º Driver Kit çš„é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡åº”ç”¨ç¨‹åºç•Œé¢ã€‚åœ¨è‹¹æœç”µè„‘æ”¶è´­ NeXT å…¬å¸ä¹‹åï¼ŒXNU çš„ Mach å¾®å†…æ ¸è¢«å‡çº§åˆ° Mach 3.0ï¼ŒBSD çš„éƒ¨åˆ†å‡çº§è‡³ FreeBSDï¼ŒDriver Kit åˆ™æ”¹æˆ I/O Kitï¼Œä¸€å¥—ä»¥ C++ æ’°å†™çš„åº”ç”¨ç¨‹åºç•Œé¢ã€‚XNU æ˜¯ä¸€ä¸ªæ··åˆå†…æ ¸ï¼Œå°†å®å†…æ ¸ä¸å¾®å†…æ ¸ä¸¤è€…çš„ç‰¹æ€§å…¼æ”¶å¹¶è“„ï¼Œä»¥æœŸåŒæ—¶æ‹¥æœ‰ä¸¤ç§å†…æ ¸çš„ä¼˜ç‚¹â€”â€”â€”â€”æ¯”å¦‚åœ¨å¾®å†…æ ¸ä¸­æé«˜æ“ä½œç³»ç»Ÿæ¨¡å—åŒ–ç¨‹åº¦ä»¥åŠè®©æ“ä½œç³»ç»Ÿæ›´å¤šçš„éƒ¨åˆ†æ¥å—å†…å­˜ä¿æŠ¤çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶ï¼Œå’Œå®å†…æ ¸åœ¨é«˜è´Ÿè·ä¸‹è¡¨ç°çš„é«˜æ€§èƒ½ã€‚åˆ° 2007 å¹´ä¸ºæ­¢ï¼ŒXNU æ”¯æŒå•æ ¸å’Œå…·æœ‰å¯¹ç§°å¤šå¤„ç†çš„ ARMï¼ŒIA-32 å’Œ x86-64 å¤„ç†å™¨ã€‚åœ¨ç¬¬ 10 ç‰ˆï¼ˆå³ Mac OS X 10.6ï¼‰ä¹‹åï¼Œä¸å†æ”¯æŒ PowerPCã€‚

&emsp;**XNU ä¸­çš„ Mach:** XNU å†…æ ¸ä»¥ä¸€ä¸ªè¢«æ·±åº¦å®šåˆ¶çš„ Mach 3.0 å†…æ ¸ä½œä¸ºåŸºç¡€ã€‚å¦‚æ­¤è¿™èˆ¬ï¼Œå®ƒä¾¿å¯ä»¥æŠŠæ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒéƒ¨åˆ†ä½œä¸ºç‹¬ç«‹çš„è¿›ç¨‹è¿è¡Œï¼Œç”±æ­¤å¸¦æ¥æå¤§çš„çµæ´»æ€§ï¼ˆMach æ ¸å¿ƒä¹‹ä¸Šå¯å¹³è¡Œè¿è¡Œå¤šä¸ªæ“ä½œç³»ç»Ÿï¼‰ã€‚ä½†æ˜¯å› ä¸º **å†…æ ¸æ€/ç”¨æˆ·æ€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢** ä¼šé¢å¤–æ¶ˆè€—æ—¶é—´ï¼ŒåŒæ—¶å†…æ ¸ä¸æœåŠ¡è¿›ç¨‹ä¹‹é—´çš„æ¶ˆæ¯ä¼ é€’ä¹Ÿä¼šé™ä½è¿è¡Œæ•ˆç‡ï¼Œæ‰€ä»¥è¿™ç§è®¾è®¡é€šå¸¸ä¼šé™ä½æ€§èƒ½ã€‚ä¸ºäº†æé«˜æ•ˆç‡ï¼Œåœ¨ Mac OS X ä¸­ BSD éƒ¨åˆ†ä¸ Mach ä¸€èµ·å†…å»ºäºæ ¸å¿ƒéƒ¨åˆ†ã€‚æ·±åº¦å®šåˆ¶çš„ â€œæ··åˆâ€ Mach 3.0 å†…æ ¸ä¸ä¼ ç»Ÿ BSD å†…æ ¸èšå˜ä¸€ä½“çš„äº§ç‰©å°±æ˜¯ä¸€ä¸ª â€œæ··åˆâ€ å†…æ ¸ï¼ŒåŒæ—¶å…·æœ‰ä¸¤è€…çš„ä¼˜ç‚¹ä¸ç¼ºç‚¹ã€‚

&emsp;[Darwin](https://zh.wikipedia.org/wiki/Darwin_(æ“ä½œç³»ç»Ÿ)) Darwin æ˜¯ç”±è‹¹æœå…¬å¸äº 2000 å¹´æ‰€å‘å¸ƒçš„ä¸€ä¸ªå¼€æ”¾æºä»£ç æ“ä½œç³»ç»Ÿï¼ˆ2003 å¹´ 7 æœˆï¼Œè‹¹æœåœ¨ APSLï¼ˆApple Public Source Licenseï¼‰çš„ 2.0 ç‰ˆæœ¬ä¸‹å‘å¸ƒäº† Darwinï¼‰ã€‚Darwin æ˜¯ macOS å’Œ iOS æ“ä½œç¯å¢ƒçš„æ“ä½œç³»ç»Ÿéƒ¨åˆ†ã€‚Darwin æ˜¯ä¸€ç§ç±» Unix æ“ä½œç³»ç»Ÿï¼Œå®ƒçš„å†…æ ¸æ˜¯ XNUï¼ˆXNU æ˜¯æ··åˆå†…æ ¸è®¾è®¡ï¼Œä½¿å…¶å…·å¤‡äº†å¾®å†…æ ¸çš„çµæ´»æ€§å’Œå®å†…æ ¸çš„æ€§èƒ½ï¼‰ï¼Œå…¶ä»¥å¾®æ ¸å¿ƒä¸ºåŸºç¡€çš„æ ¸å¿ƒæ¶æ„æ¥å®ç° Machï¼Œè€Œæ“ä½œç³»ç»Ÿçš„æœåŠ¡å’Œç”¨æˆ·ç©ºé—´å·¥å…·åˆ™ä»¥ BSD ä¸ºåŸºç¡€ã€‚ç±»ä¼¼å…¶ä»–ç±» Unix æ“ä½œç³»ç»Ÿï¼ŒDarwin ä¹Ÿæœ‰å¯¹ç§°å¤šå¤„ç†å™¨çš„ä¼˜ç‚¹ï¼Œé«˜æ€§èƒ½çš„ç½‘ç»œè®¾æ–½å’Œæ”¯æŒå¤šç§é›†æˆçš„æ–‡ä»¶ç³»ç»Ÿã€‚é›†æˆ Mach åˆ° XNU å†…æ ¸çš„å¥½å¤„æ˜¯å¯æºæ€§ï¼Œæˆ–è€…æ˜¯åœ¨ä¸åŒå½¢å¼çš„ç³»ç»Ÿä½¿ç”¨è½¯ä»¶çš„èƒ½åŠ›ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œä¸€ä¸ªæ“ä½œç³»ç»Ÿæ ¸å¿ƒé›†æˆäº† Mach å¾®æ ¸å¿ƒï¼Œèƒ½å¤Ÿæä¾›å¤šç§ä¸åŒ CPU æ¶æ„çš„äºŒè¿›åˆ¶æ ¼å¼åˆ°ä¸€ä¸ªå•ä¸€çš„æ–‡ä»¶ï¼ˆä¾‹å¦‚ x86 å’Œ PowerPCï¼‰ï¼Œè¿™æ˜¯å› ä¸ºå®ƒä½¿ç”¨äº† Mach-O çš„äºŒè¿›åˆ¶æ ¼å¼ã€‚ï¼ˆåˆ°è¿™é‡Œå°±å’Œæˆ‘ä»¬ä¹‹å‰å­¦ä¹  Mach-O çš„çŸ¥è¯†ç‚¹è”ç³»èµ·æ¥äº†ï¼‰

&emsp;åœ¨ mac ç”µè„‘çš„å‘½ä»¤ç»ˆç«¯ä¸­æ‰§è¡Œ `uname -r` å‘½ä»¤å°†æ˜¾ç¤º Darwin ç‰ˆæœ¬å·ï¼Œæ‰§è¡Œ `uname -v` å‘½ä»¤å°†æ˜¾ç¤º XNU æ„å»ºç‰ˆæœ¬çš„å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…æ‹¬ Darwin çš„ç‰ˆæœ¬å·ï¼ˆuname åé¢å¯è·Ÿ -a -m -n -p -r -s -vï¼‰ã€‚æ‰§è¡Œ `system_profiler SPSoftwareDataType` å‘½ä»¤å°†æ˜¾ç¤º mac ç”µè„‘çš„ software ä¿¡æ¯ã€‚å¦‚ä¸‹è¾“å‡ºï¼š

```c++
âœ  ~ uname -r
21.1.0
âœ  ~ uname -v
Darwin Kernel Version 21.1.0: Wed Oct 13 17:33:23 PDT 2021; root:xnu-8019.41.5~1/RELEASE_X86_64
âœ  ~ 
```

```c++
âœ  ~ system_profiler SPSoftwareDataType
Software:

    System Software Overview:

      System Version: macOS 12.0.1 (21A559)
      Kernel Version: Darwin 21.1.0
      Boot Volume: Macintosh HD
      Boot Mode: Normal
      Computer Name: HMçš„MacBook Pro
      User Name: HM C (hmc)
      Secure Virtual Memory: Enabled
      System Integrity Protection: Disabled
      Time since boot: 2:25

âœ  ~ 
```

&emsp;çœ‹åˆ°è¿™é‡Œçš„è¯æˆ‘ä»¬å¤§æ¦‚å°±å¯ä»¥å¯¹ Mach çš„ä½ç½®è¿›è¡Œä¸€ä¸ªæ€»ç»“äº†ï¼šDarwin æ˜¯ macOS å’Œ iOS æ“ä½œç¯å¢ƒçš„æ“ä½œç³»ç»Ÿéƒ¨åˆ†ï¼Œå®ƒçš„å†…æ ¸æ˜¯ XNUï¼ŒXNU æ˜¯æ··åˆå†…æ ¸è®¾è®¡ï¼Œä½¿å…¶å…·å¤‡äº†å¾®å†…æ ¸çš„çµæ´»æ€§å’Œå®å†…æ ¸çš„æ€§èƒ½ï¼Œè€Œ XNU å†…æ ¸çš„å¾®å†…æ ¸éƒ¨åˆ†ä¾¿æ˜¯ä¸€ä¸ªè¢«æ·±åº¦å®šåˆ¶çš„ Mach 3.0 å†…æ ¸ï¼Œæ‰€ä»¥çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬ä¾¿å¯ç†è§£é‚£å¥ **Mach å¼‚å¸¸ä¸ºæœ€åº•å±‚çš„å†…æ ¸çº§å¼‚å¸¸**ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ [xnu ç‰ˆæœ¬åˆ—è¡¨](https://opensource.apple.com/tarballs/xnu/) ä¸‹è½½æœ€æ–°çš„ XNU å†…æ ¸æºç ï¼ŒMach å¼‚å¸¸çš„ç±»å‹ä¾¿è¢«å®šä¹‰åœ¨ xnu-7195.141.2/osfmk/mach/exception_types.h ä¸­ï¼š

> &emsp;å¼‚å¸¸é¦–å…ˆæœ‰å¤„ç†å™¨é™·é˜±å¼•å‘ï¼Œç„¶å Mach çš„å¼‚å¸¸å¤„ç†ç¨‹åº exception_triage() è´Ÿè´£å°†å¼‚å¸¸è½¬æ¢æˆ Mach æ¶ˆæ¯ã€‚exception_triage() å†…éƒ¨é€šè¿‡ exception_deliver() å°è¯•æŠŠå¼‚å¸¸ä¾æ¬¡æŠ•é€’åˆ°ä¸‰ä¸ªç«¯å£ï¼šthreadã€taskã€host(é»˜è®¤)ï¼Œå¦‚æœæ²¡æœ‰ä¸€ä¸ªç«¯å£è¿”å›ï¼Œä»»åŠ¡å³è¢«ç»ˆæ­¢ã€‚ï¼ˆè¿™ä¸ªè¿‡ç¨‹æš‚æ—¶å®Œå…¨ç†è§£ä¸äº†...ï¼‰

&emsp;ä¸‹é¢æˆ‘ä»¬åˆ—ä¸¾å‡ ä¸ªæ¯”è¾ƒå¸¸è§çš„ Mach å¼‚å¸¸ï¼š

```c++
/*
 *    Machine-independent exception definitions.
 */

/* Could not access memory. */
/* Code contains kern_return_t describing error. */
/* Subcode contains bad memory address. */
#define EXC_BAD_ACCESS          1       
```

&emsp;é€šå¸¸ç”±äºè®¿é—®äº†ä¸è¯¥è®¿é—®çš„å†…å­˜å¯¼è‡´ã€‚

```c++
/* Instruction failed */
/* Illegal or undefined instruction or operand */
#define EXC_BAD_INSTRUCTION     2       
```

&emsp;æ­¤ç±»å¼‚å¸¸é€šå¸¸ç”±äºçº¿ç¨‹æ‰§è¡Œéæ³•æŒ‡ä»¤å¯¼è‡´ã€‚

```c++
/* Arithmetic exception */
/* Exact nature of exception is in code field */
#define EXC_ARITHMETIC          3       
```

&emsp;ç®—æœ¯å¼‚å¸¸ï¼Œé™¤é›¶é”™è¯¯ä¼šæŠ›å‡ºæ­¤ç±»å¼‚å¸¸ã€‚

&emsp;......








&emsp;ä¸‹é¢æˆ‘ä»¬å†çœ‹ä¸€ä¸‹ [ã€ŠKernel Programming Guideã€‹](https://developer.apple.com/library/archive/documentation/Darwin/Conceptual/KernelProgramming/Mach/Mach.html?spm=a2c6h.12873639.0.0.15ee7113vyXhuI#//apple_ref/doc/uid/TP30000905-CH209-TPXREF102) æ–‡æ¡£ä¸­çš„ Mach æ¦‚è¿°éƒ¨åˆ†ã€‚

&emsp;Mach Overview

&emsp;OS X å†…æ ¸çš„åŸºæœ¬æœåŠ¡å’ŒåŸè¯­ï¼ˆfundamental services and primitivesï¼‰åŸºäº Mach 3.0ã€‚Apple å·²ç»ä¿®æ”¹å¹¶æ‰©å±•äº† Machï¼Œä»¥æ›´å¥½åœ°æ»¡è¶³ OS X çš„åŠŸèƒ½å’Œæ€§èƒ½ç›®æ ‡ã€‚Mach 3.0 æœ€åˆè¢«è®¾æƒ³ä¸ºä¸€ä¸ªç®€å•ï¼Œå¯æ‰©å±•çš„é€šä¿¡å¾®å†…æ ¸ã€‚å®ƒèƒ½å¤Ÿä½œä¸ºç‹¬ç«‹å†…æ ¸è¿è¡Œï¼Œå…¶ä»–ä¼ ç»Ÿæ“ä½œç³»ç»ŸæœåŠ¡ï¼ˆå¦‚ I/Oã€æ–‡ä»¶ç³»ç»Ÿå’Œç½‘ç»œå †æ ˆï¼‰ä½œä¸ºç”¨æˆ·æ¨¡å¼æœåŠ¡è¿è¡Œã€‚

&emsp;ä½†æ˜¯ï¼Œåœ¨ OS X ä¸­ï¼ŒMach ä¸å…¶ä»–å†…æ ¸ç»„ä»¶é“¾æ¥åˆ°å•ä¸ªå†…æ ¸åœ°å€ç©ºé—´ä¸­ã€‚è¿™ä¸»è¦æ˜¯ä¸ºäº†æ€§èƒ½;åœ¨é“¾æ¥ç»„ä»¶ä¹‹é—´è¿›è¡Œç›´æ¥è°ƒç”¨æ¯”åœ¨å•ç‹¬çš„ä»»åŠ¡ä¹‹é—´å‘é€æ¶ˆæ¯æˆ–æ‰§è¡Œè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ remote procedure callsï¼ˆRPCï¼‰ è¦å¿«å¾—å¤šã€‚è¿™ç§æ¨¡å—åŒ–ç»“æ„ä½¿ç³»ç»Ÿæ¯”å•ç‰‡å†…æ ¸æ‰€å…è®¸çš„æ›´å¼ºå¤§ï¼Œæ›´å…·å¯æ‰©å±•æ€§ï¼Œè€Œä¸ä¼šå—åˆ°çº¯å¾®å†…æ ¸çš„æ€§èƒ½æŸå¤±ã€‚

&emsp;å› æ­¤ï¼Œåœ¨ OSX ä¸­ï¼ŒMach ä¸»è¦ä¸æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡æ¢çº½ã€‚ç›¸åï¼Œå®ƒçš„ä»·å€¼åœ¨äºå®ƒçš„æŠ½è±¡æ€§ã€å¯æ‰©å±•æ€§å’Œçµæ´»æ€§ã€‚ç‰¹åˆ«æ˜¯ï¼ŒMach æä¾›äº†:

+ ä»¥é€šä¿¡é€šé“ï¼ˆcommunication channelsï¼‰ï¼ˆä¾‹å¦‚ portsï¼‰ä½œä¸ºå¯¹è±¡å¼•ç”¨çš„åŸºäºå¯¹è±¡çš„ API
+ é«˜åº¦å¹¶è¡Œæ‰§è¡Œï¼ŒåŒ…æ‹¬æŠ¢å å¼è°ƒåº¦çº¿ç¨‹å’Œå¯¹ SMP çš„æ”¯æŒ
+ çµæ´»çš„è°ƒåº¦æ¡†æ¶ï¼Œæ”¯æŒå®æ—¶ä½¿ç”¨
+ ä¸€æ•´å¥— IPC åŸè¯­ï¼ŒåŒ…æ‹¬æ¶ˆæ¯ä¼ é€’ã€RPCã€åŒæ­¥å’Œé€šçŸ¥
+ æ”¯æŒå¤§å‹è™šæ‹Ÿåœ°å€ç©ºé—´ã€å…±äº«å†…å­˜åŒºåŸŸå’Œç”±æŒä¹…å­˜å‚¨æ”¯æŒçš„å†…å­˜å¯¹è±¡
+ ç»éªŒè¯çš„å¯æ‰©å±•æ€§å’Œå¯ç§»æ¤æ€§ï¼Œä¾‹å¦‚è·¨æŒ‡ä»¤é›†ä½“ç³»ç»“æ„å’Œåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­
+ å®‰å…¨å’Œèµ„æºç®¡ç†æ˜¯è®¾è®¡çš„åŸºæœ¬åŸåˆ™ï¼›æ‰€æœ‰èµ„æºéƒ½æ˜¯è™šæ‹ŸåŒ–çš„

&emsp;Mach Kernel Abstractions

&emsp;Mach æä¾›äº†ä¸€å°éƒ¨åˆ†æŠ½è±¡ï¼ˆAbstractionsï¼‰ï¼Œè¿™äº›æŠ½è±¡ï¼ˆAbstractionsï¼‰è¢«è®¾è®¡ä¸ºæ—¢ç®€å•åˆå¼ºå¤§ã€‚ä»¥ä¸‹æ˜¯ä¸»è¦çš„å†…æ ¸æŠ½è±¡ï¼ˆKernel Abstractionsï¼‰ï¼š

+ Tasksã€‚èµ„æºæ‰€æœ‰æƒçš„å•ä½ï¼›æ¯ä¸ªä»»åŠ¡ç”±ä¸€ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´ã€ä¸€ä¸ªç«¯å£æƒé™å‘½åç©ºé—´å’Œä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç»„æˆã€‚ï¼ˆç±»ä¼¼äº processï¼‰
+ Threadsã€‚ä»»åŠ¡ä¸­çš„ CPU æ‰§è¡Œå•ä½ã€‚
+ Address spaceã€‚Mach ä¸å†…å­˜ç®¡ç†å™¨ä¸€èµ·å®ç°äº† sparse è™šæ‹Ÿåœ°å€ç©ºé—´å’Œå…±äº«å†…å­˜çš„æ¦‚å¿µã€‚
+ Memory objectsã€‚å†…å­˜ç®¡ç†çš„å†…éƒ¨å•å…ƒã€‚å†…å­˜å¯¹è±¡åŒ…æ‹¬å‘½åçš„æ¡ç›®å’ŒåŒºåŸŸï¼›å®ƒä»¬æ˜¯å¯èƒ½æ˜ å°„åˆ°åœ°å€ç©ºé—´çš„æ½œåœ¨æŒä¹…æ•°æ®çš„è¡¨ç¤ºã€‚
+ Portsã€‚å®‰å…¨çš„å•å·¥é€šä¿¡é€šé“ï¼Œåªèƒ½é€šè¿‡å‘é€å’Œæ¥æ”¶åŠŸèƒ½ï¼ˆç§°ä¸ºç«¯å£æƒé™ï¼‰è®¿é—®ã€‚
+ IPCã€‚æ¶ˆæ¯é˜Ÿåˆ—ã€è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ã€é€šçŸ¥ã€ä¿¡å·é‡å’Œé”é›†ã€‚
+ Timeã€‚æ—¶é’Ÿã€è®¡æ—¶å™¨å’Œç­‰å¾…ã€‚

&emsp;åœ¨ trap çº§åˆ«ï¼Œå¤§å¤šæ•° Mach æŠ½è±¡çš„æ¥å£ç”±å‘é€åˆ°å’Œæ¥è‡ªè¡¨ç¤ºè¿™äº›å¯¹è±¡çš„å†…æ ¸ç«¯å£çš„æ¶ˆæ¯ç»„æˆã€‚trap-level æ¥å£ï¼ˆå¦‚ mach_msg_overwrite_trapï¼‰å’Œæ¶ˆæ¯æ ¼å¼æœ¬èº«åœ¨æ­£å¸¸ä½¿ç”¨ä¸­ç”± Mach æ¥å£ç”Ÿæˆå™¨ï¼ˆMIGï¼‰æŠ½è±¡ã€‚MIG ç”¨äºæ ¹æ®å¯¹åŸºäºæ¶ˆæ¯çš„ API çš„æè¿°ï¼Œç¼–è¯‘è¿™äº› API çš„è¿‡ç¨‹æ¥å£ã€‚

&emsp;Tasks and Threads

&emsp;OS X è¿›ç¨‹å’Œ POSIX çº¿ç¨‹ï¼ˆpthreadsï¼‰åˆ†åˆ«åœ¨ Mach ä»»åŠ¡å’Œçº¿ç¨‹ä¹‹ä¸Šå®ç°ã€‚çº¿ç¨‹æ˜¯ä»»åŠ¡ä¸­çš„æ§åˆ¶æµç‚¹ã€‚å­˜åœ¨ä¸€ä¸ªä»»åŠ¡ï¼Œç”¨äºä¸ºå…¶åŒ…å«çš„çº¿ç¨‹æä¾›èµ„æºã€‚è¿›è¡Œæ­¤æ‹†åˆ†æ˜¯ä¸ºäº†æä¾›å¹¶è¡Œæ€§å’Œèµ„æºå…±äº«ã€‚

&emsp;A thread

+ æ˜¯ task ä¸­æ§åˆ¶æµçš„ç‚¹ã€‚
+ å¯ä»¥è®¿é—®åŒ…å« task çš„æ‰€æœ‰å…ƒç´ ã€‚
+ ä¸å…¶ä»–çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œï¼ˆå¯èƒ½ï¼‰ï¼Œç”šè‡³åŒä¸€ä»»åŠ¡ä¸­çš„çº¿ç¨‹ã€‚
+ å…·æœ‰æœ€å°çš„çŠ¶æ€ä¿¡æ¯ï¼Œä»¥å®ç°ä½å¼€é”€ã€‚

&emsp;A task

+ æ˜¯ç³»ç»Ÿèµ„æºçš„é›†åˆã€‚è¿™äº›èµ„æºï¼ˆåœ°å€ç©ºé—´é™¤å¤–ï¼‰ç”±ç«¯å£å¼•ç”¨ã€‚å¦‚æœç«¯å£çš„æƒé™æ˜¯è¿™æ ·åˆ†é…çš„ï¼Œåˆ™è¿™äº›èµ„æºå¯ä»¥ä¸å…¶ä»–ä»»åŠ¡å…±äº«ã€‚
+ æä¾›ä¸€ä¸ªå¤§çš„ã€å¯èƒ½ç¨€ç–çš„åœ°å€ç©ºé—´ï¼Œç”±è™šæ‹Ÿåœ°å€å¼•ç”¨ã€‚è¯¥ç©ºé—´çš„ä¸€éƒ¨åˆ†å¯ä»¥é€šè¿‡ç»§æ‰¿æˆ–å¤–éƒ¨å†…å­˜ç®¡ç†æ¥å…±äº«ã€‚
+ åŒ…å«ä¸€å®šæ•°é‡çš„çº¿ç¨‹ã€‚

&emsp;è¯·æ³¨æ„ï¼Œä»»åŠ¡æœ¬èº«æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸï¼Œåªæœ‰çº¿ç¨‹æ‰§è¡ŒæŒ‡ä»¤ã€‚å½“è¯´ â€œä»»åŠ¡ Y åš X â€ æ—¶ï¼ŒçœŸæ­£çš„æ„æ€æ˜¯ â€œä»»åŠ¡ Y ä¸­åŒ…å«çš„çº¿ç¨‹åš X â€

&emsp;ä»»åŠ¡æ˜¯ä¸€ä¸ªç›¸å½“æ˜‚è´µçš„å®ä½“ã€‚å®ƒæ˜¯ä¸€ä¸ªèµ„æºé›†åˆã€‚ä»»åŠ¡ä¸­çš„æ‰€æœ‰çº¿ç¨‹å…±äº«æ‰€æœ‰å†…å®¹ã€‚å¦‚æœæ²¡æœ‰æ˜¾å¼æ“ä½œï¼ˆå°½ç®¡æ“ä½œé€šå¸¸å¾ˆç®€å•ï¼‰ï¼Œä¸¤ä¸ªä»»åŠ¡å°†ä¸ä¼šå…±äº«ä»»ä½•å†…å®¹ï¼Œå¹¶ä¸”ä¸€äº›èµ„æºï¼ˆä¾‹å¦‚ç«¯å£æ¥æ”¶æƒé™ï¼‰æ ¹æœ¬æ— æ³•åœ¨ä¸¤ä¸ªä»»åŠ¡ä¹‹é—´å…±äº«ã€‚
 
&emsp;çº¿ç¨‹æ˜¯ä¸€ä¸ªç›¸å½“è½»é‡çº§çš„å®ä½“ã€‚å®ƒçš„åˆ›å»ºæˆæœ¬ç›¸å½“ä½ï¼Œè€Œä¸”æ“ä½œå¼€é”€ä¹Ÿå¾ˆä½ã€‚è¿™æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºçº¿ç¨‹å‡ ä¹æ²¡æœ‰çŠ¶æ€ä¿¡æ¯ï¼ˆä¸»è¦æ˜¯å®ƒçš„å¯„å­˜å™¨çŠ¶æ€ï¼‰ã€‚å®ƒæ‰€æ‹¥æœ‰çš„ä»»åŠ¡æ‰¿æ‹…ç€èµ„æºç®¡ç†çš„è´Ÿæ‹…ã€‚åœ¨å¤šå¤„ç†å™¨è®¡ç®—æœºä¸Šï¼Œä»»åŠ¡ä¸­çš„å¤šä¸ªçº¿ç¨‹å¯ä»¥å¹¶è¡Œæ‰§è¡Œã€‚å³ä½¿å¹¶è¡Œæ€§ä¸æ˜¯ç›®æ ‡ï¼Œå¤šä¸ªçº¿ç¨‹ä¹Ÿæœ‰ä¸€ä¸ªä¼˜åŠ¿ï¼Œå³æ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥ä½¿ç”¨åŒæ­¥ç¼–ç¨‹é£æ ¼ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹å°è¯•æä¾›å¤šä¸ªæœåŠ¡æ¥å°è¯•å¼‚æ­¥ç¼–ç¨‹ã€‚

&emsp;çº¿ç¨‹æ˜¯åŸºæœ¬çš„è®¡ç®—å®ä½“ã€‚ä¸€ä¸ªçº¿ç¨‹åªå±äºä¸€ä¸ªå®šä¹‰å…¶è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä»»åŠ¡ã€‚è¦å½±å“åœ°å€ç©ºé—´çš„ç»“æ„æˆ–å¼•ç”¨åœ°å€ç©ºé—´ä»¥å¤–çš„ä»»ä½•èµ„æºï¼Œçº¿ç¨‹å¿…é¡»æ‰§è¡Œç‰¹æ®Šçš„é™·é˜±æŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤ä½¿å†…æ ¸ä»£è¡¨çº¿ç¨‹æ‰§è¡Œæ“ä½œï¼Œæˆ–ä»£è¡¨çº¿ç¨‹å‘æŸä¸ªä»£ç†å‘é€æ¶ˆæ¯ã€‚é€šå¸¸ï¼Œè¿™äº›é™·é˜±æ“ä½œä¸åŒ…å«çº¿ç¨‹çš„ä»»åŠ¡ç›¸å…³è”çš„èµ„æºã€‚å¯ä»¥è¯·æ±‚å†…æ ¸æ¥æ“ä½œè¿™äº›å®ä½“ï¼šåˆ›å»ºå®ƒä»¬ã€åˆ é™¤å®ƒä»¬ï¼Œå¹¶å½±å“å®ƒä»¬çš„çŠ¶æ€ã€‚

&emsp;Mach ä¸ºçº¿ç¨‹è°ƒåº¦ç­–ç•¥æä¾›äº†ä¸€ä¸ªçµæ´»çš„æ¡†æ¶ã€‚OS X çš„æ—©æœŸç‰ˆæœ¬æ”¯æŒåˆ†æ—¶å’Œå›ºå®šä¼˜å…ˆçº§ç­–ç•¥ã€‚æé«˜å’Œé™ä½åˆ†æ—¶çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œä»¥å¹³è¡¡å…¶èµ„æºæ¶ˆè€—ä¸å…¶ä»–åˆ†æ—¶çº¿ç¨‹ä¹‹é—´çš„å…³ç³»ã€‚

&emsp;å›ºå®šä¼˜å…ˆçº§çº¿ç¨‹æ‰§è¡Œä¸€æ®µæ—¶é—´ï¼Œç„¶åæ”¾åœ¨å…·æœ‰ç›¸åŒä¼˜å…ˆçº§çš„çº¿ç¨‹é˜Ÿåˆ—çš„æœ«å°¾ã€‚å°†å›ºå®šä¼˜å…ˆçº§çº¿ç¨‹çš„é‡å­çº§åˆ«è®¾ç½®ä¸ºæ— ç©·å¤§å°†å…è®¸è¯¥çº¿ç¨‹è¿è¡Œï¼Œç›´åˆ°å®ƒé˜»å¡ï¼Œæˆ–è€…ç›´åˆ°å®ƒè¢«æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹æŠ¢å ã€‚é«˜ä¼˜å…ˆçº§å®æ—¶çº¿ç¨‹é€šå¸¸æ˜¯å›ºå®šä¼˜å…ˆçº§çš„ã€‚

&emsp;OS X è¿˜ä¸ºå®æ—¶æ€§èƒ½æä¾›æ—¶é—´çº¦æŸè°ƒåº¦ã€‚æ­¤è°ƒåº¦å…è®¸ä½ æŒ‡å®šçº¿ç¨‹å¿…é¡»åœ¨ç‰¹å®šæ—¶é—´æ®µå†…è·å¾—ç‰¹å®šæ—¶é—´é‡ã€‚

&emsp;Mach è°ƒåº¦åœ¨ [Mach Scheduling and Thread Interfaces](https://developer.apple.com/library/archive/documentation/Darwin/Conceptual/KernelProgramming/scheduler/scheduler.html#//apple_ref/doc/uid/TP30000905-CH211-BEHJDFCA) ä¸­è¿›ä¸€æ­¥æè¿°ã€‚

&emsp;Ports, Port Rights, Port Sets, and Port Namespaces

&emsp;é™¤äº†ä»»åŠ¡çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¹‹å¤–ï¼Œæ‰€æœ‰å…¶ä»– Mach èµ„æºéƒ½æ˜¯é€šè¿‡ç§°ä¸ºç«¯å£ï¼ˆportï¼‰çš„é—´æ¥å¯»å€çº§åˆ«è®¿é—®çš„ã€‚ç«¯å£æ˜¯è¯·æ±‚æœåŠ¡çš„å®¢æˆ·ç«¯å’Œæä¾›æœåŠ¡çš„æœåŠ¡å™¨ä¹‹é—´å•å‘é€šä¿¡é€šé“çš„ç«¯ç‚¹ã€‚å¦‚æœè¦ä¸ºæ­¤ç±»æœåŠ¡è¯·æ±‚æä¾›å›å¤ï¼Œåˆ™å¿…é¡»ä½¿ç”¨ç¬¬äºŒä¸ªç«¯å£ã€‚è¿™ç›¸å½“äº UNIX æœ¯è¯­ä¸­çš„ï¼ˆå•å‘ï¼‰ç®¡é“ã€‚

&emsp;åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç”±ç«¯å£è®¿é—®çš„èµ„æºï¼ˆå³ç”±å®ƒå‘½åçš„ï¼‰ç§°ä¸ºå¯¹è±¡ã€‚å¤§å¤šæ•°ç”±ç«¯å£å‘½åçš„å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªæ¥æ”¶å™¨å’Œï¼ˆå¯èƒ½ï¼‰å¤šä¸ªå‘é€å™¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºæ¶ˆæ¯é˜Ÿåˆ—è¿™æ ·çš„å…¸å‹å¯¹è±¡ï¼Œåªæœ‰ä¸€ä¸ªæ¥æ”¶ç«¯å£å’Œè‡³å°‘ä¸€ä¸ªå‘é€ç«¯å£ã€‚

&emsp;å¯¹è±¡æä¾›çš„æœåŠ¡ç”±æ¥æ”¶å‘é€åˆ°å¯¹è±¡çš„è¯·æ±‚çš„ç®¡ç†å™¨ç¡®å®šã€‚å› æ­¤ï¼Œå†…æ ¸æ˜¯ä¸å†…æ ¸æä¾›çš„å¯¹è±¡å…³è”çš„ç«¯å£çš„æ¥æ”¶å™¨ï¼Œè€Œä¸ä»»åŠ¡æä¾›çš„å¯¹è±¡å…³è”çš„ç«¯å£çš„æ¥æ”¶å™¨æ˜¯æä¾›è¿™äº›å¯¹è±¡çš„ä»»åŠ¡ã€‚

&emsp;å¯¹äºä¸ºä»»åŠ¡æä¾›çš„å¯¹è±¡å‘½åçš„ç«¯å£ï¼Œå¯ä»¥å°†è¯¥ç«¯å£çš„è¯·æ±‚æ¥æ”¶è€…æ›´æ”¹ä¸ºä¸åŒçš„ä»»åŠ¡ï¼Œä¾‹å¦‚é€šè¿‡åœ¨æ¶ˆæ¯ä¸­å°†è¯¥ç«¯å£ä¼ é€’ç»™è¯¥ä»»åŠ¡ã€‚å•ä¸ªä»»åŠ¡å¯èƒ½æœ‰å¤šä¸ªå¼•ç”¨å…¶æ”¯æŒçš„èµ„æºçš„ç«¯å£ã€‚å› æ­¤ï¼Œä»»ä½•ç»™å®šçš„å®ä½“éƒ½å¯ä»¥æœ‰å¤šä¸ªè¡¨ç¤ºå®ƒçš„ç«¯å£ï¼Œæ¯ä¸ªç«¯å£éƒ½è¡¨ç¤ºä¸åŒçš„å…è®¸æ“ä½œé›†ã€‚ä¾‹å¦‚ï¼Œè®¸å¤šå¯¹è±¡å…·æœ‰åç§°ç«¯å£å’Œæ§åˆ¶ç«¯å£ï¼ˆæœ‰æ—¶ç§°ä¸ºç‰¹æƒç«¯å£ï¼‰ã€‚è®¿é—®æ§åˆ¶ç«¯å£å…è®¸æ“ä½œå¯¹è±¡ï¼›å¯¹åç§°ç«¯å£çš„è®¿é—®åªæ˜¯å‘½åå¯¹è±¡ï¼Œä»¥ä¾¿ä½ å¯ä»¥è·å–æœ‰å…³è¯¥å¯¹è±¡çš„ä¿¡æ¯æˆ–å¯¹å…¶æ‰§è¡Œå…¶ä»–éç‰¹æƒæ“ä½œã€‚

&emsp;ä»»åŠ¡å…·æœ‰ä»¥ç‰¹å®šæ–¹å¼è®¿é—®ç«¯å£çš„æƒé™ï¼ˆå‘é€ã€æ¥æ”¶ã€å‘é€ä¸€æ¬¡ï¼‰ï¼›è¿™äº›è¢«ç§°ä¸ºç«¯å£æƒé™ã€‚åªèƒ½é€šè¿‡å³é”®è®¿é—®ç«¯å£ã€‚ç«¯å£é€šå¸¸ç”¨äºæˆäºˆå®¢æˆ·ç«¯å¯¹ Mach å†…å¯¹è±¡çš„è®¿é—®æƒé™ã€‚æœ‰æƒå‘é€åˆ°å¯¹è±¡çš„ IPC ç«¯å£è¡¨ç¤ºæœ‰æƒä»¥è§„å®šçš„æ–¹å¼æ“ä½œå¯¹è±¡ã€‚å› æ­¤ï¼Œç«¯å£æƒé™æ‰€æœ‰æƒæ˜¯ Mach çš„åŸºæœ¬å®‰å…¨æœºåˆ¶ã€‚æ‹¥æœ‰å¯¹æŸä¸ªå¯¹è±¡çš„æƒé™å°±æ˜¯æ‹¥æœ‰è®¿é—®æˆ–æ“ä½œè¯¥å¯¹è±¡çš„èƒ½åŠ›ã€‚

&emsp;å¯ä»¥é€šè¿‡ IPC åœ¨ä»»åŠ¡ä¹‹é—´å¤åˆ¶å’Œç§»åŠ¨ç«¯å£æƒé™ã€‚è¿™æ ·åšå®é™…ä¸Šä¼šå°†åŠŸèƒ½ä¼ é€’ç»™æŸäº›å¯¹è±¡æˆ–æœåŠ¡å™¨ã€‚

&emsp;ç«¯å£å¼•ç”¨çš„ä¸€ç§å¯¹è±¡ç±»å‹æ˜¯ç«¯å£é›†ã€‚é¡¾åæ€ä¹‰ï¼Œç«¯å£é›†æ˜¯ä¸€ç»„ç«¯å£æƒé™ï¼Œå½“ä»è¯¥ç»„çš„ä»»ä½•æˆå‘˜æ¥æ”¶æ¶ˆæ¯æˆ–äº‹ä»¶æ—¶ï¼Œå¯ä»¥å°†å…¶è§†ä¸ºå•ä¸ªå•å…ƒã€‚ç«¯å£é›†å…è®¸ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¤šä¸ªæ¶ˆæ¯å’Œäº‹ä»¶æºï¼Œä¾‹å¦‚åœ¨å·¥ä½œå¾ªç¯ä¸­ã€‚

&emsp;ä¼ ç»Ÿä¸Šï¼Œåœ¨ Mach ä¸­ï¼Œç”±ç«¯å£è¡¨ç¤ºçš„é€šä¿¡é€šé“å§‹ç»ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ã€‚ä½†æ˜¯ï¼ŒOS X æ”¯æŒå…¶ä»–ç±»å‹çš„é€šä¿¡é€šé“ï¼Œè¿™äº›æ–°ç±»å‹çš„ IPC å¯¹è±¡ä¹Ÿç”±ç«¯å£å’Œç«¯å£æƒé™è¡¨ç¤ºã€‚æœ‰å…³æ¶ˆæ¯å’Œå…¶ä»– IPC ç±»å‹çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…è¿›ç¨‹é—´é€šä¿¡ ï¼ˆIPCï¼‰ éƒ¨åˆ†ã€‚

&emsp;ç«¯å£å’Œç«¯å£æƒé™æ²¡æœ‰å…è®¸ç›´æ¥æ“ä½œä»»æ„ç«¯å£æˆ–æƒé™çš„ç³»ç»ŸèŒƒå›´çš„åç§°ã€‚ä»…å½“ä»»åŠ¡åœ¨å…¶ port å‘½åç©ºé—´ä¸­å…·æœ‰ç«¯å£æƒé™æ—¶ï¼Œä»»åŠ¡æ‰èƒ½æ“ä½œç«¯å£ã€‚ç«¯å£æƒé™ç”±ç«¯å£åæŒ‡å®šï¼Œç«¯å£åæ˜¯ 32 ä½ç«¯å£å‘½åç©ºé—´çš„æ•´æ•°ç´¢å¼•ã€‚æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å…³è”çš„ç«¯å£å‘½åç©ºé—´ã€‚

&emsp;å½“å¦ä¸€ä¸ªä»»åŠ¡å°†ç«¯å£æƒé™æ˜¾å¼æ’å…¥å…¶å‘½åç©ºé—´æ—¶ï¼Œå½“ä»»åŠ¡åœ¨æ¶ˆæ¯ä¸­æ¥æ”¶æƒé™æ—¶ï¼Œé€šè¿‡åˆ›å»ºè¿”å›å¯¹è±¡æƒé™çš„å¯¹è±¡ï¼Œä»¥åŠé€šè¿‡ Mach è°ƒç”¨æŸäº›ç‰¹æ®Šç«¯å£ï¼ˆmach_thread_selfã€mach_task_self å’Œ mach_reply_portï¼‰æ—¶ï¼Œä»»åŠ¡ä¼šè·å–ç«¯å£æƒé™ã€‚

&emsp;Memory Management

&emsp;ä¸å¤§å¤šæ•°ç°ä»£æ“ä½œç³»ç»Ÿä¸€æ ·ï¼ŒMach ä¸ºå¤§å‹ç¨€ç–çš„è™šæ‹Ÿåœ°å€ç©ºé—´æä¾›å¯»å€ã€‚è¿è¡Œæ—¶è®¿é—®æ˜¯é€šè¿‡è™šæ‹Ÿåœ°å€è¿›è¡Œçš„ï¼Œè¿™äº›è™šæ‹Ÿåœ°å€å¯èƒ½ä¸å°è¯•è®¿é—®çš„åˆå§‹æ—¶é—´ç‰©ç†å†…å­˜ä¸­çš„ä½ç½®ä¸å¯¹åº”ã€‚Mach è´Ÿè´£è·å–è¯·æ±‚çš„è™šæ‹Ÿåœ°å€ï¼Œå¹¶åœ¨ç‰©ç†å†…å­˜ä¸­ä¸ºå…¶åˆ†é…ç›¸åº”çš„ä½ç½®ã€‚å®ƒé€šè¿‡éœ€æ±‚åˆ†é¡µæ¥å®ç°è¿™ä¸€ç‚¹ã€‚

&emsp;å°†å†…å­˜å¯¹è±¡æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´çš„èŒƒå›´æ—¶ï¼Œå°†ä½¿ç”¨æ•°æ®å¡«å……è¯¥èŒƒå›´ã€‚åœ°å€ç©ºé—´ä¸­çš„æ‰€æœ‰æ•°æ®æœ€ç»ˆéƒ½é€šè¿‡å†…å­˜å¯¹è±¡æä¾›ã€‚åœ¨ç‰©ç†å†…å­˜ä¸­å»ºç«‹é¡µé¢æ—¶ï¼ŒMach ä¼šå‘å†…å­˜å¯¹è±¡ï¼ˆå¯»å‘¼æœºï¼‰çš„æ‰€æœ‰è€…è¯¢é—®é¡µé¢çš„å†…å®¹ï¼Œå¹¶åœ¨å›æ”¶é¡µé¢ä¹‹å‰å°†å¯èƒ½ä¿®æ”¹çš„æ•°æ®è¿”å›ç»™å¯»å‘¼æœºã€‚OS X åŒ…æ‹¬ä¸¤ä¸ªå†…å»ºå¯»å‘¼æœºï¼Œå³é»˜è®¤å¯»å‘¼æœºå’Œ vnode å¯»å‘¼æœºã€‚

&emsp;é»˜è®¤å¯»å‘¼æœºå¤„ç†éæŒä¹…å†…å­˜ï¼Œç§°ä¸ºåŒ¿åå†…å­˜ã€‚åŒ¿åå†…å­˜åˆå§‹åŒ–ä¸ºé›¶ï¼Œå¹¶ä¸”ä»…åœ¨ä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸå†…å­˜ä¸­å­˜åœ¨ã€‚vnode å¯»å‘¼æœºå°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜å¯¹è±¡ã€‚Mach å°†æ¥å£å¯¼å‡ºåˆ°å†…å­˜å¯¹è±¡ï¼Œä»¥å…è®¸ç”¨æˆ·æ¨¡å¼ä»»åŠ¡æä¾›å…¶å†…å®¹ã€‚æ­¤æ¥å£ç§°ä¸ºå¤–éƒ¨å†…å­˜ç®¡ç†æ¥å£æˆ– EMMIã€‚

&emsp;å†…å­˜ç®¡ç†å­ç³»ç»Ÿå¯¼å‡ºç§°ä¸ºå‘½åæ¡ç›®æˆ–å‘½åå†…å­˜æ¡ç›®çš„è™šæ‹Ÿå†…å­˜å¥æŸ„ã€‚ä¸å¤§å¤šæ•°å†…æ ¸èµ„æºä¸€æ ·ï¼Œè¿™äº›èµ„æºç”±ç«¯å£è¡¨ç¤ºã€‚å…·æœ‰å‘½åçš„å†…å­˜è¾“å…¥å¥æŸ„å…è®¸æ‰€æœ‰è€…æ˜ å°„åŸºç¡€è™šæ‹Ÿå†…å­˜å¯¹è±¡æˆ–ä¼ é€’å°†åŸºç¡€å¯¹è±¡æ˜ å°„åˆ°å…¶ä»–å¯¹è±¡çš„æƒé™ã€‚åœ¨ä¸¤ä¸ªä¸åŒçš„ä»»åŠ¡ä¸­æ˜ å°„å‘½åæ¡ç›®ä¼šå¯¼è‡´åœ¨ä¸¤ä¸ªä»»åŠ¡ä¹‹é—´äº§ç”Ÿä¸€ä¸ªå…±äº«å†…å­˜çª—å£ï¼Œä»è€Œä¸ºå»ºç«‹å…±äº«å†…å­˜æä¾›äº†ä¸€ç§çµæ´»çš„æ–¹æ³•ã€‚

&emsp;ä» OS X v10.1 å¼€å§‹ï¼ŒEMMI ç³»ç»Ÿå¾—åˆ°äº†å¢å¼ºï¼Œä»¥æ”¯æŒ "æ— ç«¯å£" EMMIã€‚åœ¨ä¼ ç»Ÿçš„ EMMI ä¸­ï¼Œä¸ºæ¯ä¸ªå†…å­˜åŒºåŸŸåˆ›å»ºä¸¤ä¸ª Mach ç«¯å£ï¼ŒåŒæ ·ä¸ºæ¯ä¸ªç¼“å­˜çš„ vnode åˆ›å»ºä¸¤ä¸ªç«¯å£ã€‚æ— ç«¯å£ EMMI åœ¨å…¶åˆå§‹å®ç°ä¸­å°†å…¶æ›¿æ¢ä¸ºç›´æ¥å†…å­˜å¼•ç”¨ï¼ˆåŸºæœ¬ä¸Šæ˜¯æŒ‡é’ˆï¼‰ã€‚åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­ï¼Œç«¯å£å°†ç”¨äºä¸å†…æ ¸å¤–éƒ¨çš„å¯»å‘¼æœºè¿›è¡Œé€šä¿¡ï¼ŒåŒæ—¶ä½¿ç”¨ç›´æ¥å¼•ç”¨ä¸é©»ç•™åœ¨å†…æ ¸ç©ºé—´ä¸­çš„å¯»å‘¼æœºè¿›è¡Œé€šä¿¡ã€‚è¿™äº›æ›´æ”¹çš„æœ€ç»ˆç»“æœæ˜¯ï¼Œæ— ç«¯å£ EMMI çš„æ—©æœŸç‰ˆæœ¬ä¸æ”¯æŒåœ¨å†…æ ¸ç©ºé—´ä¹‹å¤–è¿è¡Œçš„å¯»å‘¼æœºã€‚é¢„è®¡æ­¤æ”¯æŒå°†åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­æ¢å¤ã€‚

&emsp;è™šæ‹Ÿå†…å­˜ç©ºé—´çš„åœ°å€èŒƒå›´ä¹Ÿå¯ä»¥é€šè¿‡ç›´æ¥åˆ†é…ï¼ˆä½¿ç”¨ vm_allocateï¼‰æ¥å¡«å……ã€‚åŸºç¡€è™šæ‹Ÿå†…å­˜å¯¹è±¡æ˜¯åŒ¿åçš„ï¼Œå¹¶ç”±é»˜è®¤å¯»å‘¼æœºæä¾›æ”¯æŒã€‚åœ°å€ç©ºé—´çš„å…±äº«èŒƒå›´ä¹Ÿå¯ä»¥é€šè¿‡ç»§æ‰¿è¿›è¡Œè®¾ç½®ã€‚åˆ›å»ºæ–°ä»»åŠ¡æ—¶ï¼Œå°†ä»çˆ¶çº§å…‹éš†è¿™äº›ä»»åŠ¡ã€‚æ­¤å…‹éš†ä¹Ÿä¸åŸºç¡€å†…å­˜åœ°å€ç©ºé—´æœ‰å…³ã€‚å¯¹è±¡çš„æ˜ å°„éƒ¨åˆ†å¯ä»¥ä½œä¸ºå‰¯æœ¬ç»§æ‰¿ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå…±äº«ç»§æ‰¿ï¼Œæˆ–è€…æ ¹æœ¬ä¸ç»§æ‰¿ï¼Œå…·ä½“å–å†³äºä¸æ˜ å°„å…³è”çš„å±æ€§ã€‚Mach å®è·µä¸€ç§ç§°ä¸ºå†™å…¥æ—¶å¤åˆ¶çš„å»¶è¿Ÿå¤åˆ¶å½¢å¼ï¼Œä»¥ä¼˜åŒ–ä»»åŠ¡åˆ›å»ºæ—¶ç»§æ‰¿å‰¯æœ¬çš„æ€§èƒ½ã€‚

&emsp;ä¸æ˜¯ç›´æ¥å¤åˆ¶èŒƒå›´ï¼Œè€Œæ˜¯é€šè¿‡å—ä¿æŠ¤çš„å…±äº«å®ç°å†™å…¥æ—¶å¤åˆ¶ä¼˜åŒ–ã€‚è¿™ä¸¤ä¸ªä»»åŠ¡å…±äº«è¦å¤åˆ¶çš„å†…å­˜ï¼Œä½†å…·æœ‰åªè¯»è®¿é—®æƒé™ã€‚å½“ä»»ä¸€ä»»åŠ¡å°è¯•ä¿®æ”¹èŒƒå›´çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œæ­¤æ—¶å°†å¤åˆ¶è¯¥éƒ¨åˆ†ã€‚è¿™ç§å¯¹å†…å­˜å‰¯æœ¬çš„å»¶è¿Ÿè¯„ä¼°æ˜¯ä¸€é¡¹é‡è¦çš„ä¼˜åŒ–ï¼Œå®ƒå…è®¸åœ¨å¤šä¸ªæ–¹é¢è¿›è¡Œç®€åŒ–ï¼Œå°¤å…¶æ˜¯æ¶ˆæ¯ä¼ é€’ APIã€‚

&emsp;Mach é€šè¿‡å¯¼å‡ºå‘½ååŒºåŸŸæä¾›äº†å¦ä¸€ç§å½¢å¼çš„å…±äº«ã€‚å‘½ååŒºåŸŸæ˜¯å‘½åæ¡ç›®çš„ä¸€ç§å½¢å¼ï¼Œä½†ä¸æ˜¯ç”±è™šæ‹Ÿå†…å­˜å¯¹è±¡æ”¯æŒï¼Œè€Œæ˜¯ç”±è™šæ‹Ÿæ˜ å°„ç‰‡æ®µæ”¯æŒã€‚æ­¤ç‰‡æ®µå¯èƒ½åŒ…å«åˆ°å¤§é‡è™šæ‹Ÿå†…å­˜å¯¹è±¡çš„æ˜ å°„ã€‚å®ƒå¯ä»¥æ˜ å°„åˆ°å…¶ä»–è™šæ‹Ÿæ˜ å°„ä¸­ï¼Œä»è€Œä¸ä»…æä¾›äº†ä¸€ç§ç»§æ‰¿ä¸€ç»„è™šæ‹Ÿå†…å­˜å¯¹è±¡ï¼Œè¿˜ç»§æ‰¿å…¶ç°æœ‰æ˜ å°„å…³ç³»çš„æ–¹æ³•ã€‚æ­¤åŠŸèƒ½åœ¨ä»»åŠ¡è®¾ç½®ä¸­æä¾›äº†æ˜¾è‘—çš„ä¼˜åŒ–ï¼Œä¾‹å¦‚ï¼Œåœ¨å…±äº«ç”¨äºå…±äº«åº“çš„åœ°å€ç©ºé—´çš„å¤æ‚åŒºåŸŸæ—¶ã€‚

&emsp;Interprocess Communication (IPC)

&emsp;ä»»åŠ¡ä¹‹é—´çš„é€šä¿¡æ˜¯ Mach philosophyï¼ˆå“²å­¦ï¼‰çš„é‡è¦å…ƒç´ ã€‚Mach æ”¯æŒå®¢æˆ·ç«¯/æœåŠ¡å™¨ç³»ç»Ÿç»“æ„ï¼Œå…¶ä¸­ä»»åŠ¡ï¼ˆå®¢æˆ·ç«¯ï¼‰é€šè¿‡é€šä¿¡é€šé“å‘é€çš„æ¶ˆæ¯å‘å…¶ä»–ä»»åŠ¡ï¼ˆæœåŠ¡å™¨ï¼‰å‘å‡ºè¯·æ±‚æ¥è®¿é—®æœåŠ¡ã€‚

&emsp;è¿™äº›é€šä¿¡ä¿¡é“åœ¨ Mach ä¸­çš„ç«¯ç‚¹ç§°ä¸º portsï¼Œè€Œ port rights è¡¨ç¤ºä½¿ç”¨è¯¥ä¿¡é“çš„æƒé™ã€‚Mach æä¾›çš„ IPC å½¢å¼åŒ…æ‹¬:

+ message queues
+ semaphores
+ notifications
+ lock sets
+ remote procedure calls (RPCs)

&emsp;ç«¯å£æ‰€è¡¨ç¤ºçš„ IPC å¯¹è±¡çš„ç±»å‹å†³å®šäº†è¯¥ç«¯å£ä¸Šå…è®¸çš„æ“ä½œï¼Œä»¥åŠæ•°æ®ä¼ è¾“çš„å‘ç”Ÿæ–¹å¼ï¼ˆä»¥åŠæ˜¯å¦å‘ç”Ÿï¼‰ã€‚

&emsp;Important: OS X ä¸­çš„ IPC è®¾å¤‡å¤„äºè¿‡æ¸¡çŠ¶æ€ã€‚åœ¨ç³»ç»Ÿçš„æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œå¹¶éæ‰€æœ‰è¿™äº› IPC ç±»å‹éƒ½å¯ä»¥å®ç°ã€‚

&emsp;æœ‰ä¸¤ä¸ªæ ¹æœ¬ä¸åŒçš„ Mach API ç”¨äºç«¯å£çš„åŸå§‹æ“ä½œ â€” mach_ipc ç³»åˆ—å’Œ mach_msg ç³»åˆ—ã€‚åœ¨åˆç†èŒƒå›´å†…ï¼Œä¸¤ä¸ªç³»åˆ—éƒ½å¯ä»¥ä¸ä»»ä½• IPC å¯¹è±¡ä¸€èµ·ä½¿ç”¨;ä½†æ˜¯ï¼Œåœ¨æ–°ä»£ç ä¸­é¦–é€‰ mach_ipc è°ƒç”¨ã€‚mach_ipc è°ƒç”¨åœ¨é€‚å½“çš„æƒ…å†µä¸‹ç»´æŠ¤çŠ¶æ€ä¿¡æ¯ï¼Œä»¥æ”¯æŒäº‹åŠ¡çš„æ¦‚å¿µã€‚æ—§ä»£ç æ”¯æŒ mach_msg è°ƒç”¨ï¼Œä½†å·²å¼ƒç”¨;å®ƒä»¬æ˜¯ statelessã€‚

&emsp;IPC Transactions and Event Dispatching

&emsp;å½“çº¿ç¨‹è°ƒç”¨ mach_ipc_dispatch æ—¶ï¼Œå®ƒä¼šé‡å¤å¤„ç†åœ¨æ³¨å†Œç«¯å£é›†ä¸Šä¼ å…¥çš„äº‹ä»¶ã€‚è¿™äº›äº‹ä»¶å¯ä»¥æ˜¯æ¥è‡ª RPC å¯¹è±¡çš„å‚æ•°å—ï¼ˆä½œä¸ºå®¢æˆ·ç«¯è°ƒç”¨çš„ç»“æœï¼‰ã€æ­£åœ¨è·å–çš„é”å®šå¯¹è±¡ï¼ˆç”±äºæŸäº›å…¶ä»–çº¿ç¨‹é‡Šæ”¾é”çš„ç»“æœï¼‰ã€æ­£åœ¨å‘å¸ƒçš„é€šçŸ¥æˆ–ä¿¡å·é‡ï¼Œæˆ–è€…æ¥è‡ªä¼ ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆæ¯ã€‚

&emsp;è¿™äº›äº‹ä»¶é€šè¿‡ mach_msg_dispatch çš„æ ‡æ³¨è¿›è¡Œå¤„ç†ã€‚æŸäº›äº‹ä»¶æ„å‘³ç€åœ¨æ ‡æ³¨çš„ç”Ÿå­˜æœŸå†…å­˜åœ¨äº‹åŠ¡ã€‚å¯¹äºé”ï¼ŒçŠ¶æ€æ˜¯é”çš„æ‰€æœ‰æƒã€‚å½“æ ‡æ³¨è¿”å›æ—¶ï¼Œå°†é‡Šæ”¾é”ã€‚å¯¹äºè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ŒçŠ¶æ€æ˜¯å®¢æˆ·ç«¯çš„æ ‡è¯†ã€å‚æ•°å—å’Œåº”ç­”ç«¯å£ã€‚å½“æ ‡æ³¨è¿”å›æ—¶ï¼Œå°†å‘é€ç­”å¤ã€‚

å½“æ ‡æ³¨è¿”å›æ—¶ï¼Œäº‹åŠ¡ï¼ˆå¦‚æœæœ‰ï¼‰å®Œæˆï¼Œçº¿ç¨‹ç­‰å¾…ä¸‹ä¸€ä¸ªäº‹ä»¶ã€‚mach_ipc_dispatch è®¾æ–½æ—¨åœ¨æ”¯æŒå·¥ä½œå¾ªç¯ã€‚

&emsp;Message Queues

&emsp;æœ€åˆï¼ŒMach ä¸­è¿›ç¨‹é—´é€šä¿¡çš„å”¯ä¸€æ ·å¼æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ã€‚åªæœ‰ä¸€ä¸ªä»»åŠ¡å¯ä»¥ä¿ç•™è¡¨ç¤ºæ¶ˆæ¯é˜Ÿåˆ—çš„ç«¯å£çš„æ¥æ”¶æƒé™ã€‚å…è®¸æ­¤ä»»åŠ¡ä»ç«¯å£é˜Ÿåˆ—æ¥æ”¶ï¼ˆè¯»å–ï¼‰æ¶ˆæ¯ã€‚å¤šä¸ªä»»åŠ¡å¯ä»¥æ‹¥æœ‰å¯¹ç«¯å£çš„æƒé™ï¼Œè¿™äº›æƒé™å…è®¸å®ƒä»¬å°†æ¶ˆæ¯å‘é€ï¼ˆå†™å…¥ï¼‰åˆ°é˜Ÿåˆ—ä¸­ã€‚

&emsp;ä¸€ä¸ªä»»åŠ¡é€šè¿‡æ„å»ºåŒ…å«ä¸€ç»„æ•°æ®å…ƒç´ çš„æ•°æ®ç»“æ„ï¼Œç„¶ååœ¨å®ƒæ‹¥æœ‰å‘é€æƒé™çš„ç«¯å£ä¸Šæ‰§è¡Œæ¶ˆæ¯å‘é€æ“ä½œï¼Œä¸å¦ä¸€ä¸ªä»»åŠ¡è¿›è¡Œé€šä¿¡ã€‚ç¨åï¼Œå…·æœ‰è¯¥ç«¯å£æ¥æ”¶æƒé™çš„ä»»åŠ¡å°†æ‰§è¡Œæ¶ˆæ¯æ¥æ”¶æ“ä½œã€‚

&emsp;æ¶ˆæ¯å¯èƒ½åŒ…å«ä»¥ä¸‹éƒ¨åˆ†æˆ–å…¨éƒ¨å†…å®¹ï¼š

+ çº¯æ•°æ®
+ å†…å­˜èŒƒå›´çš„å‰¯æœ¬
+ ç«¯å£æƒé™
+ å†…æ ¸éšå¼å±æ€§ï¼Œä¾‹å¦‚å‘é€æ–¹çš„å®‰å…¨ä»¤ç‰Œ

&emsp;æ¶ˆæ¯ä¼ è¾“æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œã€‚æ¶ˆæ¯åœ¨é€»è¾‘ä¸Šå¤åˆ¶åˆ°æ¥æ”¶ä»»åŠ¡ä¸­ï¼Œå¯èƒ½å…·æœ‰å†™å…¥æ—¶å¤åˆ¶ä¼˜åŒ–ã€‚æ¥æ”¶ä»»åŠ¡ä¸­çš„å¤šä¸ªçº¿ç¨‹å¯ä»¥å°è¯•ä»ç»™å®šç«¯å£æ¥æ”¶æ¶ˆæ¯ï¼Œä½†åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ¥æ”¶ä»»ä½•ç»™å®šæ¶ˆæ¯ã€‚

&emsp;Semaphores

&emsp;ä¿¡å·é‡ IPC å¯¹è±¡æ”¯æŒç­‰å¾…ã€æäº¤å’Œæäº¤æ‰€æœ‰æ“ä½œã€‚è¿™äº›æ˜¯è®¡æ•°ä¿¡å·é‡ï¼Œå› ä¸ºå¦‚æœè¯¥ä¿¡å·é‡çš„ç­‰å¾…é˜Ÿåˆ—ä¸­å½“å‰æ²¡æœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾…ï¼Œåˆ™å°†ä¿å­˜ï¼ˆè®¡æ•°ï¼‰å¸–å­ã€‚post all æ“ä½œå°†å”¤é†’æ‰€æœ‰å½“å‰æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹ã€‚

&emsp;Notifications

&emsp;ä¸ä¿¡å·é‡ä¸€æ ·ï¼Œé€šçŸ¥å¯¹è±¡ä¹Ÿæ”¯æŒå‘å¸ƒå’Œç­‰å¾…æ“ä½œï¼Œä½†æ·»åŠ äº†çŠ¶æ€å­—æ®µã€‚çŠ¶æ€æ˜¯åœ¨åˆ›å»ºé€šçŸ¥å¯¹è±¡æ—¶å®šä¹‰çš„å›ºå®šå¤§å°ã€å›ºå®šæ ¼å¼çš„å­—æ®µã€‚æ¯ä¸ªå¸–å­æ›´æ–°çŠ¶æ€å­—æ®µ;æ¯ä¸ªå¸–å­éƒ½è¦†ç›–äº†ä¸€ä¸ªçŠ¶æ€ã€‚

&emsp;Locks

&emsp;é”æ˜¯æä¾›å¯¹å…³é”®éƒ¨åˆ†çš„äº’æ–¥è®¿é—®çš„å¯¹è±¡ã€‚é”çš„ä¸»è¦æ¥å£æ˜¯é¢å‘äº‹åŠ¡çš„ï¼ˆè¯·å‚è§ IPC äº‹åŠ¡å’Œäº‹ä»¶è°ƒåº¦ï¼‰ã€‚åœ¨äº‹åŠ¡æœŸé—´ï¼Œçº¿ç¨‹æŒæœ‰é”ã€‚å½“å®ƒä»äº‹åŠ¡è¿”å›æ—¶ï¼Œå°†é‡Šæ”¾é”ã€‚

&emsp;Remote Procedure Call (RPC) Objects

&emsp;é¡¾åæ€ä¹‰ï¼ŒRPC å¯¹è±¡æ—¨åœ¨ä¿ƒè¿›å’Œä¼˜åŒ–è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ã€‚RPC å¯¹è±¡çš„ä¸»è¦æ¥å£æ˜¯é¢å‘äº‹åŠ¡çš„ï¼ˆè¯·å‚è§ IPC äº‹åŠ¡å’Œäº‹ä»¶è°ƒåº¦ï¼‰

&emsp;åˆ›å»º RPC å¯¹è±¡æ—¶ï¼Œå°†å®šä¹‰ä¸€ç»„å‚æ•°å—æ ¼å¼ã€‚å½“å®¢æˆ·ç«¯è¿›è¡Œ RPCï¼ˆå¯¹è±¡ä¸Šçš„å‘é€ï¼‰æ—¶ï¼Œå®ƒä¼šå¯¼è‡´åœ¨å¯¹è±¡ä¸Šåˆ›å»ºé¢„å®šä¹‰æ ¼å¼ä¹‹ä¸€çš„æ¶ˆæ¯å¹¶æ’é˜Ÿï¼Œç„¶åæœ€ç»ˆä¼ é€’ç»™æœåŠ¡å™¨ï¼ˆæ¥æ”¶æ–¹ï¼‰ã€‚å½“æœåŠ¡å™¨ä»äº‹åŠ¡è¿”å›æ—¶ï¼Œåº”ç­”å°†è¿”å›ç»™å‘é€æ–¹ã€‚Mach å°è¯•é€šè¿‡ä½¿ç”¨å®¢æˆ·ç«¯çš„èµ„æºæ‰§è¡ŒæœåŠ¡å™¨æ¥ä¼˜åŒ–äº‹åŠ¡;è¿™ç§°ä¸ºçº¿ç¨‹è¿ç§»ã€‚

&emsp;Time Management

&emsp;ä»¥ Mach ä¸ºå•ä½çš„ä¼ ç»Ÿæ—¶é—´æŠ½è±¡æ˜¯æ—¶é’Ÿï¼Œå®ƒæä¾›äº†ä¸€ç»„åŸºäº mach_timespec_t çš„å¼‚æ­¥æŠ¥è­¦æœåŠ¡ã€‚æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ—¶é’Ÿå¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡å®šä¹‰ä¸€ä¸ªå•è°ƒé€’å¢çš„æ—¶é—´å€¼ï¼Œä»¥çº³ç§’ä¸ºå•ä½è¡¨ç¤ºã€‚å®æ—¶æ—¶é’Ÿæ˜¯å†…ç½®çš„ï¼Œæ˜¯æœ€é‡è¦çš„ï¼Œä½†ç³»ç»Ÿä¸­å¯èƒ½æœ‰å…¶ä»–æ—¶é’Ÿç”¨äºå…¶ä»–æ—¶é—´æ¦‚å¿µã€‚æ—¶é’Ÿæ”¯æŒè·å–å½“å‰æ—¶é—´ã€åœ¨ç»™å®šæ—¶é—´æ®µå†…ä¼‘çœ ã€è®¾ç½®é—¹é’Ÿï¼ˆåœ¨ç»™å®šæ—¶é—´å‘é€çš„é€šçŸ¥ï¼‰ç­‰æ“ä½œã€‚

&emsp;mach_timespec_t API åœ¨ OS X ä¸­å·²å¼ƒç”¨ã€‚è¾ƒæ–°å’Œé¦–é€‰çš„ API åŸºäºè®¡æ—¶å™¨å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡åˆä½¿ç”¨ AbsoluteTime ä½œä¸ºåŸºæœ¬æ•°æ®ç±»å‹ã€‚AbsoluteTime æ˜¯ä¸€ç§ä¾èµ–äºè®¡ç®—æœºçš„ç±»å‹ï¼Œé€šå¸¸åŸºäºå¹³å°æœ¬æœºæ—¶åŸºã€‚æä¾›äº†ä¾‹ç¨‹ï¼Œç”¨äºå°† AbsoluteTime å€¼ä¸å…¶ä»–æ•°æ®ç±»å‹ï¼ˆå¦‚çº³ç§’ï¼‰ç›¸äº’è½¬æ¢ã€‚å®šæ—¶å™¨å¯¹è±¡æ”¯æŒå¼‚æ­¥ã€æ— æ¼‚ç§»é€šçŸ¥ã€å–æ¶ˆå’Œè¿‡æ—©è­¦æŠ¥ã€‚å®ƒä»¬æ¯”æ—¶é’Ÿæ›´æœ‰æ•ˆï¼Œå¹¶ä¸”å…è®¸æ›´é«˜çš„åˆ†è¾¨ç‡ã€‚




















> &emsp;**Mach ä¸º XNU çš„å¾®å†…æ ¸ï¼ŒMach å¼‚å¸¸ä¸ºæœ€åº•å±‚çš„å†…æ ¸çº§å¼‚å¸¸ã€‚åœ¨ iOS ç³»ç»Ÿä¸­ï¼Œåº•å±‚ Crash å…ˆè§¦å‘ Mach å¼‚å¸¸ï¼Œç„¶åå†è½¬æ¢ä¸ºå¯¹åº”çš„ Signal ä¿¡å·**ã€‚


















&emsp;Mach å¼•å…¥äº† port çš„æ¦‚å¿µç”¨ä»¥è¡¨ç¤ºåŒå‘çš„ IPC (è¿›ç¨‹é—´é€šä¿¡ Inter-Process Communicationï¼‰ï¼Œå®ƒå°±åƒ UNIX ä¸‹çš„æ–‡ä»¶ä¸€æ ·æ‹¥æœ‰æƒé™ä¿¡æ¯ï¼Œä½¿å¾—å…¶å®‰å…¨æ¨¡å‹éå¸¸æ¥è¿‘ UNIXã€‚å¹¶ä¸”ï¼ŒMach ä½¿å¾—ä»»ä½•è¿›ç¨‹éƒ½å¯ä»¥æ‹¥æœ‰ä¸€èˆ¬ç³»ç»Ÿä¸­å†…æ ¸æ‰æœ‰çš„æƒé™ï¼Œä»è€Œå…è®¸ç”¨æˆ·è¿›ç¨‹å®ç°ä¸ç¡¬ä»¶äº¤äº’ç­‰æ“ä½œã€‚

&emsp;Port æœºåˆ¶åœ¨ IPC ä¸­çš„åº”ç”¨è¯¥æ˜¯ Mach ä¸å…¶ä»–ä¼ ç»Ÿå†…æ ¸çš„ä¸€å¤§åˆ†é‡ã€‚åœ¨ UNIX ä¸‹ï¼Œç”¨æˆ·è¿›ç¨‹è°ƒç”¨å†…æ ¸åªèƒ½é€šè¿‡ç³»ç»Ÿè°ƒç”¨æˆ–é™·å…¥ï¼ˆtrapï¼‰ã€‚ç”¨æˆ·è¿›ç¨‹ä½¿ç”¨ä¸€ä¸ªåº“å®‰æ’å¥½æ•°æ®çš„ä½ç½®ï¼Œç„¶åè½¯ä»¶è§¦å‘ä¸€ä¸ªä¸­æ–­ï¼Œå†…æ ¸åœ¨åˆå§‹åŒ–æ—¶ä¼šä¸ºæ‰€æœ‰ä¸­æ–­è®¾ç½® handlerï¼Œå› æ­¤ç¨‹åºè§¦å‘ä¸­æ–­çš„æ—¶å€™ï¼Œæ§åˆ¶æƒå°±è½¬ç§»åˆ°äº†å†…æ ¸ï¼Œåœ¨ä¸€äº›å¿…è¦çš„æ£€æŸ¥ä¹‹åå³å¯å¾—ä»¥è¿›ä¸€æ­¥æ“ä½œã€‚
åœ¨ Mach ä¸‹ï¼Œè¿™å°±äº¤ç»™äº† IPC ç³»ç»Ÿã€‚ä¸ç›´æ¥ç³»ç»Ÿè°ƒç”¨ä¸åŒï¼Œè¿™é‡Œçš„ç”¨æˆ·è¿›ç¨‹æ˜¯å…ˆå‘å†…æ ¸ç”³è¯·ä¸€ä¸ª port çš„è®¿é—®è®¸å¯ï¼Œç„¶ååˆ©ç”¨ IPC æœºåˆ¶å‘è¿™ä¸ª port å‘é€æ¶ˆæ¯ã€‚è™½è¯´å‘é€æ¶ˆæ¯çš„æ“ä½œåŒæ ·æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œä½† Mach å†…æ ¸çš„å·¥ä½œå½¢å¼æœ‰äº›ä¸åŒâ€”â€”handler çš„å·¥ä½œå¯ä»¥äº¤ç”±å…¶ä»–è¿›ç¨‹å®ç°ã€‚


```c++
(lldb) help process handle
     Manage LLDB handling of OS signals for the current target process. Defaults to showing current policy.

Syntax: process handle <cmd-options> [<unix-signal> [<unix-signal> [...]]]

Command Options Usage:
  process handle [-n <boolean>] [-p <boolean>] [-s <boolean>] [<unix-signal> [<unix-signal> [...]]]

       -n <boolean> ( --notify <boolean> )
            Whether or not the debugger should notify the user if the signal is received.

       -p <boolean> ( --pass <boolean> )
            Whether or not the signal should be passed to the process.

       -s <boolean> ( --stop <boolean> )
            Whether or not the process should be stopped if the signal is received.

If no signals are specified, update them all.  If no update option is specified, list the current values.
     
     This command takes options and free-form arguments.  If your arguments
     resemble option specifiers (i.e., they start with a - or --), you must use
     ' -- ' between the end of the command options and the beginning of the
     arguments.
```


&emsp;`UncaughtExceptionHandlers` å‡½æ•°æ‰§è¡Œç»“æŸåï¼Œ abort() -> pthread_kill æŠ›å‡ºçš„ `SIGABRT` ä¿¡å·ï¼Œä½¿ç”¨ `signal(SIGABRT, MySignalHandler);` æ•è·ä¸åˆ°ï¼ 



## å‚è€ƒé“¾æ¥
**å‚è€ƒé“¾æ¥:ğŸ”—**
+ [Mach-ç»´åŸºç™¾ç§‘](https://zh.wikipedia.org/wiki/Mach)
+ [iOS å¼‚å¸¸ä¿¡å·æ€è€ƒ](https://minosjy.com/2021/04/10/00/377/)
+ [Linux å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ è¿›ç¨‹çº¿ç¨‹ç»ˆæ­¢å‡½æ•°å°ç»“](https://www.cnblogs.com/biyeymyhjob/archive/2012/10/11/2720377.html)
+ [pthread_killå¼•å‘çš„äº‰è®º](https://www.jianshu.com/p/756240e837dd)
+ [çº¿ç¨‹çš„ä¿¡å·pthread_kill()å‡½æ•°ï¼ˆçº¿ç¨‹å››ï¼‰](https://blog.csdn.net/littesss/article/details/71156793)
+ [åŸå­æ“ä½œatomic_fetch_add](https://www.jianshu.com/p/985fb2e9c201)
+ [iOS Crash åˆ†ææ”»ç•¥](https://zhuanlan.zhihu.com/p/159301707)
+ [Handling unhandled exceptions and signals](https://www.cocoawithlove.com/2010/05/handling-unhandled-exceptions-and.html)
+ [Apple æºç æ–‡ä»¶ä¸‹è½½åˆ—è¡¨](https://opensource.apple.com/tarballs/)
+ [iOS @try @catchå¼‚å¸¸æœºåˆ¶](https://www.jianshu.com/p/f28b9b3f8e44)

+ [iOSæ€§èƒ½ä¼˜åŒ–å®è·µï¼šå¤´æ¡æŠ–éŸ³å¦‚ä½•å®ç°OOMå´©æºƒç‡ä¸‹é™50%+](https://mp.weixin.qq.com/s?__biz=MzI1MzYzMjE0MQ==&mid=2247486858&idx=1&sn=ec5964b0248b3526836712b26ef1b077&chksm=e9d0c668dea74f7e1e16cd5d65d1436c28c18e80e32bbf9703771bd4e0563f64723294ba1324&cur_album_id=1590407423234719749&scene=189#wechat_redirect)




+ [iOS Crashä¹‹NSInvalidArgumentException](https://blog.csdn.net/skylin19840101/article/details/51941540)
+ [iOSè°ƒç”¨reloadRowsAtIndexPaths CrashæŠ¥å¼‚å¸¸NSInternalInconsistencyException](https://blog.csdn.net/sinat_27310637/article/details/62225658)
+ [iOSå¼€å‘è´¨é‡çš„é‚£äº›äº‹](https://zhuanlan.zhihu.com/p/21773994)
+ [NSExceptionæŠ›å‡ºå¼‚å¸¸&NSErrorç®€å•ä»‹ç»](https://www.jianshu.com/p/23913bbc4ee5)
+ [NSException:é”™è¯¯å¤„ç†æœºåˆ¶---è°ƒè¯•ä¸­ä»¥åŠä¸Šæ¶åçš„äº§å“å¦‚ä½•æ”¶é›†é”™è¯¯æ—¥å¿—](https://blog.csdn.net/lcl130/article/details/41891273)
+ [Exception Programming Topics](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Exceptions/Exceptions.html#//apple_ref/doc/uid/10000012-BAJGFBFB)
+ [iOSè¢«å¼€å‘è€…é—å¿˜åœ¨è§’è½çš„NSException-å…¶å®å®ƒå¾ˆå¼ºå¤§](https://www.jianshu.com/p/05aad21e319e)
+ [iOS runtimeå®ç”¨ç¯‡--å’Œå¸¸è§å´©æºƒsay good-byeï¼](https://www.jianshu.com/p/5d625f86bd02)
+ [å¼‚å¸¸å¤„ç†NSExceptionçš„ä½¿ç”¨ï¼ˆæ€ç»´ç¯‡ï¼‰](https://www.cnblogs.com/cchHers/p/15116833.html)
+ [å¼‚å¸¸ç»Ÿè®¡- IOS æ”¶é›†å´©æºƒä¿¡æ¯ NSEXCEPTIONç±»](https://www.freesion.com/article/939519506/)
+ [NSExceptionå¼‚å¸¸å¤„ç†](https://www.cnblogs.com/fuland/p/3668004.html)
+ [iOS Crashä¹‹NSGenericException](https://blog.csdn.net/skylin19840101/article/details/51945558)
+ [iOSå¼‚å¸¸å¤„ç†](https://www.jianshu.com/p/1e4d5421d29c)
+ [iOSå¼‚å¸¸å¤„ç†](https://www.jianshu.com/p/59927211b745)
+ [iOS crashåˆ†ç±»,Machå¼‚å¸¸ã€Unix ä¿¡å·å’ŒNSException å¼‚å¸¸](https://blog.csdn.net/u014600626/article/details/119517507?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.no_search_link&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.no_search_link)
+ [iOS Machå¼‚å¸¸å’Œsignalä¿¡å·](https://developer.aliyun.com/article/499180)


