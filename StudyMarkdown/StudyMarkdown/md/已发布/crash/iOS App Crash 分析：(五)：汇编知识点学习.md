# iOS App Crash åˆ†æï¼š(äº”)ï¼š

&emsp;æœ¬æ¥æœ¬ç¯‡æ ‡é¢˜æ˜¯ï¼šã€ŠiOS App Crash åˆ†æï¼š(äº”)ï¼šå‡½æ•°å †æ ˆè·å–è§£æã€‹ï¼Œç°åœ¨ä¿®æ”¹ä¸ºã€ŠiOS App Crash åˆ†æï¼š(äº”)ï¼šæ±‡ç¼–çŸ¥è¯†ç‚¹å­¦ä¹ ã€‹

&emsp;æ±‡ç¼–è¯­è¨€æ˜¯ä½¿ç”¨åŠ©è®°ç¬¦ä»£æ›¿æœºå™¨æŒ‡ä»¤çš„ä¸€ç§ç¼–ç¨‹è¯­è¨€ï¼Œæ±‡ç¼–æŒ‡ä»¤å’Œæœºå™¨æŒ‡ä»¤æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œæ‰€ä»¥æ‹¿åˆ°äºŒè¿›åˆ¶å°±å¯ä»¥è¿›è¡Œåæ±‡ç¼–ã€‚

&emsp;è™½ç„¶æˆ‘ä»¬æ—¥å¸¸å¼€å‘å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸éœ€è¦ç›´æ¥ç¼–å†™æ±‡ç¼–æŒ‡ä»¤ï¼Œä½†æ˜¯èƒ½çœ‹æ‡‚æ±‡ç¼–æŒ‡ä»¤èƒ½åˆ†æå¯¹åº”çš„ä»£ç é€»è¾‘å¯¹æˆ‘ä»¬ç†è§£è®¡ç®—æœºè¿è¡Œé€»è¾‘è¿˜æ˜¯æœ‰æå¤§ä¿ƒè¿›ä½œç”¨çš„ï¼ˆå†…åŠŸï¼‰ã€‚ç‰¹åˆ«æ˜¯å½“æˆ‘ä»¬è§£å†³ Crash é—®é¢˜æ—¶ï¼Œåˆ©ç”¨æ±‡ç¼–è°ƒè¯•æŠ€å·§è¿›è¡Œåæ±‡ç¼–æ›´æ˜“ä½¿æˆ‘ä»¬å®šä½åˆ°é—®é¢˜æ ¹æºã€‚ä»»ä½•é«˜çº§è¯­è¨€æœ€ç»ˆéƒ½ä¼šè¢«ç¼–è¯‘æˆæ±‡ç¼–ï¼Œå­¦ä¹ äº†è§£æ±‡ç¼–çš„ç›¸å…³çŸ¥è¯†ï¼Œå¯ä»¥æ›´å¥½çš„æ—¥å¸¸å¼€å‘ã€å­¦ä¹ æ¢ç´¢ä¸­å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„æ’æŸ¥é—®é¢˜ã€ç†è§£åº•å±‚è¿è¡Œçš„æœºåˆ¶ã€‚
 
&emsp;å­¦ä¹ å‡½æ•°è°ƒç”¨æ ˆç›¸å…³çš„å†…å®¹ä¹‹å‰æˆ‘ä»¬éœ€è¦äº†è§£æ±‡ç¼–ç›¸å…³çš„ä¸‰ä¸ªé‡è¦æ¦‚å¿µï¼šå¯„å­˜å™¨ã€å †æ ˆã€æŒ‡ä»¤é›†ï¼Œå…¶ä¸­å¯„å­˜å™¨ã€æŒ‡ä»¤é›†åœ¨ä¸åŒçš„æ¶æ„ä¸‹æœ‰ä¸åŒçš„åå­—ï¼Œä½†æ˜¯åŸºæœ¬æ¦‚å¿µéƒ½æ˜¯ä¸€è‡´çš„ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥ x86 å’Œ arm64 ä¸ºä¾‹æ¥å­¦ä¹ ã€‚

## å¯„å­˜å™¨æ¦‚è¿°

&emsp;åœ¨é«˜çº§è¯­è¨€ï¼Œå¦‚ Objective-Cã€C å’Œ C++ é‡Œï¼Œæ“ä½œå¯¹è±¡æ˜¯å˜é‡ï¼›åœ¨ ARM æ±‡ç¼–é‡Œï¼Œæ“ä½œå¯¹è±¡æ˜¯å¯„å­˜å™¨ï¼ˆregisterï¼‰ã€å†…å­˜å’Œæ ˆï¼ˆstackï¼‰ã€‚å…¶ä¸­å¯„å­˜å™¨å¯ä»¥çœ‹æˆ CPU è‡ªå¸¦çš„å˜é‡ï¼Œå®ƒä»¬çš„æ•°é‡ä¸€èˆ¬æ˜¯å¾ˆæœ‰é™çš„ï¼›å½“éœ€è¦æ›´å¤šå˜é‡æ—¶ï¼Œå°±å¯ä»¥æŠŠå®ƒä»¬å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼›ä¸è¿‡ï¼Œæ•°é‡ä¸Šå»äº†ï¼Œè´¨é‡ä¹Ÿä¸‹æ¥äº†ï¼Œå¯¹å†…å­˜çš„æ“ä½œæ¯”å¯¹å¯„å­˜å™¨çš„æ“ä½œè¦æ…¢çš„å¤šã€‚[iOS åº”ç”¨é€†å‘å·¥ç¨‹](http://product.m.dangdang.com/23674854.html)

&emsp;å¯„å­˜å™¨æ˜¯ CPU å†…éƒ¨ç”¨æ¥å­˜æ”¾æ•°æ®çš„ä¸€äº›å°å‹å­˜å‚¨å™¨ï¼Œç”¨æ¥æš‚æ—¶å­˜æ”¾å‚ä¸è¿ç®—çš„æ•°æ®å’Œè¿ç®—ç»“æœä»¥åŠæŒ‡ä»¤åœ°å€ã€‚ï¼ˆå…¶å®å¯„å­˜å™¨å°±æ˜¯ä¸€ç§å¸¸ç”¨çš„æ—¶åºé€»è¾‘ç”µè·¯ï¼Œä½†è¿™ç§æ—¶åºé€»è¾‘ç”µè·¯åªåŒ…å«å­˜å‚¨ç”µè·¯ã€‚å¯„å­˜å™¨çš„å­˜å‚¨ç”µè·¯æ˜¯ç”±é”å­˜å™¨æˆ–è§¦å‘å™¨æ„æˆçš„ï¼Œå› ä¸ºä¸€ä¸ªé”å­˜å™¨æˆ–è§¦å‘å™¨èƒ½å­˜å‚¨ 1 ä½äºŒè¿›åˆ¶æ•°ï¼Œæ‰€ä»¥ç”± N ä¸ªé”å­˜å™¨æˆ–è§¦å‘å™¨å¯ä»¥æ„æˆ N ä½å¯„å­˜å™¨ã€‚ï¼‰

&emsp;åœ¨è®¡ç®—æœºé¢†åŸŸï¼Œå¯„å­˜å™¨æ˜¯ CPU å†…éƒ¨çš„å…ƒä»¶ï¼ŒæŒ‰åŠŸèƒ½åˆ’åˆ†åŒ…æ‹¬ï¼šé€šç”¨å¯„å­˜å™¨ã€ä¸“ç”¨å¯„å­˜å™¨å’Œæ§åˆ¶å¯„å­˜å™¨ã€‚å¯„å­˜å™¨æ‹¥æœ‰éå¸¸é«˜çš„è¯»å†™é€Ÿåº¦ï¼Œæ‰€ä»¥åœ¨å¯„å­˜å™¨ä¹‹é—´çš„æ•°æ®ä¼ é€éå¸¸å¿«ã€‚å¯„å­˜å™¨æœ‰ä¸²è¡Œå’Œå¹¶è¡Œä¸¤ç§æ•°ç å­˜å–æ–¹å¼ã€‚å°† N ä½äºŒè¿›åˆ¶æ•°ä¸€æ¬¡å­˜å…¥å¯„å­˜å™¨æˆ–ä»å¯„å­˜å™¨ä¸­è¯»å‡ºçš„æ–¹å¼ç§°ä¸ºå¹¶è¡Œæ–¹å¼ã€‚å°† N ä½äºŒè¿›åˆ¶æ•°ä»¥æ¯æ¬¡ 1 ä½ï¼Œåˆ†æˆ N æ¬¡å­˜å…¥å¯„å­˜å™¨æˆ–ä»å¯„å­˜å™¨è¯»å‡ºï¼Œè¿™ç§æ–¹å¼ç§°ä¸ºä¸²è¡Œæ–¹å¼ã€‚å¹¶è¡Œæ–¹å¼åªéœ€ä¸€ä¸ªæ—¶é’Ÿè„‰å†²å°±å¯ä»¥å®Œæˆæ•°æ®æ“ä½œï¼Œå·¥ä½œé€Ÿåº¦å¿«ï¼Œä½†éœ€è¦ N æ ¹è¾“å…¥å’Œè¾“å‡ºæ•°æ®çº¿ã€‚ä¸²è¡Œæ–¹å¼è¦ä½¿ç”¨å‡ ä¸ªæ—¶é’Ÿè„‰å†²å®Œæˆè¾“å…¥æˆ–è¾“å‡ºæ“ä½œï¼Œå·¥ä½œé€Ÿåº¦æ…¢ï¼Œä½†åªéœ€è¦ä¸€æ ¹è¾“å…¥æˆ–è¾“å‡ºæ•°æ®çº¿ï¼Œä¼ è¾“çº¿å°‘ï¼Œé€‚ç”¨äºè¿œè·ç¦»ä¼ è¾“ã€‚[å¯„å­˜å™¨-ç™¾åº¦ç™¾ç§‘](https://baike.baidu.com/item/å¯„å­˜å™¨/187682?fr=aladdin)

## å¯„å­˜å™¨ç±»å‹

&emsp;åœ¨çœ‹å…·ä½“çš„å¯„å­˜å™¨ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå­¦ä¹ ä¸€ä¸‹ LLDB ä¸­çš„ register å‘½ä»¤ã€‚

### LLDB register å‘½ä»¤

```c++
(lldb) help register
Commands to access registers for the current thread and stack frame.

Syntax: register [read|write] ...

The following subcommands are supported:

      read  -- Dump the contents of one or more register values from the current frame.  If no register is specified, dumps them all.
      write -- Modify a single register value.

For more help on any particular subcommand, type 'help <command> <subcommand>'.
```

&emsp;register å‘½ä»¤ç”¨äºè®¿é—®å½“å‰çº¿ç¨‹å’Œ stack frame çš„å¯„å­˜å™¨çš„å‘½ä»¤ã€‚å®ƒæœ‰ä¸¤æ¡å­å‘½ä»¤ï¼š

+ readï¼šä»å½“å‰ frame Dump ä¸€ä¸ªæˆ–å¤šä¸ªå¯„å­˜å™¨ä¸­å­˜å‚¨çš„å†…å®¹ã€‚å¦‚æœæœªæŒ‡å®šå¯„å­˜å™¨ï¼Œåˆ™æŠŠå®ƒä»¬å…¨éƒ¨ Dump å‡ºæ¥ã€‚ç›´ç™½ä¸€ç‚¹ç†è§£å°±æ˜¯è¯»å–å¯„å­˜å™¨ä¸­å­˜å‚¨çš„å†…å®¹ç›´æ¥æ‰“å°å‡ºæ¥ã€‚
+ writeï¼šä¿®æ”¹å•ä¸ªå¯„å­˜å™¨çš„å€¼ã€‚

&emsp;CPU ä¸­æœ€ä¸»è¦çš„éƒ¨ä»¶æ˜¯å¯„å­˜å™¨ï¼Œå¯ä»¥é€šè¿‡æ”¹å˜å¯„å­˜å™¨çš„å†…å®¹æ¥å®ç°å¯¹ CPU çš„æ§åˆ¶ï¼Œä¸åŒ CPUï¼Œå¯„å­˜å™¨çš„ä¸ªæ•°å’Œç»“æ„æ˜¯ä¸ç›¸åŒçš„ã€‚

&emsp;ä¸‹é¢çœ‹ä¸€ä¸‹ read/write ä¸¤ä¸ªå­å‘½ä»¤åé¢éƒ½å¯ä»¥ä½¿ç”¨å“ªäº›é€‰é¡¹ï¼š

```c++
(lldb) help regist read
Dump the contents of one or more register values from the current frame.  If no register is specified, dumps them all.

Syntax: register read <cmd-options> [<register-name> [<register-name> [...]]]

Command Options Usage:
  register read [-A] [-f <format>] [-G <gdb-format>] [-s <index>] [<register-name> [<register-name> [...]]]
  register read [-Aa] [-f <format>] [-G <gdb-format>] [<register-name> [<register-name> [...]]]

       -A ( --alternate ) Display register names using the alternate register name if there is one.

       -G <gdb-format> ( --gdb-format <gdb-format> ) Specify a format using a GDB format specifier string.

       -a ( --all ) Show all register sets.

       -f <format> ( --format <format> ) Specify a format to be used for display.

       -s <index> ( --set <index> ) Specify which register sets to dump by index.
     
     This command takes options and free-form arguments.  
     If your arguments resemble option specifiers (i.e., they start with a - or --), you must use ' -- ' between the end of the command options and the beginning of the
     arguments.
```

&emsp;-A/-a é€‰é¡¹éƒ½æ˜¯æ‰“å°å‡ºå½“å‰æ‰€æœ‰å¯„å­˜å™¨ï¼Œå…¶ä¸­ -A ä½¿ç”¨ alternate å¯„å­˜å™¨åç§°ï¼ˆå¦‚æœæœ‰ï¼‰æ˜¾ç¤ºå¯„å­˜å™¨åç§°ï¼Œ-a æ˜¾ç¤ºæ‰€æœ‰å¯„å­˜å™¨çš„é›†åˆã€‚

```c++
(lldb) help register write
Modify a single register value.

Syntax: register write <register-name> <value>
```

&emsp;ä¿®æ”¹æŒ‡å®šå¯„å­˜å™¨çš„å€¼ã€‚

### ä½¿ç”¨ LLDB register å‘½ä»¤æŸ¥çœ‹ä¸åŒå¹³å°çš„å¯„å­˜å™¨

&emsp;ç„¶åæˆ‘ä»¬åœ¨ ARM64 å’Œ x86 å¹³å°ä¸‹çœ‹ä¸€ä¸‹å®ƒä»¬éƒ½æœ‰å“ªäº›å¯„å­˜å™¨ã€‚æˆ‘ä»¬åˆ†åˆ«é€‰æ‹©ä»¥æ¨¡æ‹Ÿå™¨ï¼ˆx86ï¼‰æˆ–çœŸæœºï¼ˆARM64ï¼‰è¿›å…¥ LLDB è°ƒè¯•æ¨¡å¼ï¼Œç„¶ååœ¨ Xcode æ§åˆ¶å°ä½¿ç”¨ register read å‘½ä»¤æŸ¥çœ‹æ‰“å°å†…å®¹ã€‚

#### ARM64

&emsp;å·²çŸ¥ iPhone ç³»åˆ—éƒ½æ˜¯ ARM æ¶æ„çš„ CPUï¼Œä¸”è‡ª iPhone 5s ä»¥æ¥å¼€å§‹è¿›å…¥ 64 ä½çš„ arm64 æ¶æ„ã€‚

```c++
- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
}
```

&emsp;è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ viewDidLoad å‡½æ•°ä¸ºç¤ºä¾‹ä»£ç ï¼Œä¸‹é¢å­¦ä¹ æŒ‡ä»¤é›†æ—¶ä¹Ÿä»¥ viewDidLoad å‡½æ•°ä¸ºç¤ºä¾‹ä»£ç ï¼Œåœ¨ viewDidLoad å‡½æ•°å¤„æ‰“ä¸€ä¸ªæ–­ç‚¹ï¼Œé€‰ä¸­çœŸæœºï¼ˆiPhone Xï¼‰ç„¶åè¿è¡Œç¨‹åºï¼Œæ–­ç‚¹å‘½ä¸­åè¿›å…¥ LLDB è°ƒè¯•æ¨¡å¼ï¼Œä½¿ç”¨ `register read --all` å‘½ä»¤æ‰“å°æ‰€æœ‰å¯„å­˜å™¨ï¼Œå¯çœ‹åˆ°å…¶ä¸­åŒ…æ‹¬ï¼šGeneral Purpose Registersã€Floating Point Registersã€Exception State Registers ä¸‰ä¸ªåˆ†ç»„çš„å¯„å­˜å™¨ã€‚

&emsp;æµ®ç‚¹å’Œå‘é‡å¯„å­˜å™¨ï¼šå› ä¸ºæµ®ç‚¹æ•°çš„å­˜å‚¨ä»¥åŠå…¶è¿ç®—çš„ç‰¹æ®Šæ€§ï¼ŒCPU ä¸­ä¸“é—¨æä¾›æµ®ç‚¹å¯„å­˜å™¨æ¥å¤„ç†æµ®ç‚¹æ•°ã€‚ç°åœ¨ CPU æ”¯æŒå‘é‡è¿ç®—ï¼ˆå‘é‡è¿ç®—åœ¨å›¾å½¢å¤„ç†ç›¸å…³çš„é¢†åŸŸç”¨çš„éå¸¸å¤šï¼‰ï¼Œä¸ºäº†æ”¯æŒå‘é‡è®¡ç®—ï¼Œç³»ç»Ÿä¹Ÿæä¾›äº†ä¼—å¤šçš„å‘é‡å¯„å­˜å™¨ã€‚

&emsp;è¿™é‡Œæˆ‘ä»¬åªä¸“æ³¨äº General Purpose Registers åˆ†ç»„ï¼Œçœ‹åˆ° ARM64 ä¸‹æœ‰ï¼šx0-x28ï¼ˆé€šç”¨å¯„å­˜å™¨ï¼‰ã€fpï¼ˆx29 frame pointer æ ˆåº•å¯„å­˜å™¨ï¼‰ã€lrï¼ˆx30 link register é“¾æ¥å¯„å­˜å™¨ï¼‰ã€spï¼ˆx31 stack pointer æ ˆé¡¶å¯„å­˜å™¨ï¼‰ã€pcï¼ˆx32 program counter ç¨‹åºè®¡æ•°å™¨ï¼‰ã€cpsrï¼ˆx33 çŠ¶æ€å¯„å­˜å™¨ï¼‰å…± 34 ä¸ª 64 bit çš„ General Purpose Registersï¼Œw0-w28 è¡¨ç¤º x0-x28 çš„ä½ 32 bitã€‚

&emsp;é€šç”¨å¯„å­˜å™¨ä¹Ÿç§°ä¸ºæ•°æ®åœ°å€å¯„å­˜å™¨ã€‚é€šå¸¸ç”¨æ¥åšæ•°æ®è®¡ç®—çš„ä¸´æ—¶å­˜å‚¨ã€ç´¯åŠ ã€è®¡æ•°ã€åœ°å€ä¿å­˜ç­‰åŠŸèƒ½ã€‚å®šä¹‰è¿™äº›å¯„å­˜å™¨çš„ä½œç”¨ä¸»è¦æ˜¯ç”¨äºåœ¨ CPU æŒ‡ä»¤ä¸­ä¿å­˜æ“ä½œæ•°ï¼Œåœ¨ CPU ä¸­å½“åšä¸€äº›å¸¸è§„å˜é‡æ¥ä½¿ç”¨ã€‚

&emsp;w0-w28 è¡¨ç¤º x0-x28 çš„ä½ 32 bitï¼Œå› ä¸º 64 ä½ CPU å¯ä»¥å…¼å®¹ 32 ä½ï¼Œæ‰€ä»¥å¯ä»¥åªä½¿ç”¨ 64 ä½å¯„å­˜å™¨çš„ä½ 32 ä½ã€‚

&emsp;åœ¨ ARM64 æ¶æ„ä¸‹å¯„å­˜å™¨ä»¥ x å¼€å¤´è®¿é—®æ—¶æ˜¯å®Œæ•´çš„ 64 bitï¼Œä½¿ç”¨ w å¼€å¤´è®¿é—®æ—¶æ˜¯ä½ 32 bitã€‚

&emsp;é€šå¸¸ï¼ŒCPU ä¼šå…ˆå°†å†…å­˜ä¸­çš„æ•°æ®å­˜å‚¨åˆ°é€šç”¨å¯„å­˜å™¨ä¸­ï¼Œç„¶åå†å¯¹å¯„å­˜å™¨ä¸­çš„æ•°æ®è¿›è¡Œè¿ç®—ï¼Œå‡è®¾å†…å­˜ä¸­æœ‰å—çº¢è‰²å†…å­˜ç©ºé—´çš„å€¼æ˜¯ 3ï¼Œç°åœ¨æƒ³æŠŠå®ƒçš„å€¼åŠ  1ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åˆ°è“è‰²å†…å­˜ç©ºé—´ï¼ŒCPU é¦–å…ˆä¼šå°†çº¢è‰²å†…å­˜ç©ºé—´çš„å€¼æ”¾åˆ° x0 å¯„å­˜å™¨ä¸­ï¼šmov x0, çº¢è‰²å†…å­˜ç©ºé—´
ï¼Œç„¶åè®© x0 å¯„å­˜å™¨ä¸ 1 ç›¸åŠ ï¼šadd X0, 1ï¼Œæœ€åå°†å€¼èµ‹å€¼ç»™å†…å­˜ç©ºé—´ï¼šmov è“è‰²å†…å­˜ç©ºé—´, x0ã€‚

```c++
(lldb) register read --all
General Purpose Registers:
        x0 = 0x00000001ï¼Œ02d08360  // w0 = 0x02d08360
        x1 = 0x00000001ï¼Œ9b043c57  // w1 = 0x9b043c57
        x2 = 0x00000000ï¼Œ00000001  // w2 = 0x00000001
        x3 = 0x00000001ï¼Œ6d59db90  // w3 = 0x6d59db90
        x4 = 0x00000000ï¼Œ00000010  // w4 = 0x00000010
        x5 = 0x00000000ï¼Œ00000020  // w5 = 0x00000020
        x6 = 0x00000001ï¼Œ6d59d890  // w6 = 0x6d59d890
        x7 = 0x00000000ï¼Œ00000000  // w7 = 0x00000000
        x8 = 0x00000001ï¼Œ9b043000  // w8 = 0x9b043000
        x9 = 0x00000000ï¼Œ00000000  // w9 = 0x00000000
       x10 = 0x00000000ï¼Œ0000002f  // w10 = 0x0000002f
       x11 = 0x00000001ï¼Œ03023258  // w11 = 0x03023258
       x12 = 0x00000000ï¼Œ00000025  // w12 = 0x00000025
       x13 = 0x00000000ï¼Œ00000000  // w13 = 0x00000000
       x14 = 0x00000000ï¼Œ00000000  // w14 = 0x00000000
       x15 = 0xffffffffï¼Œffffffff  // w15 = 0xffffffff
       x16 = 0x00000001ï¼Œ0286d2b2  (void *)0x78e0000000010286  // w16 = 0x0286d2b2
       x17 = 0x00000001ï¼Œ02865f60  TEST_MENU`-[ViewController viewDidLoad] at ViewController.m:16 // w17 = 0x02865f60
       x18 = 0x00000000ï¼Œ00000000  // w18 = 0x00000000
       x19 = 0x00000001ï¼Œ02d08360  // w19 = 0x02d08360
       x20 = 0x00000000ï¼Œ00000000  // w20 = 0x00000000
       x21 = 0x00000001ï¼Œf2d9c000  (void *)0x000000019efcba50  // w21 = 0xf2d9c000
       x22 = 0x00000001ï¼Œ9ba00157  // w22 = 0x9ba00157
       x23 = 0x00000001ï¼Œ9af2039d  // w23 = 0x9af2039d
       x24 = 0x00000000ï¼Œ00000000  // w24 = 0x00000000
       x25 = 0x00000001ï¼Œf3987000  UIKitCore`_UIWindowSceneActivationSettings._pinchActivationScaleThreshold  // w25 = 0xf3987000
       x26 = 0x00000001ï¼Œ02d06280  // w26 = 0x02d06280
       x27 = 0x00000001ï¼Œ9b639957  // w27 = 0x9b639957
       x28 = 0x00000001ï¼Œf84cf4f0  CoreFoundation`__NSArray0__struct  // w28 = 0xf84cf4f0
       
        fp = 0x000000016d59da00
        lr = 0x00000001830f26c8  UIKitCore`-[UIViewController _sendViewDidLoadWithAppearanceProxyObjectTaggingEnabled] + 104
        sp = 0x000000016d59d9e0
        pc = 0x0000000102865f74  TEST_MENU`-[ViewController viewDidLoad] + 20 at ViewController.m:17:5
      cpsr = 0x40000000
      
Floating Point Registers:
        ...

Exception State Registers:
       ...

```

&emsp;ç„¶åæˆ‘ä»¬å†ä½¿ç”¨ register read --alternate/register read -A å‘½ä»¤æ‰“å°ï¼Œçœ‹ä¸€ä¸‹å¯„å­˜å™¨çš„å¤‡ç”¨åï¼ˆalternate register nameï¼‰ã€‚

```c++
(lldb) register read --alternate
General Purpose Registers:
      arg1 = 0x0000000102d08360
      arg2 = 0x000000019b043c57  
      arg3 = 0x0000000000000001
      arg4 = 0x000000016d59db90
      arg5 = 0x0000000000000010
      arg6 = 0x0000000000000020
      arg7 = 0x000000016d59d890
      arg8 = 0x0000000000000000
      ...
```

&emsp;å¯çœ‹åˆ°æˆ‘ä»¬å¬è¿‡äº†å¾ˆå¤šæ¬¡çš„è¯´ x0-x7 æ˜¯å‚æ•°å¯„å­˜å™¨ï¼Œè¿™é‡Œä¹Ÿå¾—åˆ°äº†å°è¯ x0-x7 å¯„å­˜å™¨çš„å¤‡ç”¨åæ­£æ˜¯ arg1-arg8ï¼Œå¦‚ä¸‹æˆ‘ä»¬ç›´æ¥è¯»å– x0/arg1 æ‰“å°çš„éƒ½æ˜¯ x0ï¼Œç„¶åæˆ‘ä»¬æ‰“å° selfï¼Œçœ‹åˆ°å…¶å€¼ä¹Ÿæ­£æ˜¯ x0 å¯„å­˜å™¨ä¸­ä¿å­˜çš„å€¼ï¼Œç„¶åæ‰“å° `_cmd` çš„å€¼æ˜¯ viewDidLoadï¼Œç„¶åæŠŠ x1 å¯„å­˜å™¨çš„å€¼å¼ºè½¬ä¸º SEL åçœ‹åˆ°çš„ä¹Ÿæ˜¯ viewDidLoadï¼Œå³å½“å‰ x0 x1 å¯„å­˜å™¨ä¸­å­˜çš„å€¼æ­£æ˜¯å‡½æ•°çš„å‰ä¸¤ä¸ªå‚æ•°ã€‚

```c++
(lldb) register read x0
      x0 = 0x0000000102d08360
(lldb) register read arg1
      x0 = 0x0000000102d08360
(lldb) p self
(ViewController *) $0 = 0x0000000102d08360
(lldb) p _cmd
(SEL) $1 = "viewDidLoad"
(lldb) p (SEL)0x000000019b043c57
(SEL) $2 = "viewDidLoad"
```

&emsp;ä¸‹é¢æˆ‘ä»¬æŒ‘é€‰ ARM64 ä¸­æ¯”è¾ƒé‡è¦çš„å¯„å­˜å™¨æ¥åˆ†æå…¶åŠŸèƒ½/ä½œç”¨ã€‚

##### fp

+ fpï¼ˆx29 frame pointer æ ˆåº•å¯„å­˜å™¨ï¼‰ï¼Œé€šå¸¸ç”¨ä½œå¸§æŒ‡é’ˆ fpï¼ˆframe pointerï¼‰ï¼Œæ ˆå¸§åŸºå€å¯„å­˜å™¨ï¼ŒæŒ‡å‘å½“å‰å‡½æ•°æ ˆå¸§çš„æ ˆåº•ã€‚

##### lr

+ lrï¼ˆx30 link register é“¾æ¥å¯„å­˜å™¨ï¼‰ï¼Œå®ƒå­˜å‚¨çš„æ•°æ®æ˜¯æ–¹æ³• Caller æ‰§è¡Œçš„æœ€åä¸€è¡ŒæŒ‡ä»¤çš„ä¸‹ä¸€è¡Œçš„åœ°å€ï¼Œå®ƒçš„ä½œç”¨ä¹Ÿå¾ˆå¥½ç†è§£ï¼šå½“ Callee æ‰§è¡Œå®Œäº†ä¹‹åè¦è¿”å› Caller ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œä½†æ˜¯ CPU è¦å¦‚ä½•çŸ¥é“ç»§ç»­æ‰§è¡Œå“ªä¸€è¡ŒæŒ‡ä»¤å‘¢ï¼Ÿæ­£æ˜¯é  lr å¯„å­˜å™¨ä¿å­˜äº†ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼ŒCaller æ–¹æ³•/å‡½æ•°æ‰èƒ½å¾—ä»¥æ­£å¸¸é¡ºåºç»§ç»­æ‰§è¡Œã€‚

##### sp

+ spï¼ˆx31 stack pointer æ ˆé¡¶å¯„å­˜å™¨ï¼‰åœ¨è®¡ç®—æœºç§‘å­¦ä¸­æ ˆæ˜¯éå¸¸é‡è¦çš„æœ¯è¯­ã€‚sp å¯„å­˜å™¨å­˜æ”¾äº†ä¸€ä¸ªæŒ‡å‘æ ˆé¡¶çš„æŒ‡é’ˆã€‚

##### pc

+ pcï¼ˆx32 program counter ç¨‹åºè®¡æ•°å™¨ï¼‰ï¼Œpc å¯„å­˜å™¨é‡Œé¢çš„å€¼ä¿å­˜çš„å°±æ˜¯ CPU æ¥ä¸‹æ¥éœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ã€‚åœ¨ ARM64 ä¸­ï¼Œè¿›ç¨‹æ˜¯ä¸èƒ½æ”¹å†™ pc å¯„å­˜å™¨çš„ï¼Œå®ƒå­˜æ”¾äº†æ‰§è¡ŒæŒ‡ä»¤çš„åœ°å€ï¼Œåœ¨æ¯ä¸ªæŒ‡ä»¤æ‰§è¡Œå®Œæˆåä¼šè‡ªåŠ¨å¢åŠ è®°å½•ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚

> pc (x32 program counter)ï¼Œä¸ºæŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨ï¼Œå®ƒæŒ‡ç¤ºäº† CPU å½“å‰è¦è¯»å–æŒ‡ä»¤çš„åœ°å€ã€‚
> åœ¨å†…å­˜/ç£ç›˜ä¸Šï¼ŒæŒ‡ä»¤å’Œæ•°æ®æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œéƒ½æ˜¯äºŒè¿›åˆ¶ä¿¡æ¯ã€‚
> CPU åœ¨å·¥ä½œæ—¶ï¼Œå°†æœ‰çš„ä¿¡æ¯çœ‹ä½œæŒ‡ä»¤ï¼Œæœ‰çš„çœ‹ä½œæ•°æ®ï¼Œä¸ºåŒæ ·çš„ä¿¡æ¯èµ‹äºˆäº†ä¸åŒçš„æ„ä¹‰ï¼Œä¾‹å¦‚ï¼š1110 0000 0000 0011 0000 1000 1010 1010ï¼Œå¯ä»¥å½“åšæ•°æ® 0xE003008AAï¼Œä¹Ÿå¯ä»¥å½“åšæŒ‡ä»¤ mov x0, x8ï¼ŒCPU æ ¹æ®ä»€ä¹ˆå°†å†…å­˜ä¸­çš„ä¿¡æ¯çœ‹ä½œæŒ‡ä»¤å‘¢ï¼ŸCPU å°† pc æŒ‡å‘çš„å†…å­˜å•å…ƒçš„å†…å®¹çœ‹ä½œæŒ‡ä»¤ï¼Œå¦‚æœå†…å­˜ä¸­çš„æŸæ®µå†…å®¹æ›¾ç»è¢« CPU æ‰§è¡Œè¿‡ï¼Œé‚£ä¹ˆå®ƒæ‰€åœ¨çš„å†…å­˜å•å…ƒå¿…ç„¶è¢« pc æŒ‡å‘è¿‡ã€‚
> CPU ä»ä½•å¤„æ‰§è¡ŒæŒ‡ä»¤ï¼Œæ˜¯ç”± pc ä¸­çš„å†…å®¹å†³å®šçš„ï¼Œå¯ä»¥é€šè¿‡æ”¹å˜ pc çš„å†…å®¹æ¥æ§åˆ¶ CPU æ‰§è¡Œç›®æ ‡æŒ‡ä»¤ï¼ŒARM64 æä¾›äº†ä¸€ä¸ª mov æŒ‡ä»¤ï¼ˆä¼ é€æŒ‡ä»¤ï¼‰ï¼Œå¯ä»¥ç”¨æ¥æ”¹å˜å¤§éƒ¨åˆ†å¯„å­˜å™¨çš„å€¼ï¼Œä¾‹å¦‚ mov x0, #10ã€mov x1, #20ï¼Œä½†æ˜¯ï¼Œmov æŒ‡ä»¤å¹¶ä¸èƒ½ç”¨äºè®¾ç½® pc çš„å€¼ï¼ŒARM64 æ²¡æœ‰æä¾›è¿™æ ·çš„åŠŸèƒ½ã€‚ARM64 æä¾›äº†å¦å¤–çš„æŒ‡ä»¤æ¥ä¿®æ”¹ pc çš„å€¼ï¼Œè¿™äº›æŒ‡ä»¤ç»Ÿä¸€ç§°ä¸ºè½¬ç§»æŒ‡ä»¤ï¼Œå…¶ä¸­æœ€ç®€å•çš„æ˜¯ bl æŒ‡ä»¤ã€‚[iOSé€†å‘ ï¼šåˆè¯†æ±‡ç¼–](https://zhuanlan.zhihu.com/p/369071456)

> é«˜é€Ÿç¼“å­˜ï¼š
> iPhoneX ä¸Šæ­è½½çš„ arm å¤„ç†å™¨ A11ï¼Œå®ƒçš„ 1 çº§ç¼“å­˜çš„å®¹é‡æ˜¯ 64kbï¼Œ2 çº§ç¼“å­˜çš„å®¹é‡æ˜¯ 8M iPhoneX ä¸Šæ­è½½çš„ arm å¤„ç†å™¨ A11ï¼Œå®ƒçš„ 1 çº§ç¼“å­˜çš„å®¹é‡æ˜¯ 64kbï¼Œ2 çº§ç¼“å­˜çš„å®¹é‡æ˜¯ 8Mã€‚
> CPU æ¯æ‰§è¡Œä¸€æ¡æŒ‡ä»¤å‰éƒ½éœ€è¦ä»å†…å­˜ä¸­å°†æŒ‡ä»¤è¯»å–åˆ° CPU å†…å­˜å¹¶æ‰§è¡Œï¼Œè€Œå¯„å­˜å™¨çš„è¿è¡Œé€Ÿåº¦ç›¸æ¯”å†…å­˜è¯»å†™è¦å¿«å¾ˆå¤šï¼Œä¸ºäº†æ€§èƒ½ï¼ŒCPU è¿˜é›†æˆäº†ä¸€ä¸ªé«˜é€Ÿç¼“å­˜åŒºåŸŸã€‚å½“ç¨‹åºè¿è¡Œæ—¶ï¼Œå…ˆå°†è¦æ‰§è¡Œçš„æŒ‡ä»¤ä»£ç ä»¥åŠæ•°æ®å¤åˆ¶åˆ°é«˜é€Ÿç¼“å­˜ä¸­ï¼ˆç”±æ“ä½œç³»ç»Ÿå®Œæˆï¼‰ï¼Œç„¶å CPU ç›´æ¥ä»é«˜é€Ÿç¼“å­˜ä¾æ¬¡è¯»å–æŒ‡ä»¤æ¥æ‰§è¡Œã€‚







##### cpsr

+ cpsrï¼ˆx33 çŠ¶æ€å¯„å­˜å™¨ï¼‰ï¼Œsprs æ˜¯çŠ¶æ€å¯„å­˜å™¨ï¼Œç”¨äºå­˜æ”¾ç¨‹åºè¿è¡Œä¸­ä¸€äº›çŠ¶æ€æ ‡è¯†ã€‚ä¸åŒäºç¼–ç¨‹è¯­è¨€é‡Œé¢çš„ if elseï¼Œåœ¨æ±‡ç¼–ä¸­å°±éœ€è¦æ ¹æ®çŠ¶æ€å¯„å­˜å™¨ä¸­çš„ä¸€äº›çŠ¶æ€æ¥æ§åˆ¶åˆ†æ”¯çš„æ‰§è¡Œã€‚çŠ¶æ€å¯„å­˜å™¨åˆåˆ†ä¸º The Current Program Status Register (CPSR) å’Œ The Saved Program Status Registers (SPSRs)ã€‚ ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨ CPSRï¼Œ å½“å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œ CPSR ä¼šå­˜å…¥ SPSRã€‚å½“å¼‚å¸¸æ¢å¤ï¼Œå†æ‹·è´å› CPSRã€‚

#### x86

&emsp;ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ x86 æ¶æ„ä¸‹éƒ½æœ‰å“ªäº›å¯„å­˜å™¨ã€‚

&emsp;åŒæ ·çš„æ“ä½œï¼Œè¿™æ¬¡æˆ‘ä»¬é€‰æ‹©æ¨¡æ‹Ÿå™¨è¿è¡Œè°ƒè¯•ï¼Œåœ¨æ–­ç‚¹å‘½ä¸­ååœ¨ Xcode æ§åˆ¶å°è¾“å…¥ register read --all å‘½ä»¤ï¼Œçœ‹åˆ°å¯„å­˜å™¨åˆ†ç»„ä¾ç„¶æ˜¯ï¼šGeneral Purpose Registersã€Floating Point Registersã€Exception State Registersï¼Œä¸è¿‡è¿™æ¬¡å¯„å­˜å™¨çš„åå­—å®Œå…¨å‘ç”Ÿäº†å˜åŒ–ã€‚

&emsp;General Purpose Registers : raxã€rbxã€rcxã€rdxã€rdiã€rsiã€rbpã€rspã€r8ã€r9ã€r10ã€r11ã€r12ã€r13ã€r14ã€r15ã€ripã€rflagsã€csã€fsã€gsã€‚

&emsp;å¯çœ‹åˆ° x86 å’Œ ARM64 æ¶æ„ä¸‹ General Purpose Registers åˆ†ç»„çš„å¯„å­˜å™¨çš„åç§°å®Œå…¨ä¸åŒï¼Œä½†å…¶å®å®ƒä»¬çš„ä½œç”¨åŸºæœ¬éƒ½æ˜¯ç›¸åŒçš„ã€‚ 

&emsp;åŒæ ·çš„æˆ‘ä»¬ä¹Ÿä½¿ç”¨ register read --alternate å‘½ä»¤æŸ¥çœ‹å¯„å­˜å™¨çš„å¤‡ç”¨åï¼ˆalternate register nameï¼‰ï¼Œå¯çœ‹åˆ°ï¼š

+ rcx: arg4
+ rdx: arg3
+ rdi: arg1
+ rsi: arg2
+ r8: arg5
+ r9: arg6

+ rbp: fp
+ rsp: sp     

&emsp;å¯çœ‹åˆ° arg1-arg6 å¯„å­˜å™¨ä¼šç”¨æ¥å­˜å‚¨å‡½æ•°å‚æ•°ï¼Œæˆ‘ä»¬æ‰“å° self å’Œ `_cmd` çš„å€¼çœ‹åˆ° rdiï¼šarg1 ä¿å­˜çš„æ­£æ˜¯ viewDidLoad å‡½æ•°çš„å‚æ•° selfï¼Œrsi: arg2 ä¿å­˜çš„æ­£æ˜¯å‚æ•° viewDidLoad çš„é€‰æ‹©å­ã€‚

&emsp;å…¶ä¸­è¿˜æœ‰ä¸¤ä¸ªç‰¹åˆ«é‡è¦çš„å¯„å­˜å™¨ï¼Œrbp: fp å’Œ rsp: sp æ ˆåº•å’Œæ ˆé¡¶å¯„å­˜å™¨ï¼ŒARM64 ä¸­çš„ fp å¯¹åº” x86 çš„ rbpï¼ŒARM64 ä¸­çš„ sp å¯¹åº” x86 çš„ rspã€‚ 

```c++
(lldb) register read --all
General Purpose Registers:
       rax = 0x0000000000000000  // rax = 0x0000000000000000
       rbx = 0x00007fab1a20a9f0  // rbx = 0x00007fab1a20a9f0
       rcx = 0x0000000204d16600  dyld`_main_thread  // arg4 = 0x0000000204d16600  dyld`_main_thread
       rdx = 0x000000000000010d  // arg3 = 0x000000000000010d
       rdi = 0x00007fab1a20a9f0  // arg1 = 0x00007fab1a20a9f0
       rsi = 0x0000000129c5d99d  "viewDidLoad"  // arg2 = 0x0000000129c5d99d  "viewDidLoad"
       rbp = 0x000000030d789f70  // fp = 0x000000030d789f70
       rsp = 0x000000030d789f50  // sp = 0x000000030d789f50
        r8 = 0x000000010ec960b0  libsystem_pthread.dylib`_pthread_keys  // arg5 = 0x000000010ec960b0  libsystem_pthread.dylib`_pthread_keys
        r9 = 0x00007fab1d009720  // arg6 = 0x00007fab1d009720
       r10 = 0x0000000104a4949a  (void *)0xe9b80000000104a4 // r10 = 0x0000000104a4949a  (void *)0xe9b80000000104a4
       r11 = 0x0000000104a41d00  TEST_MENU`-[ViewController viewDidLoad] at ViewController.m:16  // r11 = 0x0000000104a41d00
       r12 = 0x0000000000000278  // r12 = 0x0000000000000278
       r13 = 0x000000010d4e43c0  libobjc.A.dylib`objc_msgSend  // r13 = 0x000000010d4e43c0  libobjc.A.dylib`objc_msgSend
       r14 = 0x0000000000000000  // r14 = 0x0000000000000000
       r15 = 0x000000010d4e43c0  libobjc.A.dylib`objc_msgSend  // r15 = 0x000000010d4e43c0  libobjc.A.dylib`objc_msgSend
       rip = 0x0000000104a41d10  TEST_MENU`-[ViewController viewDidLoad] + 16 at ViewController.m:17:5  // pc = 0x0000000104a41d10
    rflags = 0x0000000000000206  // flags = 0x0000000000000206
        cs = 0x000000000000002b  // cs = 0x000000000000002b
        fs = 0x0000000000000000  // fs = 0x0000000000000000
        gs = 0x0000000000000000  // gs = 0x0000000000000000
       ...

Floating Point Registers:
     ...

Exception State Registers:
    ...
    
(lldb) p self
(ViewController *) $0 = 0x00007fab1a20a9f0
(lldb) p (SEL)0x0000000129c5d99d
(SEL) $1 = "viewDidLoad"
```

&emsp;x86 æ¶æ„çš„ General Purpose Registers åˆ†ç»„ä¸‹æœ‰ 21 ä¸ª 64 bit å¯„å­˜å™¨ï¼Œç„¶å gs å¯„å­˜å™¨åé¢åˆ—å‡ºçš„åˆ™æ˜¯å‰é¢å¯„å­˜å™¨çš„ä½ä½ï¼Œä½ 32 bitã€ä½ 16 bitã€ä½ 8 bitã€‚

| 64 bit | ä½ 32 bit | ä½ 16 bit | ä½ 8 bit |
| -- | -- | -- | -- |
| rax = 0x0000000000000000 | eax = 0x00000000 | ax = 0x0000 | ah = 0x00 al = 0x00 |
| rbx = 0x00007fbaï¼Œ8450ï¼Œe1ï¼Œ20 | ebx = 0x8450e120 | bx = 0xe120 | bh = 0xe1 bl = 0x20 |
| rcx = 0x00000002ï¼Œ0263ï¼Œ36ï¼Œ00 | ecx = 0x02633600 | cx = 0x3600 | ch = 0x36 cl = 0x00 |
| rdx = 0x00000000ï¼Œ0000ï¼Œ01ï¼Œ0d | edx = 0x0000010d | dx = 0x010d | dh = 0x01 dl = 0x0d |
| rdi = 0x00007fbaï¼Œ8450ï¼Œe1ï¼Œ20 | edi = 0x8450e120 | di = 0xe120 | dil = 0x20 |
| rsi = 0x00000001ï¼Œ2722ï¼Œ79ï¼Œ9d | esi = 0x2722799d | si = 0x799d | sil = 0x9d |
| rbp = 0x00000003ï¼Œ0893ï¼Œbfï¼Œ70 | ebp = 0x0893bf70 | bp = 0xbf70 | bpl = 0x70 |
| rsp = 0x00000003ï¼Œ0893ï¼Œbfï¼Œ50 | esp = 0x0893bf50 | sp = 0xbf50 | spl = 0x50 |
| r8 = 0x00000001ï¼Œ0c55ï¼Œ70ï¼Œb0 | r8d = 0x0c5570b0 | r8w = 0x70b0 | r8l = 0xb0 |
| r9 = 0x00007fbaï¼Œ8383ï¼Œ7eï¼Œ70 | r9d = 0x83837e70 | r9w = 0x7e70 | r9l = 0x70 |
| r10 = 0x00000001ï¼Œ022dï¼Œe4ï¼Œ9a | r10d = 0x022de49a | r10w = 0xe49a | r10l = 0x9a |
| r11 = 0x00000001ï¼Œ022dï¼Œ6dï¼Œ00 | r11d = 0x022d6d00 | r11w = 0x6d00 | r11l = 0x00 |
| r12 = 0x00000000ï¼Œ0000ï¼Œ02ï¼Œ78 | r12d = 0x00000278 | r12w = 0x0278 | r12l = 0x78 |
| r13 = 0x00000001ï¼Œ0ad7ï¼Œ93ï¼Œc0 | r13d = 0x0ad793c0 | r13w = 0x93c0 | r13l = 0xc0 |
| r14 = 0x00000000ï¼Œ0000ï¼Œ00ï¼Œ00 | r14d = 0x00000000 | r14w = 0x0000 | r14l = 0x00 |
| r15 = 0x00000001ï¼Œ0ad7ï¼Œ93ï¼Œc0 | r15d = 0x0ad793c0 | r15w = 0x93c0 | r15l = 0xc0 |
| rip = 0x00000001022d6d10 | - | - | - |
| rflags = 0x0000000000000206 | - | - | - |
| cs = 0x000000000000002b | - | - | - |
| fs = 0x0000000000000000 | - | - | - |
| gs = 0x0000000000000000 | - | - | - |

&emsp;x86 å’Œ ARM64 çš„ä¸»è¦å¯„å­˜å™¨å¤§æ¦‚å°±æ˜¯è¿™äº›äº†ï¼Œä¸‹é¢çš„æˆ‘ä»¬è¯¦ç»†çš„çœ‹ä¸€ä¸‹è¿™äº›å¯„å­˜å™¨çš„å…·ä½“ä½œç”¨ã€‚

&emsp;çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬é›¶é›¶æ•£æ•£çš„çœ‹äº† x86 å’Œ ARM64 æ¶æ„ä¸‹çš„å¸¸è§å¯„å­˜å™¨ï¼Œç„¶åçŸ¥é“å¯„å­˜å™¨ä½äº CPU å†…éƒ¨ï¼Œé‚£ä¹ˆä»–ä»¬çš„è®°å½•çš„å€¼

&emsp;é‚£ä¹ˆæ€ä¹ˆæŠŠ taskã€threadã€thread stateã€register å®ƒä»¬è¿èµ·æ¥å‘¢ï¼Œregister ä¸­ä¿å­˜çš„å€¼æ­£æ˜¯ thread çš„æŸä¸ª state ä¸‹çš„å€¼...

&emsp;å¤´æ–‡ä»¶æ‘˜å–å‡ºæ¥å¤‡ç”¨

```c++
#import <i386/_types.h>

#import <i386/_mcontext.h>
#include <mach/i386/_structs.h>
#include <mach/arm/_structs.h>

#import <mach/thread_act.h>
```




## æ ˆ

&emsp;





















```c++
#if __LP64__
// true arm64

#define SUPPORT_TAGGED_POINTERS 1
#define PTR .quad
#define PTRSIZE 8
#define PTRSHIFT 3  // 1<<PTRSHIFT == PTRSIZE
// "p" registers are pointer-sized
#define UXTP UXTX
#define p0  x0
#define p1  x1
#define p2  x2
#define p3  x3
#define p4  x4
#define p5  x5
#define p6  x6
#define p7  x7
#define p8  x8
#define p9  x9
#define p10 x10
#define p11 x11
#define p12 x12
#define p13 x13
#define p14 x14
#define p15 x15
#define p16 x16
#define p17 x17

// true arm64
#else
// arm64_32

#define SUPPORT_TAGGED_POINTERS 0
#define PTR .long
#define PTRSIZE 4
#define PTRSHIFT 2  // 1<<PTRSHIFT == PTRSIZE
// "p" registers are pointer-sized
#define UXTP UXTW
#define p0  w0
#define p1  w1
#define p2  w2
#define p3  w3
#define p4  w4
#define p5  w5
#define p6  w6
#define p7  w7
#define p8  w8
#define p9  w9
#define p10 w10
#define p11 w11
#define p12 w12
#define p13 w13
#define p14 w14
#define p15 w15
#define p16 w16
#define p17 w17

// arm64_32
#endif
```

&emsp;


```c++
(lldb) register read -A
General Purpose Registers:
       rax = 0x0000000000000000
       rbx = 0x00007f83746262e0
      arg4 = 0x0000000203227600  dyld`_main_thread
      arg3 = 0x000000000000010e
      arg1 = 0x00007f83746262e0
      arg2 = 0x0000000127ebe99d  "viewDidLoad"
        fp = 0x000000030a1baf70
        sp = 0x000000030a1baf50
      arg5 = 0x000000010d1ee0b0  libsystem_pthread.dylib`_pthread_keys
      arg6 = 0x00007f8374831140
       r10 = 0x0000000102f6f362  (void *)0xf9b80000000102f6
       r11 = 0x0000000102f62220  TEST_MENU`-[ViewController viewDidLoad] at ViewController.m:33
       r12 = 0x0000000000000278
       r13 = 0x000000010ba103c0  libobjc.A.dylib`objc_msgSend
       r14 = 0x0000000000000000
       r15 = 0x000000010ba103c0  libobjc.A.dylib`objc_msgSend
        pc = 0x0000000102f62230  TEST_MENU`-[ViewController viewDidLoad] + 16 at ViewController.m:34:5
     flags = 0x0000000000000206
        cs = 0x000000000000002b
        fs = 0x0000000000000000
        gs = 0x0000000000000000

```




&emsp;ææ¸…æ¥šå‡½æ•°è°ƒç”¨æ ˆæ˜¯æ€ä¹ˆè·å–çš„ï¼Œå°±å¿…é¡»äº†è§£è¿™ä¸ªæœºåˆ¶ã€‚

&emsp;å‡½æ•°è°ƒç”¨æ ˆæœ‰ä¸ªå¤§è‡´çš„å°è±¡ï¼Œæ ˆå¸§å›¾ï¼š

&emsp;é¦–å…ˆäº†è§£å¯„å­˜å™¨ï¼ŒARM64 æœ‰ 34 ä¸ªå¯„å­˜å™¨ï¼Œå…¶ä¸­ 31 ä¸ªé€šç”¨å¯„å­˜å™¨ã€SPã€PCã€CPSRã€‚è°ƒç”¨çº¦å®šæŒ‡å®šä»–ä»¬å…¶ä¸­çš„ä¸€äº›å¯„å­˜å™¨æœ‰ç‰¹æ®Šçš„ç”¨é€”ï¼Œä¾‹å¦‚ï¼š

&emsp;x0-x28 é€šç”¨å¯„å­˜å™¨ã€‚

&emsp;x29(FP) é€šå¸¸ç”¨ä½œå¸§æŒ‡é’ˆ fp (frame pointer å¯„å­˜å™¨) ï¼Œæ ˆå¸§åŸºå€å¯„å­˜å™¨ï¼ŒæŒ‡å‘å½“å‰å‡½æ•°æ ˆå¸§çš„æ ˆåº•ã€‚

&emsp;x30(LR) é“¾æ¥å¯„å­˜å™¨ï¼ˆlink registerï¼‰ã€‚å®ƒä¿å­˜äº†å½“ç›®å‰å‡½æ•°è¿”å›æ—¶ä¸‹ä¸€ä¸ªå‡½æ•°çš„åœ°å€ã€‚

&emsp;SP æ ˆæŒ‡é’ˆï¼ˆstack pointerï¼‰å­˜æ”¾æŒ‡å‘æ ˆé¡¶çš„æŒ‡é’ˆï¼Œä½¿ç”¨ SP/WSP æ¥è¿›è¡Œå¯¹ SP å¯„å­˜å™¨çš„è®¿é—®ã€‚

&emsp;PC ç¨‹åºè®¡æ•°å™¨ï¼ˆprogram counterï¼‰å®ƒå­˜æ”¾äº†å½“å‰æ‰§è¡ŒæŒ‡ä»¤çš„åœ°å€ï¼Œåœ¨æ¯ä¸ªæŒ‡ä»¤æ‰§è¡Œå®Œæˆåä¼šè‡ªåŠ¨å¢åŠ ã€‚

&emsp;CPSR çŠ¶æ€å¯„å­˜å™¨

```c++
/* Get the current mach thread ID.
 * mach_thread_self() receives a send right for the thread port which needs to be deallocated to balance the reference count. This function takes care of all of that for you.
 *
 * @return The current thread ID.
 */
KSThread ksthread_self(void);

KSThread ksthread_self()
{
    thread_t thread_self = mach_thread_self();
    mach_port_deallocate(mach_task_self(), thread_self);
    return (KSThread)thread_self;
}
```

&emsp;å¯ä»¥çœ‹åˆ°å…¶å®ƒçš„å¯„å­˜å™¨ä¹Ÿè¿˜æœ‰ä¸€äº›ä¸ç›¸å¹²çš„ä¿¡æ¯ï¼Œè¯´æ˜å¯„å­˜å™¨ä¸ä¼šæ¯ä¸ªå †æ ˆæ‰§è¡Œå®Œéƒ½å…¨éƒ¨æ¸…ç†ï¼Œä¸€èˆ¬åªéœ€è¦ä½¿ç”¨æ—¶å€™æ­£ç¡®å–å€¼å³å¯ã€‚

&emsp;å› æ­¤å¯çŸ¥è°ƒç”¨é“¾å°±æ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„ã€‚å¸§çš„åœ°å€å°±æ˜¯æ ˆåŸºå€å¯„å­˜å™¨çš„åœ°å€ã€‚è€Œæ¯ä¸ªå¸§çš„è¿”å›åœ°å€æŒ‡é’ˆå°±æ˜¯ä¸Šä¸€ä¸ªæ ˆçš„åŸºå€å¯„å­˜å™¨ã€‚

&emsp;å†…æ ¸ä¸ºäº†èƒ½åœ¨å‡ºç°å¼‚å¸¸æ—¶å›æº¯è°ƒç”¨è¿‡ç¨‹ï¼Œä¼šæŠŠæ•´ä¸ªè°ƒç”¨é“¾çš„å †æ ˆä¿å­˜ä¸‹æ¥ã€‚

&emsp;å…¶ä¸­ä¹‹ä¸€é¿å…è°ƒç”¨æ ˆçš„å¼€é”€ï¼Œå› æ­¤ runtime æŠŠå®ƒä»¥çº¯æ±‡ç¼–çš„å½¢å¼å®ç°ï¼Œç›¸å½“äºå†…åµŒåœ¨å½“å‰çš„è°ƒç”¨æ ˆé‡Œæ‰§è¡Œï¼Œå³å®ƒå…±ç”¨çš„æ˜¯å½“å‰è°ƒç”¨æ ˆçš„ç©ºé—´ï¼Œè€Œä¸éœ€è¦æ–°å¼€è¾Ÿä¸€ä¸ªè°ƒç”¨æ ˆã€‚




## ä» å¸¸è§çš„æ±‡ç¼–è¯­æ³• ä¸€èŠ‚ç»§ç»­å‘ä¸‹å­¦ä¹ ....





## å‚è€ƒé“¾æ¥
**å‚è€ƒé“¾æ¥:ğŸ”—**
+ [iOSé€†å‘ ï¼šåˆè¯†æ±‡ç¼–](https://zhuanlan.zhihu.com/p/369071456)
+ [æ·±å…¥iOSç³»ç»Ÿåº•å±‚ä¹‹ç¨‹åºä¸­çš„æ±‡ç¼–ä»£ç ](https://zhuanlan.zhihu.com/p/67258021)
+ [ios-crash-dump-analysis-book](https://github.com/faisalmemon/ios-crash-dump-analysis-book)
+ [ios-crash-dump-analysis-book/zh](https://faisalmemon.github.io/ios-crash-dump-analysis-book/zh/)
+ [iOS Crash/å´©æºƒ/å¼‚å¸¸ å †æ ˆè·å–](https://www.jianshu.com/p/8ece78d71b3d)
+ [iOSå †æ ˆä¿¡æ¯è§£æï¼ˆå‡½æ•°åœ°å€ä¸ç¬¦å·å…³è”ï¼‰](https://www.jianshu.com/p/df5b08330afd)
+ [Machå¾®å†…æ ¸ç®€ä»‹](https://wangkejie.com/iOS/kernelarchitecture/mach.html)
+ [Mach Overview](https://developer.apple.com/library/archive/documentation/Darwin/Conceptual/KernelProgramming/Mach/Mach.html)
+ [è°ˆè°ˆiOSå †æ ˆé‚£äº›äº‹](https://joey520.github.io/2020/03/15/è°ˆè°ˆmsgSendä¸ºä»€ä¹ˆä¸ä¼šå‡ºç°åœ¨å †æ ˆä¸­/)
+ [iOS çš„å´©æºƒæ•è·-å †æ ˆç¬¦å·åŒ–-å´©æºƒåˆ†æ](https://www.jianshu.com/p/302ed945e9cf)
+ [å‡½æ•°æ ˆçš„å®ç°åŸç†](https://segmentfault.com/a/1190000017151354)
+ [å‡½æ•°è°ƒç”¨æ ˆ å‰–æï¼‹å›¾è§£[è½¬]](https://www.jianshu.com/p/78e01e513120)
+ [[è½¬è½½]Cè¯­è¨€å‡½æ•°è°ƒç”¨æ ˆ](https://www.jianshu.com/p/c89d243b8276)
+ [BSBackTraceloggerå­¦ä¹ ç¬”è®°](https://juejin.cn/post/6910791727670362125)
+ [å¦‚ä½•å®šä½Obj-Cé‡æŒ‡é’ˆéšæœºCrash(ä¸€)ï¼šå…ˆæé«˜é‡æŒ‡é’ˆCrashç‡](https://cloud.tencent.com/developer/article/1070505)
+ [å¦‚ä½•å®šä½Obj-Cé‡æŒ‡é’ˆéšæœºCrash(äºŒ)ï¼šè®©éå¿…ç°Crashå˜æˆå¿…ç°](https://cloud.tencent.com/developer/article/1070512)
+ [å¦‚ä½•å®šä½Obj-Cé‡æŒ‡é’ˆéšæœºCrash(ä¸‰)ï¼šå¦‚ä½•è®©Crashè‡ªæŠ¥å®¶é—¨](https://cloud.tencent.com/developer/article/1070528)
+ [iOS/OSX Crashï¼šæ•æ‰å¼‚å¸¸](https://zhuanlan.zhihu.com/p/271282052)
+ [æ±‡ç¼–è¿‡ç¨‹è°ƒç”¨æ˜¯æ€æ ·æ“ä½œæ ˆçš„ï¼Ÿ](https://www.zhihu.com/question/49410551/answer/115870825)

