# constexprå…³é”®å­—ä½¿ç”¨

> **`constexpr` å¯ä»¥ç”¨æ¥ä¿®é¥°å˜é‡ã€å‡½æ•°ã€æ„é€ å‡½æ•°ã€‚ä¸€æ—¦ä»¥ä¸Šä»»ä½•å…ƒç´ è¢« `constexpr` ä¿®é¥°ï¼Œé‚£ä¹ˆç­‰äºè¯´æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨ â€œè¯·å¤§èƒ†åœ°å°†æˆ‘çœ‹æˆç¼–è¯‘æ—¶å°±èƒ½å¾—å‡ºå¸¸é‡å€¼çš„è¡¨è¾¾å¼å»ä¼˜åŒ–æˆ‘â€**ã€‚

`constexpr` æ˜¯ `C++ 11` å¼€å§‹æå‡ºçš„å…³é”®å­—ï¼Œå…¶æ„ä¹‰ä¸ `C++ 14` ç‰ˆæœ¬æœ‰ä¸€äº›åŒºåˆ«ã€‚
å®ƒçš„ä½œç”¨å¦‚åŒå®ƒçš„åå­— `const expression`ã€‚`constexp`çš„ä½œç”¨å…¶å®ä¹Ÿæ˜¯å‘Šè¯‰ç¼–è¯‘å™¨è‡ªå·±å®šä¹‰è¿™ä¸ªå˜é‡çš„æ„å›¾ï¼ˆintentï¼‰ï¼Œä»è€Œè®©ç¼–è¯‘å™¨è¿›è¡Œé¢å¤–æ£€æŸ¥ï¼Œè€Œè¿™ç§é¢å¤–çš„æ£€æŸ¥åˆä¿è¯äº†è¿™ä¸ªä¿®é¥°ç¬¦æœ¬èº«çš„è¯­ä¹‰ï¼Œæ‰€ä»¥å®ƒæ›´å¤šçš„æ˜¯ä¸ºäº†æé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼ˆä¸è¦å‡è®¾ä»£ç åªæ˜¯ç»™å†™ä½œè€…ä¸€ä¸ªäººç»´æŠ¤çš„ï¼‰ã€‚`constexpr`å°±è¦æ±‚ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶æ£€æµ‹è¿™ä¸ªè¡¨è¾¾å¼æœ¬èº«æ˜¯ä¸æ˜¯ç¼–è¯‘æ—¶å¯ä»¥è®¡ç®—å‡ºå¸¸é‡å€¼çš„ã€‚

> 1. `C++ 11` ä¸­çš„ `constexpr` æŒ‡å®šçš„å‡½æ•°è¿”å›å€¼å’Œå‚æ•°å¿…é¡»æ˜¯å­—é¢å€¼ï¼Œè€Œä¸”å¿…é¡» **æœ‰ä¸”åªæœ‰ä¸€è¡Œ `return`ä»£ç **ã€‚è¿™ç»™å‡½æ•°çš„å®ç°å¸¦æ¥äº†æ›´å¤šçš„é™åˆ¶ï¼Œæ¯”å¦‚é€šå¸¸åªèƒ½é€šè¿‡ä¸‰ç›®è¿ç®—ç¬¦ + é€’å½’æ¥è®¡ç®—è¿”å›çš„å­—é¢å€¼ã€‚
  2. `C++ 14` ä¸­ä¿®æ”¹äº†è§„åˆ™ï¼Œåªè¦ä¿è¯è¿”å›å€¼å’Œå‚æ•°æ˜¯å­—é¢å€¼å°±è¡Œäº†ï¼Œå‡½æ•°ä½“ä¸­å¯ä»¥åŠ å…¥æ›´å¤šçš„è¯­å¥ï¼Œæ–¹ä¾¿äº†çµæ´»çš„è®¡ç®—ã€‚

> å¾ˆå¤šäººæŠŠ `constexpr` å’Œ `const` ç›¸æ¯”è¾ƒã€‚

å’Œ `const`å…³é”®å­—ä¸åŒï¼Œ`constexpr` è¡¨ç¤ºçš„æ˜¯è¿™ä¸ªä¿®é¥°çš„å˜é‡åœ¨è¾“å…¥ï¼ˆå¦‚æœæœ‰è¾“å…¥çš„è¯ï¼‰æ˜¯å¸¸é‡çš„æ—¶å€™èƒ½å¤Ÿåœ¨ç¼–è¯‘æ—¶è·å¾—ä¸€ä¸ªè¾“å‡ºå¸¸é‡ï¼Œè€Œ `const` æ›´å¤šçš„æ„æ€æ˜¯è¿™ä¸ªå˜é‡æœ¬èº«åœ¨è¿è¡Œæ—¶ä¸èƒ½è¢«ä¿®æ”¹ã€‚
å…¶å®ï¼Œ`const` å¹¶ä¸èƒ½ä»£è¡¨ â€œå¸¸é‡â€ï¼Œå®ƒ**ä»…ä»…æ˜¯å¯¹å˜é‡çš„ä¸€ä¸ªä¿®é¥°**ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨è¿™ä¸ªå˜é‡åªèƒ½è¢«åˆå§‹åŒ–ï¼Œä¸”ä¸èƒ½è¢«ç›´æ¥ä¿®æ”¹ï¼ˆå®é™…ä¸Šå¯ä»¥é€šè¿‡**å †æ ˆæº¢å‡º**ç­‰æ–¹å¼ä¿®æ”¹ï¼‰ã€‚è€Œè¿™ä¸ªå˜é‡çš„å€¼ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶ä¹Ÿå¯ä»¥åœ¨ç¼–è¯‘æ—¶æŒ‡å®šã€‚

`constexpr` å¯ä»¥ç”¨æ¥ä¿®é¥°å˜é‡ã€å‡½æ•°ã€æ„é€ å‡½æ•°ã€‚ä¸€æ—¦ä»¥ä¸Šä»»ä½•å…ƒç´ è¢« `constexpr` ä¿®é¥°ï¼Œé‚£ä¹ˆç­‰äºè¯´æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨ â€œè¯·å¤§èƒ†åœ°å°†æˆ‘çœ‹æˆç¼–è¯‘æ—¶å°±èƒ½å¾—å‡ºå¸¸é‡å€¼çš„è¡¨è¾¾å¼å»ä¼˜åŒ–æˆ‘â€ã€‚å¦‚ï¼š

> ç¤ºä¾‹ä»£ç ç¼–å†™ç¯å¢ƒ: Xcode 11.3.1ï¼ŒBuild Settrings ä¸­ï¼ŒC Language Dialect: gnu 11ï¼ŒC++ Language Dialect: GNU++14[-std=gnu++14]

```c++
// è¿™æ˜¯åšä¸»çš„åŸå§‹ä»£ç ï¼Œå¯èƒ½æ˜¯ Xcode å·²ç»è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¹¶ä¸ä¼šç¼–è¯‘é”™è¯¯ ğŸ™†â€â™‚ï¸
const int func() { // è¿™é‡Œä¼šç»™ä¸€ä¸ªâš ï¸ï¼š'const' type qualifier on return type has no effect
    return 10;
}
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        // insert code here...
        int arr[func()];
        arr[11] = 13; // ä¸”è¿™é‡Œç´¢å¼•å¤§äº10ï¼Œä¾ç„¶èƒ½æ­£å¸¸è¿è¡Œ
        printf("%d\t%d\n", arr[0], arr[11]);
    }
    return 0;
}
// æ‰“å°: 12    13
```
å¯¹äº `func()`ï¼Œèƒ†å°çš„ç¼–è¯‘å™¨å¹¶æ²¡æœ‰è¶³å¤Ÿçš„èƒ†é‡å»åšç¼–è¯‘ä¼˜åŒ–ï¼Œå“ªæ€•å‡½æ•°ä½“å°±ä¸€å¥ return å­—é¢å€¼ã€‚è€Œï¼š
```c++
constexpr int func() {
    return 10;
}
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        // insert code here...
        int arr[func()];
        arr[0] = 12;
        // è¿™é‡Œä¼šç»™ä¸¤æ¡è­¦å‘Š
        arr[11] = 13; // âš ï¸ï¼šArray index 11 is past the end of the array (which contains 10 elements)
        printf("%d\t%d\n", arr[0], arr[11]); // âš ï¸ï¼šArray index 11 is past the end of the array (which contains 10 elements)
    }
    return 0;
}
// æ‰“å°: 12    13
```
åˆ™ç¼–è¯‘é€šè¿‡ï¼Œç¼–è¯‘æœŸå¤§èƒ†çš„å°† func() åšäº†ä¼˜åŒ–ï¼Œåœ¨ç¼–è¯‘æœŸå°±ç¡®å®šäº† func è®¡ç®—å‡ºçš„å€¼ 10ï¼Œè€Œæ— éœ€ç­‰åˆ°è¿è¡Œæ—¶å†å»è®¡ç®—ã€‚

è¿™å°±æ˜¯ `constexpr` çš„ç¬¬ä¸€ä¸ªä½œç”¨ï¼šç»™ç¼–è¯‘å™¨è¶³å¤Ÿçš„ä¿¡å¿ƒåœ¨ç¼–è¯‘æœŸå»åšè¢« `constexpr` ä¿®é¥°çš„è¡¨è¾¾å¼çš„ä¼˜åŒ–ã€‚

`constexpr` è¿˜æœ‰å¦å¤–ä¸€ä¸ªç‰¹æ€§ï¼Œè™½ç„¶å®ƒæœ¬èº«çš„ä½œç”¨ä¹‹ä¸€å°±æ˜¯å¸Œæœ›ç¨‹åºå‘˜èƒ½ç»™ç¼–è¯‘å™¨åšä¼˜åŒ–çš„ä¿¡å¿ƒï¼Œä½†å®ƒå´çŒœåˆ°äº†è‡ªå·±å¯èƒ½ä¼šè¢«ç¨‹åºå‘˜æ¬ºéª—ï¼Œè€Œç¼–è¯‘å™¨å¹¶ä¸ä¼šå¯¹æ­¤ "æ¼ç¾æˆæ€’"ä¸­æ­¢ç¼–è¯‘ï¼Œå¦‚ï¼š
```
int func(const int n) {
    return 10 + n;
}
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        // insert code here...
        int arr[func(1)];
        arr[0] = 12;
        arr[13] = 13; // ä¸”è¿™é‡Œç´¢å¼•ä¸º 11 ä¾ç„¶èƒ½æ­£å¸¸è¿è¡Œ
        printf("%d\t%d\n", arr[0], arr[13]);
    }
    return 0;
}
// æ‰“å°:
12    13 
// å¦‚æœåœ¨ func å‰é¢åŠ  constexpr ä¼š crashï¼Œä½†æ˜¯å¯¹ arr[x] èµ‹å€¼æ—¶ï¼Œx ä¸è¶Šç•Œçš„è¯èƒ½æ­£å¸¸è¿è¡Œã€‚
```
ç¨‹åºå‘˜å‘Šè¯‰ç¼–è¯‘å™¨å°½ç®¡ä¿¡å¿ƒåè¶³åœ°æŠŠ `func` å½“åšæ˜¯ç¼–è¯‘æœŸå°±èƒ½è®¡ç®—å‡ºå€¼çš„ç¨‹åºï¼Œä½†å´æ¬ºéª—äº†å®ƒï¼Œç¨‹åºå‘˜æœ€ç»ˆå¹¶æ²¡æœ‰ä¼ é€’ä¸€ä¸ªå¸¸é‡å­—é¢é‡å€¼åˆ°è¯¥å‡½æ•°ã€‚æ²¡æœ‰è¢«ç¼–è¯‘å™¨ä¸­æ­¢ç¼–è¯‘å¹¶æŠ¥é”™çš„åŸå› åœ¨äºç¼–è¯‘å™¨å¹¶æ²¡æœ‰ 100% ç›¸ä¿¡ç¨‹åºå‘˜ï¼Œå½“å…¶æ£€æµ‹åˆ° func çš„å‚æ•°æ˜¯ä¸€ä¸ªå¸¸é‡å­—é¢å€¼çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨æ‰ä¼šå»å¯¹å…¶ä¼˜åŒ–ï¼Œå¦åˆ™ï¼Œä¾ç„¶ä¼šå°†è®¡ç®—ä»»åŠ¡ç•™ç»™è¿è¡Œæ—¶ã€‚
åŸºäºè¿™ä¸ªç‰¹æ€§ï¼Œconstexpr è¿˜å¯ä»¥è¢«ç”¨æ¥å®ç°ç¼–è¯‘æœŸçš„ `type traits`ï¼Œæ¯”å¦‚ `STL` ä¸­çš„ `is_const` çš„å®Œæ•´å®ç°:
```c++
template <class _Ty, _Ty _Val>
struct integral_constant {
    // convenient template for integral constant types
    static constexpr _Ty value = _Val;
    
    typedef _Ty value_type;
    typedef integral_constant<_Ty, _Val> type;
    
    constexpr operator value_type() const noexcept {
        // return stored value
        return (value);
    }
    
    constexpr value_type operator()() const noexcept {
        // return stored value
        return (value);
    }
};

typedef integral_constant<bool, true> true_type;
typedef integral_constant<bool, false> false_type;

template<class _Ty>
struct is_const: false_type {
    // determine whether _Ty is const qualified
};

template<class _Ty>
struct is_const<const _Ty>: true_type {
    // determine whether _Ty is const qualified
};

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        // insert code here...
        static_assert(is_const<int>::value, "error"); // error â—ï¸â—ï¸â—ï¸ Static_assert failed due to requirement 'is_const<int>::value' "error"
        static_assert(is_const<const int>::value, "error"); // ok
    }
    return 0;
}
```
**å‚è€ƒé“¾æ¥:ğŸ”—**
[C++11/14 constexpr ç”¨æ³•](https://www.jianshu.com/p/34a2a79ea947)
